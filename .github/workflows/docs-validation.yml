name: Validate Documentation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - 'scripts/docs/**'
      - '.github/workflows/docs-validation.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - 'scripts/docs/**'
      - '.github/workflows/docs-validation.yml'
  workflow_dispatch:
  workflow_call:
    inputs:
      skip_freeze_guard:
        description: 'Set to true to skip the freeze guard when reusing this workflow.'
        required: false
        type: boolean

permissions:
  contents: read
  pull-requests: write

jobs:
  freeze_guard:
    uses: ./.github/workflows/freeze-guard.yml
    with:
      skip: ${{ github.event_name == 'workflow_call' && inputs.skip_freeze_guard }}
    secrets: inherit

  validate-frontmatter:
    name: Validate Frontmatter
    runs-on: ubuntu-latest
    needs: freeze_guard
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    outputs:
      failed: ${{ steps.capture.outputs.failed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Python environment
        uses: ./.github/actions/setup-python
        with:
          python-version: '3.11'
          cache-dependency-path: requirements-docs.txt
          install-command: pip install -r requirements-docs.txt

      - name: Prepare reports directory
        run: mkdir -p docs/reports

      - name: Validate documentation frontmatter
        id: validator
        continue-on-error: true
        run: |
          python scripts/docs/validate-frontmatter.py \
            --schema v2 \
            --docs-dir ./docs/content \
            --output ./docs/reports/frontmatter-validation-pr.json \
            --verbose

      - name: Upload frontmatter validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontmatter-validation-report
          path: docs/reports/frontmatter-validation-pr.json
          if-no-files-found: warn
          retention-days: 7

      - name: Capture validator result
        id: capture
        env:
          VALIDATOR_OUTCOME: ${{ steps.validator.outcome }}
        run: |
          if [ "$VALIDATOR_OUTCOME" = "failure" ]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fail job if validation failed
        if: ${{ steps.capture.outputs.failed == 'true' }}
        run: |
          echo "Frontmatter validation failed. See artifact for details."
          exit 1

  maintenance-audit:
    name: Run Maintenance Audit
    runs-on: ubuntu-latest
    needs: freeze_guard
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    outputs:
      failed: ${{ steps.capture.outputs.failed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Python environment
        uses: ./.github/actions/setup-python
        with:
          python-version: '3.11'
          cache-dependency-path: requirements-docs.txt
          install-command: pip install -r requirements-docs.txt

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run maintenance audit
        id: audit
        continue-on-error: true
        run: bash scripts/docs/maintenance-audit.sh --ci-mode

      - name: Upload maintenance audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maintenance-audit-report
          path: docs/reports/maintenance-audit-*.md
          if-no-files-found: warn
          retention-days: 7

      - name: Capture audit result
        id: capture
        env:
          AUDIT_OUTCOME: ${{ steps.audit.outcome }}
        run: |
          if [ "$AUDIT_OUTCOME" = "failure" ]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fail job if audit failed
        if: ${{ steps.capture.outputs.failed == 'true' }}
        run: |
          echo "Maintenance audit exceeded CI threshold. See report for details."
          exit 1

  docs-check:
    name: Run Docs Validation Pipeline
    runs-on: ubuntu-latest
    needs: freeze_guard
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    outputs:
      failed: ${{ steps.capture.outputs.failed }}
    defaults:
      run:
        working-directory: docs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare docs workspace
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          cache-dependency-path: docs/package-lock.json
          working-directory: docs

      - name: Run docs:check
        id: verify_docs
        continue-on-error: true
        env:
          NODE_ENV: production
        run: npm run docs:check

      - name: Upload docs build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-build
          path: docs/build
          if-no-files-found: warn
          retention-days: 7

      - name: Capture docs:check result
        id: capture
        env:
          CHECK_OUTCOME: ${{ steps.verify_docs.outcome }}
        run: |
          if [ "$CHECK_OUTCOME" = "failure" ]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fail job if docs:check failed
        if: ${{ steps.capture.outputs.failed == 'true' }}
        run: |
          echo "docs:check reported failures. Review logs and artifacts."
          exit 1

  docs-links:
    name: Validate Documentation Links
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - docs-check
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    outputs:
      failed: ${{ steps.capture.outputs.failed }}
    defaults:
      run:
        working-directory: docs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare docs workspace
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          cache-dependency-path: docs/package-lock.json
          working-directory: docs

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-build
          path: .

      - name: Run docs:links
        id: validate_links
        continue-on-error: true
        run: |
          mkdir -p ../docs/reports
          npm run docs:links | tee ../docs/reports/docs-links.log

      - name: Upload link validation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-link-validation-log
          path: docs/reports/docs-links.log
          if-no-files-found: warn
          retention-days: 7

      - name: Capture link validation result
        id: capture
        env:
          LINKS_OUTCOME: ${{ steps.validate_links.outcome }}
        run: |
          if [ "$LINKS_OUTCOME" = "failure" ]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "failed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Fail job if links validation failed
        if: ${{ steps.capture.outputs.failed == 'true' }}
        run: |
          echo "Link validation detected issues. Investigate docs-links log."
          exit 1

  notify-slack:
    name: Notify Slack on Failure
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - validate-frontmatter
      - maintenance-audit
      - docs-check
      - docs-links
    if: ${{ always() && needs.freeze_guard.outputs.active != 'true' && secrets.SLACK_WEBHOOK_URL != '' && (
          needs.validate-frontmatter.result == 'failure' ||
          needs.maintenance-audit.result == 'failure' ||
          needs.docs-check.result == 'failure' ||
          needs.docs-links.result == 'failure'
        ) }}
    steps:
      - name: Collect failure details
        id: failure_meta
        env:
          FRONTMATTER_RESULT: ${{ needs.validate-frontmatter.result }}
          MAINTENANCE_RESULT: ${{ needs.maintenance-audit.result }}
          DOCS_CHECK_RESULT: ${{ needs.docs-check.result }}
          DOCS_LINKS_RESULT: ${{ needs.docs-links.result }}
        run: |
          failed_jobs=()
          if [ "$FRONTMATTER_RESULT" = "failure" ]; then failed_jobs+=("validate-frontmatter"); fi
          if [ "$MAINTENANCE_RESULT" = "failure" ]; then failed_jobs+=("maintenance-audit"); fi
          if [ "$DOCS_CHECK_RESULT" = "failure" ]; then failed_jobs+=("docs-check"); fi
          if [ "$DOCS_LINKS_RESULT" = "failure" ]; then failed_jobs+=("docs-links"); fi

          if [ "${#failed_jobs[@]}" -eq 0 ]; then
            echo "failed_jobs=none" >> "$GITHUB_OUTPUT"
          else
            joined="${failed_jobs[0]}"
            for job in "${failed_jobs[@]:1}"; do
              joined="$joined, $job"
            done
            echo "failed_jobs=$joined" >> "$GITHUB_OUTPUT"
          fi

      - name: Send Slack notification
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: failure
          fields: workflow,job,commit,author,ref
          custom_payload: |
            {
              "text": ":rotating_light: Documentation validation failed for ${{ github.repository }}",
              "attachments": [
                {
                  "color": "#D72638",
                  "fields": [
                    {
                      "title": "Failed Jobs",
                      "value": "${{ steps.failure_meta.outputs.failed_jobs }}",
                      "short": false
                    },
                    {
                      "title": "Run",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>",
                      "short": false
                    },
                    {
                      "title": "Commit",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": false
                    }
                  ],
                  "footer": "Triggered by ${{ github.actor }}",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                }
              ]
            }

  validation-summary:
    name: Publish Validation Summary
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - validate-frontmatter
      - maintenance-audit
      - docs-check
      - docs-links
    if: ${{ always() && needs.freeze_guard.outputs.active != 'true' }}
    steps:
      - name: Create GitHub Step Summary
        shell: bash
        env:
          FRONTMATTER_RESULT: ${{ needs.validate-frontmatter.result }}
          FRONTMATTER_FAILED: ${{ needs.validate-frontmatter.outputs.failed }}
          MAINTENANCE_RESULT: ${{ needs.maintenance-audit.result }}
          MAINTENANCE_FAILED: ${{ needs.maintenance-audit.outputs.failed }}
          DOCS_CHECK_RESULT: ${{ needs.docs-check.result }}
          DOCS_CHECK_FAILED: ${{ needs.docs-check.outputs.failed }}
          DOCS_LINKS_RESULT: ${{ needs.docs-links.result }}
          DOCS_LINKS_FAILED: ${{ needs.docs-links.outputs.failed }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          icon_for() {
            if [ "$1" = "success" ]; then
              printf "âœ…"
            elif [ "$1" = "skipped" ]; then
              printf "â­ï¸"
            elif [ "$1" = "cancelled" ]; then
              printf "â¹ï¸"
            else
              printf "âŒ"
            fi
          }

          echo "## ðŸ“š Documentation Validation Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Run: [$RUN_URL]($RUN_URL)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "| Check | Status | Details |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|---------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Validate Frontmatter | $(icon_for "$FRONTMATTER_RESULT") | Failed: ${FRONTMATTER_FAILED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Maintenance Audit | $(icon_for "$MAINTENANCE_RESULT") | Failed: ${MAINTENANCE_FAILED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Docs Check | $(icon_for "$DOCS_CHECK_RESULT") | Failed: ${DOCS_CHECK_FAILED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Docs Links | $(icon_for "$DOCS_LINKS_RESULT") | Failed: ${DOCS_LINKS_FAILED} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Artifacts are available in the workflow run for detailed reports and logs." >> "$GITHUB_STEP_SUMMARY"
