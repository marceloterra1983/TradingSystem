name: Security Audit

# Enhanced security audit with SARIF reporting and GitHub Security integration
# Part of: Phase 1.3 - Security Improvements (Improvement Plan v1.0)
# Updated: 2025-11-11

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 2 AM UTC
  pull_request:
    branches: [main, develop]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
      - '**/requirements.txt'
  push:
    branches: [main, develop]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  security-events: write # For SARIF upload
  issues: write # For PR comments
  pull-requests: write # For PR comments

jobs:
  npm-audit:
    name: NPM Audit - ${{ matrix.project.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - name: dashboard
            path: frontend/dashboard
          - name: workspace-api
            path: backend/api/workspace
          - name: tp-capital
            path: apps/tp-capital
          - name: documentation-api
            path: backend/api/documentation-api
          - name: docs
            path: docs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        id: npm_audit
        working-directory: ${{ matrix.project.path }}
        continue-on-error: true
        run: |
          echo "ðŸ” Running npm audit for ${{ matrix.project.name }}..."

          # Generate JSON report
          npm audit --json > audit-report.json || true

          # Generate human-readable report
          npm audit --audit-level=moderate > audit-text.txt || true

          # Extract summary
          TOTAL=$(jq '.metadata.vulnerabilities | to_entries | map(.value) | add' audit-report.json || echo "0")
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-report.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-report.json)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          echo "### ðŸ“Š Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY

      - name: Convert to SARIF
        if: always()
        working-directory: ${{ matrix.project.path }}
        run: |
          # Install npm-audit-to-sarif converter
          npm install -g @microsoft/sarif-multitool

          # Convert npm audit JSON to SARIF format
          if [ -f audit-report.json ]; then
            npx audit-ci --format sarif audit-report.json > audit.sarif 2>/dev/null || \
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"npm audit"}},"results":[]}]}' > audit.sarif
          fi

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ matrix.project.path }}/audit.sarif
          category: npm-audit-${{ matrix.project.name }}
        continue-on-error: true

      - name: Check for high/critical vulnerabilities
        working-directory: ${{ matrix.project.path }}
        run: |
          CRITICAL=${{ steps.npm_audit.outputs.critical }}
          HIGH=${{ steps.npm_audit.outputs.high }}

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âŒ Critical or high vulnerabilities detected!"
            echo "   Critical: $CRITICAL"
            echo "   High: $HIGH"
            echo ""
            echo "ðŸ”§ Remediation steps:"
            echo "   1. Run: cd ${{ matrix.project.path }}"
            echo "   2. Run: npm audit fix"
            echo "   3. If auto-fix fails: npm audit fix --force"
            echo "   4. Review changes and test"
            echo "   5. Commit fixes"
            exit 1
          else
            echo "âœ… No high or critical vulnerabilities found"
          fi

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-${{ matrix.project.name }}
          path: |
            ${{ matrix.project.path }}/audit-report.json
            ${{ matrix.project.path }}/audit-text.txt
            ${{ matrix.project.path }}/audit.sarif
          retention-days: 30

  python-safety:
    name: Python Safety Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Safety
        run: pip install safety

      - name: Run Safety check
        working-directory: tools/llamaindex
        continue-on-error: true
        run: |
          echo "ðŸ” Running Safety check for Python dependencies..."
          safety check --file requirements.txt --json > safety-report.json || true

      - name: Check for vulnerabilities
        working-directory: tools/llamaindex
        run: |
          if safety check --file requirements.txt; then
            echo "âœ… No Python vulnerabilities found"
          else
            echo "âš ï¸ Python vulnerabilities detected!"
            echo "Review: tools/llamaindex/safety-report.json"
          fi

      - name: Upload safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-safety-report
          path: tools/llamaindex/safety-report.json
          retention-days: 30

  secrets-scan:
    name: Scan for Hardcoded Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better secret detection

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Check for potential secrets in code
        run: |
          echo "ðŸ” Scanning for potential hardcoded secrets..."

          SCAN_DIRS=(frontend backend apps docs scripts tools)
          TARGETS=()
          for dir in "${SCAN_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              TARGETS+=("$dir")
            fi
          done

          if [ ${#TARGETS[@]} -eq 0 ]; then
            echo "âš ï¸ No directories available for scanning (skipping)"
            exit 0
          fi

          pattern="(password|secret|api_key|token|private_key).*=.*['\"][a-zA-Z0-9]{8,}"
          if grep -r -E "$pattern" \
             --include="*.ts" --include="*.tsx" --include="*.js" --include="*.py" \
             --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=build \
             --exclude-dir=.venv --exclude="*.test.*" --exclude="*.spec.*" \
             "${TARGETS[@]}" 2>/dev/null | grep -v "process.env"; then
            echo "âš ï¸ Found potential hardcoded secrets!"
            echo "Please review and move to environment variables"
            exit 1
          fi

          echo "âœ… No hardcoded secrets found"

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          comment-summary-in-pr: always

  security-summary:
    name: Security Summary (PR Comment)
    runs-on: ubuntu-latest
    needs: [npm-audit, python-safety, secrets-scan]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Download all audit reports
        uses: actions/download-artifact@v4
        with:
          path: audit-reports/

      - name: Generate security summary
        id: summary
        run: |
          echo "Generating security summary from all audit reports..."

          # Initialize counters
          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          TOTAL_MODERATE=0
          TOTAL_LOW=0
          TOTAL_VULNS=0

          # Process npm audit reports
          for report in audit-reports/npm-audit-*/audit-report.json; do
            if [ -f "$report" ]; then
              CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' "$report")
              HIGH=$(jq '.metadata.vulnerabilities.high // 0' "$report")
              MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' "$report")
              LOW=$(jq '.metadata.vulnerabilities.low // 0' "$report")

              TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
              TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
              TOTAL_MODERATE=$((TOTAL_MODERATE + MODERATE))
              TOTAL_LOW=$((TOTAL_LOW + LOW))
            fi
          done

          TOTAL_VULNS=$((TOTAL_CRITICAL + TOTAL_HIGH + TOTAL_MODERATE + TOTAL_LOW))

          echo "total_vulns=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          echo "critical=$TOTAL_CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$TOTAL_HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$TOTAL_MODERATE" >> $GITHUB_OUTPUT
          echo "low=$TOTAL_LOW" >> $GITHUB_OUTPUT

          # Determine overall status
          if [ "$TOTAL_CRITICAL" -gt 0 ] || [ "$TOTAL_HIGH" -gt 0 ]; then
            echo "status=âŒ Action Required" >> $GITHUB_OUTPUT
          elif [ "$TOTAL_MODERATE" -gt 0 ]; then
            echo "status=âš ï¸ Review Recommended" >> $GITHUB_OUTPUT
          else
            echo "status=âœ… Passed" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with security summary
        uses: actions/github-script@v7
        with:
          script: |
            const totalVulns = '${{ steps.summary.outputs.total_vulns }}';
            const critical = '${{ steps.summary.outputs.critical }}';
            const high = '${{ steps.summary.outputs.high }}';
            const moderate = '${{ steps.summary.outputs.moderate }}';
            const low = '${{ steps.summary.outputs.low }}';
            const status = '${{ steps.summary.outputs.status }}';

            let emoji = 'âœ…';
            if (critical > 0 || high > 0) {
              emoji = 'âŒ';
            } else if (moderate > 0) {
              emoji = 'âš ï¸';
            }

            const comment = `### ${emoji} Security Audit Report

            **Overall Status:** ${status}

            | Severity | Count |
            |----------|-------|
            | ðŸ”´ Critical | ${critical} |
            | ðŸŸ  High | ${high} |
            | ðŸŸ¡ Moderate | ${moderate} |
            | ðŸ”µ Low | ${low} |
            | **Total** | **${totalVulns}** |

            ${critical > 0 || high > 0 ? `
            ### âš ï¸ Action Required

            Critical or high vulnerabilities detected. Please remediate before merging:

            1. Review vulnerability details in [GitHub Security tab](https://github.com/${{ github.repository }}/security)
            2. Run \`npm audit fix\` in affected projects
            3. Test changes thoroughly
            4. Commit fixes and re-run checks

            ` : ''}

            ${moderate > 0 && critical == 0 && high == 0 ? `
            ### ðŸ“‹ Moderate Vulnerabilities

            Moderate vulnerabilities detected. Consider fixing before merge or create follow-up issue.

            ` : ''}

            ${totalVulns == 0 ? `
            ### âœ… All Clear!

            No security vulnerabilities detected across all projects.

            ` : ''}

            <details>
            <summary>ðŸ“Š View Detailed Reports</summary>

            - **npm audit reports:** Check Actions artifacts
            - **GitHub Security tab:** [View all vulnerabilities](https://github.com/${{ github.repository }}/security/dependabot)
            - **Workflow run:** [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            </details>

            ---
            *Automated security audit by [Security Audit workflow](https://github.com/${{ github.repository }}/actions/workflows/security-audit.yml)*
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
