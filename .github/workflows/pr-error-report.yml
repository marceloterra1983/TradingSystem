name: PR Error Report

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

  # Tamb칠m executa quando workflows de PR terminam
  workflow_run:
    workflows:
      - "Code Quality"
      - "Automated Tests"
      - "Bundle Size Check"
      - "Docker Build & Security"
      - "Security Audit"
      - "Documentation Validation"
      - "Environment Validation"
    types:
      - completed

jobs:
  generate-pr-error-report:
    runs-on: ubuntu-latest
    # Executa sempre, independente de sucesso ou falha
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_run'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo mkdir -p /etc/apt/sources.list.d
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh jq -y

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Generate Error Report for PR
        id: generate_report
        run: |
          chmod +x scripts/github/collect-workflow-errors.sh

          # Gerar relat칩rio (칰ltimas 15 falhas)
          bash scripts/github/collect-workflow-errors.sh 15

          # Verificar se h치 relat칩rio gerado
          if [ -f workflow-errors/LATEST.md ]; then
            echo "report_generated=true" >> $GITHUB_OUTPUT
            echo "report_path=workflow-errors/LATEST.md" >> $GITHUB_OUTPUT
          else
            echo "report_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Error Report as Artifact
        if: steps.generate_report.outputs.report_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-error-report-${{ github.event.pull_request.number || github.run_number }}
          path: workflow-errors/*.md
          retention-days: 30

      - name: Comment on PR with Report Summary
        if: github.event_name == 'pull_request' && steps.generate_report.outputs.report_generated == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          REPO_SLUG: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Ler o relat칩rio
            const reportPath = 'workflow-errors/LATEST.md';
            let reportContent = fs.readFileSync(reportPath, 'utf8');

            // Extrair apenas o resumo executivo (primeira tabela)
            const summaryMatch = reportContent.match(/## 游늵 Resumo Executivo([\s\S]*?)(?=\n---|\n##|$)/);
            const summary = summaryMatch ? summaryMatch[0] : 'Nenhum erro encontrado';

            // Contar erros
            const errorCount = (reportContent.match(/### 游댮/g) || []).length;

            const prNumber = process.env.PR_NUMBER;
            const branchName = process.env.PR_BRANCH;
            const prSha = process.env.PR_SHA;
            const repoSlug = process.env.REPO_SLUG;
            const runId = process.env.RUN_ID;

            // Criar coment치rio
            const comment = `## 游댌 Relat칩rio de Erros do PR

            **PR:** #${prNumber}
            **Branch:** \`${branchName}\`
            **Commit:** \`${prSha}\`

            ${summary}

            ---

            ### 游늵 Estat칤sticas

            - **Total de Workflows com Falha:** ${errorCount}
            - **Workflows Analisados:** 15 칰ltimos

            ### 游닍 Download do Relat칩rio Completo

            O relat칩rio completo est치 dispon칤vel nos **Artifacts** desta execu칞칚o:
            - [游늯 Download Error Report](https://github.com/${repoSlug}/actions/runs/${runId})

            ### 游댢 Comandos 칔teis

            \`\`\`bash
            # Gerar relat칩rio localmente
            bash scripts/github/collect-workflow-errors.sh

            # Ver 칰ltimo relat칩rio
            cat workflow-errors/LATEST.md

            # Monitorar workflows
            bash scripts/github/monitor-workflows.sh 30
            \`\`\`

            ---
            游뱄 *Gerado automaticamente por [PR Error Report](https://github.com/${{ github.repository }}/actions/workflows/pr-error-report.yml)*`;

            // Postar coment치rio
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: comment
            });

      - name: Set PR Status Check
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Verificar se h치 erros no relat칩rio
            let hasErrors = false;
            if (fs.existsSync('workflow-errors/LATEST.md')) {
              const content = fs.readFileSync('workflow-errors/LATEST.md', 'utf8');
              hasErrors = content.includes('### 游댮');
            }

            // Definir status
            const state = hasErrors ? 'failure' : 'success';
            const description = hasErrors
              ? 'Workflows com falhas detectados - Ver relat칩rio'
              : 'Nenhuma falha detectada';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.pull_request.head.sha }}',
              state: state,
              context: 'Error Report',
              description: description,
              target_url: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });
