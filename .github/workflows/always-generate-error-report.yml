name: Always Generate Error Report

on:
  # REMOVED: workflow_run trigger causa execuÃ§Ãµes duplicadas
  # Cada workflow completando trigga uma execuÃ§Ã£o separada
  # Resultado: 8+ execuÃ§Ãµes simultÃ¢neas para 1 push

  # ExecuÃ§Ã£o manual (recomendado)
  workflow_dispatch:

  # Executa em schedule (diÃ¡rio Ã s 9h UTC)
  schedule:
    - cron: '0 9 * * *'

  # Executa em push para main (agregado - 1 execuÃ§Ã£o por push)
  push:
    branches:
      - main

# PermissÃµes necessÃ¡rias para commit e push
permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: error-report-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-error-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo mkdir -p /etc/apt/sources.list.d
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh jq -y

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Generate Comprehensive Error Report
        id: generate_report
        run: |
          chmod +x scripts/github/collect-workflow-errors.sh

          # Gerar relatÃ³rio (Ãºltimas 20 falhas)
          bash scripts/github/collect-workflow-errors.sh 20

          # Verificar se hÃ¡ relatÃ³rio (no symlink, use timestamped files)
          LATEST_REPORT=$(ls -t workflow-errors/ERROR-REPORT-*.md 2>/dev/null | head -1)

          if [ -n "$LATEST_REPORT" ] && [ -f "$LATEST_REPORT" ]; then
            echo "report_generated=true" >> $GITHUB_OUTPUT

            # Contar erros
            ERROR_COUNT=$(grep -c "### ðŸ”´" "$LATEST_REPORT" || echo "0")
            echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          else
            echo "report_generated=false" >> $GITHUB_OUTPUT
            echo "error_count=0" >> $GITHUB_OUTPUT
          fi

      # REMOVED: Commit automÃ¡tico causa conflitos de git push
      # RelatÃ³rios ficam disponÃ­veis via Artifacts (90 dias retenÃ§Ã£o)
      # Para ver relatÃ³rios: GitHub Actions â†’ Workflow â†’ Artifacts â†’ Download

      - name: Upload Error Report as Artifact (Backup)
        if: steps.generate_report.outputs.report_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-error-report-${{ github.run_number }}
          path: workflow-errors/*.md
          retention-days: 90

      - name: Create Issue if Too Many Errors
        if: steps.generate_report.outputs.error_count > 5
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            const errorCount = ${{ steps.generate_report.outputs.error_count }};

            // Find most recent error report (no symlink)
            const latestReport = execSync('ls -t workflow-errors/ERROR-REPORT-*.md 2>/dev/null | head -1').toString().trim();

            let summary = '';
            if (latestReport && fs.existsSync(latestReport)) {
              const reportContent = fs.readFileSync(latestReport, 'utf8');
              const summaryMatch = reportContent.match(/## ðŸ“Š Resumo Executivo([\s\S]*?)(?=\n---|\n##|$)/);
              summary = summaryMatch ? summaryMatch[0] : '';
            }

            // Criar issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Alert: ${errorCount} workflow failures detected`,
              body: `## âš ï¸ Multiple Workflow Failures Detected

            **Total Failures:** ${errorCount}
            **Threshold:** 5
            **Generated:** ${new Date().toISOString()}

            ${summary}

            ---

            ### ðŸ“¦ Download Full Report

            [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Download the error report from the Artifacts section of the workflow run above.

            ### ðŸ› ï¸ Quick Actions

            \`\`\`bash
            # Generate fresh report locally
            bash scripts/github/collect-workflow-errors.sh

            # View most recent report
            ls -t workflow-errors/ERROR-REPORT-*.md | head -1 | xargs cat

            # Monitor in real-time
            bash scripts/github/monitor-workflows.sh 30
            \`\`\`

            ---
            ðŸ¤– *Auto-generated by [Always Generate Error Report](https://github.com/${{ github.repository }}/actions/workflows/always-generate-error-report.yml)*`,
              labels: ['ci/cd', 'bug', 'high-priority']
            });

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“Š Error Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find most recent error report (no symlink, use actual files)
          LATEST_REPORT=$(ls -t workflow-errors/ERROR-REPORT-*.md 2>/dev/null | head -1)

          if [ -n "$LATEST_REPORT" ] && [ -f "$LATEST_REPORT" ]; then
            ERROR_COUNT=$(grep -c "### ðŸ”´" "$LATEST_REPORT" || echo "0")
            REPORT_NAME=$(basename "$LATEST_REPORT")

            echo "- **Report Generated:** âœ… Yes" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Errors:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Report File:** \`workflow-errors/$REPORT_NAME\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Download the full report from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Report Generated:** âŒ No failures found" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** âœ… All workflows passing!" >> $GITHUB_STEP_SUMMARY
          fi
