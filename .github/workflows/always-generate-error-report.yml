name: Always Generate Error Report

on:
  # Executa apÃ³s QUALQUER workflow completar
  workflow_run:
    workflows:
      - "Code Quality"
      - "Automated Tests"
      - "Bundle Size Check"
      - "Docker Build & Security"
      - "Security Audit"
      - "Documentation Validation"
      - "Environment Validation"
      - "Infrastructure Health Check"
    types:
      - completed

  # TambÃ©m permite execuÃ§Ã£o manual
  workflow_dispatch:

  # Executa em schedule (diÃ¡rio Ã s 9h UTC)
  schedule:
    - cron: '0 9 * * *'

# PermissÃµes necessÃ¡rias para commit e push
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  generate-error-report:
    runs-on: ubuntu-latest
    # Executa SEMPRE, independente de sucesso ou falha

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/services.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh jq -y

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Generate Comprehensive Error Report
        id: generate_report
        run: |
          chmod +x scripts/github/collect-workflow-errors.sh

          # Gerar relatÃ³rio (Ãºltimas 20 falhas)
          bash scripts/github/collect-workflow-errors.sh 20

          # Verificar se hÃ¡ relatÃ³rio
          if [ -f workflow-errors/LATEST.md ]; then
            echo "report_generated=true" >> $GITHUB_OUTPUT

            # Contar erros
            ERROR_COUNT=$(grep -c "### ðŸ”´" workflow-errors/LATEST.md || echo "0")
            echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          else
            echo "report_generated=false" >> $GITHUB_OUTPUT
            echo "error_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit Error Report to Repository
        if: steps.generate_report.outputs.report_generated == 'true'
        run: |
          # Configurar git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Adicionar apenas os arquivos de relatÃ³rio
          git add workflow-errors/ERROR-REPORT-*.md
          git add workflow-errors/LATEST.md

          # Commit (apenas se houver mudanÃ§as)
          if git diff --staged --quiet; then
            echo "Nenhuma mudanÃ§a para commitar"
          else
            git commit -m "chore: add error report - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… RelatÃ³rio commitado no repositÃ³rio"
          fi

      - name: Upload Error Report as Artifact (Backup)
        if: steps.generate_report.outputs.report_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-error-report-${{ github.run_number }}
          path: workflow-errors/*.md
          retention-days: 90

      - name: Create Issue if Too Many Errors
        if: steps.generate_report.outputs.error_count > 5
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorCount = ${{ steps.generate_report.outputs.error_count }};

            // Ler resumo do relatÃ³rio
            const reportContent = fs.readFileSync('workflow-errors/LATEST.md', 'utf8');
            const summaryMatch = reportContent.match(/## ðŸ“Š Resumo Executivo([\s\S]*?)(?=\n---|\n##|$)/);
            const summary = summaryMatch ? summaryMatch[0] : '';

            // Criar issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Alert: ${errorCount} workflow failures detected`,
              body: `## âš ï¸ Multiple Workflow Failures Detected

            **Total Failures:** ${errorCount}
            **Threshold:** 5
            **Generated:** ${new Date().toISOString()}

            ${summary}

            ---

            ### ðŸ“¦ Download Full Report

            [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### ðŸ› ï¸ Quick Actions

            \`\`\`bash
            # Generate fresh report locally
            bash scripts/github/collect-workflow-errors.sh

            # View latest
            cat workflow-errors/LATEST.md

            # Monitor in real-time
            bash scripts/github/monitor-workflows.sh 30
            \`\`\`

            ---
            ðŸ¤– *Auto-generated by [Always Generate Error Report](https://github.com/${{ github.repository }}/actions/workflows/always-generate-error-report.yml)*`,
              labels: ['ci/cd', 'bug', 'high-priority']
            });

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“Š Error Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f workflow-errors/LATEST.md ]; then
            ERROR_COUNT=$(grep -c "### ðŸ”´" workflow-errors/LATEST.md || echo "0")

            echo "- **Report Generated:** âœ… Yes" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Errors:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Report File:** \`workflow-errors/LATEST.md\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Download the full report from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Report Generated:** âŒ No failures found" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** âœ… All workflows passing!" >> $GITHUB_STEP_SUMMARY
          fi
