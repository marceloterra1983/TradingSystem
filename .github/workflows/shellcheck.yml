name: Shell Script Validation

on:
  push:
    paths:
      - '**/*.sh'
      - '.shellcheckrc'
      - '.github/workflows/shellcheck.yml'
  pull_request:
    paths:
      - '**/*.sh'
      - '.shellcheckrc'
      - '.github/workflows/shellcheck.yml'

jobs:
  freeze_guard:
    name: Freeze Guard
    runs-on: ubuntu-latest
    outputs:
      active: ${{ steps.detect.outputs.active }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - id: detect
        name: Detect freeze status
        shell: bash
        run: |
          if [ ! -f FREEZE-NOTICE.md ]; then
            echo "active=false" >> "$GITHUB_OUTPUT"
            echo "No FREEZE-NOTICE.md file found - proceeding normally"
            exit 0
          fi
          status_line=$(grep -i '^\*\*Status' FREEZE-NOTICE.md 2>/dev/null | head -n1 | tr -d '\r' || echo "")
          if echo "$status_line" | grep -qiE 'ACTIVE|IN PROGRESS|ONGOING|PHASE'; then
            echo "active=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ”’ Freeze active: $status_line"
          else
            echo "active=false" >> "$GITHUB_OUTPUT"
            echo "âœ… No active freeze detected"
          fi

  workflow-lint:
    name: Workflow Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node workspace
        uses: ./.github/actions/setup-node
        with:
          node-version: '20'
          cache-dependency-path: package-lock.json

      - name: Run workflow lint
        run: npm run ci:lint-workflows

  shellcheck:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    needs: [freeze_guard, workflow-lint]
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Validate scripts
        run: |
          bash scripts/validate.sh
      
      - name: Check script permissions
        run: |
          # Check if all .sh files are executable
          non_executable=$(find scripts -name "*.sh" -type f ! -executable)
          if [ -n "$non_executable" ]; then
            echo "The following scripts are not executable:"
            echo "$non_executable"
            exit 1
          fi
