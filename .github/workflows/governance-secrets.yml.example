# ============================================
# Governance - Secrets & Environment Variables Validation
# ============================================
# 
# Workflow de valida√ß√£o de pol√≠ticas de governan√ßa de segredos
# Implementa requisitos de POL-0002 e STD-010
#
# TRIGGERS:
# - Push para branches principais
# - Pull requests
# - Scheduled (weekly scan)
#
# JOBS:
# 1. validate-policies - Valida front-matter e expira√ß√£o de pol√≠ticas
# 2. validate-envs - Verifica sincroniza√ß√£o .env ‚Üî .env.example
# 3. scan-secrets - TruffleHog scan para detectar segredos
#
# REQUISITOS:
# - Node.js 18+ instalado
# - Docker dispon√≠vel (para TruffleHog)
# - Secrets configurados: AGE_SECRET_KEY (para descriptografia SOPS)
#
# USO:
# 1. Renomear para governance-secrets.yml (remover .example)
# 2. Configurar GitHub Secrets necess√°rios
# 3. Ajustar triggers conforme necess√°rio
#
# ============================================

name: 'üîê Governance - Secrets Validation'

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'governance/**'
      - '.env.example'
      - 'governance/registry/templates/**'
      - 'governance/automation/**'
      - '.github/workflows/governance-secrets.yml'
  
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'governance/**'
      - '.env.example'
      - 'governance/registry/templates/**'
  
  # Weekly scan (every Monday at 9 AM)
  schedule:
    - cron: '0 9 * * 1'
  
  workflow_dispatch:
    inputs:
      skip_secrets_scan:
        description: 'Skip TruffleHog scan (faster for testing)'
        required: false
        default: 'false'

# Prevent concurrent runs
concurrency:
  group: governance-secrets-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  POLICY_ID: 'POL-0002'
  STANDARD_ID: 'STD-010'

jobs:
  # ============================================
  # JOB 1: Validate Policies
  # ============================================
  validate-policies:
    name: 'üìã Validate Policies & Standards'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git-based checks
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          # Install js-yaml if not in package.json
          npm list js-yaml || npm install --no-save js-yaml
      
      - name: Run policy validation
        id: validate
        run: |
          echo "::group::Validating policies frontmatter"
          npm run governance:validate-policies
          echo "::endgroup::"
      
      - name: Check policy expiration
        if: always()
        run: |
          # Extract expiration data from audit file
          AUDIT_FILE=$(ls -t governance/evidence/audits/*.json 2>/dev/null | head -1 || echo "")
          
          if [ -n "$AUDIT_FILE" ]; then
            echo "::group::Policy Expiration Report"
            cat "$AUDIT_FILE" | jq '.results'
            echo "::endgroup::"
          fi
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-validation-results
          path: governance/evidence/audits/
          retention-days: 30
      
      - name: Comment on PR (if failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Governance Policy Validation Failed
            
            The policy validation check has failed. Please review:
            
            - **Policy ID:** ${process.env.POLICY_ID}
            - **Standard ID:** ${process.env.STANDARD_ID}
            
            **Common issues:**
            - Missing or invalid front-matter YAML
            - Policy expired (lastReviewed + reviewCycleDays < today)
            - Owner field empty or "TBD"
            
            **Action required:**
            1. Review failed policies in workflow logs
            2. Update \`lastReviewed\` date if policy was reviewed
            3. Fix front-matter errors
            4. Re-run validation: \`npm run governance:validate-policies\`
            
            See: [governance/policies/secrets-env-policy.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/governance/policies/secrets-env-policy.md)`
            })

  # ============================================
  # JOB 2: Validate Environment Variables
  # ============================================
  validate-envs:
    name: 'üîë Validate .env Templates'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for tracked .env files
        id: check_tracked
        run: |
          echo "::group::Checking for tracked .env files"
          
          # Fail if .env files (non-example) are tracked
          TRACKED_ENVS=$(git ls-files | grep -E '\.env$|\.env\.local$' | grep -v '\.example$' || true)
          
          if [ -n "$TRACKED_ENVS" ]; then
            echo "::error::Tracked .env files detected!"
            echo "$TRACKED_ENVS" | while read file; do
              echo "::error file=$file::This .env file should NOT be committed"
            done
            exit 1
          fi
          
          echo "‚úÖ No tracked .env files found"
          echo "::endgroup::"
      
      - name: Validate .env ‚Üî .env.example sync
        run: |
          echo "::group::Validating .env template sync"
          npm run governance:validate-envs
          echo "::endgroup::"
      
      - name: Check for secrets in .env.example
        run: |
          echo "::group::Checking for real values in .env.example"
          
          # Patterns that indicate real secrets (not placeholders)
          SUSPICIOUS=$(grep -rE 'password=[\w\d]{8,}|token=[A-Za-z0-9]{20,}|key=sk-[A-Za-z0-9]{32,}' \
            governance/registry/templates/ .env.example 2>/dev/null || true)
          
          if [ -n "$SUSPICIOUS" ]; then
            echo "::warning::Suspicious values found in .env.example:"
            echo "$SUSPICIOUS"
            echo "::warning::Ensure these are placeholders (e.g., <YOUR_PASSWORD>), not real values"
          else
            echo "‚úÖ No suspicious values in templates"
          fi
          
          echo "::endgroup::"
      
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: env-validation-results
          path: governance/evidence/audits/secrets-audit-*.json
          retention-days: 30

  # ============================================
  # JOB 3: Scan Secrets with TruffleHog
  # ============================================
  scan-secrets:
    name: 'üîç Scan for Secrets (TruffleHog)'
    runs-on: ubuntu-latest
    
    # Skip if workflow dispatch with skip_secrets_scan=true
    if: github.event.inputs.skip_secrets_scan != 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for TruffleHog
      
      - name: Run TruffleHog scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --no-update --fail
      
      - name: Setup Node.js (for audit generation)
        if: always()
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        if: always()
        run: npm ci
      
      - name: Generate scan audit
        if: always()
        run: |
          echo "::group::Generating secrets scan audit"
          npm run governance:scan-secrets || true
          echo "::endgroup::"
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-results
          path: |
            governance/evidence/audits/secrets-scan-*.json
            governance/evidence/audits/trufflehog-*.json
          retention-days: 90  # Keep scan results longer
      
      - name: Fail if verified secrets found
        if: steps.trufflehog.outcome == 'failure'
        run: |
          echo "::error::‚ùå CRITICAL: Verified secrets detected in repository!"
          echo "::error::Review scan results in artifacts"
          echo "::error::Action required:"
          echo "::error::  1. REVOKE all exposed secrets immediately"
          echo "::error::  2. Remove from Git history: git filter-repo"
          echo "::error::  3. Follow SOP: governance/controls/secrets-rotation-sop.md"
          echo "::error::  4. Register incident: governance/evidence/audits/incident-*.json"
          exit 1

  # ============================================
  # JOB 4: Aggregate Results & Report
  # ============================================
  report-results:
    name: 'üìä Aggregate & Report'
    runs-on: ubuntu-latest
    needs: [validate-policies, validate-envs, scan-secrets]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Generate summary report
        run: |
          echo "## üîê Governance Secrets Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Policies | ${{ needs.validate-policies.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate .env | ${{ needs.validate-envs.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Secrets | ${{ needs.scan-secrets.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.validate-policies.result }}" == "success" ]] && \
             [[ "${{ needs.validate-envs.result }}" == "success" ]] && \
             [[ "${{ needs.scan-secrets.result }}" == "success" ]]; then
            echo "### ‚úÖ Overall Status: PASS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All governance checks passed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Overall Status: FAIL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action required:** Review failed jobs and fix issues before merging." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Resources:**" >> $GITHUB_STEP_SUMMARY
            echo "- [POL-0002 - Secrets Policy](governance/policies/secrets-env-policy.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [STD-010 - Secrets Standard](governance/standards/secrets-standard.md)" >> $GITHUB_STEP_SUMMARY
            echo "- [SOP-SEC-001 - Rotation SOP](governance/controls/secrets-rotation-sop.md)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify on failure (optional)
        if: failure()
        run: |
          echo "::warning::Governance validation failed. Review artifacts and logs."
          # Add notification logic here (Slack, email, etc.)

# ============================================
# Optional: Decrypt SOPS Secrets (for testing)
# ============================================
# Uncomment if you need to test decryption in CI
#
#  decrypt-secrets:
#    name: 'üîì Decrypt SOPS Secrets (Test)'
#    runs-on: ubuntu-latest
#    environment: staging  # Use GitHub Environments for secrets
#    
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v4
#      
#      - name: Install age
#        run: |
#          curl -LO https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz
#          tar xf age-v1.1.1-linux-amd64.tar.gz
#          sudo mv age/age /usr/local/bin/
#          sudo mv age/age-keygen /usr/local/bin/
#      
#      - name: Decrypt secrets
#        env:
#          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
#        run: |
#          # NEVER echo AGE_SECRET_KEY or decrypted content!
#          echo "$AGE_SECRET_KEY" | age -d -i /dev/stdin config/secrets.enc.yaml > config/secrets.yaml
#          
#          # Validate decryption worked (without exposing content)
#          if [ -s config/secrets.yaml ]; then
#            echo "‚úÖ Secrets decrypted successfully"
#          else
#            echo "::error::Failed to decrypt secrets"
#            exit 1
#          fi
#      
#      - name: Cleanup (CRITICAL)
#        if: always()
#        run: |
#          # ALWAYS shred decrypted files
#          shred -u config/secrets.yaml || rm -f config/secrets.yaml

