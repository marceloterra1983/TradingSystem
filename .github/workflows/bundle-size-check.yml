name: Bundle Size Check

# Enhanced bundle size monitoring with trend tracking and regression detection
# Part of: Phase 1.4 - Performance Improvements (Improvement Plan v1.0)
# Updated: 2025-11-11

on:
  schedule:
    - cron: '0 3 * * 1' # Every Monday at 3 AM UTC (weekly baseline)
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/dashboard/**'
      - '.github/workflows/bundle-size-check.yml'
  push:
    branches: [main]
    paths:
      - 'frontend/dashboard/**'
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  pull-requests: write # For PR comments
  issues: write # For PR comments

jobs:
  check-bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/dashboard/package-lock.json'

      - name: Install root dependencies (agents tooling)
        run: npm ci

      - name: Install dependencies
        working-directory: frontend/dashboard
        run: npm ci

      - name: Build production bundle
        working-directory: frontend/dashboard
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check bundle sizes against budgets
        id: bundle-check
        working-directory: frontend/dashboard
        run: |
          echo "Running bundle size check..."
          npm run check:bundle:size:strict > bundle-check-output.txt 2>&1 || echo "CHECK_FAILED=true" >> $GITHUB_ENV
          cat bundle-check-output.txt

          # Extract total bundle size from dist directory
          TOTAL_SIZE_BYTES=$(du -sb dist/assets | awk '{print $1}')
          TOTAL_SIZE_KB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE_BYTES / 1024}")
          TOTAL_SIZE_MB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE_BYTES / 1024 / 1024}")

          echo "total_bytes=$TOTAL_SIZE_BYTES" >> $GITHUB_OUTPUT
          echo "total_kb=$TOTAL_SIZE_KB" >> $GITHUB_OUTPUT
          echo "total_mb=$TOTAL_SIZE_MB" >> $GITHUB_OUTPUT
          echo "TOTAL_SIZE=${TOTAL_SIZE_KB}KB" >> $GITHUB_ENV

          # Count chunks
          JS_CHUNKS=$(find dist/assets -name "*.js" -type f | wc -l)
          CSS_FILES=$(find dist/assets -name "*.css" -type f | wc -l)

          echo "js_chunks=$JS_CHUNKS" >> $GITHUB_OUTPUT
          echo "css_files=$CSS_FILES" >> $GITHUB_OUTPUT

          # Get largest chunks (gzipped)
          echo "### üì¶ Largest Chunks (Top 5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          find dist/assets -name "*.js.gz" -type f -exec ls -lh {} \; | \
            sort -rh -k5 | head -5 | \
            awk '{print $9, $5}' | \
            sed 's|dist/assets/||g' | \
            awk '{printf "| `%s` | %s |\n", $1, $2}' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Size:** ${TOTAL_SIZE_KB}KB (${TOTAL_SIZE_MB}MB)" >> $GITHUB_STEP_SUMMARY
          echo "**JS Chunks:** $JS_CHUNKS | **CSS Files:** $CSS_FILES" >> $GITHUB_STEP_SUMMARY

          # Check if passed
          if grep -q "‚úì Bundle size check passed" bundle-check-output.txt; then
            echo "STATUS=‚úÖ PASSED" >> $GITHUB_ENV
            echo "CHECK_RESULT=success" >> $GITHUB_ENV
          else
            echo "STATUS=‚ùå FAILED" >> $GITHUB_ENV
            echo "CHECK_RESULT=failure" >> $GITHUB_ENV
          fi

      - name: Generate bundle analysis report
        if: always()
        working-directory: frontend/dashboard
        run: |
          # Create detailed report
          cat > bundle-report.md << 'EOF'
          # Bundle Size Report

          **Status:** ${{ env.STATUS }}
          **Total Size:** ${{ env.TOTAL_SIZE }}

          ## Detailed Results

          \`\`\`
          $(cat bundle-check-output.txt)
          \`\`\`

          ## Bundle Composition

          ### JavaScript Chunks (Gzipped)

          \`\`\`
          $(find dist/assets -name "*.js.gz" -type f -exec ls -lh {} \; | sort -rh -k5 | head -20 | awk '{print $9, $5}' | sed 's|dist/assets/||g')
          \`\`\`

          ### CSS Files (Gzipped)

          \`\`\`
          $(find dist/assets -name "*.css.gz" -type f -exec ls -lh {} \; | awk '{print $9, $5}' | sed 's|dist/assets/||g')
          \`\`\`

          ---

          üìä **Budget Status:** See [bundle-size-budgets.json](../blob/main/frontend/dashboard/scripts/bundle-size-budgets.json)
          üìö **Documentation:** See [BUNDLE-OPTIMIZATION.md](../blob/main/frontend/dashboard/BUNDLE-OPTIMIZATION.md)
          EOF

          cat bundle-report.md

      - name: Upload bundle analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            frontend/dashboard/dist/stats.html
            frontend/dashboard/bundle-report.md
            frontend/dashboard/bundle-check-output.txt
          retention-days: 30

      - name: Compare with base branch (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Checkout base branch
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }} -- frontend/dashboard/package-lock.json

          # Build base branch
          cd frontend/dashboard
          npm ci
          npm run build > /dev/null 2>&1 || true

          # Get base bundle size
          BASE_SIZE=$(du -sb dist | awk '{print $1}')

          # Checkout PR branch
          git checkout ${{ github.sha }} -- .
          npm ci
          npm run build > /dev/null 2>&1 || true

          # Get PR bundle size
          PR_SIZE=$(du -sb dist | awk '{print $1}')

          # Calculate difference
          DIFF=$((PR_SIZE - BASE_SIZE))
          DIFF_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($DIFF / $BASE_SIZE) * 100}")

          echo "BASE_SIZE=$BASE_SIZE" >> $GITHUB_ENV
          echo "PR_SIZE=$PR_SIZE" >> $GITHUB_ENV
          echo "DIFF=$DIFF" >> $GITHUB_ENV
          echo "DIFF_PERCENT=$DIFF_PERCENT" >> $GITHUB_ENV

          # Create comparison report
          cat > bundle-comparison.md << EOF
          ## Bundle Size Comparison

          | Metric | Base (${{ github.base_ref }}) | PR | Difference |
          |--------|-------------------------------|-----|-----------|
          | **Total Size** | $(numfmt --to=iec $BASE_SIZE) | $(numfmt --to=iec $PR_SIZE) | $DIFF_PERCENT% |

          $(if [ $DIFF -gt 0 ]; then echo "‚ö†Ô∏è **Warning:** Bundle size increased by $(numfmt --to=iec $DIFF)"; else echo "‚úÖ **Good:** Bundle size decreased by $(numfmt --to=iec ${DIFF#-})"; fi)
          EOF

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Get metrics from previous step
            const totalKB = '${{ steps.bundle-check.outputs.total_kb }}';
            const totalMB = '${{ steps.bundle-check.outputs.total_mb }}';
            const jsChunks = '${{ steps.bundle-check.outputs.js_chunks }}';
            const cssFiles = '${{ steps.bundle-check.outputs.css_files }}';
            const status = '${{ env.STATUS }}';
            const checkResult = '${{ env.CHECK_RESULT }}';

            // Read bundle report
            let bundleReport = '';
            try {
              bundleReport = fs.readFileSync('frontend/dashboard/bundle-report.md', 'utf8');
            } catch (e) {
              bundleReport = 'Bundle report not available';
            }

            // Read comparison report
            let comparisonReport = '';
            try {
              comparisonReport = fs.readFileSync('frontend/dashboard/bundle-comparison.md', 'utf8');
            } catch (e) {
              comparisonReport = '';
            }

            // Determine emoji based on status
            let emoji = '‚úÖ';
            if (checkResult === 'failure') {
              emoji = '‚ùå';
            } else if (comparisonReport.includes('increased')) {
              emoji = '‚ö†Ô∏è';
            }

            const comment = `### ${emoji} Bundle Size Check

**Status:** ${status}

| Metric | Value |
|--------|-------|
| **Total Size** | ${totalKB}KB (${totalMB}MB) |
| **JS Chunks** | ${jsChunks} |
| **CSS Files** | ${cssFiles} |

${comparisonReport}

${checkResult === 'failure' ? `
### ‚ö†Ô∏è Bundle Size Budget Exceeded

One or more chunks exceed their size budgets. Please optimize before merging:

1. Review the detailed report below
2. Consider code splitting for large chunks
3. Use dynamic imports for routes
4. Remove unused dependencies
5. Check bundle visualization in artifacts

` : ''}

${checkResult === 'success' && comparisonReport.includes('increased') ? `
### üìä Bundle Size Increased

While still within budget, the bundle size has increased. Consider:

- Reviewing the added dependencies
- Checking if lazy loading can be applied
- Verifying tree-shaking is working correctly

` : ''}

${checkResult === 'success' && comparisonReport.includes('decreased') ? `
### üéâ Great Job!

Bundle size decreased! This helps improve:
- ‚úÖ Initial load time
- ‚úÖ Parse/compile time
- ‚úÖ Network transfer cost

` : ''}

<details>
<summary>üìã View Detailed Bundle Report</summary>

${bundleReport}

</details>

<details>
<summary>üì¶ View Bundle Visualization</summary>

Download the \`bundle-analysis\` artifact from this workflow run to view:
- **stats.html** - Interactive bundle visualization
- **bundle-report.md** - Detailed text report
- **bundle-check-output.txt** - Raw check output

[View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

</details>

---
*Automated bundle size check by [Bundle Size Check workflow](https://github.com/${{ github.repository }}/actions/workflows/bundle-size-check.yml)*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Bundle Size Check')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail if bundle size exceeded
        if: env.CHECK_RESULT == 'failure'
        run: |
          echo "‚ùå Bundle size check failed!"
          echo "One or more chunks exceed their size budgets."
          echo ""
          echo "See the bundle report above for details."
          echo "Update the budget in scripts/bundle-size-budgets.json if this is intentional."
          exit 1

      - name: Success summary
        if: env.CHECK_RESULT == 'success'
        run: |
          echo "‚úÖ Bundle size check passed!"
          echo "All chunks are within their size budgets."
          echo "Total bundle size: ${{ env.TOTAL_SIZE }}"
