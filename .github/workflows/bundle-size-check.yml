name: Bundle Size Check

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/dashboard/**'
      - '.github/workflows/bundle-size-check.yml'
  push:
    branches: [main]
    paths:
      - 'frontend/dashboard/**'

jobs:
  check-bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/dashboard/package-lock.json'

      - name: Install dependencies
        working-directory: frontend/dashboard
        run: npm ci

      - name: Build production bundle
        working-directory: frontend/dashboard
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check bundle sizes against budgets
        id: bundle-check
        working-directory: frontend/dashboard
        run: |
          echo "Running bundle size check..."
          npm run check:bundle:size:strict > bundle-check-output.txt 2>&1 || echo "CHECK_FAILED=true" >> $GITHUB_ENV
          cat bundle-check-output.txt

          # Extract total bundle size
          TOTAL_SIZE=$(grep "Total bundle size:" bundle-check-output.txt | grep -oP '\d+\.\d+KB' || echo "N/A")
          echo "TOTAL_SIZE=$TOTAL_SIZE" >> $GITHUB_ENV

          # Check if passed
          if grep -q "‚úì Bundle size check passed" bundle-check-output.txt; then
            echo "STATUS=‚úÖ PASSED" >> $GITHUB_ENV
            echo "CHECK_RESULT=success" >> $GITHUB_ENV
          else
            echo "STATUS=‚ùå FAILED" >> $GITHUB_ENV
            echo "CHECK_RESULT=failure" >> $GITHUB_ENV
          fi

      - name: Generate bundle analysis report
        if: always()
        working-directory: frontend/dashboard
        run: |
          # Create detailed report
          cat > bundle-report.md << 'EOF'
          # Bundle Size Report

          **Status:** ${{ env.STATUS }}
          **Total Size:** ${{ env.TOTAL_SIZE }}

          ## Detailed Results

          \`\`\`
          $(cat bundle-check-output.txt)
          \`\`\`

          ## Bundle Composition

          ### JavaScript Chunks (Gzipped)

          \`\`\`
          $(find dist/assets -name "*.js.gz" -type f -exec ls -lh {} \; | sort -rh -k5 | head -20 | awk '{print $9, $5}' | sed 's|dist/assets/||g')
          \`\`\`

          ### CSS Files (Gzipped)

          \`\`\`
          $(find dist/assets -name "*.css.gz" -type f -exec ls -lh {} \; | awk '{print $9, $5}' | sed 's|dist/assets/||g')
          \`\`\`

          ---

          üìä **Budget Status:** See [bundle-size-budgets.json](../blob/main/frontend/dashboard/scripts/bundle-size-budgets.json)
          üìö **Documentation:** See [BUNDLE-OPTIMIZATION.md](../blob/main/frontend/dashboard/BUNDLE-OPTIMIZATION.md)
          EOF

          cat bundle-report.md

      - name: Upload bundle analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            frontend/dashboard/dist/stats.html
            frontend/dashboard/bundle-report.md
            frontend/dashboard/bundle-check-output.txt
          retention-days: 30

      - name: Compare with base branch (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Checkout base branch
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }} -- frontend/dashboard/package-lock.json

          # Build base branch
          cd frontend/dashboard
          npm ci
          npm run build > /dev/null 2>&1 || true

          # Get base bundle size
          BASE_SIZE=$(du -sb dist | awk '{print $1}')

          # Checkout PR branch
          git checkout ${{ github.sha }} -- .
          npm ci
          npm run build > /dev/null 2>&1 || true

          # Get PR bundle size
          PR_SIZE=$(du -sb dist | awk '{print $1}')

          # Calculate difference
          DIFF=$((PR_SIZE - BASE_SIZE))
          DIFF_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($DIFF / $BASE_SIZE) * 100}")

          echo "BASE_SIZE=$BASE_SIZE" >> $GITHUB_ENV
          echo "PR_SIZE=$PR_SIZE" >> $GITHUB_ENV
          echo "DIFF=$DIFF" >> $GITHUB_ENV
          echo "DIFF_PERCENT=$DIFF_PERCENT" >> $GITHUB_ENV

          # Create comparison report
          cat > bundle-comparison.md << EOF
          ## Bundle Size Comparison

          | Metric | Base (${{ github.base_ref }}) | PR | Difference |
          |--------|-------------------------------|-----|-----------|
          | **Total Size** | $(numfmt --to=iec $BASE_SIZE) | $(numfmt --to=iec $PR_SIZE) | $DIFF_PERCENT% |

          $(if [ $DIFF -gt 0 ]; then echo "‚ö†Ô∏è **Warning:** Bundle size increased by $(numfmt --to=iec $DIFF)"; else echo "‚úÖ **Good:** Bundle size decreased by $(numfmt --to=iec ${DIFF#-})"; fi)
          EOF

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read bundle report
            let bundleReport = '';
            try {
              bundleReport = fs.readFileSync('frontend/dashboard/bundle-report.md', 'utf8');
            } catch (e) {
              bundleReport = 'Bundle report not available';
            }

            // Read comparison report
            let comparisonReport = '';
            try {
              comparisonReport = fs.readFileSync('frontend/dashboard/bundle-comparison.md', 'utf8');
            } catch (e) {
              comparisonReport = '';
            }

            const comment = `
            ${comparisonReport}

            ${bundleReport}

            <details>
            <summary>üì¶ View bundle visualization</summary>

            Download the \`bundle-analysis\` artifact from this workflow run to view the interactive bundle visualization (\`stats.html\`).

            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Bundle Size Report')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail if bundle size exceeded
        if: env.CHECK_RESULT == 'failure'
        run: |
          echo "‚ùå Bundle size check failed!"
          echo "One or more chunks exceed their size budgets."
          echo ""
          echo "See the bundle report above for details."
          echo "Update the budget in scripts/bundle-size-budgets.json if this is intentional."
          exit 1

      - name: Success summary
        if: env.CHECK_RESULT == 'success'
        run: |
          echo "‚úÖ Bundle size check passed!"
          echo "All chunks are within their size budgets."
          echo "Total bundle size: ${{ env.TOTAL_SIZE }}"
