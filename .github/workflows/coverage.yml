name: Test Coverage Report

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'apps/**'
      - 'tools/llamaindex/**'
      - '.github/workflows/coverage.yml'
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'apps/**'
      - 'tools/llamaindex/**'
  workflow_dispatch:

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  coverage-frontend:
    name: Frontend Coverage (Dashboard)
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/dashboard/package-lock.json'

      - name: Install dependencies
        working-directory: frontend/dashboard
        run: npm ci

      - name: Run tests with coverage
        working-directory: frontend/dashboard
        run: npm run test:coverage
        continue-on-error: false

      - name: Generate coverage summary
        id: coverage_summary
        working-directory: frontend/dashboard
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            # Extract coverage percentages
            BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)

            echo "branches=$BRANCHES" >> "$GITHUB_OUTPUT"
            echo "functions=$FUNCTIONS" >> "$GITHUB_OUTPUT"
            echo "lines=$LINES" >> "$GITHUB_OUTPUT"
            echo "statements=$STATEMENTS" >> "$GITHUB_OUTPUT"

            echo "### üìä Frontend Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${LINES}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Coverage summary not found"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success() && env.CODECOV_TOKEN != ''
        with:
          files: ./frontend/dashboard/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ env.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage-report
          path: frontend/dashboard/coverage/
          retention-days: 30

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coveragePath = 'frontend/dashboard/coverage/coverage-summary.json';

            if (!fs.existsSync(coveragePath)) {
              console.log('Coverage summary not found');
              return;
            }

            const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
            const total = coverage.total;

            const comment = `### üìä Frontend Test Coverage Report

            | Metric | Coverage | Threshold |
            |--------|----------|-----------|
            | Branches | ${total.branches.pct}% | 50% |
            | Functions | ${total.functions.pct}% | 30% |
            | Lines | ${total.lines.pct}% | 30% |
            | Statements | ${total.statements.pct}% | 30% |

            **Status:** ${total.lines.pct >= 30 && total.branches.pct >= 50 ? '‚úÖ Passing' : '‚ö†Ô∏è Below threshold'}

            <details>
            <summary>üìà Coverage Details</summary>

            - **Covered Lines:** ${total.lines.covered} / ${total.lines.total}
            - **Covered Branches:** ${total.branches.covered} / ${total.branches.total}
            - **Covered Functions:** ${total.functions.covered} / ${total.functions.total}
            - **Covered Statements:** ${total.statements.covered} / ${total.statements.total}

            </details>

            [View Full Coverage Report](https://app.codecov.io/gh/${{ github.repository }}/pull/${{ github.event.pull_request.number }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  coverage-backend-workspace:
    name: Backend Coverage (Workspace API)
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    services:
      timescaledb:
        image: timescale/timescaledb:latest-pg16
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: workspace_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'backend/api/workspace/package-lock.json'

      - name: Install dependencies
        working-directory: backend/api/workspace
        run: npm ci

      - name: Run tests with coverage
        working-directory: backend/api/workspace
        env:
          DATABASE_URL: postgresql://postgres:test_password@localhost:5432/workspace_test
          NODE_ENV: test
        run: npm run test -- --coverage || echo "‚ö†Ô∏è Tests not fully configured yet"
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success() && env.CODECOV_TOKEN != ''
        with:
          files: ./backend/api/workspace/coverage/coverage-final.json
          flags: backend-workspace
          name: workspace-api-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ env.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workspace-coverage-report
          path: backend/api/workspace/coverage/
          retention-days: 30

  coverage-backend-tp-capital:
    name: Backend Coverage (TP Capital)
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'apps/tp-capital/package-lock.json'

      - name: Install dependencies
        working-directory: apps/tp-capital
        run: npm ci

      - name: Run tests with coverage
        working-directory: apps/tp-capital
        env:
          NODE_ENV: test
        run: npm run test -- --coverage || echo "‚ö†Ô∏è Tests not fully configured yet"
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success() && env.CODECOV_TOKEN != ''
        with:
          files: ./apps/tp-capital/coverage/coverage-final.json
          flags: backend-tp-capital
          name: tp-capital-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ env.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tp-capital-coverage-report
          path: apps/tp-capital/coverage/
          retention-days: 30

  coverage-python-rag:
    name: Python Coverage (RAG System)
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tools/llamaindex/requirements.txt'

      - name: Install dependencies
        working-directory: tools/llamaindex
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run Python tests with coverage
        working-directory: tools/llamaindex
        run: pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term || echo "‚ö†Ô∏è Tests not fully configured yet"
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success() && env.CODECOV_TOKEN != ''
        with:
          files: ./tools/llamaindex/coverage.xml
          flags: python-rag
          name: rag-system-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ env.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rag-coverage-report
          path: tools/llamaindex/htmlcov/
          retention-days: 30

  coverage-summary:
    name: Generate Combined Coverage Summary
    runs-on: ubuntu-latest
    needs: [coverage-frontend, coverage-backend-workspace, coverage-backend-tp-capital, coverage-python-rag]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports/

      - name: Generate combined summary
        run: |
          echo "# üìä Combined Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage Reports by Component" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Frontend
          if [ -f coverage-reports/frontend-coverage-report/coverage-summary.json ]; then
            FRONTEND_COV=$(jq '.total.lines.pct' coverage-reports/frontend-coverage-report/coverage-summary.json)
            echo "- **Frontend (Dashboard):** ${FRONTEND_COV}%" >> $GITHUB_STEP_SUMMARY
          fi

          # Workspace API
          if [ -f coverage-reports/workspace-coverage-report/coverage-summary.json ]; then
            WORKSPACE_COV=$(jq '.total.lines.pct' coverage-reports/workspace-coverage-report/coverage-summary.json)
            echo "- **Backend (Workspace API):** ${WORKSPACE_COV}%" >> $GITHUB_STEP_SUMMARY
          fi

          # TP Capital
          if [ -f coverage-reports/tp-capital-coverage-report/coverage-summary.json ]; then
            TPCAPITAL_COV=$(jq '.total.lines.pct' coverage-reports/tp-capital-coverage-report/coverage-summary.json)
            echo "- **Backend (TP Capital):** ${TPCAPITAL_COV}%" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìà Progress Tracking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Phase 1 (Current) | 30% lines, 50% branches | ‚è≥ In Progress |" >> $GITHUB_STEP_SUMMARY
          echo "| Phase 2 | 75% global coverage | üéØ Next |" >> $GITHUB_STEP_SUMMARY
          echo "| Final Target | 85% critical modules | üèÅ Future |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View detailed coverage on Codecov](https://app.codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
