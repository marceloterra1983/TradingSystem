name: CI Core Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  lint_and_typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            package-lock.json
            frontend/dashboard/package-lock.json
            docs/package-lock.json

      - name: Install root dependencies
        run: npm ci

      - name: Install dashboard dependencies
        working-directory: frontend/dashboard
        run: npm ci

      - name: Install docs dependencies
        working-directory: docs
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Type check workspaces
        run: npm run type-check

  security_config_validation:
    name: Security & Configuration Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install tooling
        run: npm ci

      - name: Validate Port Registry
        run: npm run ports:validate

      - name: Scan for Hardcoded URLs (CRITICAL)
        run: |
          echo "üîé Scanning for hardcoded localhost URLs..."
          npm run ports:scan-hardcoded || {
            echo ""
            echo "‚ùå POLICY VIOLATION: Hardcoded localhost URLs detected!"
            echo "üìñ Policy: governance/controls/hardcoded-urls-prevention-policy.md"
            echo "üí° Use environment variables from .env instead"
            exit 1
          }

      - name: Validate Environment Variables
        run: |
          if [ -f "scripts/env/validate-env.sh" ]; then
            bash scripts/env/validate-env.sh
          else
            echo "‚ö†Ô∏è  Environment validation script not found (skipping)"
          fi

  workflow_lint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install tooling
        run: npm ci

      - name: Run actionlint
        run: npm run ci:lint-workflows
