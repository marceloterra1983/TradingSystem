name: Code-Docs Sync Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/api/**/*.js'
      - 'backend/data/timescaledb/**/*.sql'
      - 'backend/api/*/package.json'
      - 'apps/*/package.json'
      - 'apps/*/src/**/*.js'
      - 'apps/*/src/**/*.ts'
      - 'apps/*/src/**/*.tsx'
      - 'docs/static/specs/*.yaml'
      - '.env.example'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  freeze_guard:
    uses: ./.github/workflows/freeze-guard.yml
    secrets: inherit

  validate-sync:
    name: Validate Code-Docs Sync
    runs-on: ubuntu-latest
    needs: freeze_guard
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    outputs:
      violations_found: ${{ steps.results.outputs.violations_found }}
      violation_count: ${{ steps.results.outputs.violation_count }}
      critical_count: ${{ steps.results.outputs.critical_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements-docs.txt

      - name: Install Node dependencies
        run: npm ci

      - name: Install Python dependencies
        run: pip install -r requirements-docs.txt

      - name: Prepare sync validation directory
        run: mkdir -p /tmp/sync-validation

      - name: Fetch base branch
        run: git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"

      - name: Run code-docs sync analysis
        id: analyze
        run: |
          base_sha=$(git merge-base HEAD "origin/${{ github.base_ref }}")
          node scripts/agents/docusaurus-daily.mjs \
            --base-ref "$base_sha" \
            --check-sync \
            --severity-threshold high \
            --outDir /tmp/sync-validation

      - name: Collect sync results
        id: results
        shell: bash
        run: |
          report="/tmp/sync-validation/sync-report.json"
          if [[ ! -f "$report" ]]; then
            echo "violations_found=false" >> "$GITHUB_OUTPUT"
            echo "violation_count=0" >> "$GITHUB_OUTPUT"
            echo "critical_count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          total=$(jq '.totalViolations // (.items | length // 0)' "$report")
          critical=$(jq '.counts.critical // 0' "$report")
          if [[ "$total" -gt 0 ]]; then
            echo "violations_found=true" >> "$GITHUB_OUTPUT"
          else
            echo "violations_found=false" >> "$GITHUB_OUTPUT"
          fi
          echo "violation_count=$total" >> "$GITHUB_OUTPUT"
          echo "critical_count=$critical" >> "$GITHUB_OUTPUT"

      - name: Upload sync validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-sync-validation
          path: /tmp/sync-validation/
          if-no-files-found: warn
          retention-days: 30

  comment-on-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - validate-sync
    if: ${{ needs.freeze_guard.outputs.active != 'true' && needs.validate-sync.outputs.violations_found == 'true' }}
    steps:
      - name: Download sync report
        uses: actions/download-artifact@v4
        with:
          name: docs-sync-validation
          path: docs-sync-validation

      - name: Post or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const marker = '## ⚠️ Documentation Sync Required';
            const reportPath = path.join(process.env.GITHUB_WORKSPACE, 'docs-sync-validation', 'sync-report.json');
            if (!fs.existsSync(reportPath)) {
              core.info('No sync report found; skipping comment.');
              return;
            }
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const counts = report.counts || {critical: 0, high: 0, medium: 0, low: 0};
            const items = report.items || [];
            const lines = [];
            lines.push('## ⚠️ Documentation Sync Required');
            lines.push('');
            lines.push('This PR modifies code that requires documentation updates.');
            lines.push('');
            lines.push(`**Violations Found**: ${items.length}`);
            lines.push(`**Critical**: ${counts.critical || 0}`);
            lines.push(`**High**: ${counts.high || 0}`);
            lines.push(`**Medium**: ${counts.medium || 0}`);
            lines.push(`**Low**: ${counts.low || 0}`);
            lines.push('');
            if (items.length) {
              lines.push('| Source | Severity | Target Docs | Owner |');
              lines.push('|--------|----------|-------------|-------|');
              for (const item of items) {
                const source = item.sourceFile ? `\`${item.sourceFile}\`` : '—';
                const severity = (item.severity || 'unknown').toUpperCase();
                const target = item.targetFile ? `\`${item.targetFile}\`` : '—';
                const owner = item.owner ? `@${item.owner}` : '—';
                lines.push(`| ${source} | ${severity} | ${target} | ${owner} |`);
              }
              lines.push('');
            }
            lines.push('### Next Steps');
            lines.push('');
            lines.push('1. Update the listed documentation files.');
            lines.push('2. Commit the changes to this pull request.');
            lines.push('3. Re-run validation (`npm run docs:check-sync`) to confirm resolution.');
            lines.push('');
            lines.push('**Mapping**: `docs/governance/CODE-DOCS-MAPPING.json`');
            lines.push('**Guide**: `docs/governance/CODE-DOCS-SYNC.md`');
            const body = lines.join('\n');

            const {owner, repo} = context.repo;
            const issueNumber = context.issue.number;
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {owner, repo, issue_number: issueNumber, per_page: 100}
            );
            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body
              });
            }

  check-critical-violations:
    name: Evaluate Violations
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - validate-sync
    if: ${{ needs.freeze_guard.outputs.active != 'true' && needs.validate-sync.result != 'skipped' }}
    steps:
      - name: Publish summary
        env:
          VIOLATION_COUNT: ${{ needs.validate-sync.outputs.violation_count }}
          CRITICAL_COUNT: ${{ needs.validate-sync.outputs.critical_count }}
        run: |
          {
            echo "## Documentation Sync Validation"
            echo ""
            echo "- Violations: ${VIOLATION_COUNT:-0}"
            echo "- Critical: ${CRITICAL_COUNT:-0}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail on critical violations
        env:
          VIOLATION_COUNT: ${{ needs.validate-sync.outputs.violation_count }}
          CRITICAL_COUNT: ${{ needs.validate-sync.outputs.critical_count }}
        run: |
          critical=${CRITICAL_COUNT:-0}
          violations=${VIOLATION_COUNT:-0}
          if [[ -z "$critical" ]]; then
            echo "No validation data available; skipping enforcement."
            exit 0
          fi
          if [[ "$critical" -gt 0 ]]; then
            echo "Critical documentation sync violations detected."
            exit 1
          fi
          if [[ "$violations" -gt 0 ]]; then
            echo "::warning::Documentation sync updates required (non-critical severities)."
          else
            echo "No blocking documentation sync violations detected."
          fi
