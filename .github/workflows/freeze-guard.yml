name: Reusable Freeze Guard

on:
  workflow_call:
    inputs:
      skip:
        description: 'Skip freeze guard check'
        required: false
        default: false
        type: boolean
    outputs:
      active:
        description: 'Whether freeze is active'
        value: ${{ jobs.freeze_guard.outputs.active }}

jobs:
  freeze_guard:
    name: Freeze Guard
    runs-on: ubuntu-latest
    outputs:
      active: ${{ steps.detect.outputs.active }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: detect
        name: Detect freeze status
        shell: bash
        env:
          SKIP_FREEZE_GUARD: ${{ inputs.skip }}
        run: |
          if [ "$SKIP_FREEZE_GUARD" = "true" ]; then
            echo "active=false" >> "$GITHUB_OUTPUT"
            echo "Freeze guard skipped via reusable workflow input"
            exit 0
          fi

          if [ ! -f FREEZE-NOTICE.md ]; then
            echo "active=false" >> "$GITHUB_OUTPUT"
            echo "No FREEZE-NOTICE.md file found - proceeding normally"
            exit 0
          fi

          status_line=$(grep -i '^\*\*Status' FREEZE-NOTICE.md 2>/dev/null | head -n1 | tr -d '\r' || echo "")
          if echo "$status_line" | grep -qiE 'ACTIVE|IN PROGRESS|ONGOING|PHASE'; then
            echo "active=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ”’ Freeze active: $status_line"
          else
            echo "active=false" >> "$GITHUB_OUTPUT"
            echo "âœ… No active freeze detected"
          fi

