name: Environment Validation

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '.env.example'
      - 'backend/**/.env*'
      - 'frontend/**/.env*'
      - 'ai/**/.env*'
      - 'scripts/env/**'
      - '**/vite.config.ts'
      - '**/vite.config.js'
  push:
    branches: [main]
    paths:
      - '.env.example'
      - 'scripts/env/**'

jobs:
  validate-env-files:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate environment files
        run: |
          echo "ðŸ” Validating environment configuration..."
          bash scripts/env/validate-env.sh

      - name: Check for hardcoded secrets in code
        run: |
          echo "ðŸ” Checking for hardcoded secrets..."

          # Search for potential secrets (excluding test files and node_modules)
          if grep -r -E "(password|secret|api_key|token).*=.*['\"][a-zA-Z0-9]{8,}" \
             --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
             --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=build \
             --exclude="*.test.*" --exclude="*.spec.*" \
             frontend/ backend/ ai/ | grep -v "process.env" | grep -v "import.meta.env"; then
            echo "âŒ Found potential hardcoded secrets!"
            echo "Please move all secrets to environment variables"
            exit 1
          fi

          echo "âœ… No hardcoded secrets found"

      - name: Validate proxy configuration (CRITICAL)
        run: |
          echo "ðŸ” Validating Vite proxy configuration..."

          # Check for VITE_ prefix on proxy targets (FORBIDDEN)
          if grep -r "VITE_.*PROXY_TARGET" .env.example; then
            echo "âŒ CRITICAL ERROR: Found VITE_ prefix on proxy target!"
            echo "This exposes container hostnames to the browser!"
            echo ""
            echo "WRONG:  VITE_WORKSPACE_PROXY_TARGET=http://workspace-api:3200"
            echo "CORRECT: WORKSPACE_PROXY_TARGET=http://workspace-api:3200"
            echo ""
            echo "See: docs/content/frontend/engineering/PROXY-BEST-PRACTICES.md"
            exit 1
          fi

          echo "âœ… Proxy configuration is correct"

      - name: Check for localhost URLs in frontend code
        run: |
          echo "ðŸ” Checking for hardcoded localhost URLs..."

          # Search for localhost URLs in frontend code (should use relative paths)
          if grep -r "http://localhost:[0-9]" \
             --include="*.ts" --include="*.tsx" \
             --exclude-dir=node_modules --exclude-dir=dist \
             frontend/dashboard/src/; then
            echo "âŒ Found hardcoded localhost URLs in frontend!"
            echo "Use relative paths instead: /api/workspace/items"
            echo ""
            echo "See: docs/content/frontend/engineering/PROXY-BEST-PRACTICES.md"
            exit 1
          fi

          echo "âœ… No hardcoded localhost URLs found"

  validate-env-sync:
    name: Validate .env.example Sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check .env.example completeness
        run: |
          echo "ðŸ“‹ Checking if .env.example contains all required variables..."

          # Extract all env var references from code
          echo "Scanning for environment variable usage..."

          # Node.js/TypeScript (process.env.*)
          grep -roh "process\.env\.[A-Z_]*" \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=build \
            backend/ frontend/ | \
            sed 's/process\.env\.//' | sort -u > used_vars.txt

          # Vite (import.meta.env.*)
          grep -roh "import\.meta\.env\.[A-Z_]*" \
            --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=dist \
            frontend/ | \
            sed 's/import\.meta\.env\.//' | sort -u >> used_vars.txt

          # Docker Compose env references
          find tools/ -name "*.yml" -exec grep -oh "\${[A-Z_]*}" {} \; | \
            sed 's/\${//' | sed 's/}//' | sort -u >> used_vars.txt

          # Remove duplicates
          sort -u used_vars.txt -o used_vars.txt

          # Check if all are in .env.example
          MISSING_VARS=""
          while read var; do
            if ! grep -q "^$var=" .env.example; then
              MISSING_VARS="$MISSING_VARS\n  - $var"
            fi
          done < used_vars.txt

          if [ -n "$MISSING_VARS" ]; then
            echo "âŒ Missing variables in .env.example:"
            echo -e "$MISSING_VARS"
            echo ""
            echo "Please add these variables to .env.example"
            exit 1
          fi

          echo "âœ… All environment variables are documented in .env.example"

  validate-vite-config:
    name: Validate Vite Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Vite proxy configuration
        run: |
          echo "ðŸ” Validating Vite proxy configuration..."

          # Check that proxy targets don't use VITE_ prefix
          if grep -r "VITE_.*_PROXY_TARGET" frontend/*/vite.config.ts; then
            echo "âŒ Found VITE_ prefix in proxy target configuration!"
            echo "Proxy targets should NOT have VITE_ prefix"
            exit 1
          fi

          # Check that proxy paths are using relative URLs
          if grep -r "target.*localhost" frontend/*/vite.config.ts; then
            echo "âš ï¸ Warning: Found localhost in proxy target"
            echo "Consider using container names for better Docker compatibility"
          fi

          echo "âœ… Vite configuration validated"

  validate-docker-env:
    name: Validate Docker Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Docker Compose env_file references
        run: |
          echo "ðŸ³ Checking Docker Compose env_file references..."

          # All services should reference root .env
          find tools/compose -name "*.yml" | while read compose_file; do
            echo "Checking: $compose_file"

            # Check if env_file points to root
            if grep -q "env_file:" "$compose_file"; then
              if ! grep -q "../../.env" "$compose_file"; then
                echo "âš ï¸ Warning: $compose_file should reference ../../.env"
              fi
            fi
          done

          echo "âœ… Docker environment configuration validated"

      - name: Check for local .env files (FORBIDDEN)
        run: |
          echo "ðŸ” Checking for local .env files..."

          # Find any .env files (excluding .env.example and root .env)
          FORBIDDEN_ENVS=$(find . -name ".env" \
            -not -path "./.env" \
            -not -path "./node_modules/*" \
            -not -path "./dist/*" \
            -not -path "./build/*")

          if [ -n "$FORBIDDEN_ENVS" ]; then
            echo "âŒ Found local .env files (FORBIDDEN):"
            echo "$FORBIDDEN_ENVS"
            echo ""
            echo "All services must use the root .env file"
            echo "Delete local .env files and update configuration to use root .env"
            exit 1
          fi

          echo "âœ… No forbidden local .env files found"
