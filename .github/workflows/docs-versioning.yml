name: Documentation Versioning

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic version to version docs with (e.g., 1.2.3)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  NODE_ENV: production
  CI: true

jobs:
  freeze_guard:
    name: Freeze Guard
    runs-on: ubuntu-latest
    outputs:
      active: ${{ steps.freeze.outputs.active }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: freeze
        name: Detect deployment freeze
        run: |
          if [ ! -f FREEZE-NOTICE.md ]; then
            echo "No freeze notice file found. Continuing."
            echo "active=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if grep -Eiq '(\*\*)?status(\*\*)?[^\n]*:\s*active' FREEZE-NOTICE.md; then
            echo "Deployment freeze is ACTIVE. Skipping downstream jobs."
            echo "active=true" >> "$GITHUB_OUTPUT"
          else
            echo "Deployment freeze not active."
            echo "active=false" >> "$GITHUB_OUTPUT"
          fi

  validate-prerequisites:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    needs: freeze_guard
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    defaults:
      run:
        working-directory: docs
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm
          cache-dependency-path: docs/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          npm ci
          pip install -r ../requirements-docs.txt

      - id: version
        name: Determine version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            REF_NAME="${GITHUB_REF##*/}"
            VERSION="${REF_NAME#v}"
          fi

          if [[ -z "$VERSION" ]]; then
            echo "Unable to determine version from tag or input."
            exit 1
          fi

          echo "Version detected: $VERSION"

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must follow semantic versioning (X.Y.Z). Provided: $VERSION"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Validate frontmatter
        run: |
          python ../scripts/docs/validate-frontmatter.py \
            --schema v2 \
            --docs-dir ./content

      - name: Run maintenance audit
        run: |
          bash ../scripts/docs/maintenance-audit.sh \
            --ci-mode \
            --ci-threshold 5

      - name: Run full documentation validation suite
        run: |
          npm run docs:check

  create-version:
    name: Create Documentation Version
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - validate-prerequisites
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    defaults:
      run:
        working-directory: docs
    env:
      VERSION: ${{ needs.validate-prerequisites.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm
          cache-dependency-path: docs/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          npm ci
          pip install -r ../requirements-docs.txt

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Execute automated versioning script
        run: |
          bash ../scripts/docs/auto-version.sh \
            --version "$VERSION" \
            --skip-build-validation

      - name: Push documentation version snapshot
        run: |
          git push origin HEAD:main

      - name: Upload version report
        uses: actions/upload-artifact@v4
        with:
          name: docs-version-report
          path: |
            docs/reports/version-${VERSION}-*.md
          retention-days: 90

  verify-version:
    name: Verify Documentation Version
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - create-version
      - validate-prerequisites
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    defaults:
      run:
        working-directory: docs
    env:
      VERSION: ${{ needs.validate-prerequisites.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm
          cache-dependency-path: docs/package-lock.json

      - name: Install dependencies
        run: |
          npm ci

      - name: Verify versions.json updated
        run: |
          if ! grep -q "\"$VERSION\"" versions.json; then
            echo "Version $VERSION not found in versions.json"
            exit 1
          fi

      - name: Verify versioned docs directory
        run: |
          if [ ! -d "versioned_docs/version-$VERSION" ]; then
            echo "versioned_docs/version-$VERSION not found"
            exit 1
          fi

      - name: Verify versioned sidebars file
        run: |
          if [ ! -f "versioned_sidebars/version-$VERSION-sidebars.json" ]; then
            echo "versioned_sidebars/version-$VERSION-sidebars.json missing"
            exit 1
          fi

      - name: Count versioned documents
        run: |
          FILE_COUNT=$(find "versioned_docs/version-$VERSION" -name "*.mdx" | wc -l | tr -d ' ')
          echo "Versioned documents: $FILE_COUNT"
          if [ "$FILE_COUNT" -lt 100 ]; then
            echo "File count $FILE_COUNT below minimum expected threshold (>= 100)"
            exit 1
          fi

      - name: Build documentation with new version
        run: |
          npm run docs:build

      - name: Start docs server and verify version routing
        run: |
          npm run docs:serve -- --port 3333 --no-open &
          SERVER_PID=$!
          trap 'kill "$SERVER_PID"' EXIT
          npx wait-on http://localhost:3333
          curl --fail --silent http://localhost:3333/ > /tmp/root.html
          if ! grep -q "docsVersionDropdown" /tmp/root.html; then
            echo "Root docs page is missing version dropdown markup"
            exit 1
          fi

          VERSION_ROUTE=$(node -e "const path = require('path'); const configPath = path.resolve(process.cwd(), 'docusaurus.config.js'); let config; try { config = require(configPath); } catch (error) { console.error('Unable to require docusaurus.config.js:', error); process.exit(2); } const classicPreset = Array.isArray(config.presets) ? config.presets.find((preset) => Array.isArray(preset) && preset[0] === 'classic') : null; const docsConfig = classicPreset && classicPreset[1] && classicPreset[1].docs ? classicPreset[1].docs : {}; const versions = docsConfig.versions || {}; const entry = versions['${VERSION}'] || {}; const route = typeof entry.path === 'string' ? entry.path.trim() : ''; process.stdout.write(route);")

          ROOT_HAS_VERSION=0
          if grep -q "\"${VERSION}\"" /tmp/root.html || grep -q "$VERSION" /tmp/root.html; then
            ROOT_HAS_VERSION=1
          fi

          ROUTE_CONFIRMED=0
          if [ -n "$VERSION_ROUTE" ]; then
            ROUTE_PATH=$(printf "/%s/" "${VERSION_ROUTE#/}")
            if curl --fail --silent "http://localhost:3333$ROUTE_PATH" > /tmp/version.html; then
              if grep -q "$VERSION" /tmp/version.html; then
                ROUTE_CONFIRMED=1
              else
                echo "Versioned docs page at $ROUTE_PATH does not reference version $VERSION"
              fi
            else
              echo "Failed to load version-specific route at $ROUTE_PATH"
            fi
          fi

          if [ -z "$VERSION_ROUTE" ] && [ "$ROOT_HAS_VERSION" -ne 1 ]; then
            echo "Version $VERSION expected at root, but could not confirm presence on root page."
            exit 1
          fi

          if [ -n "$VERSION_ROUTE" ] && [ "$ROUTE_CONFIRMED" -ne 1 ] && [ "$ROOT_HAS_VERSION" -ne 1 ]; then
            echo "Unable to confirm documentation availability for version $VERSION at root or $VERSION_ROUTE."
            exit 1
          fi

          kill "$SERVER_PID"
          trap - EXIT


  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs:
      - freeze_guard
      - verify-version
      - validate-prerequisites
    if: ${{ needs.freeze_guard.outputs.active != 'true' }}
    env:
      VERSION: ${{ needs.validate-prerequisites.outputs.version }}
      TAG: v${{ needs.validate-prerequisites.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract release notes from CHANGELOG
        id: notes
        run: |
          VERSION_HEADING="## [${VERSION}]"
          if ! grep -Fq "$VERSION_HEADING" CHANGELOG.md; then
            echo "Release notes for version $VERSION not found in CHANGELOG.md"
            exit 1
          fi

          NOTES=$(awk -v ver="$VERSION_HEADING" '
            $0 == ver {flag=1; next}
            /^## \[/ && flag {exit}
            flag {print}
          ' CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            NOTES="Documentation version $VERSION released."
          fi

          echo "notes<<'EOF'" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Download version artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: ${{ steps.notes.outputs.notes }}
        run: |
          NOTES_PATH="release-notes.md"
          printf "## TradingSystem Docs %s\n\n%s\n" "$VERSION" "$RELEASE_NOTES" > "$NOTES_PATH"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists."
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

          RELEASE_ARGS=( "$TAG" )
          if compgen -G "artifacts/docs-version-report/*" > /dev/null; then
            RELEASE_ARGS+=( artifacts/docs-version-report/* )
          fi

          gh release create "${RELEASE_ARGS[@]}" \
            --title "Documentation ${VERSION}" \
            --notes-file "$NOTES_PATH" \
            --latest
