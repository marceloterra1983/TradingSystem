@startuml Connection States State Machine
!theme plain
title ProfitDLL Connection States

!define STATE_COLOR #E5F5FF
!define ERROR_COLOR #FFE5E5
!define SUCCESS_COLOR #E5FFE5
!define WARN_COLOR #FFF5E5

[*] --> Disconnected : Application starts

state Disconnected ERROR_COLOR {
  Disconnected : Entry: No connection
  Disconnected : State 1 (Broker): 0 (Disconnected)
  Disconnected : State 2 (Market): 0 (Disconnected)
  Disconnected : Exit: Initialize connection
}

Disconnected --> Initializing : DLLInitialize()
Disconnected --> [*] : Shutdown

state Initializing STATE_COLOR {
  Initializing : Entry: Call DLLInitialize
  Initializing : Do: Load credentials
  Initializing : - Activation key
  Initializing : - Username
  Initializing : - Password
  Initializing : Exit: Wait for callback
}

Initializing --> Authenticating : DLL loaded
Initializing --> Disconnected : Init failed\n(retry after 5s)

state Authenticating STATE_COLOR {
  Authenticating : Entry: Send credentials
  Authenticating : Do: Validate with broker
  Authenticating : Callback: StateCallback(0)
  Authenticating : Exit: Authentication result
}

Authenticating --> BrokerConnecting : Auth OK (State 0 = 0)
Authenticating --> InvalidCredentials : Auth failed\n(State 0 = 1/2)

state InvalidCredentials ERROR_COLOR {
  InvalidCredentials : Entry: Log auth error
  InvalidCredentials : State 0 = 1: Invalid user
  InvalidCredentials : State 0 = 2: Wrong password
  InvalidCredentials : Exit: Retry or abort
}

InvalidCredentials --> Disconnected : Retry (max 3x)
InvalidCredentials --> [*] : Manual intervention

state BrokerConnecting STATE_COLOR {
  BrokerConnecting : Entry: Connect to broker
  BrokerConnecting : State 1: Broker status
  BrokerConnecting : Callback: StateCallback(1)
  BrokerConnecting : Exit: Broker connection result
}

BrokerConnecting --> BrokerConnected : State 1 = 2\n(Connected)
BrokerConnecting --> BrokerHCSConnected : State 1 = 5\n(HCS Connected)
BrokerConnecting --> Disconnected : State 1 = 0\n(Failed)

state BrokerConnected SUCCESS_COLOR {
  BrokerConnected : Entry: Broker online
  BrokerConnected : State 1 = 2 (Connected)
  BrokerConnected : Can send orders: YES
  BrokerConnected : Exit: Connect to market
}

state BrokerHCSConnected SUCCESS_COLOR {
  BrokerHCSConnected : Entry: HCS mode active
  BrokerHCSConnected : State 1 = 5 (HCS Connected)
  BrokerHCSConnected : High-speed connection
  BrokerHCSConnected : Exit: Connect to market
}

BrokerConnected --> MarketConnecting : Proceed
BrokerHCSConnected --> MarketConnecting : Proceed
BrokerConnected --> Degraded : Broker issues
BrokerHCSConnected --> Degraded : Broker issues

state MarketConnecting STATE_COLOR {
  MarketConnecting : Entry: Connect to market
  MarketConnecting : State 2: Market status
  MarketConnecting : Callback: StateCallback(2)
  MarketConnecting : Exit: Market connection result
}

MarketConnecting --> FullyConnected : State 2 = 4\n(Market connected)
MarketConnecting --> MarketNotLogged : State 2 = 3\n(Not logged)
MarketConnecting --> Disconnected : Connection timeout

state MarketNotLogged ERROR_COLOR {
  MarketNotLogged : Entry: Market login failed
  MarketNotLogged : State 2 = 3 (Not Logged)
  MarketNotLogged : Can receive data: NO
  MarketNotLogged : Exit: Retry login
}

MarketNotLogged --> MarketConnecting : Retry login
MarketNotLogged --> Disconnected : Max retries

state FullyConnected SUCCESS_COLOR {
  FullyConnected : Entry: All systems online
  FullyConnected : State 1 = 2/5 (Broker)
  FullyConnected : State 2 = 4 (Market)
  FullyConnected : State 3 = 0 (Activation OK)
  FullyConnected : Can trade: YES
  FullyConnected : Can receive data: YES
  FullyConnected : Exit: Monitor health
}

FullyConnected --> SubscribingTickers : Subscribe to assets
FullyConnected --> Degraded : Connection issues
FullyConnected --> Disconnected : Manual disconnect

state SubscribingTickers STATE_COLOR {
  SubscribingTickers : Entry: Subscribe to tickers
  SubscribingTickers : Do: SubscribeTicker()
  SubscribingTickers : Assets: WINZ25, WDOZ25, etc.
  SubscribingTickers : Exit: Start receiving data
}

SubscribingTickers --> Active : Subscriptions OK
SubscribingTickers --> FullyConnected : Subscription failed

state Active SUCCESS_COLOR {
  Active : Entry: System operational
  Active : Receiving: Trades, Book, Quotes
  Active : Sending: Orders, Cancels
  Active : Latency: < 500ms (monitored)
  Active : Exit: Monitor continuously
}

Active --> Degraded : High latency (>1s)
Active --> Degraded : Missed heartbeats
Active --> Disconnected : Connection lost
Active --> FullyConnected : Unsubscribe all

state Degraded WARN_COLOR {
  Degraded : Entry: Performance issues
  Degraded : Symptoms:
  Degraded : - Latency > 1000ms
  Degraded : - Missed callbacks
  Degraded : - Broker reconnects
  Degraded : Exit: Auto-recovery or failover
}

Degraded --> Active : Recovery successful
Degraded --> Disconnected : Degradation persists\n(>60s)

note right of Disconnected
  **Initial/Error State**
  No connection to ProfitDLL.
  System cannot trade or receive data.
  Auto-reconnect every 5 seconds.
end note

note right of Authenticating
  **StateCallback(0) - Login State**
  0 = OK (success)
  1 = Invalid user
  2 = Wrong password
end note

note right of BrokerConnecting
  **StateCallback(1) - Broker State**
  0 = Disconnected
  2 = Connected
  5 = HCS Connected (high-speed)
end note

note right of MarketConnecting
  **StateCallback(2) - Market State**
  3 = Not Logged
  4 = Connected (OK)
end note

note left of FullyConnected
  **Operational State**
  All callbacks registered:
  - TStateCallback
  - TConnectorTradeCallback
  - TOfferBookCallback
  - TConnectorOrderCallback

  Ready to subscribe to tickers.
end note

note left of Active
  **Production State**
  System is trading live.

  **Monitored Metrics:**
  - Latency P95 < 500ms
  - Callback success rate > 99.9%
  - Heartbeat every 1s
  - Order execution time < 200ms
end note

note left of Degraded
  **Warning State**
  System continues operating but
  with reduced performance.

  **Actions:**
  - Pause new order submission
  - Alert operators
  - Attempt auto-recovery
  - If persists >60s â†’ Disconnect
end note

@enduml
