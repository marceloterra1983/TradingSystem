#!/usr/bin/env bash

set -eu

if [ "${SKIP_DOCS_HOOKS:-0}" = "1" ]; then
  echo "âš ï¸  Skipping docs lint (SKIP_DOCS_HOOKS=1)"
  exit 0
fi

if git diff --cached --name-only | grep -q "config/ports/registry.yaml"; then
  echo "ğŸ” Registry modified, running ports:sync..."
  npm run ports:sync
  git add .env.shared \
    config/ports/index.json \
    docs/content/tools/ports-services.mdx \
    tools/compose/docker-compose.ports.generated.yml \
    scripts/maintenance/ports-health.sh
fi

# ============================================================================
# CRITICAL: Hardcoded URLs Prevention (ALWAYS RUN)
# ============================================================================
# Policy: governance/controls/hardcoded-urls-prevention-policy.md
# This check runs on EVERY commit to prevent hardcoded localhost URLs

echo "ğŸ” Scanning for hardcoded localhost URLs..."
npm run ports:scan-hardcoded || {
  echo ""
  echo "âŒ Hardcoded localhost URLs detected!"
  echo "ğŸ“– Policy: governance/controls/hardcoded-urls-prevention-policy.md"
  echo "ğŸ’¡ Use environment variables from .env instead"
  exit 1
}

# Port registry validation (only when ports changed)
if git diff --cached --name-only | grep -Eq "(config/ports/registry.yaml|tools/ports/)"; then
  echo "ğŸ” ports:validate"
  npm run ports:validate
fi

if [ "${SKIP_DOCS_AUTO:-0}" = "1" ]; then
  echo "âš ï¸  Skipping docs:auto (SKIP_DOCS_AUTO=1)"
else
  echo "ğŸ”„ docs auto-generate"
  npm --prefix docs run docs:auto
  
  # Adicionar automaticamente arquivos gerados pelo docs:auto (se nÃ£o estiverem no .gitignore)
  if [ -f "docs/content/frontend/design-system/tokens.mdx" ]; then
    if ! git check-ignore -q "docs/content/frontend/design-system/tokens.mdx"; then
      git add docs/content/frontend/design-system/tokens.mdx
    fi
  fi
  if [ -f "docs/content/reference/ports.mdx" ]; then
    if ! git check-ignore -q "docs/content/reference/ports.mdx"; then
      git add docs/content/reference/ports.mdx
    fi
  fi
  
  echo "âœ“ Auto-generated files checked (ignored files skipped)"
fi

echo "ğŸ” docs lint"
npm --prefix docs run docs:lint || echo "âš ï¸  Lint errors found but not blocking commit"

echo "âœ… Pre-commit validation passed"
echo "â„¹ï¸  Note: Run 'bash scripts/maintenance/validate-md-structure.sh' manually if needed"
