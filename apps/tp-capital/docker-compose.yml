services:
  tp-capital:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: tp-capital-service
    ports:
      - "${TP_CAPITAL_HOST_PORT:-4005}:4005"
    env_file:
      - ../../.env
    environment:
      - NODE_ENV=development
      - PORT=4005
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - TP_CAPITAL_DB_HOST=${TP_CAPITAL_DB_HOST:-tp-capital-pgbouncer}
      - TP_CAPITAL_DB_PORT=${TP_CAPITAL_DB_PORT:-5440}
      - TP_CAPITAL_DB_NAME=${TP_CAPITAL_DB_NAME:-tp_capital_db}
      - TP_CAPITAL_DB_USER=${TP_CAPITAL_DB_USER:-tp_capital}
      - TP_CAPITAL_DB_PASSWORD=${TP_CAPITAL_DB_PASSWORD:-tp_capital_secure_pass_2024}
      - TP_CAPITAL_DB_SCHEMA=${TP_CAPITAL_DB_SCHEMA:-signals}
      - TELEGRAM_GATEWAY_DB_HOST=${TELEGRAM_GATEWAY_DB_HOST:-telegram-timescaledb}
      - TELEGRAM_GATEWAY_DB_PORT=${TELEGRAM_GATEWAY_DB_PORT:-5434}
      - TELEGRAM_GATEWAY_DB_NAME=${TELEGRAM_GATEWAY_DB_NAME:-telegram_gateway}
      - TELEGRAM_GATEWAY_DB_SCHEMA=${TELEGRAM_GATEWAY_DB_SCHEMA:-telegram_gateway}
      - TELEGRAM_GATEWAY_DB_USER=${TELEGRAM_GATEWAY_DB_USER:-telegram}
      - TELEGRAM_GATEWAY_DB_PASSWORD=${TELEGRAM_GATEWAY_DB_PASSWORD:-telegram_secure_pass}
    volumes:
      - ./src:/app/src:ro
      - ./scripts:/app/scripts:ro
      - /app/node_modules
    networks:
      - tradingsystem_backend
    # depends_on:
    #   timescaledb:
    #     condition: service_healthy
    # NOTE: Now using dedicated tp-capital stack (tools/compose/docker-compose.4-1-tp-capital-stack.yml)
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4005/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # timescaledb:
  #   image: timescale/timescaledb:latest-pg15
  #   container_name: tp-capital-timescaledb
  #   ports:
  #     - "${TIMESCALEDB_HOST_PORT:-5445}:5432"
  #   environment:
  #     - POSTGRES_USER=${TIMESCALEDB_USER:-timescale}
  #     - POSTGRES_PASSWORD=${TIMESCALEDB_PASSWORD:-pass_timescale}
  #     - POSTGRES_DB=${TIMESCALEDB_DATABASE:-APPS-TPCAPITAL}
  #   volumes:
  #     - tp-capital-timescaledb-data:/var/lib/postgresql/data
  #   networks:
  #     - tradingsystem-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${TIMESCALEDB_USER:-timescale}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  # NOTE: Using dedicated tp-capital stack instead

networks:
  tradingsystem_backend:
    name: tradingsystem_backend
    external: true

volumes:
  tp-capital-timescaledb-data:
    name: tp-capital-timescaledb-data
