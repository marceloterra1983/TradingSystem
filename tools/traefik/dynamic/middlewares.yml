# ============================================================
# Traefik Dynamic Configuration (Phase 3 Epic 1)
# ============================================================
# This file defines middlewares, routers, and services that can
# be updated without restarting Traefik.
# ============================================================

http:
  # ============================================================
  # Middlewares
  # ============================================================
  middlewares:
    # Security Headers
    security-headers:
      headers:
        browserXssFilter: true
        contentTypeNosniff: true
        frameDeny: true
        sslRedirect: false # TODO: Enable in production
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Powered-By: "TradingSystem"
          Server: ""

    # CORS (Development - permissive)
    cors-dev:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
          - OPTIONS
        accessControlAllowOriginList:
          - "http://localhost:9080" # Dashboard
          - "http://localhost:3404" # Docs
        accessControlAllowHeaders:
          - "*"
        accessControlExposeHeaders:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true
        accessControlAllowCredentials: true

    # CORS (Production - restrictive)
    cors-prod:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
        accessControlAllowOriginList:
          - "https://dashboard.tradingsystem.com"
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "X-Request-ID"
        accessControlExposeHeaders:
          - "X-Request-ID"
          - "X-RateLimit-Limit"
          - "X-RateLimit-Remaining"
        accessControlMaxAge: 3600
        addVaryHeader: true
        accessControlAllowCredentials: true

    # Rate Limiting (Global)
    rate-limit-global:
      rateLimit:
        average: 300
        period: 1m
        burst: 50

    # Rate Limiting (Per User - future with Redis)
    rate-limit-user:
      rateLimit:
        average: 100
        period: 1m
        burst: 50

    # Rate Limiting (Strict - for sensitive endpoints)
    rate-limit-strict:
      rateLimit:
        average: 10
        period: 1m
        burst: 5

    # Compression
    compress:
      compress: {}

    # Request ID
    request-id:
      headers:
        customRequestHeaders:
          X-Request-ID: "{{.UUID}}"

    # Retry
    retry:
      attempts: 3
      initialInterval: 100ms

    # Circuit Breaker
    circuit-breaker:
      circuitBreaker:
        expression: "LatencyAtQuantileMS(50.0) > 100 || ResponseCodeRatio(500, 600, 0, 600) > 0.25"

    # JWT Authentication (future - Phase 3 Epic 1.4)
    # Requires traefik-jwt-plugin or custom middleware
    # jwt-auth:
    #   plugin:
    #     jwt:
    #       secret: "${JWT_SECRET}"
    #       algorithm: "HS256"
    #       issuer: "tradingsystem"
    #       audience: "api"
    #       validateExpiry: true

    # Auth Chain (combines multiple auth methods)
    auth-chain:
      chain:
        middlewares:
          - security-headers
          - cors-dev
          - request-id
          - compress
          # - jwt-auth  # TODO: Enable in Epic 1.4

    # Standard Middleware Chains (referenced by services)
    api-standard:
      chain:
        middlewares:
          - security-headers
          - cors-dev
          - request-id
          - compress
          - rate-limit-global

    static-standard:
      chain:
        middlewares:
          - security-headers
          - cors-dev
          - compress

    admin-standard:
      chain:
        middlewares:
          - security-headers
          - cors-dev
          - rate-limit-strict
    n8n-dashboard-auth-header:
      headers:
        customRequestHeaders:
          Authorization: "Basic YXV0b21hdGlvbjpNYXJjZWxvMTIzQA=="
    dashboard-auth:
      basicAuth:
        users:
          - "dev:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"

    static-allow-iframe:
      chain:
        middlewares:
          - cors-dev
          - compress

  # ============================================================
  # Services (Backend targets)
  # ============================================================
  # Note: Most services will be auto-discovered via Docker labels
  # Manual definitions only needed for external services
  # ============================================================

  # Example: External service not in Docker
  # services:
  #   external-api:
  #     loadBalancer:
  #       servers:
  #         - url: "http://external-host:3000"
  #       healthCheck:
  #         path: /health
  #         interval: 30s
  #         timeout: 5s

  # ============================================================
  # Routers (URL routing rules)
  # ============================================================
  # Note: Most routes will be auto-discovered via Docker labels
  # Manual definitions only for complex routing logic
  # ============================================================

  # Example: Custom router
  # routers:
  #   api-workspace:
  #     rule: "PathPrefix(`/api/workspace`)"
  #     service: workspace-api
  #     entryPoints:
  #       - web
  #     middlewares:
  #       - auth-chain
  #       - rate-limit-user
# ============================================================
# TCP/UDP Configuration (future)
# ============================================================
# tcp:
#   routers: {}
#   services: {}
#
# udp:
#   routers: {}
#   services: {}

# ============================================================
# TLS Configuration (future)
# ============================================================
# tls:
#   options:
#     default:
#       minVersion: VersionTLS12
#       cipherSuites:
#         - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
#         - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
#       sniStrict: true
