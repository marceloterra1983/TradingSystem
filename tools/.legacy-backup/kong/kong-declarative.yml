# ============================================================
# Kong Gateway - Declarative Configuration
# ============================================================
# Purpose: RAG Services routes and plugins configuration
# Format: Kong 3.x declarative config (DB-less mode compatible)
# Documentation: https://docs.konghq.com/gateway/latest/production/deployment-topologies/db-less-and-declarative-config/
# ============================================================

_format_version: "3.0"
_transform: true

# ============================================================
# SERVICES
# ============================================================

services:
  # RAG Documentation API (Proxy Service)
  - name: rag-documentation-api
    url: http://rag-service:3000
    protocol: http
    host: rag-service
    port: 3000
    path: /
    connect_timeout: 10000
    write_timeout: 30000
    read_timeout: 30000
    retries: 3
    tags:
      - rag
      - documentation
    
    routes:
      # GET /api/v1/rag/search (Semantic Search)
      - name: rag-search
        paths:
          - /api/v1/rag/search
        methods:
          - GET
        strip_path: false
        preserve_host: false
        tags:
          - rag
          - search
      
      # POST /api/v1/rag/query (Q&A)
      - name: rag-query
        paths:
          - /api/v1/rag/query
        methods:
          - POST
        strip_path: false
        tags:
          - rag
          - query
      
      # GET /api/v1/rag/status/* (Health & Status)
      - name: rag-status
        paths:
          - /api/v1/rag/status
        methods:
          - GET
        strip_path: false
        tags:
          - rag
          - status

  # RAG Collections Service
  - name: rag-collections-service
    url: http://rag-collections-service:3402
    protocol: http
    host: rag-collections-service
    port: 3402
    path: /
    connect_timeout: 10000
    write_timeout: 60000  # Longer timeout for ingestion
    read_timeout: 60000
    retries: 3
    tags:
      - rag
      - collections
    
    routes:
      # GET /api/v1/rag/collections (List Collections)
      - name: rag-collections-list
        paths:
          - /api/v1/rag/collections
        methods:
          - GET
        strip_path: false
        tags:
          - rag
          - collections
      
      # POST /api/v1/rag/collections (Create Collection)
      - name: rag-collections-create
        paths:
          - /api/v1/rag/collections
        methods:
          - POST
        strip_path: false
        tags:
          - rag
          - collections
      
      # GET /api/v1/rag/collections/:id/stats (Collection Stats)
      - name: rag-collections-stats
        paths:
          - /api/v1/rag/collections/~/stats
        methods:
          - GET
        strip_path: false
        tags:
          - rag
          - stats

# ============================================================
# GLOBAL PLUGINS
# ============================================================

plugins:
  # CORS Plugin (Global)
  - name: cors
    enabled: true
    config:
      origins:
        - http://localhost:3103
        - http://localhost:3400
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Requested-With
        - X-Service-Token
        - X-Correlation-ID
      exposed_headers:
        - X-Auth-Token
        - X-Request-ID
        - X-Cache-Status
        - X-Circuit-Breaker-State
      credentials: true
      max_age: 3600
      preflight_continue: false
  
  # Rate Limiting (Global - 100 req/min per IP)
  - name: rate-limiting
    enabled: true
    config:
      minute: 100
      hour: 5000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      redis_host: null
  
  # Request ID (Correlation Tracking)
  - name: correlation-id
    enabled: true
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true
  
  # Prometheus Metrics (Monitoring)
  - name: prometheus
    enabled: true
    config:
      per_consumer: false
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

# ============================================================
# CONSUMERS (API Users)
# ============================================================

consumers:
  # Default application consumer
  - username: rag-app
    custom_id: rag-application
    tags:
      - application
      - rag
    
    # JWT Credentials
    jwt_secrets:
      - key: rag-app-key
        secret: ${JWT_SECRET_KEY:-dev-secret}
        algorithm: HS256
    
    # ACLs (Access Control Lists)
    acls:
      - group: rag-users

# ============================================================
# UPSTREAM TARGETS (Future: Service Discovery)
# ============================================================

upstreams:
  # RAG Service upstream (for advanced load balancing)
  - name: rag-service-upstream
    algorithm: least-connections
    hash_on: none
    hash_fallback: none
    healthchecks:
      active:
        type: http
        http_path: /api/v1/rag/status/health
        timeout: 5
        concurrency: 10
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3
          timeouts: 3
      passive:
        type: http
        healthy:
          successes: 3
        unhealthy:
          http_failures: 3
          timeouts: 3
    targets:
      - target: rag-service:3000
        weight: 100

# ============================================================
# NOTES
# ============================================================
# 
# To apply this configuration:
# 1. Using declarative config (DB-less mode):
#    - Mount this file to Kong container: /etc/kong/kong.yml
#    - Set KONG_DECLARATIVE_CONFIG=/etc/kong/kong.yml
#
# 2. Using Admin API (DB mode):
#    - Run: bash scripts/kong/configure-rag-routes.sh
#
# 3. Using Konga UI:
#    - Access http://localhost:1337
#    - Navigate to Services â†’ Add Service
#    - Add routes and plugins via UI
#
# ============================================================


