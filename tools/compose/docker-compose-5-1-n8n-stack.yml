# ==============================================================================
# n8n Automation Stack (Queue Mode)
# ==============================================================================
# Reference: https://github.com/n8n-io/n8n
# Components:
#   - n8n-app (main UI/API) + n8n-worker (background executions)
#   - PostgreSQL for workflow persistence
#   - Redis for Bull queue and event bus
# This stack follows TradingSystem conventions (shared .env, named volumes,
# json-file logging, healthchecks, and dedicated bridge network).
# Usage:
#   docker compose --env-file ../../.env -f tools/compose/docker-compose.n8n.yml up -d
# ==============================================================================

name: 5-1-n8n-stack

x-n8n-common-env: &n8n-common-env
  NODE_ENV: production
  N8N_PROTOCOL: ${N8N_PROTOCOL:-http}
  N8N_HOST: ${N8N_HOST:-localhost}
  N8N_PORT: ${N8N_INTERNAL_PORT:-5678}
  N8N_BASE_URL: ${N8N_BASE_URL:-http://localhost:9080/n8n}
  N8N_PATH: ${N8N_PATH:-/n8n/}
  VUE_APP_URL_BASE_API: ${N8N_PATH:-/n8n/}
  WEBHOOK_URL: ${N8N_WEBHOOK_URL:-http://localhost:9080/n8n/}
  N8N_PROXY_HOPS: ${N8N_PROXY_HOPS:-3}
  N8N_BASIC_AUTH_ACTIVE: ${N8N_BASIC_AUTH_ACTIVE:-false}
  N8N_DISABLE_UI_SECURITY: ${N8N_DISABLE_UI_SECURITY:-true}
  N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER:-automation}
  N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD:-changeme}
  N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:-please-set-a-secure-key}
  N8N_USER_FOLDER: ${N8N_USER_FOLDER:-/home/node/.n8n}
  N8N_LOG_LEVEL: ${N8N_LOG_LEVEL:-info}
  N8N_SECURITY_ALLOW_EMBEDDING_IN_IFRAME: ${N8N_SECURITY_ALLOW_EMBEDDING_IN_IFRAME:-true}
  N8N_METRICS: ${N8N_METRICS:-true}
  N8N_METRICS_INCLUDE_IDENTIFIERS: ${N8N_METRICS_INCLUDE_IDENTIFIERS:-false}
  N8N_DIAGNOSTICS_ENABLED: ${N8N_DIAGNOSTICS_ENABLED:-false}
  N8N_PERSONALIZATION_ENABLED: ${N8N_PERSONALIZATION_ENABLED:-false}
  N8N_VERSION_NOTIFICATIONS_ENABLED: ${N8N_VERSION_NOTIFICATIONS_ENABLED:-false}
  N8N_HIDE_USAGE_PAGE: ${N8N_HIDE_USAGE_PAGE:-true}
  N8N_HIRING_BANNER_ENABLED: ${N8N_HIRING_BANNER_ENABLED:-false}
  N8N_SKIP_WEBHOOK_DEREGISTRATION_ON_SHUTDOWN: ${N8N_SKIP_WEBHOOK_DEREGISTRATION_ON_SHUTDOWN:-true}
  N8N_SECURE_COOKIE: ${N8N_SECURE_COOKIE:-false}
  N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: ${N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS:-true}
  GENERIC_TIMEZONE: ${N8N_TZ:-America/Sao_Paulo}
  TZ: ${N8N_TZ:-America/Sao_Paulo}
  EXECUTIONS_MODE: ${N8N_EXECUTIONS_MODE:-queue}
  QUEUE_HEALTH_CHECK_ACTIVE: ${N8N_QUEUE_HEALTH_CHECK_ACTIVE:-true}
  QUEUE_BULL_REDIS_HOST: n8n-redis
  QUEUE_BULL_REDIS_PORT: 6379
  QUEUE_BULL_REDIS_DB: ${N8N_REDIS_DB:-0}
  QUEUE_BULL_REDIS_PASSWORD: ${N8N_REDIS_PASSWORD:-redis-pass}
  REDIS_HOST: n8n-redis
  REDIS_PORT: 6379
  REDIS_PASSWORD: ${N8N_REDIS_PASSWORD:-redis-pass}
  N8N_REDIS_TIMEOUT_THRESHOLD: ${N8N_REDIS_TIMEOUT_THRESHOLD:-30000}
  DB_TYPE: postgresdb
  DB_POSTGRESDB_HOST: n8n-postgres
  DB_POSTGRESDB_PORT: 5432
  DB_POSTGRESDB_DATABASE: ${N8N_POSTGRES_DB:-n8n}
  DB_POSTGRESDB_USER: ${N8N_POSTGRES_USER:-n8n}
  DB_POSTGRESDB_PASSWORD: ${N8N_POSTGRES_PASSWORD:-please-change}
  DB_POSTGRESDB_SCHEMA: ${N8N_POSTGRES_SCHEMA:-public}

x-logging-json: &logging-json
  driver: json-file
  options:
    max-size: "10m"
    max-file: "5"

services:
  # ----------------------------------------------------------------------------
  # n8n main UI/API process (queue mode, orchestrates triggers & webhooks)
  # ----------------------------------------------------------------------------
  n8n-app:
    container_name: n8n-app
    image: ${N8N_IMAGE:-n8nio/n8n:latest}
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      <<: *n8n-common-env

    # External port exposure removed; service publicado via Traefik gateway
    volumes:
      - n8n-user-data:/home/node/.n8n
      - n8n-local-files:/home/node/.n8n/local-files

    depends_on:
      n8n-postgres:
        condition: service_healthy
      n8n-redis:
        condition: service_healthy

    networks:
      - n8n_backend
      - tradingsystem_backend # Allow dashboard access via proxy

    logging: *logging-json

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - >
          wget --spider --quiet --tries=1 --timeout=5 "http://${N8N_BASIC_AUTH_USER:-automation}:${N8N_BASIC_AUTH_PASSWORD:-changeme}@127.0.0.1:${N8N_INTERNAL_PORT:-5678}/healthz" || exit 1
      interval: 30s
      timeout: 10s
      retries: 6
      start_period: 45s

    labels:
      - "com.tradingsystem.stack=automation"
      - "com.tradingsystem.tier=application"
      - "com.tradingsystem.service=n8n"
      - "com.tradingsystem.component=automation-platform"
      # Traefik disabled on n8n-app (routed via n8n-proxy instead)

  # ----------------------------------------------------------------------------
  # Nginx proxy for iframe embedding support
  # ----------------------------------------------------------------------------
  n8n-proxy:
    container_name: n8n-proxy
    image: img-n8n-proxy:latest
    build:
      context: .
      dockerfile: n8n-proxy/Dockerfile
    restart: unless-stopped

    depends_on:
      n8n-app:
        condition: service_healthy

    networks:
      - n8n_backend
      - tradingsystem_backend

    logging: *logging-json

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - wget --spider --quiet --tries=1 --timeout=5 http://127.0.0.1:80/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    labels:
      - "com.tradingsystem.stack=automation"
      - "com.tradingsystem.tier=gateway"
      - "com.tradingsystem.service=n8n-proxy"
      - "com.tradingsystem.component=nginx-proxy"

      # Traefik Configuration (routes to proxy on port 80)
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"

      # HTTP Router
      - "traefik.http.routers.n8n.rule=PathPrefix(`/n8n`)"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.routers.n8n.service=n8n"
      - "traefik.http.routers.n8n.priority=80"
      - "traefik.http.routers.n8n.middlewares=n8n-dashboard-auth-header"

      # Service (proxy listens on port 80)
      - "traefik.http.services.n8n.loadbalancer.server.port=80"

      # Middleware (NO strip - nginx-proxy handles /n8n prefix internally)
      # REMOVED: stripprefix causes nginx to receive /assets/* without /n8n prefix
      # - "traefik.http.routers.n8n.middlewares=n8n-stripprefix"
      # - "traefik.http.middlewares.n8n-stripprefix.stripprefix.prefixes=/n8n"

      # Health checks
      - "traefik.http.services.n8n.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.n8n.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.n8n.loadbalancer.healthcheck.timeout=10s"
      - "traefik.http.middlewares.n8n-dashboard-auth-header.headers.customrequestheaders.Authorization=Basic YXV0b21hdGlvbjpNYXJjZWxvMTIzQA=="

  # ----------------------------------------------------------------------------
  # Dedicated worker to execute jobs from the Bull queue
  # ----------------------------------------------------------------------------
  n8n-worker:
    container_name: n8n-worker
    image: ${N8N_IMAGE:-n8nio/n8n:latest}
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      <<: *n8n-common-env

    command:
      - worker
      - --concurrency
      - "${N8N_WORKER_CONCURRENCY:-5}"

    volumes:
      - n8n-user-data:/home/node/.n8n
      - n8n-local-files:/home/node/.n8n/local-files

    depends_on:
      n8n-postgres:
        condition: service_healthy
      n8n-redis:
        condition: service_healthy

    networks:
      - n8n_backend
      - tradingsystem_backend # Allow dashboard access via proxy

    logging: *logging-json

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - pgrep -f "n8n worker" >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ----------------------------------------------------------------------------
  # PostgreSQL – workflow persistence
  # ----------------------------------------------------------------------------
  n8n-postgres:
    container_name: n8n-postgres
    image: ${N8N_POSTGRES_IMAGE:-postgres:16-alpine}
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      POSTGRES_DB: ${N8N_POSTGRES_DB:-n8n}
      POSTGRES_USER: ${N8N_POSTGRES_USER:-n8n}
      POSTGRES_PASSWORD: ${N8N_POSTGRES_PASSWORD:-please-change}
      TZ: ${N8N_TZ:-America/Sao_Paulo}

    command: >
      postgres
      -c max_connections=${N8N_POSTGRES_MAX_CONNECTIONS:-200}
      -c shared_buffers=${N8N_POSTGRES_SHARED_BUFFERS:-256MB}
      -c timezone=${N8N_TZ:-America/Sao_Paulo}
      -c wal_level=logical

    # External port exposure removed; service reachable only via Docker network
    volumes:
      - n8n-postgres-data:/var/lib/postgresql/data

    networks:
      - n8n_backend
      - tradingsystem_backend # Allow dashboard access via proxy

    logging: *logging-json

    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${N8N_POSTGRES_USER:-n8n} -d ${N8N_POSTGRES_DB:-n8n}
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s

  # ----------------------------------------------------------------------------
  # Redis – Bull queue backend + event bus
  # ----------------------------------------------------------------------------
  n8n-redis:
    container_name: n8n-redis
    image: ${N8N_REDIS_IMAGE:-redis:7-alpine}
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    command: >
      sh -c "redis-server --requirepass ${N8N_REDIS_PASSWORD:-redis-pass} --appendonly yes --maxmemory-policy allkeys-lru"

    # External port exposure removed; service reachable only via Docker network
    volumes:
      - n8n-redis-data:/data

    networks:
      - n8n_backend
      - tradingsystem_backend # Allow dashboard access via proxy

    logging: *logging-json

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - >
          redis-cli -h 127.0.0.1 -p 6379 -a ${N8N_REDIS_PASSWORD:-redis-pass} ping | grep -q PONG
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s

networks:
  n8n_backend:
    external: true
  tradingsystem_backend:
    external: true

volumes:
  n8n-user-data:
  n8n-local-files:
  n8n-postgres-data:
  n8n-redis-data:
