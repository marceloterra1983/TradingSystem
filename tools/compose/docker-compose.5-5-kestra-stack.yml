name: 5-5-kestra-stack

services:
  # ============================================================================
  # Kestra Orchestrator
  # ============================================================================
  kestra:
    image: kestra/kestra:latest
    container_name: kestra
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://kestra-postgres:5432/${KESTRA_DB_NAME:-kestra}
            driverClassName: org.postgresql.Driver
            username: ${KESTRA_DB_USER:-kestra}
            password: ${KESTRA_DB_PASSWORD:-kestra_password_change_in_production}
        kestra:
          repository:
            type: postgres
          storage:
            type: local
            local:
              basePath: "/app/storage"
          queue:
            type: postgres
          server:
            basicAuth:
              username: ${KESTRA_BASICAUTH_USERNAME:-admin@tradingsystem.local}
              password: ${KESTRA_BASICAUTH_PASSWORD:-ChangeMe123!}
          tasks:
            tmpDir:
              path: /tmp/kestra-wd/tmp
          url: http://kestra:8080/

    volumes:
      - "${KESTRA_WORKDIR_DIR:-../kestra/workdir}:/tmp/kestra-wd"
      - "${KESTRA_STORAGE_DIR:-../kestra/storage}:/app/storage"

    networks:
      - tradingsystem_backend
      - kestra_internal

    depends_on:
      kestra-postgres:
        condition: service_healthy

    command: ["server", "standalone"]

    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8081/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

    labels:
      - "com.tradingsystem.stack=5-5-kestra-stack"
      - "com.tradingsystem.service=kestra"
      - "com.tradingsystem.tier=orchestrator"
      - "traefik.enable=true"
      - "traefik.http.routers.kestra.rule=PathPrefix(`/kestra`)"
      - "traefik.http.routers.kestra.entrypoints=web"
      - "traefik.http.routers.kestra.service=kestra-ui"
      - "traefik.http.routers.kestra.middlewares=kestra-strip,static-standard@file"
      - "traefik.http.middlewares.kestra-strip.stripprefix.prefixes=/kestra"
      - "traefik.http.services.kestra-ui.loadbalancer.server.port=8080"
      - "traefik.http.services.kestra-ui.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.kestra-ui.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.kestra-ui.loadbalancer.healthcheck.timeout=10s"
      - "traefik.http.routers.kestra-management.rule=PathPrefix(`/kestra-management`)"
      - "traefik.http.routers.kestra-management.entrypoints=web"
      - "traefik.http.routers.kestra-management.service=kestra-management"
      - "traefik.http.routers.kestra-management.middlewares=kestra-management-strip,api-standard@file"
      - "traefik.http.middlewares.kestra-management-strip.stripprefix.prefixes=/kestra-management"
      - "traefik.http.services.kestra-management.loadbalancer.server.port=8081"
      - "traefik.http.services.kestra-management.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.kestra-management.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.kestra-management.loadbalancer.healthcheck.timeout=10s"

  # ============================================================================
  # Kestra Postgres
  # ============================================================================
  kestra-postgres:
    image: postgres:15-alpine
    container_name: kestra-postgres
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${KESTRA_DB_NAME:-kestra}
      POSTGRES_USER: ${KESTRA_DB_USER:-kestra}
      POSTGRES_PASSWORD: ${KESTRA_DB_PASSWORD:-kestra_password_change_in_production}

    volumes:
      - kestra-postgres-data:/var/lib/postgresql/data

    networks:
      - kestra_internal

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KESTRA_DB_USER:-kestra} -d ${KESTRA_DB_NAME:-kestra}"]
      interval: 10s
      timeout: 5s
      retries: 5

    labels:
      - "com.tradingsystem.stack=5-5-kestra-stack"
      - "com.tradingsystem.service=kestra-postgres"
      - "com.tradingsystem.tier=database"

networks:
  tradingsystem_backend:
    external: true
  kestra_internal:
    external: true

volumes:
  kestra-postgres-data:
    driver: local
