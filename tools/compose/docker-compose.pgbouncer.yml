version: '3.8'

#
# PgBouncer Connection Pooling Stack
# OPT-003: Improve database connection efficiency with connection pooling
# Expected Impact: ~45ms query latency reduction, 5x connection capacity increase
#

services:
  # ============================================================================
  # PgBouncer - TimescaleDB Connection Pooler
  # ============================================================================
  pgbouncer:
    image: edoburu/pgbouncer:1.21.0
    container_name: pgbouncer
    restart: unless-stopped

    environment:
      # Database connections (format: dbname=host=X port=Y dbname=Z)
      - DB_USER=timescale
      - DB_PASSWORD=timescale
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=postgres

      # PgBouncer pooling mode
      # session: Server connection released when client disconnects (safest, default)
      # transaction: Server connection released after transaction completes (recommended)
      # statement: Server connection released after each statement (aggressive)
      - POOL_MODE=transaction

      # Connection pool sizes
      - MAX_CLIENT_CONN=1000           # Max client connections
      - DEFAULT_POOL_SIZE=20           # Default pool size per user/database
      - MIN_POOL_SIZE=5                # Min pool size (keep-alive connections)
      - RESERVE_POOL_SIZE=5            # Reserve connections for high-priority clients
      - MAX_DB_CONNECTIONS=20          # Max connections to database per pool
      - MAX_USER_CONNECTIONS=50        # Max connections per user

      # Connection timeouts
      - SERVER_LIFETIME=3600           # Close server connection after 1 hour
      - SERVER_IDLE_TIMEOUT=600        # Close idle server connection after 10 min
      - SERVER_CONNECT_TIMEOUT=15      # Server connection timeout
      - SERVER_LOGIN_RETRY=15          # Retry server connection after 15s
      - QUERY_TIMEOUT=0                # No query timeout (0 = disabled)
      - QUERY_WAIT_TIMEOUT=120         # Client waits 2min for server connection
      - CLIENT_IDLE_TIMEOUT=0          # No client idle timeout (0 = disabled)
      - CLIENT_LOGIN_TIMEOUT=60        # Client login timeout

      # Logging
      - LOG_CONNECTIONS=1              # Log connections
      - LOG_DISCONNECTIONS=1           # Log disconnections
      - LOG_POOLER_ERRORS=1            # Log pooler errors
      - STATS_PERIOD=60                # Stats logging every 60s

      # Performance tuning
      - SO_REUSEPORT=1                 # Enable SO_REUSEPORT for better performance
      - TCP_KEEPALIVE=1                # Enable TCP keepalive
      - TCP_KEEPIDLE=600               # TCP keepalive idle time (10 min)
      - TCP_KEEPINTVL=30               # TCP keepalive interval
      - TCP_KEEPCNT=5                  # TCP keepalive count

    ports:
      - "6432:5432"                    # PgBouncer port (external:internal)

    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro

    networks:
      - tradingsystem-network

    healthcheck:
      test: ["CMD", "psql", "-h", "localhost", "-U", "timescale", "-d", "pgbouncer", "-c", "SHOW POOLS"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    labels:
      - "com.tradingsystem.service=pgbouncer"
      - "com.tradingsystem.optimization=OPT-003"
      - "com.tradingsystem.description=Connection pooler for TimescaleDB"

networks:
  tradingsystem-network:
    external: true
