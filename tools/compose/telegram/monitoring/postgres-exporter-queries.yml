# ==============================================================================
# Custom Postgres Exporter Queries for Telegram Stack
# ==============================================================================

pg_database:
  query: |
    SELECT 
      datname,
      numbackends as connections,
      xact_commit as transactions_committed,
      xact_rollback as transactions_rolled_back,
      blks_read as blocks_read,
      blks_hit as blocks_hit,
      tup_returned as tuples_returned,
      tup_fetched as tuples_fetched,
      tup_inserted as tuples_inserted,
      tup_updated as tuples_updated,
      tup_deleted as tuples_deleted,
      conflicts,
      temp_files,
      temp_bytes,
      deadlocks,
      blk_read_time,
      blk_write_time
    FROM pg_stat_database
    WHERE datname = current_database()
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - connections:
        usage: "GAUGE"
        description: "Number of backends currently connected to this database"
    - transactions_committed:
        usage: "COUNTER"
        description: "Number of transactions committed"
    - transactions_rolled_back:
        usage: "COUNTER"
        description: "Number of transactions rolled back"
    - blocks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read"
    - blocks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits (cache)"
    - tuples_returned:
        usage: "COUNTER"
        description: "Number of rows returned by queries"
    - tuples_fetched:
        usage: "COUNTER"
        description: "Number of rows fetched by queries"
    - tuples_inserted:
        usage: "COUNTER"
        description: "Number of rows inserted"
    - tuples_updated:
        usage: "COUNTER"
        description: "Number of rows updated"
    - tuples_deleted:
        usage: "COUNTER"
        description: "Number of rows deleted"

pg_stat_statements:
  query: |
    SELECT
      queryid,
      query,
      calls,
      total_exec_time as total_time_seconds,
      mean_exec_time as mean_time_seconds,
      stddev_exec_time as stddev_time_seconds,
      min_exec_time as min_time_seconds,
      max_exec_time as max_time_seconds,
      rows,
      shared_blks_hit,
      shared_blks_read,
      100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0) AS cache_hit_ratio
    FROM pg_stat_statements
    WHERE query NOT LIKE '%pg_stat%'
    ORDER BY total_exec_time DESC
    LIMIT 100
  metrics:
    - queryid:
        usage: "LABEL"
        description: "Query ID"
    - query:
        usage: "LABEL"
        description: "Query text (truncated)"
    - calls:
        usage: "COUNTER"
        description: "Number of times executed"
    - total_time_seconds:
        usage: "COUNTER"
        description: "Total time spent executing query"
    - mean_time_seconds:
        usage: "GAUGE"
        description: "Average execution time"
    - rows:
        usage: "COUNTER"
        description: "Total rows returned/affected"
    - cache_hit_ratio:
        usage: "GAUGE"
        description: "Buffer cache hit percentage"

pg_locks:
  query: |
    SELECT
      mode,
      locktype,
      COUNT(*) as lock_count
    FROM pg_locks
    WHERE granted = true
    GROUP BY mode, locktype
  metrics:
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - locktype:
        usage: "LABEL"
        description: "Lock type"
    - lock_count:
        usage: "GAUGE"
        description: "Number of locks"

pg_replication:
  query: |
    SELECT
      application_name,
      state,
      sync_state,
      COALESCE(pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn), 0) as replay_lag_bytes
    FROM pg_stat_replication
  metrics:
    - application_name:
        usage: "LABEL"
        description: "Application name of replica"
    - state:
        usage: "LABEL"
        description: "Replication state"
    - sync_state:
        usage: "LABEL"
        description: "Synchronous state"
    - replay_lag_bytes:
        usage: "GAUGE"
        description: "Replication lag in bytes"

