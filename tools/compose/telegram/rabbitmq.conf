# ==============================================================================
# RabbitMQ Configuration for Telegram Stack
# ==============================================================================
# Purpose: Message queue for pub/sub pattern (optional)
# Expected load: 20-50 msg/s (low for RabbitMQ, can handle 10K+ msg/s)
# ==============================================================================

# -----------------------------------------------------------------------------
# Network Listeners
# -----------------------------------------------------------------------------
listeners.tcp.default = 5672
management.tcp.port = 15672

# -----------------------------------------------------------------------------
# Memory Management
# -----------------------------------------------------------------------------
# High watermark: RabbitMQ starts flow control at 80% of RAM
vm_memory_high_watermark.relative = 0.8

# Paging threshold: Start writing to disk at 75% of high watermark
vm_memory_high_watermark_paging_ratio = 0.75

# -----------------------------------------------------------------------------
# Disk Space Management
# -----------------------------------------------------------------------------
# RabbitMQ stops accepting messages when disk free space < 2GB
disk_free_limit.absolute = 2GB

# -----------------------------------------------------------------------------
# Clustering (for future expansion)
# -----------------------------------------------------------------------------
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_partition_handling = autoheal

# -----------------------------------------------------------------------------
# Performance Tuning
# -----------------------------------------------------------------------------
# Maximum number of channels per connection
channel_max = 2048

# Heartbeat interval (seconds)
heartbeat = 60

# Maximum frame size (bytes)
frame_max = 131072

# TCP listen options
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.linger.on = true
tcp_listen_options.linger.timeout = 0

# -----------------------------------------------------------------------------
# Message Store Settings
# -----------------------------------------------------------------------------
# Queue index embed msgs (optimization for small messages)
queue_index_embed_msgs_below = 4096

# Message store index module
msg_store_index_module = rabbit_msg_store_ets_index

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
log.console = true
log.console.level = info
log.console.formatter = json

# File logging disabled (use Docker logs instead)
log.file = false

# Log categories
log.connection.level = info
log.channel.level = info
log.queue.level = info
log.mirroring.level = info
log.federation.level = info

# -----------------------------------------------------------------------------
# Management Plugin
# -----------------------------------------------------------------------------
management.load_definitions = /etc/rabbitmq/definitions.json

# Disable unnecessary plugins
management.disable_stats = false
management.rates_mode = basic

# -----------------------------------------------------------------------------
# Default User (from environment variables)
# -----------------------------------------------------------------------------
# RABBITMQ_DEFAULT_USER=telegram (set via Docker environment)
# RABBITMQ_DEFAULT_PASS=<password> (set via Docker environment)
# RABBITMQ_DEFAULT_VHOST=telegram (set via Docker environment)

# -----------------------------------------------------------------------------
# Queue Defaults
# -----------------------------------------------------------------------------
# Default queue type (classic = traditional, quorum = replicated)
default_queue_type = classic

# Message TTL (time-to-live) - messages expire after this time if not consumed
# Set to 0 = no expiration (let application control TTL)
default_message_ttl = 0

# -----------------------------------------------------------------------------
# Consumer Prefetch
# -----------------------------------------------------------------------------
# Consumer prefetch count (how many unacked messages per consumer)
consumer_prefetch = 250

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------
# Loopback users (can only connect from localhost)
# loopback_users.guest = false

# SSL/TLS (disabled for local deployment)
# listeners.ssl.default = 5671
# ssl_options.cacertfile = /path/to/ca_certificate.pem
# ssl_options.certfile = /path/to/server_certificate.pem
# ssl_options.keyfile = /path/to/server_key.pem

