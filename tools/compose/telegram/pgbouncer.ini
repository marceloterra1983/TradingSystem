;; ==============================================================================
;; PgBouncer Configuration for Telegram Stack
;; ==============================================================================
;; Clients: MTProto Gateway (native), TP Capital Worker, Gateway API
;; Expected concurrency: 3 services Ã— ~5-10 connections each = ~30 client connections
;; Pool size: 20 server connections (transaction mode)
;; ==============================================================================

[databases]
;; Database connections (format: dbname = host=X port=Y dbname=Z)
telegram_gateway = host=telegram-timescale port=5432 dbname=telegram_gateway
pgbouncer = host=telegram-timescale port=5432 dbname=pgbouncer

[pgbouncer]
;; Network settings
listen_addr = 0.0.0.0
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; Pooling mode
;; - session: Server connection released when client disconnects (safest)
;; - transaction: Server connection released after transaction (RECOMMENDED)
;; - statement: Server connection released after each statement (aggressive)
pool_mode = transaction

;; Connection pool sizes
max_client_conn = 100              ;; Maximum client connections
default_pool_size = 20             ;; Default pool size per database
min_pool_size = 5                  ;; Minimum pool size (keep-alive)
reserve_pool_size = 5              ;; Reserve for high-priority clients
reserve_pool_timeout = 3           ;; Timeout for reserve pool (seconds)
max_db_connections = 20            ;; Max connections to TimescaleDB per pool
max_user_connections = 50          ;; Max connections per user

;; Connection timeouts
server_lifetime = 3600             ;; Close server connection after 1 hour
server_idle_timeout = 600          ;; Close idle server connection after 10 min
server_connect_timeout = 15        ;; Server connection timeout
server_login_retry = 15            ;; Retry server connection after 15s
query_timeout = 0                  ;; No query timeout (0 = disabled)
query_wait_timeout = 120           ;; Client waits 2min for server connection
client_idle_timeout = 0            ;; No client idle timeout
client_login_timeout = 60          ;; Client login timeout

;; Logging
log_connections = 1                ;; Log new connections
log_disconnections = 1             ;; Log disconnections
log_pooler_errors = 1              ;; Log pooler errors
stats_period = 60                  ;; Stats logging interval (seconds)
verbose = 0                        ;; Verbosity level (0-2)

;; Admin interface
admin_users = telegram             ;; Admin users (can use SHOW commands)
stats_users = telegram             ;; Stats users (can view stats)

;; Performance tuning
so_reuseport = 1                   ;; Enable SO_REUSEPORT for better performance
tcp_keepalive = 1                  ;; Enable TCP keepalive
tcp_keepidle = 600                 ;; TCP keepalive idle time (10 min)
tcp_keepintvl = 30                 ;; TCP keepalive interval
tcp_keepcnt = 5                    ;; TCP keepalive probe count
tcp_socket_buffer = 0              ;; Use OS default socket buffer
tcp_defer_accept = 1               ;; Defer TCP accept for better performance

;; Security
ignore_startup_parameters = extra_float_digits,options

;; Dangerous timeouts (keep disabled)
server_check_delay = 30            ;; Check server health every 30s
server_check_query = SELECT 1      ;; Health check query
server_fast_close = 0              ;; Don't use fast close (wait for clean shutdown)

;; Application name passthrough
application_name_add_host = 1      ;; Add client host to application_name

