name: 1-dashboard-stack

services:
  dashboard:
    container_name: dashboard-ui
    image: img-dashboard-ui
    build:
      context: ../..
      dockerfile: frontend/dashboard/Dockerfile
    env_file:
      - ../../.env
      - ../../.env.shared
    ports:
      - "8090:3103"  # Expose dashboard on port 8090
    environment:
      - DASHBOARD_PORT=${DASHBOARD_PORT:-9080}
      - SKIP_DASHBOARD_PREBUILD=1
      - VITE_USE_UNIFIED_DOMAIN=${VITE_USE_UNIFIED_DOMAIN:-true}
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:9080}
      # Override URLs for containerized environment (use Vite proxy instead of direct URLs)
      # Traefik Gateway defaults (override via env caso seja necess√°rio expor portas diretas)
      - TP_CAPITAL_PROXY_TARGET=${TP_CAPITAL_PROXY_TARGET:-http://api-gateway:9080/api/tp-capital}
      - VITE_TELEGRAM_GATEWAY_PROXY_TARGET=${VITE_TELEGRAM_GATEWAY_PROXY_TARGET:-http://telegram-gateway-api:4010/api/telegram-gateway}
      - VITE_TELEGRAM_GATEWAY_API_URL=${VITE_TELEGRAM_GATEWAY_API_URL:-http://localhost:9080/api/telegram-gateway}
      - WORKSPACE_PROXY_TARGET=${WORKSPACE_PROXY_TARGET:-http://api-gateway:9080/api/workspace}
      - WORKSPACE_LIBRARY_PROXY_TARGET=${WORKSPACE_LIBRARY_PROXY_TARGET:-http://api-gateway:9080/api/library}
      - DOCUSAURUS_PROXY_TARGET=${DOCUSAURUS_PROXY_TARGET:-http://api-gateway:9080/docs}
      - VITE_DOCUSAURUS_URL=/
      - DOCS_API_PROXY_TARGET=${DOCS_API_PROXY_TARGET:-http://api-gateway:9080/api/docs}
      # Telegram Gateway API Keys (for frontend authentication)
      - VITE_GATEWAY_TOKEN=${TELEGRAM_GATEWAY_API_TOKEN:-gw_secret_9K7j2mPq8nXwR5tY4vL1zD3fH6bN0sA}
      - VITE_TELEGRAM_GATEWAY_API_TOKEN=${TELEGRAM_GATEWAY_API_TOKEN:-gw_secret_9K7j2mPq8nXwR5tY4vL1zD3fH6bN0sA}
      - VITE_API_SECRET_TOKEN=${API_SECRET_TOKEN:-gw_secret_9K7j2mPq8nXwR5tY4vL1zD3fH6bN0sA}
      # n8n proxy configuration (server-side only, NOT exposed to browser)
      # NOTE: No VITE_ prefix! This is server-side only (Vite proxy target)
      - N8N_PROXY_TARGET=http://n8n-proxy:80
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-automation}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-changeme}
      # Course Crawler UI: Browser-facing URL (must use localhost for host browser access)
      - VITE_COURSE_CRAWLER_APP_URL=http://localhost:4201
      # Database UI proxies - Via Docker bridge gateway (workaround for WSL2 network isolation)
      - DB_UI_PGADMIN_PROXY_TARGET=${DB_UI_PGADMIN_PROXY_TARGET:-http://api-gateway:9080/db/pgadmin}
      - DB_UI_PGWEB_PROXY_TARGET=${DB_UI_PGWEB_PROXY_TARGET:-http://api-gateway:9080/db/pgweb}
      - DB_UI_ADMINER_PROXY_TARGET=${DB_UI_ADMINER_PROXY_TARGET:-http://api-gateway:9080/db/adminer}
      - DB_UI_QUESTDB_PROXY_TARGET=${DB_UI_QUESTDB_PROXY_TARGET:-http://api-gateway:9080/db/questdb}
    networks:
      - tradingsystem_frontend
      - tradingsystem_backend  # Hub network for API access (proxy)
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3103/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    labels:
      - "com.tradingsystem.stack=frontend-ui"
      - "com.tradingsystem.service=dashboard"

      # ========================================================================
      # Traefik Configuration - API Gateway Integration
      # ========================================================================
      # Enable Traefik routing for dashboard UI
      - "traefik.enable=true"

      # HTTP Router Configuration
      - "traefik.http.routers.dashboard-ui.rule=PathPrefix(`/`) && !PathPrefix(`/db-ui/`) && !PathPrefix(`/api/`) && !PathPrefix(`/docs/`)"
      - "traefik.http.routers.dashboard-ui.entrypoints=web"
      - "traefik.http.routers.dashboard-ui.service=dashboard-ui"
      - "traefik.http.routers.dashboard-ui.priority=1"  # Lowest priority - catch-all (excluding /db-ui/, /api/, /docs/)

      # Service Configuration (backend target)
      - "traefik.http.services.dashboard-ui.loadbalancer.server.port=3103"

      # Middlewares (no path transformation needed - direct passthrough)
      - "traefik.http.routers.dashboard-ui.middlewares=static-standard@file"

      # Health Check
      - "traefik.http.services.dashboard-ui.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.dashboard-ui.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.dashboard-ui.loadbalancer.healthcheck.timeout=5s"

networks:
  tradingsystem_frontend:
    external: true
  tradingsystem_backend:
    external: true
