name: 4-2-telegram-stack

# ==============================================================================
# Telegram Monitoring Stack - 4 Containers
# ==============================================================================
# Components: Prometheus, Grafana, Postgres Exporter, Redis Exporter
# Purpose: Comprehensive monitoring and alerting for Telegram stack
# Resources: 2 CPU, 2GB RAM total
# ==============================================================================

services:
  # ============================================================================
  # 1. Prometheus - Metrics Collection & Alerting
  # ============================================================================
  telegram-prometheus:
    container_name: telegram-prometheus
    image: prom/prometheus:v2.48.0
    restart: unless-stopped
    
    ports:
      - "${TELEGRAM_PROMETHEUS_PORT:-9090}:9090"
    
    volumes:
      - ./telegram/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./telegram/monitoring/alerts:/etc/prometheus/alerts:ro
      - telegram-prometheus-data:/prometheus
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:9090/-/healthy']
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    
    networks:
      - telegram_backend
      - tradingsystem_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=monitoring"
      - "com.tradingsystem.service=prometheus"
      - "com.tradingsystem.description=Metrics collection and alerting engine"

  # ============================================================================
  # 2. Grafana - Visualization & Dashboards
  # ============================================================================
  telegram-grafana:
    container_name: telegram-grafana
    image: grafana/grafana:10.2.2
    restart: unless-stopped
    
    ports:
      - "${TELEGRAM_GRAFANA_PORT:-3100}:3000"
    
    environment:
      # Security
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_SECURITY_SECRET_KEY=${GRAFANA_SECRET_KEY:-change_this_secret_key}
      
      # Server
      - GF_SERVER_ROOT_URL=http://localhost:3100
      - GF_SERVER_SERVE_FROM_SUB_PATH=false
      
      # Database (using SQLite for simplicity)
      - GF_DATABASE_TYPE=sqlite3
      - GF_DATABASE_PATH=/var/lib/grafana/grafana.db
      
      # Plugins
      - GF_INSTALL_PLUGINS=redis-datasource,marcusolsson-json-datasource
      
      # Analytics (disable telemetry)
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
    
    volumes:
      - telegram-grafana-data:/var/lib/grafana
      - ./telegram/monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./telegram/monitoring/dashboards:/etc/grafana/provisioning/dashboards:ro
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    
    # Note: Services connect via network, no depends_on needed
    
    healthcheck:
      test: ['CMD-SHELL', 'wget --quiet --tries=1 --spider http://localhost:3000/api/health || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=monitoring"
      - "com.tradingsystem.service=grafana"
      - "com.tradingsystem.description=Visualization dashboards (6 pre-configured)"

  # ============================================================================
  # 3. Postgres Exporter - TimescaleDB Metrics
  # ============================================================================
  telegram-postgres-exporter:
    container_name: telegram-postgres-exporter
    image: prometheuscommunity/postgres-exporter:v0.15.0
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    
    environment:
      DATA_SOURCE_URI: "telegram-timescale:5432/telegram_gateway?sslmode=disable"
      DATA_SOURCE_USER: ${TELEGRAM_DB_USER:-telegram}
      DATA_SOURCE_PASS: ${TELEGRAM_DB_PASSWORD}
      PG_EXPORTER_EXTEND_QUERY_PATH: "/etc/postgres-exporter/queries.yml"
    
    ports:
      - "${TELEGRAM_POSTGRES_EXPORTER_PORT:-9187}:9187"
    
    volumes:
      - ./telegram/monitoring/postgres-exporter-queries.yml:/etc/postgres-exporter/queries.yml:ro
    
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    # Note: TimescaleDB is in separate compose file, connect via network
    # Remove depends_on since services are in different compose files
    
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:9187/metrics']
      interval: 10s
      timeout: 5s
      retries: 3
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=monitoring"
      - "com.tradingsystem.service=postgres-exporter"
      - "com.tradingsystem.description=TimescaleDB metrics exporter"

  # ============================================================================
  # 4. Redis Exporter - Cache Metrics
  # ============================================================================
  telegram-redis-exporter:
    container_name: telegram-redis-exporter
    image: oliver006/redis_exporter:v1.55.0-alpine
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    
    environment:
      REDIS_ADDR: "telegram-redis-master:6379"
      REDIS_EXPORTER_CHECK_KEYS: "telegram:*"
      REDIS_EXPORTER_CHECK_SINGLE_KEYS: "telegram:dedup:*,telegram:msg:*"
    
    ports:
      - "${TELEGRAM_REDIS_EXPORTER_PORT:-9121}:9121"
    
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    
    # Note: Redis master is in separate compose file, connect via network
    
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:9121/metrics']
      interval: 10s
      timeout: 5s
      retries: 3
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=monitoring"
      - "com.tradingsystem.service=redis-exporter"
      - "com.tradingsystem.description=Redis cache metrics exporter"

volumes:
  telegram-prometheus-data:
    name: telegram-prometheus-data
  telegram-grafana-data:
    name: telegram-grafana-data

networks:
  telegram_backend:
    external: true
  tradingsystem_backend:
    external: true
