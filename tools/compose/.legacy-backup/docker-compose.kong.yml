version: '3.8'

name: kong-gateway

services:
  # ============================================================
  # Kong Database (PostgreSQL 15)
  # Stores Kong configuration, routes, plugins, consumers
  # ============================================================
  kong-db:
    image: postgres:15-alpine
    container_name: kong-db
    hostname: kong-db
    ports:
      - "${KONG_DB_PORT:-5433}:5432"
    environment:
      POSTGRES_USER: ${KONG_DB_USER:-kong}
      POSTGRES_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      POSTGRES_DB: ${KONG_DB_NAME:-kong}
    volumes:
      - kong_data:/var/lib/postgresql/data
    networks:
      - tradingsystem_backend
      - kong_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong -d kong"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    labels:
      - "com.tradingsystem.service=kong-db"
      - "com.tradingsystem.category=database"

  # ============================================================
  # Kong Migrations (One-time bootstrap)
  # Runs database migrations on first startup
  # ============================================================
  kong-migrations:
    image: kong:${KONG_VERSION:-3.4-alpine}
    container_name: kong-migrations
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_PORT: 5432
      KONG_PG_USER: ${KONG_DB_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      KONG_PG_DATABASE: ${KONG_DB_NAME:-kong}
    networks:
      - kong_network
    depends_on:
      kong-db:
        condition: service_healthy
    restart: "no"
    labels:
      - "com.tradingsystem.service=kong-migrations"
      - "com.tradingsystem.category=setup"

  # ============================================================
  # Kong Gateway (Main API Gateway)
  # Handles routing, authentication, rate limiting, logging
  # ============================================================
  kong-gateway:
    image: kong:${KONG_VERSION:-3.4-alpine}
    container_name: kong-gateway
    hostname: kong-gateway
    ports:
      - "${KONG_PROXY_PORT:-8000}:8000"        # HTTP Proxy
      - "${KONG_PROXY_SSL_PORT:-8443}:8443"    # HTTPS Proxy
      - "${KONG_ADMIN_PORT:-8001}:8001"        # Admin API
      - "${KONG_ADMIN_SSL_PORT:-8444}:8444"    # Admin API (HTTPS)
    environment:
      # Database Configuration
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_PORT: 5432
      KONG_PG_USER: ${KONG_DB_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      KONG_PG_DATABASE: ${KONG_DB_NAME:-kong}
      
      # Proxy Configuration
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_PROXY_LISTEN_SSL: 0.0.0.0:8443
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_LISTEN_SSL: 0.0.0.0:8444
      
      # Performance & Security
      KONG_NGINX_HTTP_CLIENT_MAX_BODY_SIZE: 50m
      KONG_NGINX_HTTP_CLIENT_BODY_BUFFER_SIZE: 1m
      KONG_REAL_IP_HEADER: X-Forwarded-For
      KONG_TRUSTED_IPS: 0.0.0.0/0,::/0
      
      # Plugins
      KONG_PLUGINS: bundled,jwt,rate-limiting,cors,request-transformer,response-transformer,prometheus
      
      # Declarative Configuration (optional)
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
      
      # Logging
      KONG_LOG_LEVEL: ${KONG_LOG_LEVEL:-info}
      KONG_ANONYMOUS_REPORTS: "off"
    volumes:
      # Declarative configuration (if using DB-less mode)
      - ../kong/kong-declarative.yml:/etc/kong/kong.yml:ro
      
      # Custom plugins (if any)
      - ../kong/plugins:/usr/local/share/lua/5.1/kong/plugins
    networks:
      - tradingsystem_backend
      - kong_network
    depends_on:
      kong-migrations:
        condition: service_completed_successfully
      kong-db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
    labels:
      - "com.tradingsystem.service=kong-gateway"
      - "com.tradingsystem.category=api-gateway"

  # ============================================================
  # Konga (Kong Admin UI)
  # Web interface for managing Kong configuration
  # ============================================================
  konga:
    image: pantsel/konga:latest
    container_name: konga
    hostname: konga
    ports:
      - "${KONGA_PORT:-1337}:1337"
    environment:
      # Database Configuration (uses Kong's PostgreSQL)
      DB_ADAPTER: postgres
      DB_HOST: kong-db
      DB_PORT: 5432
      DB_USER: ${KONG_DB_USER:-kong}
      DB_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      DB_DATABASE: ${KONGA_DB_NAME:-konga}
      
      # Konga Configuration
      NODE_ENV: ${NODE_ENV:-production}
      KONGA_HOOK_TIMEOUT: 120000
      
      # Admin Credentials (first user)
      KONGA_SEED_USER_DATA_SOURCE_FILE: /app/userdb.data
      NO_AUTH: "false"
    volumes:
      # User seed file (optional, for auto-creating admin user)
      - ../kong/konga-userdb.data:/app/userdb.data:ro
    networks:
      - kong_network
    depends_on:
      kong-db:
        condition: service_healthy
      kong-gateway:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:1337"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    labels:
      - "com.tradingsystem.service=konga"
      - "com.tradingsystem.category=admin-ui"

# ============================================================
# Networks
# ============================================================
networks:
  tradingsystem_backend:
    external: true
    name: tradingsystem_backend
  
  kong_network:
    driver: bridge
    name: kong_network

# ============================================================
# Volumes
# ============================================================
volumes:
  kong_data:
    driver: local
    name: kong_data
