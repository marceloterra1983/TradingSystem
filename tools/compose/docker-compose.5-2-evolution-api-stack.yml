# ==============================================================================
# Evolution API Stack - WhatsApp Orchestration via EvolutionAPI
# ==============================================================================
# Components:
#   1. PostgreSQL 16 + PgBouncer (Prisma backend)
#   2. Redis cache for hot state / event buffers
#   3. MinIO (S3-compatible media storage) + bootstrap job
#   4. Evolution API (core service) + Evolution Manager UI
# Networking: Dedicated bridge network `evolution_backend`
# Configuration: inherits env from ../../.env and ../../.env.shared
# ==============================================================================

name: 5-2-evolution-api-stack

services:
  # ============================================================================
  # PostgreSQL 16 (primary data store for Evolution API)
  # ============================================================================
  evolution-postgres:
    container_name: evolution-postgres
    image: postgres:16-alpine
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      POSTGRES_DB: ${EVOLUTION_DB_NAME:-evolution}
      POSTGRES_USER: ${EVOLUTION_DB_USER:-evolution}
      POSTGRES_PASSWORD: ${EVOLUTION_DB_PASSWORD:-evolutiondb}
      TZ: ${EVOLUTION_TZ:-UTC}

    command: >
      postgres
      -c listen_addresses='*'
      -c port=5432
      -c max_connections=500
      -c superuser_reserved_connections=5
      -c shared_buffers=512MB
      -c effective_cache_size=1536MB
      -c maintenance_work_mem=256MB
      -c work_mem=8MB
      -c wal_buffers=16MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c checkpoint_completion_target=0.9
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c synchronous_commit=off
      -c max_wal_senders=0
      -c autovacuum=on
      -c autovacuum_naptime=15s
      -c autovacuum_max_workers=5
      -c autovacuum_vacuum_scale_factor=0.02
      -c autovacuum_analyze_scale_factor=0.01
      -c shared_preload_libraries='pg_stat_statements'
      -c "pg_stat_statements.max=5000"
      -c "pg_stat_statements.track=all"
      -c log_destination='stderr'
      -c logging_collector=on
      -c log_directory='log'
      -c log_filename='postgresql-%Y-%m-%d.log'
      -c log_rotation_age='1d'
      -c log_rotation_size=0
      -c log_connections=on
      -c log_disconnections=on
      -c log_checkpoints=on
      -c log_lock_waits=on
      -c log_min_duration_statement='250ms'
      -c log_statement='ddl'
      -c timezone='UTC'

    ports:
      - "${EVOLUTION_DB_HOST_BIND:-127.0.0.1}:${EVOLUTION_DB_PORT:-5437}:5432"

    volumes:
      - evolution-postgres-data:/var/lib/postgresql/data

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '1.0'
          memory: 1.5G

    healthcheck:
      test:
        - CMD-SHELL
        - >
          pg_isready -U ${EVOLUTION_DB_USER:-evolution} -d ${EVOLUTION_DB_NAME:-evolution}
          && psql -U ${EVOLUTION_DB_USER:-evolution} -d ${EVOLUTION_DB_NAME:-evolution} -tAc "SELECT 1" >/dev/null
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 45s

    networks:
      - evolution_backend

    labels:
      - "com.tradingsystem.stack=evolution-api"
      - "com.tradingsystem.tier=data"
      - "com.tradingsystem.service=postgres"
      - "com.tradingsystem.component=database"
      - "com.tradingsystem.description=Primary PostgreSQL for Evolution API"

  # ============================================================================
  # PgBouncer - transaction-mode connection pool for Prisma
  # ============================================================================
  evolution-pgbouncer:
    container_name: evolution-pgbouncer
    image: pgbouncer/pgbouncer:latest
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      - DATABASES_HOST=evolution-postgres
      - DATABASES_PORT=5432
      - DATABASES_USER=${EVOLUTION_DB_USER:-evolution}
      - DATABASES_PASSWORD=${EVOLUTION_DB_PASSWORD:-evolutiondb}
      - DATABASES_DBNAME=${EVOLUTION_DB_NAME:-evolution}
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=800
      - DEFAULT_POOL_SIZE=20

    ports:
      - "${EVOLUTION_PGBOUNCER_HOST_BIND:-127.0.0.1}:${EVOLUTION_PGBOUNCER_PORT:-6436}:6432"

    depends_on:
      evolution-postgres:
        condition: service_healthy

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost 6432']
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 10s

    networks:
      - evolution_backend

    labels:
      - "com.tradingsystem.stack=evolution-api"
      - "com.tradingsystem.tier=data"
      - "com.tradingsystem.service=pgbouncer"
      - "com.tradingsystem.component=connection-pooler"
      - "com.tradingsystem.description=PgBouncer pool for Evolution API Prisma workloads"

  # ============================================================================
  # Redis cache (sessions, webhook buffers, idempotency)
  # ============================================================================
  evolution-redis:
    container_name: evolution-redis
    image: redis:7-alpine
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    command: >
      redis-server
      --port 6379
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --tcp-backlog 511
      --tcp-keepalive 300
      --timeout 0

    ports:
      - "${EVOLUTION_REDIS_HOST_BIND:-127.0.0.1}:${EVOLUTION_REDIS_PORT:-6388}:6379"

    volumes:
      - evolution-redis-data:/data

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s

    networks:
      evolution_backend:
        aliases:
          - evolution-redis

    labels:
      - "com.tradingsystem.stack=evolution-api"
      - "com.tradingsystem.tier=cache"
      - "com.tradingsystem.service=redis"
      - "com.tradingsystem.component=data-cache"
      - "com.tradingsystem.description=Redis cache backing Evolution API sessions"

  # ============================================================================
  # MinIO - S3-compatible media/object storage
  # ============================================================================
  evolution-minio:
    container_name: evolution-minio
    image: quay.io/minio/minio:latest
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      MINIO_ROOT_USER: ${EVOLUTION_MINIO_ROOT_USER:-evolution}
      MINIO_ROOT_PASSWORD: ${EVOLUTION_MINIO_ROOT_PASSWORD:-evolutionminio}
      MINIO_REGION: ${EVOLUTION_MINIO_REGION:-us-east-1}

    command: server /data --console-address ":9001"

    ports:
      - "${EVOLUTION_MINIO_API_HOST_BIND:-127.0.0.1}:${EVOLUTION_MINIO_API_PORT:-9310}:9000"
      - "${EVOLUTION_MINIO_CONSOLE_HOST_BIND:-127.0.0.1}:${EVOLUTION_MINIO_CONSOLE_PORT:-9311}:9001"

    volumes:
      - evolution-minio-data:/data

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - curl -fsS http://127.0.0.1:9000/minio/health/ready > /dev/null
      interval: 15s
      timeout: 5s
      retries: 6
      start_period: 30s

    networks:
      - evolution_backend

    labels:
      - "com.tradingsystem.stack=evolution-api"
      - "com.tradingsystem.tier=object-storage"
      - "com.tradingsystem.service=minio"
      - "com.tradingsystem.component=media-store"
      - "com.tradingsystem.description=MinIO for Evolution API media/S3 integrations"

  # ============================================================================
  # One-shot MinIO bootstrap (bucket + public policy)
  # ============================================================================
  evolution-minio-init:
    container_name: evolution-minio-init
    image: quay.io/minio/mc:latest
    restart: 'no'

    env_file:
      - ../../.env
      - ../../.env.shared

    depends_on:
      evolution-minio:
        condition: service_healthy

    entrypoint: /bin/sh
    command: >
      -c "
        set -euo pipefail;
        mc alias set evo http://evolution-minio:9000 ${EVOLUTION_MINIO_ROOT_USER:-evolution} ${EVOLUTION_MINIO_ROOT_PASSWORD:-evolutionminio};
        if ! mc ls evo/${EVOLUTION_MINIO_BUCKET:-evolution-media} >/dev/null 2>&1; then
          mc mb evo/${EVOLUTION_MINIO_BUCKET:-evolution-media};
        fi;
        mc anonymous set download evo/${EVOLUTION_MINIO_BUCKET:-evolution-media};
      "

    networks:
      - evolution_backend

  # ============================================================================
  # Evolution API (core Baileys/official WhatsApp orchestration layer)
  # ============================================================================
  evolution-api:
    container_name: evolution-api
    image: ${EVOLUTION_API_IMAGE:-evoapicloud/evolution-api:latest}
    restart: unless-stopped

    depends_on:
      evolution-postgres:
        condition: service_healthy
      evolution-pgbouncer:
        condition: service_healthy
      evolution-redis:
        condition: service_healthy
      evolution-minio-init:
        condition: service_completed_successfully

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      NODE_ENV: production
      SERVER_NAME: ${EVOLUTION_SERVER_NAME:-evolution}
      SERVER_TYPE: ${EVOLUTION_SERVER_TYPE:-http}
      SERVER_PORT: ${EVOLUTION_API_INTERNAL_PORT:-8080}
      SERVER_URL: ${EVOLUTION_API_PUBLIC_URL:-http://localhost:4100}
      SSL_CONF_PRIVKEY: ${EVOLUTION_SSL_KEY_PATH:-}
      SSL_CONF_FULLCHAIN: ${EVOLUTION_SSL_CERT_PATH:-}
      DATABASE_PROVIDER: ${EVOLUTION_DATABASE_PROVIDER:-psql_bouncer}
      DATABASE_CONNECTION_URI: postgresql://${EVOLUTION_DB_USER:-evolution}:${EVOLUTION_DB_PASSWORD:-evolutiondb}@${EVOLUTION_DB_HOST:-evolution-pgbouncer}:${EVOLUTION_DB_POOL_PORT:-6432}/${EVOLUTION_DB_NAME:-evolution}?pgbouncer=true&schema=${EVOLUTION_DB_SCHEMA:-evolution_api}
      DATABASE_BOUNCER_CONNECTION_URI: postgresql://${EVOLUTION_DB_USER:-evolution}:${EVOLUTION_DB_PASSWORD:-evolutiondb}@${EVOLUTION_DB_HOST:-evolution-pgbouncer}:${EVOLUTION_DB_POOL_PORT:-6432}/${EVOLUTION_DB_NAME:-evolution}?pgbouncer=true&schema=${EVOLUTION_DB_SCHEMA:-evolution_api}
      DATABASE_CONNECTION_CLIENT_NAME: ${EVOLUTION_DB_CLIENT_NAME:-evolution-stack}
      CACHE_REDIS_ENABLED: ${EVOLUTION_CACHE_REDIS_ENABLED:-true}
      CACHE_REDIS_URI: ${EVOLUTION_CACHE_REDIS_URI:-redis://evolution-redis:6379/6}
      CACHE_REDIS_TTL: ${EVOLUTION_CACHE_REDIS_TTL:-604800}
      CACHE_REDIS_PREFIX_KEY: ${EVOLUTION_CACHE_REDIS_PREFIX_KEY:-evolution}
      CACHE_REDIS_SAVE_INSTANCES: ${EVOLUTION_CACHE_REDIS_SAVE_INSTANCES:-false}
      S3_ENABLED: ${EVOLUTION_S3_ENABLED:-true}
      S3_ACCESS_KEY: ${EVOLUTION_MINIO_ROOT_USER:-evolution}
      S3_SECRET_KEY: ${EVOLUTION_MINIO_ROOT_PASSWORD:-evolutionminio}
      S3_BUCKET: ${EVOLUTION_MINIO_BUCKET:-evolution-media}
      S3_ENDPOINT: ${EVOLUTION_S3_ENDPOINT:-evolution-minio}
      S3_REGION: ${EVOLUTION_MINIO_REGION:-us-east-1}
      S3_PORT: ${EVOLUTION_S3_PORT:-9000}
      S3_USE_SSL: ${EVOLUTION_S3_USE_SSL:-false}
      TELEMETRY_ENABLED: ${EVOLUTION_TELEMETRY_ENABLED:-false}
      PROMETHEUS_METRICS: ${EVOLUTION_PROMETHEUS_METRICS:-true}
      METRICS_AUTH_REQUIRED: ${EVOLUTION_METRICS_AUTH_REQUIRED:-false}
      METRICS_USER: ${EVOLUTION_METRICS_USER:-prometheus}
      METRICS_PASSWORD: ${EVOLUTION_METRICS_PASSWORD:-change-me}
      CORS_ORIGIN: ${EVOLUTION_CORS_ORIGIN:-*}
      CORS_METHODS: ${EVOLUTION_CORS_METHODS:-GET,POST,PUT,DELETE,PATCH}
      CORS_CREDENTIALS: ${EVOLUTION_CORS_CREDENTIALS:-true}
      LOG_LEVEL: ${EVOLUTION_LOG_LEVEL:-ERROR,WARN,DEBUG,INFO,LOG}
      LOG_BAILEYS: ${EVOLUTION_LOG_BAILEYS:-warn}
      EVENT_EMITTER_MAX_LISTENERS: ${EVOLUTION_EVENT_EMITTER_MAX_LISTENERS:-50}
      AUTHENTICATION_ENABLED: ${EVOLUTION_AUTH_ENABLED:-true}
      AUTHENTICATION_TYPE: ${EVOLUTION_AUTH_TYPE:-global}
      AUTHENTICATION_GLOBAL_API_KEY_NAME: ${EVOLUTION_API_GLOBAL_KEY_NAME:-global-key}
      AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES: ${AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES:-false}

    ports:
      - "${EVOLUTION_API_HOST_BIND:-127.0.0.1}:${EVOLUTION_API_PORT:-4100}:8080"

    volumes:
      - evolution-api-instances:/evolution/instances

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    healthcheck:
      test:
        - CMD-SHELL
        - >
          wget -q --spider http://127.0.0.1:8080/ || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    networks:
      - evolution_backend
      - tradingsystem_backend

    labels:
      - "com.tradingsystem.stack=evolution-api"
      - "com.tradingsystem.tier=application"
      - "com.tradingsystem.service=evolution-api"
      - "com.tradingsystem.component=api"
      - "com.tradingsystem.description=Evolution API core service"

  # ============================================================================
  # Evolution Manager UI (official dashboard)
  # ============================================================================
  evolution-manager:
    container_name: evolution-manager
    image: ${EVOLUTION_MANAGER_IMAGE:-evoapicloud/evolution-manager:latest}
    restart: unless-stopped

    depends_on:
      evolution-api:
        condition: service_healthy

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      API_BASE_URL: ${EVOLUTION_MANAGER_API_BASE_URL:-http://evolution-api:8080}

    ports:
      - "${EVOLUTION_MANAGER_HOST_BIND:-127.0.0.1}:${EVOLUTION_MANAGER_PORT:-4203}:80"

    volumes:
      - ../../tools/compose/evolution/nginx-manager.conf:/etc/nginx/conf.d/nginx.conf:ro

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

    healthcheck:
      test:
        - CMD-SHELL
        - >
          curl -fsS -o /dev/null http://127.0.0.1/ || exit 1
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - evolution_backend
      - tradingsystem_backend

    labels:
      - "com.tradingsystem.stack=evolution-api"
      - "com.tradingsystem.tier=presentation"
      - "com.tradingsystem.service=evolution-manager"
      - "com.tradingsystem.component=dashboard"
      - "com.tradingsystem.description=Evolution Manager UI (NGINX static build)"
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.evolution-manager.rule=PathPrefix(`/apps/evolution-manager`)"
      - "traefik.http.routers.evolution-manager.entrypoints=web"
      - "traefik.http.routers.evolution-manager.priority=70"
      - "traefik.http.routers.evolution-manager.middlewares=evolution-manager-strip"
      - "traefik.http.middlewares.evolution-manager-strip.stripprefix.prefixes=/apps/evolution-manager"
      - "traefik.http.services.evolution-manager.loadbalancer.server.port=80"
      - "traefik.http.services.evolution-manager.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.evolution-manager.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.evolution-manager.loadbalancer.healthcheck.timeout=5s"

volumes:
  evolution-postgres-data:
  evolution-redis-data:
  evolution-minio-data:
  evolution-api-instances:

networks:
  tradingsystem_backend:
    external: true
    name: tradingsystem_backend

  evolution_backend:
    name: evolution_backend
