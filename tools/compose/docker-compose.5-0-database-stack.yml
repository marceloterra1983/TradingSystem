name: 5-0-database-stack

services:
  dbui-launcher-api:
    container_name: dbui-launcher-api
    image: database-ui-dbui-launcher-api
    build:
      context: ../../backend/api/launcher-api
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    environment:
      LAUNCHER_API_PORT: ${LAUNCHER_API_PORT:-3909}
      LAUNCHER_API_TOKEN: ${LAUNCHER_API_TOKEN:-devlocal-launcher-token}
    # TEMP: Direct port disabled due to Docker socket conflict - access via Traefik
    # ports:
    #   - "${LAUNCHER_API_PORT:-3909}:${LAUNCHER_API_PORT:-3909}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - tradingsystem_backend
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3909/healthz']
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  dbui-questdb:
    container_name: dbui-questdb
    image: questdb/questdb:latest
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    # TEMP: Direct ports disabled - access via Traefik at /db-ui/questdb
    # ports:
    #   - "${QUESTDB_HTTP_PORT:-9000}:9000"
    #   - "${QUESTDB_ILP_PORT:-9009}:9009"
    #   - "${QUESTDB_PG_PORT:-8812}:8812"
    volumes:
      - questdb-data:/var/lib/questdb
    networks:
      - tradingsystem_backend
    depends_on:
      - dbui-launcher-api
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.dbui-questdb.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/db-ui/questdb`)"
      - "traefik.http.routers.dbui-questdb.entrypoints=web"
      - "traefik.http.routers.dbui-questdb.priority=100"
      - "traefik.http.routers.dbui-questdb.middlewares=admin-standard@file"
      - "traefik.http.services.dbui-questdb.loadbalancer.server.port=9000"

  dbui-pgadmin:
    container_name: dbui-pgadmin
    image: dpage/pgadmin4:${PGADMIN_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    environment:
      PGADMIN_LISTEN_PORT: 5050
      # Disable enhanced cookie protection for iframe support
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "False"
    networks:
      - tradingsystem_backend
    # Note: No direct port exposure - accessed via nginx proxy (in 0-gateway-stack)

  dbui-adminer:
    container_name: dbui-adminer
    image: adminer:latest
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    environment:
      ADMINER_DESIGN: ${ADMINER_DESIGN:-flat}
    networks:
      - tradingsystem_backend
    # Note: No direct port exposure - accessed via nginx proxy (in 0-gateway-stack)

  dbui-pgweb:
    container_name: dbui-pgweb
    image: sosedoff/pgweb:latest
    restart: unless-stopped
    # NOTE: No env_file loaded to prevent DATABASE_URL from being set
    # pgWeb should start without pre-configured connection - users select DB from UI
    # TEMPORARY: Port 5052 disabled due to Docker socket conflict
    # Access via Traefik: http://localhost:9080/db-ui/pgweb
    # ports:
    #   - "${PGWEB_PORT:-5052}:8081"
    networks:
      - tradingsystem_backend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.dbui-pgweb.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/db-ui/pgweb`)"
      - "traefik.http.routers.dbui-pgweb.entrypoints=web"
      - "traefik.http.routers.dbui-pgweb.priority=100"
      - "traefik.http.routers.dbui-pgweb.middlewares=pgweb-stripprefix,admin-standard@file"
      - "traefik.http.middlewares.pgweb-stripprefix.stripprefix.prefixes=/db-ui/pgweb"
      - "traefik.http.services.dbui-pgweb.loadbalancer.server.port=8081"

networks:
  tradingsystem_backend:
    external: true

volumes:
  questdb-data:
    driver: local
  pgadmin-data:
    driver: local
