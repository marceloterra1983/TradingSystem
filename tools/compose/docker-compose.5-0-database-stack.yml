name: 5-0-database-stack

services:
  dbui-launcher-api:
    container_name: dbui-launcher-api
    image: database-ui-dbui-launcher-api
    build:
      context: ../../backend/api/launcher-api
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    environment:
      LAUNCHER_API_PORT: ${LAUNCHER_API_PORT:-3909}
      LAUNCHER_API_TOKEN: ${LAUNCHER_API_TOKEN:-devlocal-launcher-token}
    ports:
      - "${LAUNCHER_API_PORT:-3909}:${LAUNCHER_API_PORT:-3909}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - tradingsystem_backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3909/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  dbui-questdb:
    container_name: dbui-questdb
    image: questdb/questdb:${QUESTDB_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    ports:
      - "${QUESTDB_HTTP_PORT:-9000}:9000"
      - "${QUESTDB_ILP_PORT:-9009}:9009"
      - "${QUESTDB_PG_PORT:-8812}:8812"
    volumes:
      - questdb-data:/var/lib/questdb
    networks:
      - tradingsystem_backend
    depends_on:
      - dbui-launcher-api
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.dbui-questdb.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/db-ui/questdb`)"
      - "traefik.http.routers.dbui-questdb.entrypoints=web"
      - "traefik.http.routers.dbui-questdb.priority=100"
      # - "traefik.http.routers.dbui-questdb.middlewares=admin-standard@file"  # Disabled - file middlewares not working in WSL2
      - "traefik.http.services.dbui-questdb.loadbalancer.server.port=9000"

  dbui-pgadmin:
    container_name: dbui-pgadmin
    image: dpage/pgadmin4:${PGADMIN_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    environment:
      PGADMIN_LISTEN_PORT: 5050
      # Disable enhanced cookie protection for iframe support
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "False"
      PGADMIN_CONFIG_CHECK_EMAIL_DELIVERABILITY: "False"
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-tradingsystem}
    networks:
      - tradingsystem_backend
    expose:
      - "5050"
    volumes:
      - pgadmin-data:/var/lib/pgadmin

  dbui-pgadmin-proxy:
    container_name: dbui-pgadmin-proxy
    image: nginx:1.25-alpine
    restart: unless-stopped
    depends_on:
      - dbui-pgadmin
    volumes:
      - ./nginx-proxies/pgadmin:/etc/nginx/conf.d:ro
    networks:
      - tradingsystem_backend
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    command: ["nginx", "-g", "daemon off;"]

  dbui-adminer:
    container_name: dbui-adminer
    image: adminer:${ADMINER_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ../../.env
      - ../../.env.shared
    environment:
      ADMINER_DESIGN: ${ADMINER_DESIGN:-flat}
    networks:
      - tradingsystem_backend
    expose:
      - "8080"

  dbui-adminer-proxy:
    container_name: dbui-adminer-proxy
    image: nginx:1.25-alpine
    restart: unless-stopped
    depends_on:
      - dbui-adminer
    volumes:
      - ./nginx-proxies/adminer:/etc/nginx/conf.d:ro
    networks:
      - tradingsystem_backend
    ports:
      - "${ADMINER_PORT:-3910}:80"
    command: ["nginx", "-g", "daemon off;"]

  dbui-pgweb:
    container_name: dbui-pgweb
    image: sosedoff/pgweb:${PGWEB_IMAGE_TAG:-latest}
    restart: unless-stopped
    # NOTE: No env_file loaded to prevent DATABASE_URL from being set
    # pgWeb should start without pre-configured connection - users select DB from UI
    ports:
      - "${PGWEB_PORT:-5052}:8081"
    networks:
      - tradingsystem_backend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.dbui-pgweb.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/db-ui/pgweb`)"
      - "traefik.http.routers.dbui-pgweb.entrypoints=web"
      - "traefik.http.routers.dbui-pgweb.priority=100"
      - "traefik.http.routers.dbui-pgweb.middlewares=pgweb-stripprefix" # Removed admin-standard@file due to WSL2 issues
      - "traefik.http.middlewares.pgweb-stripprefix.stripprefix.prefixes=/db-ui/pgweb"
      - "traefik.http.services.dbui-pgweb.loadbalancer.server.port=8081"

networks:
  tradingsystem_backend:
    external: true

volumes:
  questdb-data:
    driver: local
  pgadmin-data:
    driver: local
