name: qdrant-ha

services:
  # Qdrant Node 1 (Leader - Bootstrap Node)
  qdrant-node1:
    image: qdrant/qdrant:v1.7.4
    container_name: qdrant-node1
    hostname: qdrant-node1
    command: ["./qdrant", "--uri", "http://qdrant-node1:6335"]
    ports:
      - "6333:6333"  # HTTP API
      - "6335:6335"  # Raft P2P communication
    environment:
      - QDRANT__CLUSTER__ENABLED=true
      - QDRANT__CLUSTER__P2P__PORT=6335
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant_node1_data:/qdrant/storage
    networks:
      - tradingsystem_backend
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Qdrant Node 2 (Replica - Joins via Bootstrap)
  qdrant-node2:
    image: qdrant/qdrant:v1.7.4
    container_name: qdrant-node2
    hostname: qdrant-node2
    command: ["./qdrant", "--bootstrap", "http://qdrant-node1:6335", "--uri", "http://qdrant-node2:6335"]
    ports:
      - "6336:6333"  # HTTP API
      - "6337:6335"  # Raft P2P communication
    environment:
      - QDRANT__CLUSTER__ENABLED=true
      - QDRANT__CLUSTER__P2P__PORT=6335
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant_node2_data:/qdrant/storage
    networks:
      - tradingsystem_backend
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    depends_on:
      qdrant-node1:
        condition: service_healthy

  # Qdrant Node 3 (Replica - Joins via Bootstrap)
  qdrant-node3:
    image: qdrant/qdrant:v1.7.4
    container_name: qdrant-node3
    hostname: qdrant-node3
    command: ["./qdrant", "--bootstrap", "http://qdrant-node1:6335", "--uri", "http://qdrant-node3:6335"]
    ports:
      - "6338:6333"  # HTTP API
      - "6339:6335"  # Raft P2P communication
    environment:
      - QDRANT__CLUSTER__ENABLED=true
      - QDRANT__CLUSTER__P2P__PORT=6335
      - QDRANT__SERVICE__GRPC_PORT=6334
    volumes:
      - qdrant_node3_data:/qdrant/storage
    networks:
      - tradingsystem_backend
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    depends_on:
      qdrant-node1:
        condition: service_healthy

  # HAProxy Load Balancer
  qdrant-lb:
    image: haproxy:2.8-alpine
    container_name: qdrant-lb
    hostname: qdrant-lb
    ports:
      - "6340:6333"  # Load balancer endpoint
      - "8404:8404"  # HAProxy stats page
    volumes:
      - ./haproxy-qdrant.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    networks:
      - tradingsystem_backend
    depends_on:
      - qdrant-node1
      - qdrant-node2
      - qdrant-node3
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8404/stats || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

networks:
  tradingsystem_backend:
    external: true

volumes:
  qdrant_node1_data:
    driver: local
  qdrant_node2_data:
    driver: local
  qdrant_node3_data:
    driver: local

