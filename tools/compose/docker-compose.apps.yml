name: apps

# ==============================================================================
# NOTICE (2025-11-04): TP-Capital Migrated to Autonomous Stack
# ==============================================================================
# 
# TP-Capital now runs as autonomous stack via docker-compose.tp-capital-stack.yml
# 
# New Stack:
#   - File: tools/compose/docker-compose.tp-capital-stack.yml
#   - Port: 4008 (was 4005)
#   - Containers: 5 (TimescaleDB, PgBouncer, Redis×2, API)
#   - Integration: HTTP API (was direct database)
# 
# To start new stack:
#   bash scripts/docker/start-tp-capital-stack.sh
# 
# Legacy service below is DISABLED. Remove after 2025-11-11.
# ==============================================================================

services:
  # ========================================
  # TP Capital API (Trading Signals) - LEGACY/DISABLED
  # ========================================
  # 
  # ⚠️  DEPRECATED (2025-11-04): Migrated to autonomous stack
  # Use docker-compose.tp-capital-stack.yml instead (port 4008)
  # 
  # Legacy service kept for reference only
  # To remove: Delete this entire tp-capital service block after 1 week
  # 
  # tp-capital:
    image: "${IMG_APPS_TPCAPITAL:-img-apps-tpcapital}:${IMG_VERSION:-latest}"
    build:
      context: ../..
      dockerfile: apps/tp-capital/Dockerfile.dev
    container_name: apps-tpcapital

    # Load environment from centralized root .env
    env_file:
      - ../../.env

    ports:
      - "4006:4005"  # MUDOU de 4005 para 4006 (evita conflitos)
    environment:
      # Server
      - PORT=4005
      - NODE_ENV=development
      - LOG_LEVEL=info

      # TimescaleDB Connection (Central Database)
      - TIMESCALEDB_HOST=data-timescale
      - TIMESCALEDB_PORT=5432
      - TIMESCALEDB_DATABASE=${TIMESCALEDB_DATABASE:-tradingsystem}
      - TIMESCALEDB_USER=${TIMESCALEDB_USER:-timescale}
      - TIMESCALEDB_PASSWORD=${TIMESCALEDB_PASSWORD:-pass_timescale}
      - TIMESCALEDB_SCHEMA=tp_capital

      # Gateway Database Connection (for polling messages)
      # Updated: 2025-11-03 - Using dedicated Telegram TimescaleDB
      - TELEGRAM_GATEWAY_DB_URL=postgresql://telegram:${TELEGRAM_DB_PASSWORD}@telegram-timescale:5432/telegram_gateway
      - GATEWAY_DATABASE_HOST=telegram-timescale
      - GATEWAY_DATABASE_URL=postgresql://telegram:${TELEGRAM_DB_PASSWORD}@telegram-timescale:5432/telegram_gateway
      - GATEWAY_DATABASE_PORT=5432
      - GATEWAY_DATABASE_NAME=telegram_gateway
      - GATEWAY_DATABASE_SCHEMA=telegram_gateway
      - GATEWAY_DATABASE_USER=telegram
      - GATEWAY_DATABASE_PASSWORD=${TELEGRAM_DB_PASSWORD}

      # Gateway Configuration
      - GATEWAY_POLLING_INTERVAL_MS=${GATEWAY_POLLING_INTERVAL_MS:-5000}
      - GATEWAY_SIGNALS_CHANNEL_ID=${GATEWAY_SIGNALS_CHANNEL_ID:--1001649127710}
      - GATEWAY_BATCH_SIZE=${GATEWAY_BATCH_SIZE:-100}

      # Telegram (optional - for bot mode)
      - TELEGRAM_INGESTION_BOT_TOKEN=${TELEGRAM_INGESTION_BOT_TOKEN:-}
      - TELEGRAM_MODE=${TELEGRAM_MODE:-gateway-polling}
      
      # Telegram Gateway Connection (host service)
      - TELEGRAM_GATEWAY_URL=http://host.docker.internal:4010  # ✅ Corrigido de 4006 para 4010
      - TELEGRAM_GATEWAY_PORT=4010  # ✅ Corrigido de 4006 para 4010

      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3103}

      # Database Pool
      - DB_POOL_MAX=10
      - DB_POOL_IDLE_TIMEOUT=30000
      - DB_POOL_CONNECTION_TIMEOUT=5000

      # Rate Limiting (Aumentado para comportar dashboard auto-refresh)
      - RATE_LIMIT_WINDOW_MS=60000
      - RATE_LIMIT_MAX_REQUESTS=100

    volumes:
      # Hot-reload: mount source code
      - ../../apps/tp-capital/src:/app/src:ro
      - ../../apps/tp-capital/api:/app/api:ro
      - ../../apps/tp-capital/public:/app/public:ro

      # Anonymous volume prevents overwrite
      - /app/node_modules

    networks:
      - tradingsystem_backend
      - telegram_backend  # Required to resolve telegram-timescale hostname

    # Allow container to access host services (Telegram Gateway)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Note: TimescaleDB must be started first via docker-compose.database.yml
    # The service will retry connections automatically on startup

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4005/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================
  # Workspace Service - MOVED TO DEDICATED STACK
  # ========================================
  # 
  # The Workspace service has been moved to a dedicated stack for better isolation.
  # 
  # Workspace now runs in: docker-compose.workspace-stack.yml
  # 
  # This stack includes:
  #   - Neon Database (pageserver, safekeeper, compute) - 3 containers
  #   - Workspace API service - 1 container
  #   Total: 4 containers managed as unified workspace-stack
  # 
  # To start Workspace:
  #   docker compose -f tools/compose/docker-compose.workspace-stack.yml up -d
  # 
  # Benefits:
  #   ✅ Unified management (1 command for all Workspace containers)
  #   ✅ Isolated Neon database (no sharing with TP Capital)
  #   ✅ Clear dependencies (API depends_on database)
  #   ✅ Dedicated network (workspace_network)
  # 
  # Migration date: 2025-11-03
  # See: docs/content/reference/adrs/007-workspace-neon-migration.md
  # ========================================

# ========================================
# Networks
# ========================================
networks:
  tradingsystem_backend:
    name: tradingsystem_backend
    external: true  # Use existing network from infrastructure stack
  telegram_backend:
    name: telegram_backend
    external: true  # Use existing network from Telegram stack
