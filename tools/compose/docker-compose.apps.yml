name: apps

services:
  # ========================================
  # TP Capital API (Trading Signals)
  # ========================================
  tp-capital-api:
    build:
      context: ../../apps/tp-capital/api
      dockerfile: Dockerfile.dev
    container_name: tp-capital-api

    # Load environment from centralized root .env
    env_file:
      - ../../.env

    ports:
      - "4005:4005"
    environment:
      # Server
      - PORT=4005
      - NODE_ENV=development
      - LOG_LEVEL=info

      # TimescaleDB Connection
      # Note: Credentials loaded from root .env via env_file directive
      - TIMESCALEDB_HOST=${TIMESCALEDB_HOST:-timescaledb}
      - TIMESCALEDB_PORT=${TIMESCALEDB_PORT:-5432}
      - TIMESCALEDB_SCHEMA=tp_capital

      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3103}

      # Database Pool
      - DB_POOL_MAX=10
      - DB_POOL_IDLE_TIMEOUT=30000
      - DB_POOL_CONNECTION_TIMEOUT=5000

      # Rate Limiting
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX_REQUESTS=100

    volumes:
      # Hot-reload: mount source code
      - ../../apps/tp-capital/api/src:/app/src:ro

      # Anonymous volume prevents overwrite
      - /app/node_modules

    networks:
      - tradingsystem_backend

    # Note: TimescaleDB must be started first via docker-compose.database.yml
    # The service will retry connections automatically on startup

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4005/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================
  # Workspace Service (Ideas & Documentation)
  # ========================================
  workspace:
    build:
      context: ../../backend/api/workspace
      dockerfile: Dockerfile.dev
    container_name: workspace-service

    env_file:
      - ../../.env

    ports:
      - "3200:3200"
    environment:
      # Server
      - WORKSPACE_PORT=3200
      - NODE_ENV=development
      - LOG_LEVEL=info

      # TimescaleDB Connection
      - TIMESCALEDB_HOST=timescaledb
      - TIMESCALEDB_PORT=5432
      - WORKSPACE_DATABASE=APPS-WORKSPACE
      - TIMESCALEDB_USER=timescale
      - TIMESCALEDB_PASSWORD=axA7d0kgjBezRw0mRlj9tOnHRBKgmZsL

      # Database Strategy (TimescaleDB only)
      - LIBRARY_DB_STRATEGY=timescaledb

    volumes:
      # Hot-reload: mount source code
      - ../../backend/api/workspace/src:/app/src:ro
      - ../../backend/api/workspace/scripts:/app/scripts:ro

      # Anonymous volume prevents overwrite
      - /app/node_modules

    networks:
      - tradingsystem_backend

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3200/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 40s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ========================================
  # TimescaleDB (Shared Database)
  # ========================================
  # Note: Uses existing TimescaleDB from database stack
  # Must be started separately via:
  #   docker compose -f tools/compose/docker-compose.database.yml up -d timescaledb

# ========================================
# Networks
# ========================================
networks:
  tradingsystem_backend:
    name: tradingsystem_backend
    external: true  # Use existing network from infrastructure stack
