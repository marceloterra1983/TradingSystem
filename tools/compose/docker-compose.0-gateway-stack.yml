name: 0-gateway-stack

# ==============================================================================
# TradingSystem - API Gateway Stack (Traefik)
# ==============================================================================
# Purpose: Centralized reverse proxy for all HTTP services
# Features:
#   - Automatic service discovery via Docker labels
#   - JWT authentication middleware
#   - Rate limiting (100 req/min per IP)
#   - CORS configuration
#   - Circuit breakers
#   - Request compression (gzip/brotli)
#   - Prometheus metrics export
#   - Access logs (JSON format)
# ==============================================================================
#
# Usage:
#   docker compose -f tools/compose/docker-compose.0-gateway-stack.yml up -d
#   docker compose -f tools/compose/docker-compose.0-gateway-stack.yml logs -f
#   docker compose -f tools/compose/docker-compose.0-gateway-stack.yml down
#
# Access:
#   Gateway:    http://localhost:9080
#   Dashboard:  http://localhost:9081
#   Metrics:    http://localhost:9080/metrics
#
# Last Updated: 2025-11-11
# ==============================================================================

services:
  # ============================================================================
  # Traefik API Gateway
  # ============================================================================
  traefik:
    image: traefik:v3.0
    container_name: api-gateway
    restart: unless-stopped

    # Configuration via file (traefik-minimal.yml) - simpler and less error-prone
    # command arguments commented out to avoid conflicts

    ports:
      - "9080:9080"   # HTTP Gateway
      - "9081:9080"   # Dashboard
      - "9443:9443"   # HTTPS Gateway (future)

    volumes:
      # Docker socket (service discovery)
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # Static configuration (using minimal config for testing)
      - ../../tools/traefik/traefik-minimal.yml:/etc/traefik/traefik.yml:ro

      # Dynamic configuration (routes, middlewares)
      - ../../tools/traefik/dynamic:/etc/traefik/dynamic:ro

      # Access logs
      - traefik-logs:/var/log/traefik

      # Certificates (future - Let's Encrypt)
      - traefik-certs:/letsencrypt

    environment:
      - TZ=America/Sao_Paulo

    networks:
      - tradingsystem_backend
      - tradingsystem_frontend
      - tp_capital_backend

    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

    labels:
      - "com.tradingsystem.stack=0-gateway-stack"
      - "com.tradingsystem.service=api-gateway"
      - "com.tradingsystem.type=infrastructure"

      # Dashboard routing (Traefik monitoring itself)
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`localhost`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

  # ============================================================================
  # Database UI Nginx Reverse Proxies
  # ============================================================================
  # Purpose: Strip security headers (X-Frame-Options, CSP) to enable iframe embedding
  # These proxies sit between Traefik and the actual Database UI applications
  # ============================================================================

  dbui-pgadmin-proxy:
    container_name: dbui-pgadmin-proxy
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "${PGADMIN_LISTEN_PORT:-5050}:5051"
    volumes:
      - ./pgadmin-nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - tradingsystem_backend
    labels:
      - "com.tradingsystem.stack=0-gateway-stack"
      - "com.tradingsystem.service=dbui-pgadmin-proxy"
      - "com.tradingsystem.type=reverse-proxy"

      # Traefik routing
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.dbui-pgadmin.rule=PathPrefix(`/db-ui/pgadmin`)"
      - "traefik.http.routers.dbui-pgadmin.entrypoints=web"
      - "traefik.http.routers.dbui-pgadmin.priority=100"
      - "traefik.http.routers.dbui-pgadmin.middlewares=pgadmin-stripprefix,admin-standard@file"
      - "traefik.http.middlewares.pgadmin-stripprefix.stripprefix.prefixes=/db-ui/pgadmin"
      - "traefik.http.services.dbui-pgadmin.loadbalancer.server.port=80"

  dbui-adminer-proxy:
    container_name: dbui-adminer-proxy
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "${ADMINER_PORT:-3910}:3911"
    volumes:
      - ./adminer-nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - tradingsystem_backend
    labels:
      - "com.tradingsystem.stack=0-gateway-stack"
      - "com.tradingsystem.service=dbui-adminer-proxy"
      - "com.tradingsystem.type=reverse-proxy"

      # Traefik routing
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.dbui-adminer.rule=PathPrefix(`/db-ui/adminer`)"
      - "traefik.http.routers.dbui-adminer.entrypoints=web"
      - "traefik.http.routers.dbui-adminer.priority=100"
      - "traefik.http.routers.dbui-adminer.middlewares=adminer-stripprefix,admin-standard@file"
      - "traefik.http.middlewares.adminer-stripprefix.stripprefix.prefixes=/db-ui/adminer"
      - "traefik.http.services.dbui-adminer.loadbalancer.server.port=80"

  # ============================================================================
  # Automation Tools Nginx Reverse Proxies
  # ============================================================================
  # Purpose: Enable iframe embedding and subpath routing for automation tools
  # ============================================================================

  n8n-proxy:
    container_name: n8n-proxy
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "5681:5681"
    volumes:
      - ./n8n-nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - tradingsystem_backend
    labels:
      - "com.tradingsystem.stack=0-gateway-stack"
      - "com.tradingsystem.service=n8n-proxy"
      - "com.tradingsystem.type=reverse-proxy"

      # Traefik routing
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.n8n.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/automation/n8n`)"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.routers.n8n.priority=100"
      - "traefik.http.routers.n8n.middlewares=n8n-stripprefix,admin-standard@file"
      - "traefik.http.middlewares.n8n-stripprefix.stripprefix.prefixes=/automation/n8n"
      - "traefik.http.services.n8n.loadbalancer.server.port=5681"

  kestra-proxy:
    container_name: kestra-proxy
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "5682:5682"
    volumes:
      - ./kestra-nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - tradingsystem_backend
    labels:
      - "com.tradingsystem.stack=0-gateway-stack"
      - "com.tradingsystem.service=kestra-proxy"
      - "com.tradingsystem.type=reverse-proxy"

      # Traefik routing
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.kestra.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/automation/kestra`)"
      - "traefik.http.routers.kestra.entrypoints=web"
      - "traefik.http.routers.kestra.priority=100"
      - "traefik.http.routers.kestra.middlewares=kestra-stripprefix,admin-standard@file"
      - "traefik.http.middlewares.kestra-stripprefix.stripprefix.prefixes=/automation/kestra"
      - "traefik.http.services.kestra.loadbalancer.server.port=5682"

  # ============================================================================
  # Monitoring Tools Nginx Reverse Proxies
  # ============================================================================

  grafana-proxy:
    container_name: grafana-proxy
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "5683:5683"
    volumes:
      - ./grafana-nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - tradingsystem_backend
    labels:
      - "com.tradingsystem.stack=0-gateway-stack"
      - "com.tradingsystem.service=grafana-proxy"
      - "com.tradingsystem.type=reverse-proxy"

      # Traefik routing
      - "traefik.enable=true"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.routers.grafana.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/monitoring/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.routers.grafana.priority=100"
      - "traefik.http.routers.grafana.middlewares=grafana-stripprefix,admin-standard@file"
      - "traefik.http.middlewares.grafana-stripprefix.stripprefix.prefixes=/monitoring/grafana"
      - "traefik.http.services.grafana.loadbalancer.server.port=5683"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  traefik-logs:
    driver: local
    labels:
      - "com.tradingsystem.component=logs"

  traefik-certs:
    driver: local
    labels:
      - "com.tradingsystem.component=certificates"

# ==============================================================================
# Networks
# ==============================================================================
networks:
  tradingsystem_backend:
    external: true
  tradingsystem_frontend:
    external: true
  tp_capital_backend:
    external: true

# ==============================================================================
# MIGRATION GUIDE
# ==============================================================================
#
# Phase 1: Enable gateway for 1 service (Workspace API)
# -------------------------------------------------------
# 1. Start gateway:
#      docker compose -f tools/compose/docker-compose.0-gateway-stack.yml up -d
#
# 2. Add Traefik labels to workspace-api in docker-compose.4-3-workspace-stack.yml:
#      labels:
#        - "traefik.enable=true"
#        - "traefik.http.routers.workspace.rule=PathPrefix(`/api/workspace`)"
#        - "traefik.http.routers.workspace.entrypoints=web"
#        - "traefik.http.services.workspace.loadbalancer.server.port=3200"
#
# 3. Test:
#      curl http://localhost:8080/api/workspace/health
#
# 4. Validate in Traefik Dashboard:
#      Open http://localhost:8081/dashboard/
#      Check "HTTP Routers" â†’ should see "workspace" router
#
# Phase 2: Add rate limiting
# ---------------------------
# 1. Add middleware label:
#      - "traefik.http.routers.workspace.middlewares=rate-limit@file"
#
# 2. Test rate limit (should get 429 after 100 requests):
#      for i in {1..110}; do curl http://localhost:8080/api/workspace/health; done
#
# Phase 3: Add all services
# --------------------------
# Repeat labels for each service (dashboard, docs, tp-capital, telegram, etc.)
#
# ==============================================================================
