name: firecrawl

services:
  # Firecrawl Proxy - TradingSystem Gateway (Port 3600) - Full functionality
  firecrawl-proxy:
    image: "${IMG_FIRECRAWL_PROXY:-img-firecrawl-proxy}:${IMG_VERSION:-latest}"
    container_name: firecrawl-proxy
    platform: linux/amd64
    build:
      context: ../../backend/api/firecrawl-proxy
      dockerfile: Dockerfile
    ports:
      - "${FIRECRAWL_PROXY_PORT:-3600}:3600"
    environment:
      - PORT=3600
      - FIRECRAWL_API_URL=${FIRECRAWL_API_URL:-https://api.firecrawl.dev}
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY}
      - LOG_LEVEL=${FIRECRAWL_LOG_LEVEL:-info}
    volumes:
      - ../../backend/api/firecrawl-proxy/src:/app/src:ro
    restart: unless-stopped
    env_file:
      - ../../.env
    networks:
      - firecrawl_network
      - tradingsystem_backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3600/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    labels:
      - "com.tradingsystem.stack=firecrawl"
      - "com.tradingsystem.service=firecrawl-proxy"

  # Firecrawl Core API (Port 3002) - Internal only
  firecrawl-api:
    image: "${IMG_FIRECRAWL_API:-nginx}:${IMG_VERSION:-alpine}"
    container_name: firecrawl-api
    ports:
      - "${FIRECRAWL_API_PORT:-3002}:80"
    restart: unless-stopped
    env_file:
      - ../../.env
    networks:
      - firecrawl_network

  firecrawl-postgres:
    image: "${IMG_FIRECRAWL_POSTGRES:-postgres}:${IMG_VERSION:-15}"
    container_name: firecrawl-postgres
    ports:
      - "${FIRECRAWL_POSTGRES_PORT:-5436}:5432"
    environment:
      POSTGRES_DB: firecrawl
      POSTGRES_USER: firecrawl
      POSTGRES_PASSWORD: ${FIRECRAWL_DB_PASSWORD:-firecrawl}
    restart: unless-stopped
    env_file:
      - ../../.env
    networks:
      - firecrawl_network

  firecrawl-redis:
    image: "${IMG_FIRECRAWL_REDIS:-redis}:${IMG_VERSION:-latest}"
    container_name: firecrawl-redis
    ports:
      - "${FIRECRAWL_REDIS_PORT:-6379}:6379"
    restart: unless-stopped
    env_file:
      - ../../.env
    networks:
      - firecrawl_network

  firecrawl-playwright:
    image: "${IMG_FIRECRAWL_PLAYWRIGHT:-nginx}:${IMG_VERSION:-alpine}"
    container_name: firecrawl-playwright
    ports:
      - "${FIRECRAWL_PLAYWRIGHT_PORT:-3003}:80"
    restart: unless-stopped
    env_file:
      - ../../.env
    networks:
      - firecrawl_network

networks:
  firecrawl_network:
    driver: bridge
  tradingsystem_backend:
    external: true
