;; ============================================================================
;; PgBouncer Configuration
;; OPT-003: Connection Pooling for TimescaleDB
;; Expected Impact: ~45ms latency reduction, 5x connection capacity
;; ============================================================================

[databases]
;; Database connection strings
;; Format: dbname = host=X port=Y dbname=Z pool_size=N reserve_pool=M

;; APPS-WORKSPACE Database
APPS-WORKSPACE = host=timescaledb port=5432 dbname=APPS-WORKSPACE pool_size=20 reserve_pool=5

;; APPS-TPCAPITAL Database
APPS-TPCAPITAL = host=timescaledb port=5432 dbname=APPS-TPCAPITAL pool_size=20 reserve_pool=5

;; Default PostgreSQL database
postgres = host=timescaledb port=5432 dbname=postgres pool_size=10 reserve_pool=2

;; PgBouncer admin database
pgbouncer = host=localhost port=5432 dbname=pgbouncer

[pgbouncer]
;; ============================================================================
;; Connection Settings
;; ============================================================================

;; Where to listen for connections
listen_addr = 0.0.0.0
listen_port = 5432

;; Unix socket location
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777

;; ============================================================================
;; Authentication
;; ============================================================================

;; Authentication type
auth_type = md5

;; User authentication file
auth_file = /etc/pgbouncer/userlist.txt

;; Query for authentication (optional, for database-stored passwords)
;; auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

;; ============================================================================
;; Pooling Configuration
;; ============================================================================

;; Pooling mode
;; - session: Server connection released when client disconnects (safest)
;; - transaction: Server connection released after transaction (recommended)
;; - statement: Server connection released after statement (aggressive)
pool_mode = transaction

;; Connection pool sizes
max_client_conn = 1000              ;; Maximum client connections
default_pool_size = 20              ;; Default pool size per user/database
min_pool_size = 5                   ;; Minimum pool size (keep-alive connections)
reserve_pool_size = 5               ;; Reserve connections for high-priority clients
reserve_pool_timeout = 3            ;; Seconds to wait for reserve pool

;; Per-database connection limits
max_db_connections = 0              ;; 0 = unlimited (limited by default_pool_size)
max_user_connections = 0            ;; 0 = unlimited

;; ============================================================================
;; Connection Timeouts
;; ============================================================================

;; Server connection management
server_reset_query = DISCARD ALL    ;; Query to reset server connection
server_check_delay = 30             ;; How long to keep released connections available
server_check_query = SELECT 1       ;; Health check query
server_lifetime = 3600              ;; Close server connection after 1 hour
server_idle_timeout = 600           ;; Close idle server connection after 10 min
server_connect_timeout = 15         ;; Server connection timeout
server_login_retry = 15             ;; Retry server connection after 15s

;; Query timeouts
query_timeout = 0                   ;; Query execution timeout (0 = disabled)
query_wait_timeout = 120            ;; Client waits 2min for server connection

;; Client connection management
client_idle_timeout = 0             ;; Disconnect idle clients (0 = disabled)
client_login_timeout = 60           ;; Client login timeout
idle_transaction_timeout = 0        ;; Close idle transactions (0 = disabled)

;; ============================================================================
;; Logging
;; ============================================================================

;; Logging level
;; - 0 = Off
;; - 1 = Fatal
;; - 2 = Error
;; - 3 = Warning
;; - 4 = Info
;; - 5 = Debug
;; - 6 = Noise
log_connections = 1                 ;; Log connections
log_disconnections = 1              ;; Log disconnections
log_pooler_errors = 1               ;; Log pooler errors
log_stats = 1                       ;; Log pool statistics
stats_period = 60                   ;; Stats logging every 60s

;; Syslog configuration
;; syslog = 0                       ;; 1 = enable syslog
;; syslog_ident = pgbouncer         ;; Syslog ident
;; syslog_facility = daemon         ;; Syslog facility

;; ============================================================================
;; Performance Tuning
;; ============================================================================

;; Socket options
so_reuseport = 1                    ;; Enable SO_REUSEPORT for better performance
tcp_socket_buffer = 0               ;; TCP socket buffer size (0 = default)
tcp_defer_accept = 45               ;; Defer accept for 45s
tcp_keepalive = 1                   ;; Enable TCP keepalive
tcp_keepidle = 600                  ;; TCP keepalive idle time (10 min)
tcp_keepintvl = 30                  ;; TCP keepalive interval
tcp_keepcnt = 5                     ;; TCP keepalive count
tcp_user_timeout = 0                ;; TCP user timeout (0 = default)

;; DNS caching
dns_max_ttl = 15                    ;; DNS cache TTL (seconds)
dns_nxdomain_ttl = 15               ;; DNS negative cache TTL
dns_zone_check_period = 0           ;; DNS zone check period (0 = disabled)

;; Application name passthrough
application_name_add_host = 1       ;; Add client host to application_name

;; ============================================================================
;; Advanced Settings
;; ============================================================================

;; Disable PGJDBC fix
disable_pqexec = 0                  ;; Disable Simple Query Protocol (keep default)

;; Prepared statement cache
max_prepared_statements = 0         ;; Max prepared statements (0 = unlimited)

;; Packet size
pkt_buf = 4096                      ;; Internal packet buffer size
max_packet_size = 2147483647        ;; Max packet size (2GB)
sbuf_loopcnt = 5                    ;; Socket buffer loop count

;; Admin users (can access pgbouncer database)
admin_users = timescale

;; Stats users (can access SHOW commands)
stats_users = timescale

;; Ignore startup parameters
ignore_startup_parameters = extra_float_digits

;; Track extra parameters
track_extra_parameters = IntervalStyle

;; ============================================================================
;; Security
;; ============================================================================

;; Peer authentication
;; peer_id = nobody                 ;; User ID for peer authentication

;; TLS/SSL configuration (optional)
;; client_tls_sslmode = disable
;; client_tls_ca_file =
;; client_tls_cert_file =
;; client_tls_key_file =
;; server_tls_sslmode = disable
;; server_tls_ca_file =
;; server_tls_cert_file =
;; server_tls_key_file =

;; ============================================================================
;; Maintenance
;; ============================================================================

;; Verbose errors
verbose = 0                         ;; Verbose error messages

;; Conffile (config reload)
conffile = /etc/pgbouncer/pgbouncer.ini

;; PID file
pidfile = /var/run/pgbouncer/pgbouncer.pid

;; ============================================================================
;; Expected Performance Improvements
;; ============================================================================
;; - Connection acquisition time: ~40-50ms reduction
;; - Connection reuse: ~95% (vs. ~0% without pooling)
;; - Max concurrent connections: 1000 (vs. 200 without pooling)
;; - Database server load: ~75% reduction (connection overhead)
;; - Memory usage: ~50% reduction (fewer server processes)
;; - Throughput: ~5x increase (connection reuse)
;; ============================================================================
