# ==============================================================================
# WAHA Stack - WhatsApp HTTP API + Persistence
# ==============================================================================
# Reference: https://github.com/devlikeapro/waha
# This stack keeps sessions in PostgreSQL and stores media in MinIO (S3 API)
# following the TradingSystem conventions (.env sharing + named volumes).
# ==============================================================================

name: 5-3-waha-stack

services:
  # ----------------------------------------------------------------------------
  # WhatsApp HTTP API Core (WAHA)
  # ----------------------------------------------------------------------------
  waha-core:
    container_name: waha-core
    image: ${WAHA_IMAGE:-devlikeapro/waha:noweb}
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      NODE_ENV: production
      TZ: America/Sao_Paulo
      WAHA_BASE_URL: ${WAHA_BASE_URL:-http://localhost:3310}
      WAHA_PUBLIC_URL: ${WAHA_PUBLIC_URL:-http://localhost:3310}
      WHATSAPP_API_HOSTNAME: ${WAHA_HOSTNAME:-0.0.0.0}
      WHATSAPP_API_PORT: ${WAHA_INTERNAL_PORT:-3000}
      WAHA_MEDIA_STORAGE: ${WAHA_MEDIA_STORAGE:-S3}
      WAHA_S3_REGION: ${WAHA_MINIO_REGION:-us-east-1}
      WAHA_S3_BUCKET: ${WAHA_MINIO_BUCKET:-waha-media}
      WAHA_S3_ENDPOINT: ${WAHA_S3_ENDPOINT:-http://waha-minio:9000}
      WAHA_S3_ACCESS_KEY_ID: ${WAHA_MINIO_ROOT_USER:-wahaadmin}
      WAHA_S3_SECRET_ACCESS_KEY: ${WAHA_MINIO_ROOT_PASSWORD:-wahasecret}
      WAHA_S3_FORCE_PATH_STYLE: 'true'
      WAHA_S3_PROXY_FILES: ${WAHA_S3_PROXY_FILES:-true}
      WAHA_HOOK_URL: ${WAHA_HOOK_URL:-http://waha-webhook:${WAHA_WEBHOOK_PORT:-3908}/webhooks/waha}
      WAHA_HOOK_EVENTS: ${WAHA_HOOK_EVENTS:-message,message.ack,session.status}
      WAHA_HOOK_CUSTOM_HEADERS: ${WAHA_HOOK_CUSTOM_HEADERS:-"X-WAHA-TOKEN:${WAHA_WEBHOOK_TOKEN:-waha-webhook-dev-token}"}
      WHATSAPP_SESSIONS_POSTGRESQL_URL: postgres://${WAHA_POSTGRES_USER:-waha}:${WAHA_POSTGRES_PASSWORD:-wahadb}@waha-postgres:5432/${WAHA_POSTGRES_DB:-waha}?sslmode=disable
      WAHA_LOG_FORMAT: ${WAHA_LOG_FORMAT:-JSON}
      WAHA_LOG_LEVEL: ${WAHA_LOG_LEVEL:-info}
      WAHA_PRINT_QR: ${WAHA_PRINT_QR:-false}

    ports:
      - "${WAHA_HOST_BIND:-127.0.0.1}:${WAHA_PORT:-3310}:3000"

    volumes:
      - waha-sessions:/app/.sessions

    depends_on:
      waha-postgres:
        condition: service_healthy
      waha-minio:
        condition: service_healthy
      waha-minio-init:
        condition: service_completed_successfully
      waha-webhook:
        condition: service_started

    networks:
      - waha_backend

    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '5'

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - >
          code=$$(curl -s -o /dev/null -w "%{http_code}" -H "X-Api-Key: ${WAHA_API_KEY:-changeme-waha-api-key}" http://127.0.0.1:3000/health);
          if [ "$$code" = "200" ] || [ "$$code" = "422" ]; then
            exit 0;
          fi;
          exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 75s

  # ----------------------------------------------------------------------------
  # PostgreSQL – session persistence
  # ----------------------------------------------------------------------------
  waha-postgres:
    container_name: waha-postgres
    image: postgres:16-alpine
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      POSTGRES_DB: ${WAHA_POSTGRES_DB:-waha}
      POSTGRES_USER: ${WAHA_POSTGRES_USER:-waha}
      POSTGRES_PASSWORD: ${WAHA_POSTGRES_PASSWORD:-wahadb}
      TZ: ${WAHA_TZ:-America/Sao_Paulo}

    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c synchronous_commit=off
      -c timezone=${WAHA_TZ:-America/Sao_Paulo}

    ports:
      - "${WAHA_POSTGRES_HOST_BIND:-127.0.0.1}:${WAHA_POSTGRES_PORT:-5438}:5432"

    volumes:
      - waha-postgres-data:/var/lib/postgresql/data

    networks:
      - waha_backend

    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '5'

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - >
          pg_isready -U ${WAHA_POSTGRES_USER:-waha} -d ${WAHA_POSTGRES_DB:-waha}
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s

  # ----------------------------------------------------------------------------
  # MinIO – S3-compatible media storage
  # ----------------------------------------------------------------------------
  waha-minio:
    container_name: waha-minio
    image: quay.io/minio/minio:latest
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      MINIO_ROOT_USER: ${WAHA_MINIO_ROOT_USER:-wahaadmin}
      MINIO_ROOT_PASSWORD: ${WAHA_MINIO_ROOT_PASSWORD:-wahasecret}
      MINIO_REGION: ${WAHA_MINIO_REGION:-us-east-1}

    command: server /data --console-address ":9001"

    ports:
      - "${WAHA_MINIO_HOST_BIND:-127.0.0.1}:${WAHA_MINIO_API_PORT:-9300}:9000"
      - "${WAHA_MINIO_CONSOLE_HOST_BIND:-127.0.0.1}:${WAHA_MINIO_CONSOLE_PORT:-9301}:9001"

    volumes:
      - waha-minio-data:/data

    networks:
      - waha_backend

    logging:
      driver: json-file
      options:
        max-size: '10m'
        max-file: '5'

    healthcheck:
      test:
        - CMD
        - /bin/sh
        - -c
        - curl -fsS http://127.0.0.1:9000/minio/health/ready > /dev/null
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s

  # ----------------------------------------------------------------------------
  # One-shot MinIO bucket/bootstrap job
  # ----------------------------------------------------------------------------
  waha-minio-init:
    container_name: waha-minio-init
    image: quay.io/minio/mc:latest
    restart: 'no'

    env_file:
      - ../../.env
      - ../../.env.shared

    depends_on:
      waha-minio:
        condition: service_healthy

    entrypoint: /bin/sh
    command: >
      -c "
        set -euo pipefail;
        mc alias set waha http://waha-minio:9000 ${WAHA_MINIO_ROOT_USER:-wahaadmin} ${WAHA_MINIO_ROOT_PASSWORD:-wahasecret};
        if ! mc ls waha/${WAHA_MINIO_BUCKET:-waha-media} >/dev/null 2>&1; then
          mc mb waha/${WAHA_MINIO_BUCKET:-waha-media};
        fi;
        mc anonymous set download waha/${WAHA_MINIO_BUCKET:-waha-media};
      "

    networks:
      - waha_backend

  # ----------------------------------------------------------------------------
  # Webhook receiver - bridges WAHA events into TradingSystem
  # ----------------------------------------------------------------------------
  waha-webhook:
    container_name: waha-webhook
    build:
      context: ../../backend/api/waha
      dockerfile: Dockerfile
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      WAHA_WEBHOOK_PORT: ${WAHA_WEBHOOK_PORT:-3908}
      WAHA_WEBHOOK_TOKEN: ${WAHA_WEBHOOK_TOKEN:-waha-webhook-dev-token}

    ports:
      - "${WAHA_WEBHOOK_HOST_BIND:-127.0.0.1}:${WAHA_WEBHOOK_PORT:-3908}:${WAHA_WEBHOOK_PORT:-3908}"

    networks:
      - waha_backend

    logging:
      driver: json-file
      options:
        max-size: '5m'
        max-file: '3'

volumes:
  waha-sessions:
  waha-postgres-data:
  waha-minio-data:

networks:
  waha_backend:
    external: true
