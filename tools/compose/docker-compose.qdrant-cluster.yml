version: '3.8'

name: qdrant-cluster

services:
  # ============================================================
  # Qdrant Node 1 (Leader/Primary)
  # ============================================================
  qdrant-node-1:
    image: qdrant/qdrant:${QDRANT_VERSION:-v1.7.4}
    container_name: qdrant-node-1
    hostname: qdrant-node-1
    ports:
      - "${QDRANT_NODE_1_PORT:-6333}:6333"  # gRPC/HTTP API
      - "${QDRANT_NODE_1_P2P_PORT:-6335}:6335"  # P2P/Raft communication
    environment:
      # Cluster Configuration
      - QDRANT__CLUSTER__ENABLED=true
      - QDRANT__CLUSTER__P2P__PORT=6335
      - QDRANT__CLUSTER__CONSENSUS__TICK_PERIOD_MS=100
      
      # Service Configuration
      - QDRANT__SERVICE__HOST=0.0.0.0
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      
      # Storage Configuration
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
      
      # Performance Tuning
      - QDRANT__STORAGE__OPTIMIZERS__DEFAULT_SEGMENT_NUMBER=2
      - QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD=10000
      - QDRANT__STORAGE__WAL__WAL_CAPACITY_MB=32
      
      # Logging
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}
    volumes:
      - qdrant_data_1:/qdrant/storage
      - qdrant_snapshots_1:/qdrant/snapshots
    networks:
      - tradingsystem_backend
      - qdrant_cluster
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    labels:
      - "com.tradingsystem.service=qdrant-node-1"
      - "com.tradingsystem.category=vector-database"
      - "com.tradingsystem.role=leader"

  # ============================================================
  # Qdrant Node 2 (Follower/Replica)
  # ============================================================
  qdrant-node-2:
    image: qdrant/qdrant:${QDRANT_VERSION:-v1.7.4}
    container_name: qdrant-node-2
    hostname: qdrant-node-2
    ports:
      - "${QDRANT_NODE_2_PORT:-6334}:6333"
      - "${QDRANT_NODE_2_P2P_PORT:-6336}:6335"
    environment:
      # Cluster Configuration
      - QDRANT__CLUSTER__ENABLED=true
      - QDRANT__CLUSTER__P2P__PORT=6335
      - QDRANT__CLUSTER__CONSENSUS__BOOTSTRAP=http://qdrant-node-1:6335
      - QDRANT__CLUSTER__CONSENSUS__TICK_PERIOD_MS=100
      
      # Service Configuration
      - QDRANT__SERVICE__HOST=0.0.0.0
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      
      # Storage Configuration
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
      
      # Performance Tuning (same as Node 1)
      - QDRANT__STORAGE__OPTIMIZERS__DEFAULT_SEGMENT_NUMBER=2
      - QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD=10000
      - QDRANT__STORAGE__WAL__WAL_CAPACITY_MB=32
      
      # Logging
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}
    volumes:
      - qdrant_data_2:/qdrant/storage
      - qdrant_snapshots_2:/qdrant/snapshots
    networks:
      - tradingsystem_backend
      - qdrant_cluster
    depends_on:
      qdrant-node-1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 45s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    labels:
      - "com.tradingsystem.service=qdrant-node-2"
      - "com.tradingsystem.category=vector-database"
      - "com.tradingsystem.role=follower"

  # ============================================================
  # Qdrant Node 3 (Follower/Replica)
  # ============================================================
  qdrant-node-3:
    image: qdrant/qdrant:${QDRANT_VERSION:-v1.7.4}
    container_name: qdrant-node-3
    hostname: qdrant-node-3
    ports:
      - "${QDRANT_NODE_3_PORT:-6337}:6333"
      - "${QDRANT_NODE_3_P2P_PORT:-6338}:6335"
    environment:
      # Cluster Configuration
      - QDRANT__CLUSTER__ENABLED=true
      - QDRANT__CLUSTER__P2P__PORT=6335
      - QDRANT__CLUSTER__CONSENSUS__BOOTSTRAP=http://qdrant-node-1:6335
      - QDRANT__CLUSTER__CONSENSUS__TICK_PERIOD_MS=100
      
      # Service Configuration
      - QDRANT__SERVICE__HOST=0.0.0.0
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      
      # Storage Configuration
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
      
      # Performance Tuning (same as Node 1)
      - QDRANT__STORAGE__OPTIMIZERS__DEFAULT_SEGMENT_NUMBER=2
      - QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD=10000
      - QDRANT__STORAGE__WAL__WAL_CAPACITY_MB=32
      
      # Logging
      - QDRANT__LOG_LEVEL=${QDRANT_LOG_LEVEL:-INFO}
    volumes:
      - qdrant_data_3:/qdrant/storage
      - qdrant_snapshots_3:/qdrant/snapshots
    networks:
      - tradingsystem_backend
      - qdrant_cluster
    depends_on:
      qdrant-node-1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 45s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    labels:
      - "com.tradingsystem.service=qdrant-node-3"
      - "com.tradingsystem.category=vector-database"
      - "com.tradingsystem.role=follower"

  # ============================================================
  # NGINX Load Balancer (Round-Robin + Health Checks)
  # ============================================================
  qdrant-lb:
    image: nginx:alpine
    container_name: qdrant-lb
    hostname: qdrant-lb
    ports:
      - "${QDRANT_LB_PORT:-6333}:80"
    volumes:
      - ./qdrant-nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - tradingsystem_backend
      - qdrant_cluster
    depends_on:
      qdrant-node-1:
        condition: service_healthy
      qdrant-node-2:
        condition: service_healthy
      qdrant-node-3:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    labels:
      - "com.tradingsystem.service=qdrant-lb"
      - "com.tradingsystem.category=load-balancer"

# ============================================================
# Networks
# ============================================================
networks:
  tradingsystem_backend:
    external: true
    name: tradingsystem_backend
  
  qdrant_cluster:
    driver: bridge
    name: qdrant_cluster
    ipam:
      config:
        - subnet: 172.30.0.0/24

# ============================================================
# Volumes
# ============================================================
volumes:
  qdrant_data_1:
    driver: local
    name: qdrant_data_1
  
  qdrant_data_2:
    driver: local
    name: qdrant_data_2
  
  qdrant_data_3:
    driver: local
    name: qdrant_data_3
  
  qdrant_snapshots_1:
    driver: local
    name: qdrant_snapshots_1
  
  qdrant_snapshots_2:
    driver: local
    name: qdrant_snapshots_2
  
  qdrant_snapshots_3:
    driver: local
    name: qdrant_snapshots_3


