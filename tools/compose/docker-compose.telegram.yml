name: telegram-stack

# ==============================================================================
# Telegram Hybrid Stack - 7 Dedicated Containers
# ==============================================================================
# Architecture: Native MTProto service (systemd) + Containerized data layer
# Purpose: Isolated, high-performance Telegram message processing
# Resources: 7 CPU, 5.5GB RAM total
# ==============================================================================

services:
  # ============================================================================
  # 1. TimescaleDB - Dedicated Database for Telegram
  # ============================================================================
  telegram-timescaledb:
    container_name: telegram-timescale
    image: timescale/timescaledb:latest-pg16
    platform: linux/amd64
    restart: unless-stopped
    
    env_file:
      - ../../.env
    
    environment:
      POSTGRES_DB: telegram_gateway
      POSTGRES_USER: ${TELEGRAM_DB_USER:-telegram}
      POSTGRES_PASSWORD: ${TELEGRAM_DB_PASSWORD}
      TIMESCALEDB_TELEMETRY: 'off'
      
      # Performance tuning
      POSTGRES_INITDB_ARGS: >-
        --encoding=UTF-8
        --locale=C
        --data-checksums
    
    ports:
      - "${TELEGRAM_DB_PORT:-5434}:5432"
    
    volumes:
      - telegram-timescaledb-data:/var/lib/postgresql/data
      - ../../backend/data/timescaledb/telegram-gateway:/docker-entrypoint-initdb.d:ro
      - ./telegram/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c shared_buffers=512MB
      -c effective_cache_size=1536MB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_connections=100
      -c shared_preload_libraries=timescaledb,pg_stat_statements
    
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', '${TELEGRAM_DB_USER:-telegram}', '-d', 'telegram_gateway']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=data"
      - "com.tradingsystem.service=timescaledb"
      - "com.tradingsystem.component=database"
      - "com.tradingsystem.description=Dedicated TimescaleDB for Telegram Gateway"

  # ============================================================================
  # 2. PgBouncer - Connection Pooling Layer (CRITICAL FOR PERFORMANCE)
  # ============================================================================
  telegram-pgbouncer:
    container_name: telegram-pgbouncer
    image: pgbouncer/pgbouncer:latest
    restart: unless-stopped
    
    environment:
      - DATABASES_HOST=telegram-timescaledb
      - DATABASES_PORT=5432
      - DATABASES_USER=${TELEGRAM_DB_USER:-telegram}
      - DATABASES_PASSWORD=${TELEGRAM_DB_PASSWORD}
      - DATABASES_DBNAME=telegram_gateway
    
    ports:
      - "${TELEGRAM_PGBOUNCER_PORT:-6434}:6432"
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    depends_on:
      telegram-timescaledb:
        condition: service_healthy
    
    healthcheck:
      test: ['CMD-SHELL', 'PGPASSWORD=${TELEGRAM_DB_PASSWORD} psql -h localhost -p 6432 -U telegram -d telegram_gateway -c "SELECT 1"']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=data"
      - "com.tradingsystem.service=pgbouncer"
      - "com.tradingsystem.component=connection-pooler"
      - "com.tradingsystem.description=Connection pooling for TimescaleDB (reduces overhead 50ms â†’ 5ms)"

  # ============================================================================
  # 3. Redis Master - Hot Cache (Write Path)
  # ============================================================================
  telegram-redis-master:
    container_name: telegram-redis-master
    image: redis:7-alpine
    restart: unless-stopped
    
    command: >
      redis-server
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
      --maxclients 1000
    
    ports:
      - "${TELEGRAM_REDIS_PORT:-6379}:6379"
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    
    networks:
      telegram_backend:
        aliases:
          - telegram-redis-master
          - redis-master
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=cache"
      - "com.tradingsystem.service=redis"
      - "com.tradingsystem.role=master"
      - "com.tradingsystem.description=Redis master for hot message cache (1h TTL)"

  # ============================================================================
  # 4. Redis Replica - Read Scaling
  # ============================================================================
  telegram-redis-replica:
    container_name: telegram-redis-replica
    image: redis:7-alpine
    restart: unless-stopped
    
    command: >
      redis-server
      --replicaof telegram-redis-master 6379
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --replica-read-only yes
    
    ports:
      - "${TELEGRAM_REDIS_REPLICA_PORT:-6380}:6379"
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    depends_on:
      telegram-redis-master:
        condition: service_healthy
    
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=cache"
      - "com.tradingsystem.service=redis"
      - "com.tradingsystem.role=replica"
      - "com.tradingsystem.description=Redis replica for read scaling and HA"

  # ============================================================================
  # 5. Redis Sentinel - High Availability Monitoring
  # ============================================================================
  telegram-redis-sentinel:
    container_name: telegram-redis-sentinel
    image: redis:7-alpine
    restart: unless-stopped
    
    command: redis-sentinel /etc/redis/sentinel.conf
    
    ports:
      - "${TELEGRAM_REDIS_SENTINEL_PORT:-26379}:26379"
    
    volumes:
      - ./telegram/sentinel-simple.conf:/etc/redis/sentinel.conf:ro
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    depends_on:
      telegram-redis-master:
        condition: service_healthy
      telegram-redis-replica:
        condition: service_healthy
    
    healthcheck:
      test: ['CMD', 'redis-cli', '-p', '26379', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=cache"
      - "com.tradingsystem.service=redis"
      - "com.tradingsystem.role=sentinel"
      - "com.tradingsystem.description=Redis Sentinel for automatic failover (down detection: 5s)"

  # ============================================================================
  # 6. RabbitMQ - Event Bus (Optional, for decoupling)
  # ============================================================================
  telegram-rabbitmq:
    container_name: telegram-rabbitmq
    image: rabbitmq:3.12-management-alpine
    restart: unless-stopped
    
    environment:
      RABBITMQ_DEFAULT_USER: ${TELEGRAM_RABBITMQ_USER:-telegram}
      RABBITMQ_DEFAULT_PASS: ${TELEGRAM_RABBITMQ_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: telegram
      RABBITMQ_CONFIG_FILE: /etc/rabbitmq/rabbitmq.conf
    
    ports:
      - "${TELEGRAM_RABBITMQ_PORT:-5672}:5672"       # AMQP
      - "${TELEGRAM_RABBITMQ_MGMT_PORT:-15672}:15672" # Management UI
    
    volumes:
      - telegram-rabbitmq-data:/var/lib/rabbitmq
      - ./telegram/rabbitmq-simple.conf:/etc/rabbitmq/rabbitmq.conf:ro
    
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    networks:
      - telegram_backend
    
    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=queue"
      - "com.tradingsystem.service=rabbitmq"
      - "com.tradingsystem.description=Message queue for pub/sub pattern (optional)"

  # ============================================================================
  # 7. Telegram Gateway REST API (PHASE 2 - COMMENTED OUT FOR NOW)
  # ============================================================================
  # telegram-gateway-api:
  #     container_name: telegram-gateway-api
  #     build:
  #       context: ../../backend/api/telegram-gateway
  #       dockerfile: Dockerfile
  #     restart: unless-stopped
  #     
  #     env_file:
  #       - ../../.env
  #     
  #     environment:
  #       - NODE_ENV=production
  #       - TELEGRAM_GATEWAY_API_PORT=4010
  #       
  #       # Database (via PgBouncer - CRITICAL)
  #       - TELEGRAM_GATEWAY_DB_HOST=telegram-pgbouncer
  #       - TELEGRAM_GATEWAY_DB_PORT=5432
  #       - TELEGRAM_GATEWAY_DB_NAME=telegram_gateway
  #       - TELEGRAM_GATEWAY_DB_USER=${TELEGRAM_DB_USER:-telegram}
  #       - TELEGRAM_GATEWAY_DB_PASSWORD=${TELEGRAM_DB_PASSWORD}
  #       
  #       # Redis (optional for API caching)
  #       - REDIS_HOST=telegram-redis-master
  #       - REDIS_PORT=6379
  #       - REDIS_ENABLED=${TELEGRAM_REDIS_ENABLED:-true}
  #       
  #       # Gateway Service URL (native service on host)
  #       - GATEWAY_SERVICE_URL=http://host.docker.internal:4006
  #     
  #     ports:
  #       - "${TELEGRAM_GATEWAY_API_PORT:-4010}:4010"
  #     
  #     extra_hosts:
  #       - "host.docker.internal:host-gateway"
  #     
  #     deploy:
  #       resources:
  #         limits:
  #           cpus: '0.5'
  #           memory: 256M
  #         reservations:
  #           cpus: '0.25'
  #           memory: 128M
  #     
  #     depends_on:
  #       telegram-pgbouncer:
  #         condition: service_healthy
  #       telegram-redis-master:
  #         condition: service_healthy
  #     
  #     healthcheck:
  #       test: ['CMD', 'node', '-e', "require('http').get('http://localhost:4010/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
  #       interval: 30s
  #       timeout: 10s
  #       retries: 3
  #       start_period: 30s
  #     
  #     networks:
  #       - telegram_backend
  #       - tradingsystem_backend
  #     
  #     labels:
  #       - "com.tradingsystem.stack=telegram"
  #       - "com.tradingsystem.tier=api"
  #       - "com.tradingsystem.service=gateway-api"
  #       - "com.tradingsystem.description=REST API for querying Telegram messages"
  # 
  # volumes:
  #   telegram-timescaledb-data:
  #     name: telegram-timescaledb-data
  #   telegram-rabbitmq-data:
  #     name: telegram-rabbitmq-data
  # 
  # networks:
  #   telegram_backend:
  #     name: telegram_backend
  #     driver: bridge
  #     internal: false
  #     ipam:
  #       config:
  #         - subnet: 172.25.0.0/16
  #   
  #   tradingsystem_backend:
  #     external: true
  # 

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  telegram_backend:
    driver: bridge
    name: telegram_backend

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  telegram-timescaledb-data:
    name: telegram-timescaledb-data
  telegram-redis-master-data:
    name: telegram-redis-master-data
  telegram-redis-replica-data:
    name: telegram-redis-replica-data
  telegram-rabbitmq-data:
    name: telegram-rabbitmq-data
