name: dashboard

services:
  dashboard:
    container_name: dashboard-ui
    build:
      context: ../..
      dockerfile: frontend/dashboard/Dockerfile
    env_file:
      - ../../.env
      - ../../.env.shared
    environment:
      - DASHBOARD_PORT=${DASHBOARD_PORT:-3103}
      - SKIP_DASHBOARD_PREBUILD=1
      # Override URLs for containerized environment (use Vite proxy instead of direct URLs)
      # TP Capital: Uses /api/tp-capital → proxied to tp-capital-api:4005
      # NOTE: No VITE_ prefix! This is server-side only (Vite proxy target, not exposed to browser)
      - TP_CAPITAL_PROXY_TARGET=http://tp-capital-api:4005
      # Telegram Gateway: Direct access (same network)
      - VITE_TELEGRAM_GATEWAY_PROXY_TARGET=http://telegram-gateway-api:4010
      # Workspace: Uses /api/workspace → proxied to workspace-api:3200/api (basePath /api added by vite.config.ts)
      # NOTE: No VITE_ prefix! This is server-side only (Vite proxy target, not exposed to browser)
      - WORKSPACE_PROXY_TARGET=http://workspace-api:3200/api
      # Docusaurus: Direct access to /next/ → proxied to docs-hub:80/next/ (NGINX serving Docusaurus static site)
      - DOCUSAURUS_PROXY_TARGET=http://docs-hub:80  # Vite proxy target (container-to-container, NOT exposed to browser)
      - VITE_DOCUSAURUS_URL=/  # Browser-facing base URL (empty base, versioned paths like /next/ are used directly)
      - DOCS_API_PROXY_TARGET=http://docs-api:3000
      # Telegram Gateway API Keys (for frontend authentication)
      - VITE_GATEWAY_TOKEN=${TELEGRAM_GATEWAY_API_TOKEN:-gw_secret_9K7j2mPq8nXwR5tY4vL1zD3fH6bN0sA}
      - VITE_TELEGRAM_GATEWAY_API_TOKEN=${TELEGRAM_GATEWAY_API_TOKEN:-gw_secret_9K7j2mPq8nXwR5tY4vL1zD3fH6bN0sA}
      - VITE_API_SECRET_TOKEN=${API_SECRET_TOKEN:-gw_secret_9K7j2mPq8nXwR5tY4vL1zD3fH6bN0sA}
      # n8n proxy configuration (server-side only, NOT exposed to browser)
      # NOTE: No VITE_ prefix! This is server-side only (Vite proxy target)
      - N8N_PROXY_TARGET=http://n8n-app:5678
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-automation}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-changeme}
      # Course Crawler UI: Browser-facing URL (must use localhost for host browser access)
      - VITE_COURSE_CRAWLER_APP_URL=http://localhost:4201
      # Database UI proxies (container-to-container)
      - DB_UI_PGADMIN_PROXY_TARGET=http://dbui-pgadmin:5050
      - DB_UI_PGWEB_PROXY_TARGET=http://dbui-pgweb:8081
      - DB_UI_ADMINER_PROXY_TARGET=http://dbui-adminer:8080
      - DB_UI_QUESTDB_PROXY_TARGET=http://dbui-questdb:9000
    ports:
      - "${DASHBOARD_PORT:-3103}:${DASHBOARD_PORT:-3103}"
    networks:
      - tradingsystem_frontend
      - tradingsystem_backend  # Hub network for API access (proxy)
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${DASHBOARD_PORT:-3103}/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    labels:
      - "com.tradingsystem.stack=frontend-ui"
      - "com.tradingsystem.service=dashboard"

networks:
  tradingsystem_frontend:
    external: true
  tradingsystem_backend:
    external: true
