# =============================================================================
# Nginx Proxy for n8n iFrame Embedding
# =============================================================================
# This proxy allows iframe embedding in the Dashboard by stripping security
# headers and forwarding all requests to n8n-app.
#
# Flow: Traefik forwards /n8n/* → Nginx strips /n8n → n8n-app:5678 receives /*
# =============================================================================

server {
    listen 80;
    server_name localhost;

    # Proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Strip security headers to allow iframe embedding
    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header X-Content-Type-Options;

    # Add permissive headers for iframe
    add_header X-Frame-Options "ALLOWALL" always;
    add_header Content-Security-Policy "default-src * data: blob: 'unsafe-inline' 'unsafe-eval'; frame-ancestors *;" always;

    # Buffer settings
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;

    # Health check endpoint for Docker/Traefik healthchecks
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Traefic forwarda /n8n/*; tratamos a raiz e subsequentes separadamente
    location = /n8n {
        return 301 /n8n/;
    }

    location ^~ /assets/ {
        proxy_set_header X-Forwarded-Prefix /n8n;
        rewrite ^/assets/(.*)$ /n8n/assets/$1 break;
        proxy_pass http://n8n-app:5678;
    }

    location ^~ /static/ {
        proxy_set_header X-Forwarded-Prefix /n8n;
        rewrite ^/static/(.*)$ /n8n/static/$1 break;
        proxy_pass http://n8n-app:5678;
    }

    location ^~ /n8n/assets/ {
        proxy_set_header X-Forwarded-Prefix /n8n;
        proxy_pass http://n8n-app:5678;
    }

    location ^~ /n8n/static/ {
        proxy_set_header X-Forwarded-Prefix /n8n;
        proxy_pass http://n8n-app:5678;
    }

    location /n8n/ {
        proxy_set_header X-Forwarded-Prefix /n8n;
        rewrite ^/n8n/(.*)$ /$1 break;
        proxy_pass http://n8n-app:5678;
    }
}
