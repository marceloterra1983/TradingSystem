# =============================================================================
# Nginx Proxy for n8n iFrame Embedding
# =============================================================================
# This proxy allows iframe embedding in the Dashboard by stripping security
# headers and forwarding all requests to n8n-app.
#
# Flow: Traefik forwards /n8n/* → Nginx strips /n8n → n8n-app:5678 receives /*
# =============================================================================

server {
    listen 80;
    server_name localhost;

    # Proxy headers - preserve original request context for n8n
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Port $server_port;

    # Preserve Origin header from browser (localhost:9082)
    proxy_set_header Origin $http_origin;

    # Strip security headers to allow iframe embedding
    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header X-Content-Type-Options;

    # Add permissive headers for iframe
    add_header X-Frame-Options "ALLOWALL" always;
    add_header Content-Security-Policy "default-src * data: blob: 'unsafe-inline' 'unsafe-eval'; frame-ancestors *;" always;

    # Buffer settings
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;

    # Health check endpoint for Docker/Traefik healthchecks
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Traefic forwarda /n8n/*; tratamos a raiz e subsequentes separadamente
    location = /n8n {
        return 301 /n8n/;
    }

    # N8N assets - handle all asset path variations
    # N8N serves assets with "n8n" prefix (no slash) when VUE_APP_URL_BASE_API=/n8n
    location /n8nassets/ {
        rewrite ^/n8nassets/(.*)$ /assets/$1 break;
        proxy_pass http://n8n-app:5678;
    }

    location /n8nstatic/ {
        rewrite ^/n8nstatic/(.*)$ /static/$1 break;
        proxy_pass http://n8n-app:5678;
    }

    # Handle REST API calls with n8n prefix
    location /n8nrest/ {
        rewrite ^/n8nrest/(.*)$ /rest/$1 break;
        proxy_pass http://n8n-app:5678;
    }

    # Handle favicon with n8n prefix
    location = /n8nfavicon.ico {
        rewrite ^/n8nfavicon.ico$ /favicon.ico break;
        proxy_pass http://n8n-app:5678;
    }

    location /n8n/ {
        proxy_set_header X-Forwarded-Prefix /n8n;
        rewrite ^/n8n/(.*)$ /$1 break;
        proxy_pass http://n8n-app:5678;
    }

    location ~ ^/n8n/assets/polyfills--.*\.js$ {
        default_type application/javascript;
        return 200 "// polyfills stub served by n8n-proxy to prevent 404\n";
    }
}
