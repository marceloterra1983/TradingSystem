name: 4-3-workspace-stack

# ==============================================================================
# Workspace Stack - 3 Dedicated Containers (+ Redis Cache)
# ==============================================================================
# Architecture: Dedicated PostgreSQL database + REST API + Redis cache
# Purpose: Workspace management for projects, notes, and items
# Resources: 2.5 CPU, 3.4GB RAM total
# ==============================================================================
#
# Related: backend/api/workspace/
# Database: PostgreSQL 17 Alpine
# Cache: Redis 7 Alpine (Phase 2.3 - Performance Optimization)
# API: Node.js Express + PostgreSQL + Redis
# ==============================================================================

services:
  # ============================================================================
  # 1. Redis - Application Cache for Workspace API (NEW - Phase 2.3)
  # ============================================================================
  workspace-redis:
    image: redis:7-alpine
    container_name: workspace-redis
    platform: linux/amd64
    restart: unless-stopped

    command:
      - redis-server
      - --maxmemory 256mb
      - --maxmemory-policy allkeys-lru
      - --appendonly yes
      - --save 60 1000

    volumes:
      - workspace-redis-data:/data

    networks:
      - tradingsystem_backend

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 384M
        reservations:
          cpus: '0.25'
          memory: 256M

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.tier=cache"
      - "com.tradingsystem.service=redis"
      - "com.tradingsystem.component=application-cache"
      - "com.tradingsystem.phase=2.3-performance"

  # ============================================================================
  # 2. PostgreSQL - Dedicated Database for Workspace
  # ============================================================================
  workspace-db:
    image: postgres:17-alpine
    container_name: workspace-db
    platform: linux/amd64
    restart: unless-stopped

    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${WORKSPACE_DB_PASSWORD:-workspace_secure_pass}
      POSTGRES_DB: workspace
      POSTGRES_MAX_CONNECTIONS: 100
      POSTGRES_SHARED_BUFFERS: 256MB

    volumes:
      - workspace-db-data:/var/lib/postgresql/data
      - ./init-workspace-schema.sql:/docker-entrypoint-initdb.d/01-init.sql:ro

    networks:
      - tradingsystem_backend

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d workspace"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.tier=data"
      - "com.tradingsystem.service=postgresql"
      - "com.tradingsystem.component=database"

  # ============================================================================
  # 3. Workspace API - Application Layer (Updated with Redis Cache)
  # ============================================================================
  workspace-api:
    image: img-apps-workspace:latest
    build:
      context: ../..
      dockerfile: backend/api/workspace/Dockerfile.dev
    container_name: workspace-api
    restart: unless-stopped
    # ports:
    #   - "3200:3200"  # Expose workspace-api on port 3200 (disabled - access via Traefik on 9080)

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      # Server
      - WORKSPACE_PORT=3200
      - NODE_ENV=${NODE_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_PATH=/app/node_modules

      # Database Strategy (ensure Timescale/Postgres is used for full CRUD support)
      - LIBRARY_DB_STRATEGY=postgresql

      # PostgreSQL Connection (via internal Docker network)
      - POSTGRES_HOST=workspace-db
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=workspace
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${WORKSPACE_DB_PASSWORD:-workspace_secure_pass}
      - POSTGRES_SCHEMA=workspace

      # Connection Pool
      - POSTGRES_POOL_MAX=50
      - POSTGRES_POOL_MIN=2
      - POSTGRES_IDLE_TIMEOUT=30000
      - POSTGRES_CONNECTION_TIMEOUT=30000  # Aumentado de 10000ms para 30000ms (30s)

      # Redis Cache Configuration (Phase 2.3 - Performance Optimization)
      - REDIS_HOST=workspace-redis
      - REDIS_PORT=6379
      - REDIS_CACHE_ENABLED=true
      - CACHE_REDIS_TTL=300  # 5 minutes default TTL

      # CORS
      - CORS_ORIGIN=http://localhost:9080,http://localhost:3400

      # Rate Limiting
      - RATE_LIMIT_WINDOW_MS=60000
      - RATE_LIMIT_MAX=120

    # NOTE:
    #   Bind mounts for source code were removed because the devcontainer mount
    #   (`/workspace`) uses private propagation, which results in empty folders
    #   when nested containers try to mount the same paths. The image already
    #   bundles the source and shared modules during build, so running without
    #   bind mounts guarantees the API boots correctly. Rebuild the image to
    #   pick up local changes.

    networks:
      - tradingsystem_backend

    depends_on:
      workspace-db:
        condition: service_healthy
      workspace-redis:
        condition: service_healthy

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3200/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.tier=application"
      - "com.tradingsystem.service=api"
      - "com.tradingsystem.component=workspace-management"
      - "com.tradingsystem.cache=redis-enabled"

      # ============================================================================
      # Traefik Configuration - API Gateway Integration
      # ============================================================================
      # Enable Traefik routing for this service
      - "traefik.enable=true"

      # HTTP Router Configuration
      - "traefik.http.routers.workspace-api.rule=PathPrefix(`/api/workspace`)"
      - "traefik.http.routers.workspace-api.entrypoints=web"
      - "traefik.http.routers.workspace-api.service=workspace-api"
      - "traefik.http.routers.workspace-api.priority=100"

      # Service Configuration (backend target)
      - "traefik.http.services.workspace-api.loadbalancer.server.port=3200"

      # Middlewares (path transformation, CORS, compression, rate limit)
      - "traefik.http.routers.workspace-api.middlewares=workspace-pathrewrite,workspace-cors,workspace-compress,workspace-ratelimit"

      # Path transformation: rewrite /api/workspace/* â†’ /api/*
      - "traefik.http.middlewares.workspace-pathrewrite.replacepathregex.regex=^/api/workspace/?(.*)"
      - "traefik.http.middlewares.workspace-pathrewrite.replacepathregex.replacement=/$$1"

      # CORS Middleware
      - "traefik.http.middlewares.workspace-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,PATCH,OPTIONS"
      - "traefik.http.middlewares.workspace-cors.headers.accesscontrolalloworiginlist=http://localhost:9080,http://localhost:3404"
      - "traefik.http.middlewares.workspace-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.workspace-cors.headers.accesscontrolexposeheaders=*"
      - "traefik.http.middlewares.workspace-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.workspace-cors.headers.addvaryheader=true"
      - "traefik.http.middlewares.workspace-cors.headers.accesscontrolallowcredentials=true"

      # Compression Middleware
      - "traefik.http.middlewares.workspace-compress.compress=true"

      # Rate Limiting Middleware (100 req/min per IP)
      - "traefik.http.middlewares.workspace-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.workspace-ratelimit.ratelimit.period=1m"
      - "traefik.http.middlewares.workspace-ratelimit.ratelimit.burst=50"

      # Health Check
      - "traefik.http.services.workspace-api.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.workspace-api.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.workspace-api.loadbalancer.healthcheck.timeout=5s"

networks:
  tradingsystem_backend:
    name: tradingsystem_backend
    external: true

volumes:
  workspace-db-data:
    name: workspace-db-data
    driver: local
    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.component=database"

  workspace-redis-data:
    name: workspace-redis-data
    driver: local
    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.component=cache"
      - "com.tradingsystem.phase=2.3-performance"

# ==============================================================================
# USAGE EXAMPLES
# ==============================================================================
#
# Start entire Workspace stack:
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml up -d
#
# View logs (all services):
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml logs -f
#
# View logs (specific service):
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml logs -f workspace-api
#
# Check Redis cache stats:
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml exec workspace-redis redis-cli INFO stats
#
# Monitor Redis keys:
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml exec workspace-redis redis-cli KEYS '*'
#
# Check status:
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml ps
#
# Restart specific service:
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml restart workspace-api
#
# Stop entire stack:
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml down
#
# Stop and remove volumes (CAUTION - deletes data):
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml down -v
#
# Connect to database:
#   docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml exec workspace-db \
#     psql -U postgres -d workspace
#
# Check API health (via Traefik gateway):
#   curl http://localhost:9080/api/workspace/health | jq '.'
#
# List workspace items (via Traefik gateway):
#   curl http://localhost:9080/api/workspace/items | jq '.'
#
# Check cache headers (should show X-Cache: HIT or MISS):
#   curl -v http://localhost:9080/api/workspace/items
#
# ==============================================================================
