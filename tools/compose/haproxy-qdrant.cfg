# HAProxy Configuration for Qdrant HA Cluster
# 3-node cluster with round-robin load balancing

global
    log stdout format raw local0
    maxconn 4096
    # Stats socket removed due to permission issues in container
    stats timeout 30s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout queue   30s
    # Retry on connection failure
    retries 3
    option redispatch

# Stats page (accessible at http://localhost:8404/stats)
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats show-node
    stats auth admin:admin  # Change in production!

# Qdrant HTTP API Frontend
frontend qdrant_frontend
    bind *:6333
    default_backend qdrant_cluster

# Qdrant Backend (3 nodes with health checks)
backend qdrant_cluster
    balance roundrobin
    
    # Health check configuration
    option httpchk GET /health
    http-check expect status 200
    
    # Server definitions
    # format: server <name> <host>:<port> check inter <interval> fall <failures> rise <recoveries>
    server node1 qdrant-node1:6333 check inter 5s fall 3 rise 2 weight 100
    server node2 qdrant-node2:6333 check inter 5s fall 3 rise 2 weight 100
    server node3 qdrant-node3:6333 check inter 5s fall 3 rise 2 weight 100
    
    # Enable connection pooling
    option http-keep-alive
    
    # Add X-Forwarded-For header
    option forwardfor
    
    # Server timeout
    timeout server 30s

