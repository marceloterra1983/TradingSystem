# ==============================================================================
# Telegram Stack - MINIMAL PORT EXPOSURE (Solução Definitiva para Conflitos)
# ==============================================================================
# ESTRATÉGIA: Remover exposição de portas para serviços internos
# APENAS APIs públicas (4007, 4010) são expostas
# Todos os outros serviços comunicam via rede interna Docker
# ==============================================================================

name: 4-2-telegram-stack

services:
  # ============================================================================
  # 1. TimescaleDB - SEM PORTA EXTERNA (acesso apenas interno)
  # ============================================================================
  telegram-timescaledb:
    container_name: telegram-timescale
    image: timescale/timescaledb:latest-pg16
    platform: linux/amd64
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      POSTGRES_DB: telegram_gateway
      POSTGRES_USER: ${TELEGRAM_DB_USER:-telegram}
      POSTGRES_PASSWORD: ${TELEGRAM_DB_PASSWORD}
      TIMESCALEDB_TELEMETRY: "off"
      POSTGRES_INITDB_ARGS: >-
        --encoding=UTF-8
        --locale=C
        --data-checksums

    # ⚡ SEM PORTA EXTERNA - comunicação via rede interna
    # ports:
    #   - "${TELEGRAM_DB_PORT:-7435}:5432"

    volumes:
      - telegram-timescaledb-data:/var/lib/postgresql/data
      - ../../backend/data/timescaledb/telegram-gateway:/docker-entrypoint-initdb.d:ro
      # Commented out: mount error causing restart loop
      # - ./telegram/postgresql.conf:/etc/postgresql/postgresql.conf:ro

    command: >
      postgres
      -c shared_buffers=512MB
      -c effective_cache_size=1536MB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_connections=100
      -c shared_preload_libraries=timescaledb,pg_stat_statements

    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "1.0"
          memory: 1G

    healthcheck:
      test:
        [
          "CMD-SHELL",
          'pg_isready -U telegram -d telegram_gateway && psql -U telegram -d telegram_gateway -c "SELECT 1" > /dev/null 2>&1',
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

    networks:
      - telegram_backend

    labels:
      - "com.tradingsystem.stack=telegram"
      - "com.tradingsystem.tier=data"

  # ============================================================================
  # 2. PgBouncer - SEM PORTA EXTERNA
  # ============================================================================
  telegram-pgbouncer:
    container_name: telegram-pgbouncer
    image: edoburu/pgbouncer:latest
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      - DB_HOST=telegram-timescale
      - DB_PORT=5432
      - DB_USER=${TELEGRAM_DB_USER:-telegram}
      - DB_PASSWORD=${TELEGRAM_DB_PASSWORD}
      - DB_NAME=telegram_gateway
      - LISTEN_PORT=6432
      - AUTH_TYPE=md5
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=100
      - DEFAULT_POOL_SIZE=20

    # ⚡ SEM PORTA EXTERNA
    # ports:
    #   - "${TELEGRAM_PGBOUNCER_PORT:-6434}:6432"

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

    depends_on:
      telegram-timescaledb:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 6432"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - telegram_backend

  # ============================================================================
  # 3. Redis Master - SEM PORTA EXTERNA
  # ============================================================================
  telegram-redis-master:
    container_name: telegram-redis-master
    image: redis:7-alpine
    restart: unless-stopped

    command: >
      redis-server
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
      --maxclients 1000

    # ⚡ SEM PORTA EXTERNA
    # ports:
    #   - "${TELEGRAM_REDIS_PORT:-6389}:6379"

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

    volumes:
      - telegram-redis-master-data:/data

    networks:
      telegram_backend:
        aliases:
          - telegram-redis-master
          - redis-master

  # ============================================================================
  # 4. Redis Replica - SEM PORTA EXTERNA
  # ============================================================================
  telegram-redis-replica:
    container_name: telegram-redis-replica
    image: redis:7-alpine
    restart: unless-stopped

    command: >
      redis-server
      --replicaof telegram-redis-master 6379
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
      --replica-read-only yes

    # ⚡ SEM PORTA EXTERNA
    # ports:
    #   - "${TELEGRAM_REDIS_REPLICA_PORT:-6385}:6379"

    depends_on:
      telegram-redis-master:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

    volumes:
      - telegram-redis-replica-data:/data

    networks:
      - telegram_backend

  # ============================================================================
  # 5. Redis Sentinel - SEM PORTA EXTERNA
  # ============================================================================
  telegram-redis-sentinel:
    container_name: telegram-redis-sentinel
    image: redis:7-alpine
    restart: unless-stopped

    command: >
      sh -c '
        until MASTER_IP=$(getent hosts telegram-redis-master | awk "{print \$1}"); do
          echo "[sentinel] waiting for redis master DNS resolution...";
          sleep 1;
        done;
        sed "s/__MASTER_HOST__/$${MASTER_IP}/" /etc/redis/sentinel.template.conf > /tmp/sentinel.conf;
        redis-sentinel /tmp/sentinel.conf
      '

    # ⚡ SEM PORTA EXTERNA
    # ports:
    #   - "${TELEGRAM_REDIS_SENTINEL_PORT:-26379}:26379"

    volumes:
      - ./telegram/sentinel-simple.template.conf:/etc/redis/sentinel.template.conf

    depends_on:
      telegram-redis-master:
        condition: service_healthy
      telegram-redis-replica:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

    networks:
      - telegram_backend

  # ============================================================================
  # 6. RabbitMQ - SEM PORTA EXTERNA (Management UI opcional)
  # ============================================================================
  telegram-rabbitmq:
    container_name: telegram-rabbitmq
    image: rabbitmq:3.12-management-alpine
    restart: unless-stopped

    environment:
      RABBITMQ_DEFAULT_USER: ${TELEGRAM_RABBITMQ_USER:-telegram}
      RABBITMQ_DEFAULT_PASS: ${TELEGRAM_RABBITMQ_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: telegram
      RABBITMQ_CONFIG_FILE: /etc/rabbitmq/rabbitmq.conf

    # ⚡ SEM PORTA EXTERNA - Management UI comentada
    # Descomente se precisar acessar o Management UI
    # ports:
    #   - "${TELEGRAM_RABBITMQ_PORT:-5672}:5672"
    #   - "${TELEGRAM_RABBITMQ_MGMT_PORT:-15672}:15672"

    volumes:
      - telegram-rabbitmq-data:/var/lib/rabbitmq
      - ./telegram/rabbitmq-simple.conf:/etc/rabbitmq/rabbitmq.conf:ro

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G

    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    networks:
      - telegram_backend

  # ============================================================================
  # 7. Telegram MTProto Gateway - ✅ PORTA EXPOSTA (necessária)
  # ============================================================================
  telegram-mtproto:
    container_name: telegram-mtproto
    image: img-telegram-mtproto
    build:
      context: ../../apps/telegram-gateway
      dockerfile: Dockerfile
    restart: unless-stopped

    env_file:
      - ../../.env
      - ../../.env.shared

    environment:
      - NODE_ENV=production
      - GATEWAY_PORT=4007 # ✅ ALWAYS 4007 internally (for inter-container communication)
      - TELEGRAM_GATEWAY_DB_SCHEMA=telegram_gateway
      - TELEGRAM_GATEWAY_DB_TABLE=messages
      - TELEGRAM_GATEWAY_DB_SSL=${TELEGRAM_GATEWAY_DB_SSL:-false}
      - TELEGRAM_REDIS_ENABLED=${TELEGRAM_REDIS_ENABLED:-true}
      - TELEGRAM_REDIS_HOST=telegram-redis-master
      - TELEGRAM_REDIS_PORT=6379

    ports:
      - "${TELEGRAM_MTPROTO_PORT:-14007}:4007" # ✅ External 14007 → Internal 4007

    volumes:
      - ../../apps/telegram-gateway/.session:/usr/src/app/.session
      - ../../apps/telegram-gateway/data:/usr/src/app/data

    depends_on:
      telegram-pgbouncer:
        condition: service_healthy
      telegram-redis-master:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

    networks:
      - telegram_backend
      - tradingsystem_backend

  # ============================================================================
  # 8. Telegram Gateway REST API - ✅ PORTA EXPOSTA (necessária)
  # ============================================================================
  telegram-gateway-api:
    container_name: telegram-gateway-api
    image: img-telegram-gateway-api
    build:
      context: ../../backend/api/telegram-gateway
      dockerfile: Dockerfile
    restart: unless-stopped

    env_file:
      - ../../.env

    environment:
      - NODE_ENV=production
      - TELEGRAM_GATEWAY_API_PORT=4010 # ✅ ALWAYS 4010 internally (for inter-container communication)
      - TELEGRAM_GATEWAY_API_TOKEN=${TELEGRAM_GATEWAY_API_TOKEN}
      - API_SECRET_TOKEN=${API_SECRET_TOKEN:-${TELEGRAM_GATEWAY_API_TOKEN}}
      - TELEGRAM_GATEWAY_DB_HOST=telegram-pgbouncer
      - TELEGRAM_GATEWAY_DB_PORT=6432
      - TELEGRAM_GATEWAY_DB_NAME=telegram_gateway
      - TELEGRAM_GATEWAY_DB_USER=${TELEGRAM_DB_USER:-telegram}
      - TELEGRAM_GATEWAY_DB_PASSWORD=${TELEGRAM_DB_PASSWORD}
      - TELEGRAM_GATEWAY_DB_CONNECTION_TIMEOUT_MS=30000
      - TELEGRAM_GATEWAY_DB_POOL_MAX=10
      - TELEGRAM_GATEWAY_DB_IDLE_TIMEOUT_MS=30000
      - REDIS_HOST=telegram-redis-master
      - REDIS_PORT=6379
      - REDIS_ENABLED=${TELEGRAM_REDIS_ENABLED:-true}
      - GATEWAY_SERVICE_URL=http://telegram-mtproto:4007 # ✅ Internal port 4007
      - MTPROTO_SERVICE_URL=http://telegram-mtproto:4007 # ✅ Internal port 4007
      - TELEGRAM_GATEWAY_SESSION_FILE=/usr/src/app/.session/telegram-gateway.session
      - TELEGRAM_GATEWAY_FAILURE_QUEUE_PATH=/usr/src/app/data/failure-queue.jsonl

    # External port exposure removed; service published via Traefik gateway
    volumes:
      - ../../apps/telegram-gateway/.session:/usr/src/app/.session
      - ../../apps/telegram-gateway/data:/usr/src/app/data

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

    depends_on:
      telegram-pgbouncer:
        condition: service_healthy
      telegram-redis-master:
        condition: service_healthy

    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:4010/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    networks:
      - telegram_backend
      - tradingsystem_backend

    labels:
      - "com.tradingsystem.stack=telegram-gateway"
      - "com.tradingsystem.tier=application"
      - "com.tradingsystem.service=rest-api"
      - "com.tradingsystem.component=gateway"

      - "traefik.enable=true"
      - "traefik.http.routers.telegram-gateway.rule=PathPrefix(`/api/telegram-gateway`)"
      - "traefik.http.routers.telegram-gateway.entrypoints=web"
      - "traefik.http.routers.telegram-gateway.service=telegram-gateway"
      - "traefik.http.routers.telegram-gateway.priority=90"
      - "traefik.http.routers.telegram-gateway-messages.rule=PathPrefix(`/api/messages`)"
      - "traefik.http.routers.telegram-gateway-messages.entrypoints=web"
      - "traefik.http.routers.telegram-gateway-messages.service=telegram-gateway"
      - "traefik.http.routers.telegram-gateway-messages.priority=80"
      - "traefik.http.routers.telegram-gateway-channels.rule=PathPrefix(`/api/channels`)"
      - "traefik.http.routers.telegram-gateway-channels.entrypoints=web"
      - "traefik.http.routers.telegram-gateway-channels.service=telegram-gateway"
      - "traefik.http.routers.telegram-gateway-channels.priority=80"
      - "traefik.http.services.telegram-gateway.loadbalancer.server.port=4010"
      - "traefik.docker.network=tradingsystem_backend"
      - "traefik.http.services.telegram-gateway.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.telegram-gateway.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.telegram-gateway.loadbalancer.healthcheck.timeout=10s"

networks:
  telegram_backend:
    external: true
  tradingsystem_backend:
    external: true

volumes:
  telegram-timescaledb-data:
    name: telegram-timescaledb-data
  telegram-redis-master-data:
    name: telegram-redis-master-data
  telegram-redis-replica-data:
    name: telegram-redis-replica-data
  telegram-rabbitmq-data:
    name: telegram-rabbitmq-data
