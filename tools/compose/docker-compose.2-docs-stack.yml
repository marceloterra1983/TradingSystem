# ============================================================================
# TradingSystem - Documentation Services (2 Containers)
# ============================================================================
# Services:
#   - Documentation (Port 3404) - NGINX serving Docusaurus + specs (static)
#   - DocsAPI (Port 3405) - Express + FlexSearch + CRUD (dynamic API)
#
# Usage:
#   docker compose -f tools/compose/docker-compose.docs.yml up -d
#   docker compose -f tools/compose/docker-compose.docs.yml logs -f
#   docker compose -f tools/compose/docker-compose.docs.yml down
#
# Last Updated: 2025-10-26
# ============================================================================

name: 2-docs-stack

services:
  # ============================================================================
  # Documentation - NGINX Static Server
  # Serves: Docusaurus (HTML/CSS/JS), OpenAPI/AsyncAPI specs (YAML/JSON)
  # ============================================================================
  documentation:
    container_name: docs-hub
    image: "${IMG_DOCS_HUB:-img-docs-hub}:${IMG_VERSION:-latest}"
    platform: linux/amd64
    # ports:
    #   - "3404:80"  # Expose docs-hub on port 3404 (disabled - access via Traefik on 9080/docs)
    env_file:
      - ../../.env
      - ../../.env.shared
    build:
      context: ./documentation
      dockerfile: Dockerfile
    volumes:
      # Docusaurus build (static site)
      - ../../docs/build:/usr/share/nginx/html
      # OpenAPI/AsyncAPI specifications (shared with dashboard)
      - ../../frontend/dashboard/public/specs:/data/specs:ro
    restart: unless-stopped
    networks:
      - tradingsystem_frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    labels:
      - "com.tradingsystem.stack=2-docs-stack"
      - "com.tradingsystem.service=docs-static"
      - "com.tradingsystem.type=frontend"
      - "com.tradingsystem.port=3404"

      # ========================================================================
      # Traefik Configuration - API Gateway Integration
      # ========================================================================
      # Enable Traefik routing for Documentation Hub
      - "traefik.enable=true"

      # HTTP Router Configuration
      - "traefik.http.routers.docs-hub.rule=PathPrefix(`/docs`)"
      - "traefik.http.routers.docs-hub.entrypoints=web"
      - "traefik.http.routers.docs-hub.service=docs-hub"
      - "traefik.http.routers.docs-hub.priority=50"

      # Service Configuration (backend target)
      - "traefik.http.services.docs-hub.loadbalancer.server.port=80"

      # Middlewares (strip /docs prefix only - no @file middleware due to WSL2 issues)
      - "traefik.http.routers.docs-hub.middlewares=docs-stripprefix"
      - "traefik.http.middlewares.docs-stripprefix.stripprefix.prefixes=/docs"

      # Health Check
      - "traefik.http.services.docs-hub.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.docs-hub.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.docs-hub.loadbalancer.healthcheck.timeout=10s"

  # ============================================================================
  # DocsAPI - Documentation Management API
  # Provides: FlexSearch, CRUD operations, spec validation
  # ============================================================================
  docs-api:
    container_name: docs-api
    image: "${IMG_DOCS_API:-img-docs-api}:${IMG_VERSION:-latest}"
    platform: linux/amd64
    # ports:
    #   - "3405:3000"  # Expose docs-api on port 3405 (disabled - access via Traefik on 9080/api/docs)
    env_file:
      - ../../.env
      - ../../.env.shared
    build:
      context: ../..  # CORRIGIDO: Project root para paths funcionarem
      dockerfile: backend/api/documentation-api/Dockerfile
      target: development
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DOCS_DIR=/app/docs
      - LLAMAINDEX_DOCS_DIR=/app/docs/content
      - LLAMAINDEX_INGESTION_DOCS_DIR=/data/docs
      - LLAMAINDEX_REPOSITORY_DIR=/data/tradingsystem
      - DOCUMENTATION_DB_STRATEGY=none
      - LOG_LEVEL=info
      # RAG Features (Optional - Graceful Degradation)
      - ENABLE_RAG_FEATURES=false
      - REDIS_ENABLED=false
      - QDRANT_URL=http://rag-qdrant:6333
      - OLLAMA_BASE_URL=http://rag-ollama:11434
      - REDIS_URL=redis://rag-redis:6379
      - COLLECTIONS_SERVICE_URL=http://rag-collections-service:3402
      - LLAMAINDEX_QUERY_URL=http://rag-llamaindex-query:8000
      - LLAMAINDEX_INGESTION_URL=http://rag-llamaindex-ingest:8000
    volumes:
      # Documentation source files
      - ../../docs:/app/docs:ro
      - ../../:/data/tradingsystem:ro
      # Database (SQLite)
      - docs-api-data:/app/db
    restart: unless-stopped
    networks:
      - tradingsystem_backend
      - tradingsystem_frontend
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    labels:
      - "com.tradingsystem.stack=2-docs-stack"
      - "com.tradingsystem.service=docs-api"
      - "com.tradingsystem.type=backend"
      - "com.tradingsystem.port=3405"

      # ========================================================================
      # Traefik Configuration - API Gateway Integration
      # ========================================================================
      # Enable Traefik routing for Documentation API
      - "traefik.enable=true"

      # HTTP Router Configuration
      - "traefik.http.routers.docs-api.rule=PathPrefix(`/api/docs`)"
      - "traefik.http.routers.docs-api.entrypoints=web"
      - "traefik.http.routers.docs-api.service=docs-api"
      - "traefik.http.routers.docs-api.priority=90"

      # Service Configuration (backend target)
      - "traefik.http.services.docs-api.loadbalancer.server.port=3000"

      # Middlewares (path transformation only - no @file middleware due to WSL2 issues)
      - "traefik.http.routers.docs-api.middlewares=docs-api-stripprefix"

      # Path transformation: /api/docs/X â†’ /X (API has routes at root like /health, /search)
      - "traefik.http.middlewares.docs-api-stripprefix.stripprefix.prefixes=/api/docs"

      # Health Check
      - "traefik.http.services.docs-api.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.docs-api.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.docs-api.loadbalancer.healthcheck.timeout=10s"

# ============================================================================
# Volumes
# ============================================================================
volumes:
  docs-api-data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  tradingsystem_backend:
    external: true
  tradingsystem_frontend:
    external: true
