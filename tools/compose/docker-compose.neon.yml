name: neon

services:
  # ============================================================
  # Neon Compute (PostgreSQL 15 node)
  # Main database interface for applications
  # ============================================================
  neon-compute:
    image: neondatabase/compute-node-v15:latest
    container_name: neon-compute
    hostname: neon-compute
    ports:
      - "${NEON_COMPUTE_PORT:-5435}:5432"
    environment:
      # PostgreSQL Configuration
      POSTGRES_USER: ${NEON_POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${NEON_POSTGRES_PASSWORD:-neon_password}
      POSTGRES_DB: ${NEON_POSTGRES_DB:-rag}
      
      # Neon-specific Configuration
      NEON_PAGESERVER_CONNSTRING: postgresql://postgres@neon-pageserver:6400
      NEON_SAFEKEEPER_CONNSTRINGS: postgresql://postgres@neon-safekeeper:7676
      
      # Connection Pooling
      MAX_CONNECTIONS: "100"
      SHARED_BUFFERS: "1GB"
      EFFECTIVE_CACHE_SIZE: "3GB"
      WORK_MEM: "16MB"
      
      # Logging
      LOG_STATEMENT: "all"
      LOG_MIN_DURATION_STATEMENT: "100"
      LOG_LINE_PREFIX: "%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h"
    volumes:
      # Minimal local storage (most data in Pageserver)
      - neon_compute_data:/var/lib/postgresql/data
      
      # Custom configuration (optional)
      - ./neon/neon.conf:/etc/postgresql/postgresql.conf:ro
      
      # Init scripts for extensions and schema
      - ../../backend/data/neon/init:/docker-entrypoint-initdb.d:ro
    networks:
      - tradingsystem_backend
    depends_on:
      neon-pageserver:
        condition: service_healthy
      neon-safekeeper:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${NEON_POSTGRES_USER:-postgres} -d ${NEON_POSTGRES_DB:-rag}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
    labels:
      - "com.tradingsystem.service=neon-compute"
      - "com.tradingsystem.category=database"
      - "com.tradingsystem.layer=data"

  # ============================================================
  # Neon Pageserver (Storage layer)
  # Handles page-level storage with copy-on-write
  # ============================================================
  neon-pageserver:
    image: neondatabase/neon:latest
    container_name: neon-pageserver
    hostname: neon-pageserver
    command: pageserver -D /data
    ports:
      - "${NEON_PAGESERVER_PORT:-6400}:6400"
    environment:
      - PAGESERVER_ID=1
      - PAGESERVER_LISTEN_ADDR=0.0.0.0:6400
      - PAGESERVER_BROKER_ENDPOINT=http://neon-safekeeper:7676
      
      # Storage configuration
      - PAGESERVER_CHECKPOINT_DISTANCE=268435456  # 256MB
      - PAGESERVER_CHECKPOINT_TIMEOUT=600         # 10 minutes
      - PAGESERVER_COMPACTION_THRESHOLD=10        # Compact after 10 layers
      
      # Performance tuning
      - PAGESERVER_PAGE_CACHE_SIZE=1073741824     # 1GB page cache
      - PAGESERVER_MAX_FILE_DESCRIPTORS=10000
    volumes:
      - neon_pageserver_data:/data
      
      # Configuration (optional)
      - ./neon/pageserver.toml:/data/pageserver.toml:ro
    networks:
      - tradingsystem_backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6400/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    labels:
      - "com.tradingsystem.service=neon-pageserver"
      - "com.tradingsystem.category=database"
      - "com.tradingsystem.layer=data"

  # ============================================================
  # Neon Safekeeper (WAL service for durability)
  # Provides PITR and crash recovery
  # ============================================================
  neon-safekeeper:
    image: neondatabase/neon:latest
    container_name: neon-safekeeper
    hostname: neon-safekeeper
    command: safekeeper -D /data --id=1 --listen-pg=0.0.0.0:7676 --listen-http=0.0.0.0:7677
    ports:
      - "${NEON_SAFEKEEPER_PORT:-7676}:7676"
      - "${NEON_SAFEKEEPER_HTTP_PORT:-7677}:7677"
    environment:
      - SAFEKEEPER_ID=1
      - SAFEKEEPER_LISTEN_PG=0.0.0.0:7676
      - SAFEKEEPER_LISTEN_HTTP=0.0.0.0:7677
      
      # WAL retention for PITR (30 days)
      - SAFEKEEPER_WAL_RETENTION_PERIOD=2592000  # 30 days in seconds
      
      # Consensus configuration
      - SAFEKEEPER_HEARTBEAT_INTERVAL=100         # 100ms
      - SAFEKEEPER_ELECTION_TIMEOUT=500           # 500ms
    volumes:
      - neon_safekeeper_data:/data
      
      # Configuration (optional)
      - ./neon/safekeeper.toml:/data/safekeeper.toml:ro
    networks:
      - tradingsystem_backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7677/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
    labels:
      - "com.tradingsystem.service=neon-safekeeper"
      - "com.tradingsystem.category=database"
      - "com.tradingsystem.layer=data"

# ============================================================
# Networks
# ============================================================
networks:
  tradingsystem_backend:
    external: true
    name: tradingsystem_backend

# ============================================================
# Volumes
# ============================================================
volumes:
  neon_compute_data:
    driver: local
    name: neon_compute_data
  
  neon_pageserver_data:
    driver: local
    name: neon_pageserver_data
  
  neon_safekeeper_data:
    driver: local
    name: neon_safekeeper_data
