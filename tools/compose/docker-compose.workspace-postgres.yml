name: workspace-stack-postgres

# ==============================================================================
# Workspace Stack - PostgreSQL Vanilla (Alternative to Neon)
# ==============================================================================
#
# This is a simplified version using standard PostgreSQL 17 instead of Neon.
# Use this if Neon build fails or for faster deployment.
#
# Differences from Neon:
# - No database branching (but you don't need it for this use case)
# - No scale-to-zero (always running)
# - Simpler architecture (1 container vs 3)
# - Faster startup (~10 seconds vs ~60 seconds)
# - Less RAM usage (~300MB vs ~1.3GB)
#
# Usage:
#   docker compose -f tools/compose/docker-compose.workspace-postgres.yml up -d
#   docker compose -f tools/compose/docker-compose.workspace-postgres.yml down
#
# ==============================================================================

services:
  # ============================================================================
  # DATABASE LAYER - PostgreSQL 17 (Vanilla)
  # ============================================================================

  workspace-db:
    image: postgres:17-alpine
    container_name: workspace-db
    
    environment:
      # Database credentials
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${WORKSPACE_DB_PASSWORD:-workspace_secure_pass}
      POSTGRES_DB: workspace
      
      # Performance tuning
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      
      # Connection limits
      POSTGRES_MAX_CONNECTIONS: 100
      
      # Shared buffers (25% of RAM)
      POSTGRES_SHARED_BUFFERS: 256MB
      
      # Work memory
      POSTGRES_WORK_MEM: 16MB
      
      # Maintenance work memory
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB
    
    ports:
      - "5450:5432"  # External:Internal (5433-5435 in use, using 5450)
    
    volumes:
      # Data persistence
      - workspace-db-data:/var/lib/postgresql/data
      
      # Initialization script
      - ./init-workspace-schema.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    
    networks:
      - workspace_network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d workspace"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    restart: unless-stopped
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.component=database"
      - "com.tradingsystem.type=postgresql"

  # ============================================================================
  # APPLICATION LAYER - Workspace API
  # ============================================================================

  workspace-api:
    image: "${IMG_APPS_WORKSPACE:-img-apps-workspace}:${IMG_VERSION:-latest}"
    build:
      context: ../..
      dockerfile: backend/api/workspace/Dockerfile.dev
    container_name: workspace-api
    
    env_file:
      - ../../.env
    
    ports:
      - "${WORKSPACE_EXTERNAL_PORT:-3210}:3200"  # Using 3210 externally (3200 in use)
    
    environment:
      # Server Configuration
      - WORKSPACE_PORT=3200
      - NODE_ENV=${NODE_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # Database Strategy (POSTGRESQL instead of NEON)
      - LIBRARY_DB_STRATEGY=postgresql
      
      # PostgreSQL Connection
      - POSTGRES_HOST=workspace-db
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=workspace
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${WORKSPACE_DB_PASSWORD:-workspace_secure_pass}
      - POSTGRES_SCHEMA=workspace
      
      # Connection Pool
      - POSTGRES_POOL_MAX=50
      - POSTGRES_POOL_MIN=2
      - POSTGRES_IDLE_TIMEOUT=30000
      - POSTGRES_CONNECTION_TIMEOUT=5000
      
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3103,http://localhost:3400}
      
      # Rate Limiting
      - RATE_LIMIT_WINDOW_MS=60000
      - RATE_LIMIT_MAX=120
    
    volumes:
      # Hot-reload: mount source code
      - ../../backend/api/workspace/src:/app/src:ro
      - ../../backend/api/workspace/scripts:/app/scripts:ro
      
      # Mount shared modules
      - ../../backend/shared:/app/backend/shared:ro
      
      # Anonymous volume prevents overwrite
      - /app/node_modules
    
    networks:
      - workspace_network
      - tradingsystem_backend
    
    depends_on:
      workspace-db:
        condition: service_healthy
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3200/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.component=api"
      - "com.tradingsystem.type=nodejs"

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  # Internal network for Workspace stack
  workspace_network:
    name: workspace_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
    labels:
      - "com.tradingsystem.stack=workspace"
  
  # External network for Dashboard access
  tradingsystem_backend:
    name: tradingsystem_backend
    external: true

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  workspace-db-data:
    name: workspace-db-data
    driver: local
    labels:
      - "com.tradingsystem.stack=workspace"
      - "com.tradingsystem.component=database"

# ==============================================================================
# USAGE EXAMPLES
# ==============================================================================
# 
# Start Workspace stack (PostgreSQL):
#   docker compose -f tools/compose/docker-compose.workspace-postgres.yml up -d
# 
# View logs:
#   docker compose -f tools/compose/docker-compose.workspace-postgres.yml logs -f
# 
# Stop stack:
#   docker compose -f tools/compose/docker-compose.workspace-postgres.yml down
# 
# Connect to database:
#   docker compose -f tools/compose/docker-compose.workspace-postgres.yml exec workspace-db psql -U postgres -d workspace
# 
# ==============================================================================

