---
title: "Flow \u2013 Place Order"
description: Process flow for placing an order through the TradingSystem platform.
tags:
  - sdd
  - flows
owner: ArchitectureGuild
lastReviewed: '2025-10-26'
---
## Overview

The Place Order flow describes the complete sequence for creating and submitting a trading order through TradingSystem, from initial request to broker submission.

**Flow Name**: Place Order  
**Version**: v1  
**Status**: Specification (implementation pending)  
**Trigger**: User submits order via Dashboard or API client

## Flow Diagram

```mermaid
sequenceDiagram
    participant User
    participant Dashboard
    participant OrderManager as Order Manager API
    participant RiskEngine as Risk Engine
    participant Database
    participant ProfitDLL
    participant EventBus

    User->>Dashboard: Fill order form (symbol, side, quantity, price)
    Dashboard->>Dashboard: Client-side validation
    Dashboard->>OrderManager: POST /api/orders

    Note over OrderManager: Step 1: Input Validation
    OrderManager->>OrderManager: Validate required fields
    OrderManager->>OrderManager: Validate field types and formats

    Note over OrderManager,RiskEngine: Step 2: Risk Validation
    OrderManager->>RiskEngine: Check trading hours
    RiskEngine-->>OrderManager: ✅ Passed (9:00-18:00)

    OrderManager->>RiskEngine: Check kill switch
    RiskEngine-->>OrderManager: ✅ Passed (inactive)

    OrderManager->>Database: Query current daily loss
    Database-->>OrderManager: R$1,250 / R$5,000
    OrderManager->>RiskEngine: Check daily loss limit
    RiskEngine-->>OrderManager: ✅ Passed

    OrderManager->>Database: Query current position (PETR4)
    Database-->>OrderManager: 750 shares
    OrderManager->>RiskEngine: Check position size
    RiskEngine-->>OrderManager: ✅ Passed

    OrderManager->>ProfitDLL: Query available margin
    ProfitDLL-->>OrderManager: R$40,000 available
    OrderManager->>RiskEngine: Check margin requirement
    RiskEngine-->>OrderManager: ✅ Passed

    Note over OrderManager: Step 3: Order Creation
    OrderManager->>Database: INSERT order (status: PENDING)
    Database-->>OrderManager: Order created

    OrderManager->>EventBus: Publish order.created event
    EventBus-->>Dashboard: Event notification

    OrderManager-->>Dashboard: 201 Created {orderId, status: PENDING}
    Dashboard->>Dashboard: Update order list
    Dashboard-->>User: Display success notification

    Note over OrderManager: Step 4: Broker Submission
    OrderManager->>ProfitDLL: SendOrder(PETR4, BUY, 100, 32.50)
    ProfitDLL-->>OrderManager: Order ID: XXX-YYY-ZZZ

    OrderManager->>Database: UPDATE order (status: SUBMITTED)
    OrderManager->>EventBus: Publish order.submitted event

    Note over ProfitDLL: Step 5: Broker Execution
    ProfitDLL->>ProfitDLL: Order in book, awaiting fill
    ProfitDLL-->>OrderManager: OnOrderStatus callback (FILLED)

    OrderManager->>Database: UPDATE order (status: FILLED)
    OrderManager->>EventBus: Publish order.filled event
    EventBus-->>Dashboard: Event notification
    Dashboard->>Dashboard: Update order status
    Dashboard-->>User: Display fill notification
```

## Steps

### Step 1: Input Validation

**Responsibility**: Order Manager API  
**Duration**: &lt;10ms

**Validations**
1. Validate required fields present: `symbol`, `side`, `type`, `quantity`
2. Validate field types: `quantity` is integer, `price` is decimal
3. Validate enums: `side` in [BUY, SELL], `type` in [MARKET, LIMIT, STOP, STOP_LIMIT]
4. Validate conditional fields: `price` required for LIMIT, `stopPrice` required for STOP
5. Validate ranges: `quantity` > 0, `price` > 0

**Success**: Proceed to Step 2  
**Failure**: Return 400 Bad Request with validation errors

### Step 2: Risk Validation

**Responsibility**: Risk Engine (within Order Manager)  
**Duration**: &lt;100ms p95

**Risk Checks (in sequence)**
1. **Trading Hours**: Reject if current time outside configured hours
2. **Kill Switch**: Reject if kill switch active
3. **Daily Loss Limit**: Reject if `currentDailyLoss &gt;= dailyLossLimit`
4. **Position Size Limit**: Reject if `currentPosition + orderQuantity > maxPositionSize[symbol]`
5. **Margin Requirement**: Reject if insufficient margin from broker

**Success**: All checks pass, proceed to Step 3  
**Failure**: Return 403 Forbidden with specific rejection reason

### Step 3: Order Creation

**Responsibility**: Order Manager API  
**Duration**: &lt;50ms

**Actions**
1. Generate `orderId` (format `ORD-YYYYMMDD-NNN`)
2. Set status to `PENDING`
3. Apply timestamps `createdAt` and `updatedAt`
4. Check idempotency key and return existing order if duplicate
5. Insert order into database
6. Publish `order.created` event
7. Return 201 Created response

**Success**: Order created, event published, proceed to Step 4  
**Failure**: Return 500 Internal Server Error if database or event bus fails

### Step 4: Broker Submission

**Responsibility**: Order Manager API + ProfitDLL  
**Duration**: &lt;500ms p95

**Actions**
1. Call ProfitDLL `SendOrder`
2. Await broker acknowledgment (timeout 5 seconds)
3. Receive broker order ID
4. Update order status to `SUBMITTED`
5. Persist broker order ID
6. Publish `order.submitted` event

**Success**: Order submitted, proceed to Step 5  
**Failure**: Set status to `FAILED`, capture error context, retry up to 3 times, and publish `order.failed` if retries are exhausted (transitioning to `REJECTED`)

### Step 5: Broker Execution

**Responsibility**: ProfitDLL + Broker  
**Duration**: Variable (market driven)

**Actions**
1. Broker places order in book
2. ProfitDLL emits status callbacks
3. Update order status to `PARTIALLY_FILLED` or `FILLED`
4. Record fills (quantity, price, timestamp)
5. Publish corresponding events (`order.filled`, etc.)
6. Update positions and audit log

**Success**: Order reaches terminal state  
**Failure**: Handle `CANCELED`, `REJECTED`, `FAILED`, or `EXPIRED` outcomes

## Validations

**Pre-Conditions**
- User authenticated (future)
- Order Manager service healthy
- ProfitDLL connection active
- Database accessible
- Event bus available (degrades gracefully)

**Post-Conditions**
- Order persisted with status `PENDING` or `SUBMITTED`
- `order.created` event published
- Client receives confirmation
- Risk checks logged to audit trail

**Invariants**
- Order ID unique
- Status transitions follow state machine
- Risk checks recorded (pass or fail)
- Timestamps increase monotonically

## Error Scenarios

### Scenario 1: Risk Check Failure
- Input validation passes
- Risk validation fails (e.g., daily loss limit)
- Order not persisted
- API returns 403 Forbidden with reason

### Scenario 2: Database Failure
- Risk checks pass
- Database insert fails
- Order not created
- API returns 500 Internal Server Error

### Scenario 3: Event Bus Failure
- Order created successfully
- Event publication fails
- Error logged, API returns 201 Created
- Event lost (acceptable for MVP)

### Scenario 4: ProfitDLL Disconnected
- Order created (status `PENDING`)
- Broker submission fails
- Status updated to `FAILED` then retried
- After retries, publish `order.failed`, set status `REJECTED`, and surface reason to client

### Scenario 5: Time-in-Force Expiration
- Order remains `SUBMITTED` without fills past `timeInForce`
- Broker or scheduler triggers expiration
- Status transitions to `EXPIRED`
- Publish `order.canceled` (if broker cancels) or future `order.expired` event once defined

## Performance Considerations

- Total latency target: &lt;500ms p95 (Steps 1-4)
- Input validation: &lt;10ms
- Risk validation: &lt;100ms p95
- Order creation: &lt;50ms
- Broker submission: &lt;500ms p95
- Support 100 concurrent order placements
- Use database transactions for consistency

## Related Documentation

- [Order Schema](../../domain/schemas/v1/order)
- [Risk Rule Schema](../../domain/schemas/v1/risk-rule)
- [Order Created Event](../../events/v1/order-created)
- [Order Failed Event](../../events/v1/order-failed)
- [Cancel Order Flow](./cancel-order)
- [Order Manager API](../../api/order-manager)
- [State Machine Diagram](/diagrams) (when migrated)
