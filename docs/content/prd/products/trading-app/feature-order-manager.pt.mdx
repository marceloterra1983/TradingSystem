---
title: "Brief de Funcionalidade \u2013 Order Manager"
description: Requisitos de produto para a funcionalidade Order Manager dentro do Trading
  App.
tags:
  - prd
  - trading-app
  - order-manager
owner: ProductOps
lastReviewed: '2025-10-26'
language: pt
translated_from: ./feature-order-manager.mdx
translation_source_language: en
translation_source_hash: d53b910baec02fc2676641aa5f068da471af67a6
---
## 1. Resumo

A funcionalidade **Order Manager** possibilita execução automatizada de ordens com salvaguardas de risco abrangentes. Ela aplica limites de perda diária, controles de tamanho de posição, restrições de horário de negociação e oferece um kill switch para paradas de emergência. O sistema valida todas as ordens contra parâmetros de risco configurados antes do envio ao ProfitDLL, garantindo automação segura com execução rápida (&lt;500ms p95 de latência).

**Problema**
- Execução manual de ordens é lenta e sujeita a erros
- Dashboards atuais não mostram claramente rejeições de ordens e motivos
- Controles de risco aplicados de forma inconsistente e sem automação
- Ausência de kill switch centralizado para emergências

**Solução Proposta**
- Order Manager automatizado com validação de risco pré-negociação
- Payloads de erro estruturados com motivos acionáveis
- Dashboard com monitoramento de risco em tempo real
- Kill switch de emergência para cancelar todas as ordens instantaneamente

## 2. Objetivos

**Objetivos Primários**
1. Aplicar limites de perda diária e tamanho de posição antes de cada ordem
2. Fornecer feedback acionável quando ordens forem rejeitadas
3. Executar ordens market, limit e stop com latência &lt;500ms p95
4. Rastrear todo o ciclo de vida da ordem (PENDING → FILLED/CANCELED/REJECTED)
5. Implementar kill switch para parada emergencial de negociações

**Objetivos Secundários**
1. Suportar múltiplos tipos de ordem (MARKET, LIMIT, STOP, STOP_LIMIT)
2. Garantir idempotência na criação de ordens (evitar duplicadas)
3. Expor métricas Prometheus para monitoramento
4. Manter trilha de auditoria completa para compliance
5. Permitir configuração dinâmica de limites de risco

## 3. Não-Objetivos

- Não redesenha a camada de integração ProfitDLL (usa DLL atual)
- Não implementa suporte multi-broker (MVP com um broker)
- Não permite modificação de ordens (cancelar e recriar)
- Não inclui modo de backtesting (feature separada)
- Não adiciona tipos avançados de ordem (OCO, bracket) no MVP
- Não oferece execução totalmente automatizada (requer aprovação manual)

## 4. Contexto

**Estado Atual**
- Execução manual de ordens via API ProfitDLL
- Controles de risco aplicados manualmente por traders
- Sem rastreamento centralizado de ordens ou trilha de auditoria
- Dashboard não possui interface de gestão de ordens
- Sem validação automática de risco antes do envio

**Contexto de Mercado**
- Negociação em ativos brasileiros (feed TP Capital)
- Horário de mercado: 9:00-18:00 BRT
- Moeda: BRL (Real)
- Broker: Nelogica via ProfitDLL

**Contexto Técnico**
- Deploy nativo Windows (requisito do ProfitDLL)
- Implementação .NET 8 / C#
- Porta 3205 (API Order Manager)
- Integração com Dashboard (porta 3103)

## 5. Histórias de Usuário

### US-1: Colocação de Ordem com Validação de Risco
**Como** trader  
**Quero** enviar ordens com validação automática de risco  
**Para** executar trades com segurança sem checagens manuais

**Critérios de Aceitação**
- Formulário valida entradas no cliente (ticker, quantidade, preço)
- API valida ordem contra limites de risco antes do envio
- Rejeições exibem motivo claro (ex.: "Limite de perda diária excedido: R$5.250 / R$5.000")
- Ordens aprovadas submetidas ao broker em &lt;500ms
- Status atualizado em tempo real (PENDING → SUBMITTED → FILLED)

### US-2: Configuração de Limites de Risco
**Como** analista de risco  
**Quero** configurar limites dinamicamente  
**Para** ajustar controles sem reiniciar serviços

**Critérios de Aceitação**
- Limites configuráveis via API (perda diária, tamanho de posição, horários)
- Mudanças aplicadas imediatamente (sem restart)
- Auditoria registra todas as mudanças com horário e usuário
- Dashboard mostra limites vigentes e utilização

### US-3: Kill Switch de Emergência
**Como** gestor de risco  
**Quero** acionar o kill switch para parar trading  
**Para** evitar perdas durante anomalias de mercado

**Critérios de Aceitação**
- Kill switch ativa em até 1 segundo
- Todas as ordens pendentes canceladas imediatamente
- Novas ordens rejeitadas enquanto kill switch ativo
- Alerta enviado a operadores (Slack, email)
- Auditoria registra motivo e timestamp da ativação

### US-4: Visibilidade de Rejeição de Ordens
**Como** analista de risco  
**Preciso** de motivos claros de rejeição  
**Para** ajustar parâmetros de trading rapidamente

**Critérios de Aceitação**
- Order Manager rejeita solicitações que excedem limites com payload estruturado
- Rejeições aparecem no dashboard com mensagem acionável
- Mensagens incluem limite violado e valor atual
- Histórico de rejeições disponível via API

### US-5: Acompanhamento do Ciclo de Vida da Ordem
**Como** trader  
**Quero** acompanhar o status da ordem em tempo real  
**Para** monitorar execuções e agir quando necessário

**Critérios de Aceitação**
- Dashboard lista todas as ordens com status atual
- Status atualizado em tempo real (polling ou WebSocket)
- Detalhes incluem fills, preço médio, timestamps
- Filtro por status, símbolo e período

## 6. Critérios de Aceitação

**Funcionais**
- ✅ Endpoint de criação valida todos os campos obrigatórios
- ✅ Checagens de risco aplicam limite diário, tamanho de posição e horário
- ✅ Kill switch cancela ordens pendentes em até 1 segundo
- ✅ Ciclo de vida segue 11 estados definidos (diagrama de estados)
- ✅ Chave de idempotência evita ordens duplicadas
- ✅ Cancelamento de ordens é idempotente

**Performance**
- ✅ Latência de colocação &lt;500ms p95 (NFR-1.5)
- ✅ Validação de risco &lt;100ms p95
- ✅ Tempo de resposta da API &lt;200ms p95
- ✅ Suporta 100 ordens concorrentes por conta

**Segurança**
- ✅ Todas as ordens registradas na trilha de auditoria
- ✅ Violações de risco logadas com motivo e timestamp
- ✅ Ativações de kill switch registradas com usuário e motivo
- ✅ Mensagens de erro sem dados sensíveis

**Usabilidade**
- ✅ Mensagens de erro claras e acionáveis
- ✅ Dashboard mostra status em tempo real
- ✅ Violações exibem valor atual vs limite
- ✅ Kill switch com diálogo de confirmação

## 7. Dependências

**SDD**
- [Schema de Ordem](../../../sdd/domain/schemas/v1/order)
- [Schema de Regra de Risco](../../../sdd/domain/schemas/v1/risk-rule)
- [Evento Order Created](../../../sdd/events/v1/order-created)
- [Fluxo Place Order](../../../sdd/flows/v1/place-order)
- [Fluxo Cancel Order](../../../sdd/flows/v1/cancel-order)

**API**
- [API Order Manager](../../../api/order-manager)
- [Spec Order Manager](../../../sdd/api/order-manager/v1/spec)
- [Guidelines Order Manager](../../../sdd/api/order-manager/v1/guidelines)
- Redoc: `/redoc/order-manager` (pendente de automação)

**Frontend**
- [Arquitetura Frontend](../../../frontend/engineering/architecture)
- [Convenções Frontend](../../../frontend/engineering/conventions)
- [Design System](../../../frontend/design-system/components)

**Externo**
- ProfitDLL (execução de ordens, ambiente Windows)
- Feed de sinais TP Capital (validação de preço)
- TimescaleDB (persistência de ordens)

## 8. Referências de UX/UI

**Design System**
- Cores: Gestão de Risco (Vermelho #EF4444) para UI de ordens
- Tipografia: Família Inter, pesos 400-700
- Componentes: shadcn/ui (Button, Dialog, Table, Badge)

**Wireframe do Formulário**
```
┌─────────────────────────────────────┐
│ Colocar Ordem                 [×]  │
├─────────────────────────────────────┤
│ Ativo *          Lado *             │
│ [PETR4      ▼]  [COMPRA    ▼]      │
│                                     │
│ Tipo *           Quantidade *       │
│ [LIMITADA  ▼]    [100           ]  │
│                                     │
│ Preço *           Preço Stop        │
│ [32,50       ]    [            ]   │
│                                     │
│ Validade                         │
│ [DAY        ▼]                     │
│                                     │
│ ┌─────────────────────────────────┐│
│ │ Resumo de Risco                ││
│ │ ✅ Horário: OK                 ││
│ │ ✅ Perda diária: R$1.250 / R$5.000││
│ │ ✅ Posição: 750 / 1.000        ││
│ │ ✅ Margem: Suficiente          ││
│ └─────────────────────────────────┘│
│                                     │
│ [Cancelar]           [Enviar Ordem] │
└─────────────────────────────────────┘
```

**Wireframe da Lista de Ordens**
```
┌─────────────────────────────────────────────────────────┐
│ Ordens                                    [+ Nova Ordem]│
├─────────────────────────────────────────────────────────┤
│ [Todas ▼] [Ativo ▼] [Status ▼] [Período ▼]             │
├─────────────────────────────────────────────────────────┤
│ ORD-001  PETR4  COMPRA 100 LIMIT 32,50  EXECUTADA ✅    │
│ ORD-002  VALE3  VENDA  50 MARKET  -     PENDENTE  ⏳    │
│ ORD-003  ITUB4  COMPRA 200 LIMIT 28,00  REJEITADA ❌    │
│          Motivo: Limite de perda diária excedido        │
├─────────────────────────────────────────────────────────┤
│ Exibindo 3 de 150 ordens                                │
└─────────────────────────────────────────────────────────┘
```

**Figma/Design**: Link a definir

## 9. Métricas

**KPIs de Produto**
- Volume de ordens por dia
- Taxa de execução (ordens preenchidas)
- Taxa de rejeição (ordens bloqueadas por risco)
- Latência média (p50, p95, p99)
- Violações de risco por tipo (perda diária, posição, horário)
- Ativações do kill switch (contagem e duração)

**Métricas de Performance**
- Latência de execução: &lt;500ms p95 (`order_manager_execution_latency_seconds`)
- Latência da checagem de risco: &lt;100ms p95
- Tempo de resposta da API: &lt;200ms p95 (`api_request_duration_seconds`)
- Carregamento do dashboard: &lt;2 segundos

**Métricas de Qualidade**
- Taxa de erro: &lt;1% das ordens falham
- Disponibilidade: 99% em 30 dias
- Consistência de dados: 100% das ordens na auditoria
- Idempotência: 0 ordens duplicadas por retry

**Requisitos de Tracking**
- Contador de rejeições por regra (`order_manager_risk_violations_total{type}`)
- Logar todas as transições de ciclo de vida
- Exportar métricas para Prometheus/Grafana
- Logs estruturados com `trace_id`

## 10. Questões em Aberto

**Do Contexto Original**
- Devemos manter logs por ordem ou agregados? **Decisão**: logs por ordem (compliance)

**Novas Questões**
1. **Modificação de Ordem**: MVP deve permitir editar ordens ou usar cancelar+recriar? **Decisão**: cancelar+recriar (edição no v1.1)
2. **Execução Assíncrona**: Devemos usar fila assíncrona para envio? **Decisão**: síncrono no MVP (assíncrono no v2.0)
3. **Multi-Broker**: Quando incluir suporte multi-broker? **Decisão**: v2.0 (após estabilização do MVP)
4. **Eventos WebSocket**: Devemos enviar status via WebSocket? **Decisão**: polling no MVP, WebSocket no v1.1
5. **Modo Backtesting**: Devemos simular ordens para testes? **Decisão**: v1.2 (feature separada)
6. **Autenticação**: Quando adicionar autenticação na API? **Decisão**: v1.1 (auth baseada em token)

## Documentação Relacionada

- [Visão Geral do Trading App](./prd-overview.pt.mdx)
- [API Order Manager](../../../api/order-manager)
- [Schema de Ordem](../../../sdd/domain/schemas/v1/order)
- [Fluxo Place Order](../../../sdd/flows/v1/place-order)
- [Configuração de Limites de Risco](../../../tools/security-config/risk-limits)
