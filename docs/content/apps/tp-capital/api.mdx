---
title: API Surface
sidebar_position: 4
description: TP Capital APIs and references to autogenerated documentation.
tags:
  - apps
  - tp-capital
  - api
owner: DocsOps
lastReviewed: '2025-10-26'
---
## Base URLs

- Development / Compose: `http://localhost:4005`
- Production: `https://<domain>/api/tp-capital` (reverse proxy to port 4005)
- Internal callback (Telegram Gateway): `http://<tp-capital-host>:4005/ingest`

## REST Endpoints

### GET /signals

- Purpose: Return normalized TP Capital signals persisted in TimescaleDB.
- Query parameters:
  - `channel` — Filter by Telegram channel id/alias.
  - `type` — Signal type (ex.: `COMPRA`, `VENDA`).
  - `limit` / `offset` — Pagination (limit defaults to 100, max 500).
  - `from` / `to` — Timestamp filters (Unix epoch or ISO string).
  - `search` — Case-insensitive substring match on asset or raw message.
- Response:

  ```json
  {
    "data": [
      {
        "channel": "TP_CAPITAL",
        "asset": "PETR4",
        "signal_type": "COMPRA",
        "buy_min": 32.5,
        "buy_max": 33.0,
        "targets": [34.0, 35.0, 36.0],
        "stop": 31.5,
        "ts": "2025-10-24T10:30:00.000Z",
        "ingested_at": "2025-10-24T10:30:01.120Z",
        "raw_message": "TP Capital sinal ..."
      }
    ],
    "limit": 100,
    "offset": 0
  }
  ```

- Status codes: `200`, `400`, `503`.
- Example: `curl "http://localhost:4005/signals?channel=TP_CAPITAL&limit=10"`.

### GET /forwarded-messages

- Purpose: Audit messages forwarded from Gateway to downstream channels.
- Query parameters: `channelId`, `limit`, `from`, `to`.
- Returns data from TimescaleDB table `forwarded_messages`.
- Example: `curl "http://localhost:4005/forwarded-messages?limit=50"`.

### POST /sync-messages

- Purpose: Request backfill from Telegram Gateway (`/sync-messages` on port 4010).
- Body: `{ "limit": 100 }` (optional).
- Response includes `channelsSynced`, number of queued messages converted, and worker status.
- Use when dashboard detects divergence or after downtime.

### Telegram Channels Admin

- `GET /telegram-channels` — List configured channels with last signal timestamps.
- `POST /telegram-channels` — Create channel metadata (`label`, `channel_id`, `channel_type`, `description`).
- `PUT /telegram-channels/:id` — Update fields; supports partial payloads.
- `DELETE /telegram-channels/:id` — Remove channel metadata.

### GET /logs

- Purpose: Access structured logs without shell access.
- Query parameters: `limit` (default 50), `level` (`info`, `warn`, `error`).
- Example: `curl "http://localhost:4005/logs?level=error&limit=20"`.

### GET /health

- Purpose: Report dependencies (TimescaleDB, Gateway DB, polling worker).
- Response example:

  ```json
  {
    "status": "healthy",
    "timescale": true,
    "gatewayDb": "connected",
    "pollingWorker": {
      "status": "running",
      "lastPoll": "2025-10-24T10:30:05.000Z"
    },
    "messagesWaiting": 0
  }
  ```

### GET /metrics

- Purpose: Expose Prometheus metrics (`tpcapital_gateway_messages_processed_total`, `http_request_duration_seconds`, etc.).
- Content-Type: `text/plain; version=0.0.4`.

### POST /ingest (Gateway only)

- Purpose: Entry point used by Telegram Gateway to push messages directly.
- Headers: `X-Gateway-Token` must match `GATEWAY_SECRET_TOKEN`.
- Returns `{"success":true}` when message is accepted or flagged as duplicate.
- Not exposed publicly; restricted to internal network.

## OpenAPI Specification

- Status: Pending publication.
- Planned file: `docs/content/reference/specs/openapi/tp-capital.yaml`.
- Future Redoc route: `https://docs.tradingsystem.local/api/tp-capital`.

## Integration Examples

```typescript
interface Signal {
  channel: string;
  asset: string;
  signal_type: 'COMPRA' | 'VENDA';
  buy_min?: number;
  buy_max?: number;
  targets: number[];
  stop?: number;
  ts: string;
  ingested_at: string;
}

async function fetchSignals(filters: {
  channel?: string;
  type?: string;
  limit?: number;
  offset?: number;
  from?: string;
  to?: string;
  search?: string;
}): Promise<Signal[]> {
  const params = new URLSearchParams();
  Object.entries(filters).forEach(([key, value]) => {
    if (value !== undefined && value !== null && value !== '') {
      params.append(key, String(value));
    }
  });

  const response = await fetch(`http://localhost:4005/signals?${params.toString()}`);
  if (!response.ok) {
    throw new Error(`HTTP error: ${response.status}`);
  }

  const payload = await response.json();
  return payload.data ?? [];
}
```

```typescript
import { useQuery } from '@tanstack/react-query';

export function useTPCapitalSignals(filters: Record<string, string>) {
  return useQuery({
    queryKey: ['tp-capital-signals', filters],
    queryFn: () => fetchSignals(filters),
    refetchInterval: 15_000,
    staleTime: 10_000,
    keepPreviousData: true,
  });
}
```

## TimescaleDB Queries

```sql
SELECT *
FROM tp_capital.tp_capital_signals
WHERE ts > now() - interval '7 days'
ORDER BY ts DESC
LIMIT 100;

SELECT channel, COUNT(*) AS signal_count
FROM tp_capital.tp_capital_signals
WHERE ts > now() - interval '1 day'
GROUP BY channel;

SELECT signal_type, COUNT(*) AS count, AVG(buy_max) AS avg_buy_max
FROM tp_capital.tp_capital_signals
WHERE ts > now() - interval '7 days'
GROUP BY signal_type;
```

## Rate Limiting

- Not enforced in v1.0.0.
- Planned limits (v1.1.0): 100 requests/min per IP, soft cap of 1 000/hour.
- Planned headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`.

## Authentication

- Internal REST APIs: no authentication (restricted by network policies).
- `/ingest`: requires `X-Gateway-Token`.
- Future roadmap: service-to-service API keys when exposing externally.

## CORS Configuration

- Allowed origins: `http://localhost:3103`, `http://localhost:3205`, production dashboards.
- Methods: GET, POST, OPTIONS.
- Headers: `Content-Type`, `Authorization`, `X-Gateway-Token`.
