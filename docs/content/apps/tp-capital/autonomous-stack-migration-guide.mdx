---
title: Guia de Migra√ß√£o para Stack Aut√¥noma
slug: /apps/tp-capital/autonomous-stack-migration-guide
sidebar_position: 10
description: Guia completo para migrar TP-Capital de banco compartilhado para stack aut√¥noma
tags:
  - apps
  - tp-capital
  - migration
  - architecture
owner: DevOps
lastReviewed: '2025-11-04'
---

# TP-Capital: Migra√ß√£o para Stack Aut√¥noma

## üéØ Vis√£o Geral

Este guia documenta a migra√ß√£o do **TP-Capital** de uma arquitetura com banco de dados compartilhado para uma **stack aut√¥noma** com 5 containers dedicados.

### Motiva√ß√£o

**Problema atual:**
- TP-Capital compartilha TimescaleDB central (`tradingsystem` database, `tp_capital` schema)
- Conten√ß√£o de recursos com outros servi√ßos
- Performance imprevis√≠vel
- Blast radius alto (erro em outro schema afeta TP-Capital)

**Solu√ß√£o:**
- Stack dedicada com 5 containers
- TimescaleDB pr√≥prio
- Cache Redis (master + replica)
- Connection pooling via PgBouncer
- Rede isolada

### Benef√≠cios Quantificados

| M√©trica | Antes | Depois | Melhoria |
|---------|-------|--------|----------|
| DB Connection | ~50ms | ~5ms | **-90%** |
| Cache Hit Rate | 0% | ~80% | **+80%** |
| Dashboard Query | ~150ms | ~20ms | **-87%** |
| Throughput | ~50 req/s | ~1000 req/s | **+1900%** |

---

## üìÇ Arquivos Criados

### 1. ADR Completo
**Localiza√ß√£o:** `docs/content/reference/adrs/ADR-008-tp-capital-autonomous-stack` (a publicar)

An√°lise arquitetural detalhada incluindo:
- 6 dimens√µes de an√°lise (estrutura, design patterns, depend√™ncias, data flow, escalabilidade, seguran√ßa)
- Compara√ß√£o before/after
- Roadmap de implementa√ß√£o
- Riscos e mitiga√ß√µes

### 2. Docker Compose Stack
**Localiza√ß√£o:** `tools/compose/docker-compose.4-1-tp-capital-stack.yml`

Define 5 containers:
- `tp-capital-timescale` (TimescaleDB dedicated)
- `tp-capital-pgbouncer` (Connection pooling)
- `tp-capital-redis-master` (Cache write)
- `tp-capital-redis-replica` (Cache read)
- `tp-capital-api` (Application)

### 3. Database Schema
**Localiza√ß√£o:** `backend/data/timescaledb/tp-capital/01-init-schema.sql`

Cria:
- 3 schemas (`signals`, `forwarded_messages`, `metrics`)
- Hypertables (time-series optimized)
- Indexes (query performance)
- Continuous aggregates (hourly stats)
- Retention policies (90/30/30 days)

### 4. Migration Script
**Localiza√ß√£o:** `scripts/database/migrate-tp-capital-to-dedicated-stack.sh`

Automatiza:
- Pre-flight checks
- Backup autom√°tico
- Data migration (CSV export/import)
- Validation (record counts)
- Report generation

### 5. PostgreSQL Config
**Localiza√ß√£o:** `tools/compose/tp-capital/postgresql.conf`

Otimizado para:
- Time-series inserts
- Dashboard queries
- 4GB RAM, 2 vCPU, SSD storage

---

## üöÄ Quick Start

### Pr√©-requisitos

```bash
# 1. Configurar vari√°veis de ambiente
vim .env

# Adicionar (se n√£o existir):
TP_CAPITAL_DB_PASSWORD=<secure_password_here>
TP_CAPITAL_DB_PORT=5435
TP_CAPITAL_PGBOUNCER_PORT=6435
TP_CAPITAL_REDIS_PORT=6381
TP_CAPITAL_REDIS_REPLICA_PORT=6382
```

### Passo 1: Iniciar Nova Stack

```bash
cd /home/marce/Projetos/TradingSystem

# Iniciar todos os containers
docker compose -f tools/compose/docker-compose.4-1-tp-capital-stack.yml up -d

# Verificar status
docker compose -f tools/compose/docker-compose.4-1-tp-capital-stack.yml ps

# Expected output:
# NAME                         STATUS    PORTS
# tp-capital-timescale         Up        0.0.0.0:5435->5432/tcp
# tp-capital-pgbouncer         Up        0.0.0.0:6435->6432/tcp
# tp-capital-redis-master      Up        0.0.0.0:6381->6379/tcp
# tp-capital-redis-replica     Up        0.0.0.0:6382->6379/tcp
# tp-capital-api               Up        0.0.0.0:4005->4005/tcp
```

### Passo 2: Validar Health

```bash
# API health
curl http://localhost:4005/health
# Expected: {"status":"healthy","database":"connected","uptime":30}

# Database connection
docker exec -it tp-capital-timescale psql -U tp_capital -d tp_capital_db -c "SELECT 1"
# Expected: 1 row returned

# PgBouncer stats
docker exec -it tp-capital-pgbouncer psql -h localhost -p 6432 -U tp_capital -d tp_capital_db -c "SHOW POOLS"

# Redis cache
docker exec -it tp-capital-redis-master redis-cli INFO
# Expected: redis_version:7.x, role:master
```

### Passo 3: Migrar Dados

```bash
# Dry run (teste sem modificar dados)
bash scripts/database/migrate-tp-capital-to-dedicated-stack.sh --dry-run

# Migra√ß√£o real (com backup autom√°tico)
bash scripts/database/migrate-tp-capital-to-dedicated-stack.sh

# Expected output:
# ‚úì Pre-flight checks passed
# ‚úì Backup created
# ‚úì Data migration completed
# ‚úì Validation passed
# ‚úì Migration report created
```

### Passo 4: Validar Migra√ß√£o

```bash
# Query API
curl http://localhost:4005/signals?limit=10 | jq '.'

# Verificar contagem de registros
docker exec -it tp-capital-timescale psql -U tp_capital -d tp_capital_db -c \
  "SELECT COUNT(*) FROM signals.tp_capital_signals"

# Dashboard
# Abrir: http://localhost:3103/#/tp-capital
# Verificar: Sinais carregam normalmente
```

---

## üìä Monitoramento

### Logs em Tempo Real

```bash
# API logs
docker logs tp-capital-api -f

# Database logs
docker logs tp-capital-timescale -f

# Redis logs
docker logs tp-capital-redis-master -f
```

### M√©tricas

```bash
# Prometheus metrics
curl http://localhost:4005/metrics

# Key metrics to watch:
# - tpcapital_signals_total
# - tpcapital_cache_hit_rate
# - http_request_duration_seconds
```

### Health Checks

```bash
# All containers
docker compose -f tools/compose/docker-compose.4-1-tp-capital-stack.yml ps

# Detailed health
curl http://localhost:4005/health | jq '.'
```

---

## üîÑ Deploy Canary (Recomendado)

Para minimizar riscos, mantenha a stack antiga rodando em paralelo:

```bash
# 1. Stack antiga continua rodando
docker compose -f tools/compose/docker-compose.apps.yml ps

# 2. Nova stack iniciada
docker compose -f tools/compose/docker-compose.4-1-tp-capital-stack.yml up -d

# 3. Configurar load balancer (Nginx/Traefik) para split 90/10
# - 90% tr√°fego ‚Üí nova stack (porta 4005)
# - 10% tr√°fego ‚Üí stack antiga (porta 4007)

# 4. Monitorar por 3-5 dias
# - Comparar lat√™ncias
# - Verificar error rates
# - Monitorar m√©tricas

# 5. Cutover final (100% nova stack)
docker stop apps-tpcapital
```

---

## üö® Rollback Plan

Se houver problemas com a nova stack:

```bash
# 1. Parar nova stack
docker compose -f tools/compose/docker-compose.4-1-tp-capital-stack.yml down

# 2. Reiniciar stack antiga
docker compose -f tools/compose/docker-compose.apps.yml up -d tp-capital

# 3. Restaurar vari√°veis de ambiente antigas
export TIMESCALEDB_HOST=data-timescale
export TIMESCALEDB_PORT=5433
export TIMESCALEDB_DATABASE=tradingsystem
export TIMESCALEDB_SCHEMA=tp_capital

# 4. Validar funcionamento
curl http://localhost:4007/health
```

**Backup dispon√≠vel em:**
```
backups/tp-capital-migration-YYYYMMDD-HHMMSS/
  ‚îú‚îÄ‚îÄ schema.sql
  ‚îú‚îÄ‚îÄ data.sql
  ‚îú‚îÄ‚îÄ tp_capital_signals.csv
  ‚îú‚îÄ‚îÄ MIGRATION_REPORT.md
  ‚îî‚îÄ‚îÄ migration.log
```

---

## üìù Checklist P√≥s-Migra√ß√£o

### Dia 1
- [ ] Health checks passando
- [ ] Dashboard carregando normalmente
- [ ] Sinais sendo ingeridos
- [ ] M√©tricas dispon√≠veis (Prometheus)
- [ ] Logs estruturados (JSON)

### Semana 1
- [ ] Zero perda de dados
- [ ] Lat√™ncia < 200ms (P95)
- [ ] Cache hit rate > 70%
- [ ] Uptime > 99.9%
- [ ] Error rate < 0.1%

### Ap√≥s 1 Semana (Cleanup)
- [ ] Validar estabilidade
- [ ] Documentar lessons learned
- [ ] Limpar schema antigo:

```sql
-- CAUTION: Apenas ap√≥s 1 semana de estabilidade!
psql -h localhost -p 5433 -U timescale -d tradingsystem

DROP SCHEMA tp_capital CASCADE;
```

---

## üîç Troubleshooting

### Container n√£o inicia

```bash
# Verificar logs
docker logs tp-capital-timescale --tail 100

# Verificar rede
docker network inspect tp_capital_backend

# Verificar volumes
docker volume ls | grep tp-capital
```

### Database connection error

```bash
# Verificar senha
echo $TP_CAPITAL_DB_PASSWORD

# Testar conex√£o direta
docker exec -it tp-capital-timescale psql -U tp_capital -d tp_capital_db

# Testar via PgBouncer
docker exec -it tp-capital-pgbouncer psql -h localhost -p 6432 -U tp_capital -d tp_capital_db
```

### Redis n√£o conecta

```bash
# Verificar Redis master
docker exec -it tp-capital-redis-master redis-cli PING
# Expected: PONG

# Verificar replica√ß√£o
docker exec -it tp-capital-redis-master redis-cli INFO replication
# Expected: role:master, connected_slaves:1

# Verificar replica
docker exec -it tp-capital-redis-replica redis-cli PING
# Expected: PONG
```

---

## üìö Refer√™ncias

### Documenta√ß√£o Interna
- ADR-008: TP-Capital Autonomous Stack (em elabora√ß√£o)
- [Architecture Review (2025-11-04)](https://github.com/marceloterra1983/TradingSystem/blob/main/reports/root-archive/tp-capital/ARCHITECTURE-REVIEW-TP-CAPITAL-2025-11-04.md)
- [TP-Capital Overview](overview.mdx)

### Documenta√ß√£o Externa
- [TimescaleDB HA Guide](https://docs.timescale.com/self-hosted/latest/high-availability/)
- [PgBouncer Documentation](https://www.pgbouncer.org/config.html)
- [Redis Sentinel](https://redis.io/docs/management/sentinel/)

---

## üí¨ Suporte

**Para problemas:**
1. Verificar logs: `docker logs tp-capital-api -f`
2. Revisar migration report: `backups/tp-capital-migration-*/MIGRATION_REPORT.md`
3. Consultar ADR-008: An√°lise arquitetural completa
4. Executar rollback: Seguir instru√ß√µes acima

**Contatos:**
- DevOps Team
- Architecture Review Agent
- Development Team

---

**Status:** üü¢ Pronto para implementa√ß√£o  
**√öltima Atualiza√ß√£o:** 2025-11-04  
**Pr√≥xima Revis√£o:** Ap√≥s migra√ß√£o completa
