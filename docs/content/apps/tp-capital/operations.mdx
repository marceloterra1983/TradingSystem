---
title: Operations
sidebar_position: 7
description: Monitoring, logging, and metrics for the TP Capital application.
tags:
  - apps
  - tp-capital
  - operations
owner: DocsOps
lastReviewed: '2025-10-26'
---
## Health Monitoring

### Health Endpoints

| Endpoint | Purpose | Expected Response | Cadence |
|----------|---------|-------------------|---------|
| `GET /health` | Service & dependency status | `{"status":"healthy","timescale":true,...}` | 30s |
| `GET /signals?limit=1` | Data freshness | Timestamp &lt; 5 min behind market | 5m |
| `http://localhost:4007/health` | Telegram Gateway MTProto status | `{"status":"healthy","telegram":"connected"}` | 1m |
| `psql -c "SELECT 1"` | TimescaleDB connectivity (`APPS-TPCAPITAL`) | `1` | Manual |

### Dashboards

- Grafana dashboard: `tools/monitoring/dashboards/tp-capital.json`.
- Panels: ingestion throughput, API latency percentiles, gateway polling lag, TimescaleDB queue depth, error rate, storage usage.

### Prometheus Queries

```promql
# Signals ingested per minute
rate(tpcapital_gateway_messages_processed_total{status="published"}[5m])

# Polling lag
tpcapital_gateway_polling_lag_seconds

# API latency p95
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{endpoint="/signals"}[5m]))

# Gateway queue backlog
tpcapital_gateway_messages_waiting
```

### Alert Thresholds

| Alert | Condition | Severity | Action |
|-------|-----------|----------|--------|
| High ingestion latency | `tpcapital_gateway_processing_duration_seconds` p95 &gt; 1s for 5m | Warning | Check TimescaleDB, Gateway health |
| Queue backlog | `tpcapital_gateway_messages_waiting` &gt; 50 for 10m | Critical | Run `/sync-messages`, inspect Gateway |
| Timescale disconnected | `/health.timescale === false` | Critical | Restart DB or fix credentials |
| No signals received | `rate(tpcapital_gateway_messages_processed_total[30m]) == 0` | Warning | Confirm market hours, Telegram activity |
| Disk pressure | TimescaleDB volume &gt; 80% | Warning | Prune partitions, expand storage |

## Logs and Metrics

### Log Access

```bash
# Follow container logs
docker compose -f docker-compose.prod.yml logs -f tp-capital-signals

# Filter errors
docker compose -f docker-compose.prod.yml logs tp-capital-signals | grep ERROR

# HTTP endpoint (restricted network)
curl "http://localhost:4005/logs?level=warn&limit=50"
```

Logs are JSON-formatted via `pino` with fields: `service`, `event`, `channel`, `message_id`, `latency_ms`, `gateway.status`.

### Notable Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `tpcapital_gateway_messages_processed_total` | Counter | Messages processed from Gateway (`status` label: published, duplicate, failed) |
| `tpcapital_gateway_polling_lag_seconds` | Gauge | Seconds since last successful poll |
| `tpcapital_gateway_messages_waiting` | Gauge | Queue depth in `telegram_gateway.messages` |
| `http_request_duration_seconds` | Histogram | API latency by endpoint/method/status |
| `process_resident_memory_bytes` | Gauge | Node.js process memory footprint |

## Maintenance Procedures

### Daily

1. Review dashboard for error/latency anomalies.
2. Verify latest signal timestamp (`GET /signals?limit=1`).
3. Check Gateway health (`curl http://localhost:4007/health`).

### Weekly

1. Prune stale rows if backlog grows (`DELETE FROM telegram_gateway.messages WHERE status='processed' AND processed_at < now() - interval '7 days'`).
2. Validate TimescaleDB chunk compression/job status.
3. Confirm alerts are firing through (Grafana/Prometheus test).

### Monthly

1. Rotate `GATEWAY_SECRET_TOKEN` and Telegram tokens; update `.env` / secrets store.
2. Review ingestion parsing rules and adjust filters (`TP_CAPITAL_GATEWAY_FILTER_TEXT_CONTAINS`).
3. Backup schema (`pg_dump -n tp_capital APPS-TPCAPITAL > tp-capital-$(date +%F).sql`).

### TimescaleDB Checks

```sql
-- Messages ingested per channel (last 24h)
SELECT channel, COUNT(*) AS total
FROM tp_capital.tp_capital_signals
WHERE ts > now() - interval '1 day'
GROUP BY channel
ORDER BY total DESC;

-- Detect duplicates (same channel/message)
SELECT channel, message_id, COUNT(*) AS duplicates
FROM tp_capital.tp_capital_signals
WHERE ts > now() - interval '1 day'
GROUP BY channel, message_id
HAVING COUNT(*) > 1;
```

## Operational Playbooks

- **Gateway backlog**: Trigger `/sync-messages`, inspect `messages_waiting`, restart Gateway if polling stalled.
- **Timescale outage**: Restart container, apply migrations (`apps/tp-capital/scripts/init-database.sh --force` with caution), restore from latest dump.
- **Dashboard gaps**: Compare `/signals` vs `/forwarded-messages`; ensure dashboard environment variables point to port 4005.
