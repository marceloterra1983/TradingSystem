---
title: 'Sincroniza√ß√£o Autom√°tica no Startup'
sidebar_position: 3
tags: ['telegram-gateway', 'configuration', 'sync']
---

# Sincroniza√ß√£o Autom√°tica no Startup

## üìã Vis√£o Geral

O Telegram Gateway agora **sincroniza automaticamente** as √∫ltimas mensagens de todos os canais monitorados sempre que o servi√ßo √© iniciado. Isso garante que o banco de dados local esteja sempre atualizado com os canais sendo monitorados.

## üéØ Benef√≠cios

- ‚úÖ **Sempre atualizado**: Database sincronizado com os canais ao iniciar
- ‚úÖ **Recupera√ß√£o autom√°tica**: Mensagens perdidas s√£o recuperadas ap√≥s reiniciar
- ‚úÖ **Sem interven√ß√£o manual**: N√£o precisa clicar em "Checar Mensagens"
- ‚úÖ **Configur√°vel**: Controle total via vari√°veis de ambiente
- ‚úÖ **N√£o bloqueante**: Erros n√£o impedem o servidor de iniciar

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente

Adicione ao `.env` do projeto:

```bash
# ========================================
# Telegram Gateway - Startup Sync
# ========================================

# Habilitar/desabilitar sincroniza√ß√£o autom√°tica no startup
# Valores: true | false
# Padr√£o: true
TELEGRAM_GATEWAY_SYNC_ON_STARTUP=true

# Delay antes de iniciar sincroniza√ß√£o (em milissegundos)
# Aguarda estabiliza√ß√£o do servidor e conex√£o com Telegram
# Valores: 0 - 60000 (0 a 60 segundos)
# Padr√£o: 5000 (5 segundos)
TELEGRAM_GATEWAY_STARTUP_SYNC_DELAY=5000

# N√∫mero m√°ximo de mensagens a sincronizar por canal
# Valores: 1 - 1000
# Padr√£o: 500
TELEGRAM_GATEWAY_STARTUP_SYNC_LIMIT=500

# N√∫mero de canais processados em paralelo
# Valores: 1 - 10
# Padr√£o: 3
TELEGRAM_GATEWAY_STARTUP_SYNC_CONCURRENCY=3
```

### Configura√ß√µes Recomendadas

#### Produ√ß√£o (Alta Performance)
```bash
TELEGRAM_GATEWAY_SYNC_ON_STARTUP=true
TELEGRAM_GATEWAY_STARTUP_SYNC_DELAY=10000    # 10s - aguardar estabiliza√ß√£o
TELEGRAM_GATEWAY_STARTUP_SYNC_LIMIT=1000     # M√°ximo de mensagens
TELEGRAM_GATEWAY_STARTUP_SYNC_CONCURRENCY=5  # Mais paralelo
```

#### Desenvolvimento (R√°pido)
```bash
TELEGRAM_GATEWAY_SYNC_ON_STARTUP=true
TELEGRAM_GATEWAY_STARTUP_SYNC_DELAY=3000     # 3s - startup r√°pido
TELEGRAM_GATEWAY_STARTUP_SYNC_LIMIT=100      # Menos mensagens
TELEGRAM_GATEWAY_STARTUP_SYNC_CONCURRENCY=2  # Menos paralelismo
```

#### Desabilitado (Testes)
```bash
TELEGRAM_GATEWAY_SYNC_ON_STARTUP=false
```

## üöÄ Como Funciona

### Fluxo de Execu√ß√£o

```mermaid
sequenceDiagram
    participant Server as Server Startup
    participant Sync as StartupSyncService
    participant TG as Telegram Client
    participant DB as Database
    participant Logs as Logs

    Server->>Server: app.listen(port)
    Server->>Sync: initializeStartupSync()
    Sync->>Logs: Log: "Sync enabled"
    
    Note over Sync: Aguardar delay (5s)
    
    Sync->>TG: getTelegramClient()
    TG-->>Sync: Client instance
    Sync->>TG: connect()
    TG-->>Sync: Connected
    
    Sync->>DB: listChannels()
    DB-->>Sync: Active channels
    
    loop Para cada canal
        Sync->>TG: Buscar mensagens
        TG-->>Sync: Messages
        Sync->>DB: Salvar mensagens
    end
    
    Sync->>Logs: Log: "Sync complete"
```

### Processo Detalhado

1. **Servidor inicia** (porta 4010)
2. **Aguarda delay** (padr√£o: 5 segundos)
   - Permite estabiliza√ß√£o do servidor
   - Aguarda conex√£o com Telegram
3. **Conecta ao Telegram** via TelegramClientService
4. **Busca canais ativos** no banco de dados
5. **Sincroniza em paralelo** (padr√£o: 3 canais simult√¢neos)
6. **Salva mensagens** no TimescaleDB
7. **Registra logs detalhados** de todo o processo

## üìä Logs e Monitoramento

### Logs de Sucesso

```json
{
  "level": "info",
  "msg": "[StartupSync] Startup synchronization enabled - will run after delay",
  "delay": 5000,
  "limit": 500,
  "concurrency": 3
}

{
  "level": "info",
  "msg": "[StartupSync] Telegram client connected successfully"
}

{
  "level": "info",
  "msg": "[StartupSync] Active channels found - starting sync",
  "channelCount": 3,
  "channels": ["@canal1", "@canal2", "@canal3"],
  "limit": 500
}

{
  "level": "info",
  "msg": "[StartupSync] ‚úÖ Startup synchronization completed successfully",
  "totalMessagesSynced": 245,
  "totalMessagesSaved": 245,
  "channelsSynced": 3,
  "durationMs": 3876,
  "durationSeconds": "3.88"
}
```

### Logs de Erro

```json
{
  "level": "error",
  "msg": "[StartupSync] ‚ùå Startup synchronization failed",
  "err": {
    "message": "Session file not found",
    "stack": "..."
  }
}

{
  "level": "error",
  "msg": "[StartupSync] Session error - may need to re-authenticate with Telegram"
}
```

### Visualizar Logs

```bash
# Logs em tempo real
tail -f logs/telegram-gateway-mtproto.log

# Filtrar apenas startup sync
tail -f logs/telegram-gateway-mtproto.log | grep "StartupSync"

# Contar mensagens sincronizadas
grep "StartupSync.*completed" logs/telegram-gateway-mtproto.log | jq '.totalMessagesSynced'
```

## üß™ Testando

### Teste Manual

1. **Desabilite o sync temporariamente**:
   ```bash
   echo "TELEGRAM_GATEWAY_SYNC_ON_STARTUP=false" >> .env
   ```

2. **Inicie o servi√ßo**:
   ```bash
   bash START-GATEWAY-MTPROTO.sh
   ```

3. **Verifique logs** - n√£o deve haver sync:
   ```bash
   tail -f logs/telegram-gateway-mtproto.log | grep "StartupSync"
   # Deve mostrar: "Startup synchronization disabled"
   ```

4. **Re-habilite e reinicie**:
   ```bash
   sed -i 's/TELEGRAM_GATEWAY_SYNC_ON_STARTUP=false/TELEGRAM_GATEWAY_SYNC_ON_STARTUP=true/' .env
   bash START-GATEWAY-MTPROTO.sh
   ```

5. **Verifique que sync ocorreu**:
   ```bash
   tail -100 logs/telegram-gateway-mtproto.log | grep "StartupSync.*completed"
   ```

### Teste de Performance

Medir tempo de sincroniza√ß√£o:

```bash
# Buscar √∫ltima sincroniza√ß√£o nos logs
grep "StartupSync.*completed" logs/telegram-gateway-mtproto.log | tail -1 | jq '{totalMessages: .totalMessagesSynced, duration: .durationSeconds, channels: .channelsSynced}'
```

Exemplo de resultado:
```json
{
  "totalMessages": 245,
  "duration": "3.88",
  "channels": 3
}
```

## ‚ùå Problemas Comuns

### Sync n√£o executa

**Sintoma**: Logs n√£o mostram mensagens de `[StartupSync]`

**Causas poss√≠veis**:
- `TELEGRAM_GATEWAY_SYNC_ON_STARTUP=false`
- Delay muito longo
- Servi√ßo n√£o est√° iniciando corretamente

**Solu√ß√£o**:
```bash
# Verificar configura√ß√£o
grep "TELEGRAM_GATEWAY_SYNC_ON_STARTUP" .env

# Verificar logs de startup
tail -50 logs/telegram-gateway-mtproto.log | grep -E "started|StartupSync"
```

### Erro de sess√£o

**Sintoma**: `Session error - may need to re-authenticate`

**Causa**: Arquivo de sess√£o MTProto n√£o existe ou est√° corrompido

**Solu√ß√£o**:
```bash
cd apps/telegram-gateway
bash authenticate-interactive.sh
```

### Nenhum canal ativo

**Sintoma**: `No active channels found - sync skipped`

**Causa**: Nenhum canal est√° marcado como ativo no banco

**Solu√ß√£o**:
```bash
# Listar canais
curl http://localhost:4010/api/channels

# Ativar um canal
curl -X PUT http://localhost:4010/api/channels/{id} \
  -H "Content-Type: application/json" \
  -d '{"isActive": true}'
```

### Timeout ou lentid√£o

**Sintoma**: Sync demora mais de 1 minuto

**Causas poss√≠veis**:
- Muitos canais ativos
- Limite muito alto
- Concorr√™ncia muito baixa

**Solu√ß√£o**: Ajustar configura√ß√µes
```bash
# Reduzir limite por canal
TELEGRAM_GATEWAY_STARTUP_SYNC_LIMIT=200

# Aumentar paralelismo
TELEGRAM_GATEWAY_STARTUP_SYNC_CONCURRENCY=5
```

## üîß Desabilitando Temporariamente

Para desabilitar sem remover do c√≥digo:

```bash
# Adicionar ao .env
TELEGRAM_GATEWAY_SYNC_ON_STARTUP=false

# Reiniciar servi√ßo
bash START-GATEWAY-MTPROTO.sh
```

Os logs mostrar√£o:
```
[StartupSync] Startup synchronization disabled (TELEGRAM_GATEWAY_SYNC_ON_STARTUP=false)
```

## üìà M√©tricas

### Prometheus Metrics

O servi√ßo de sync exp√µe m√©tricas via `/metrics`:

- `telegram_gateway_startup_sync_duration_seconds` - Dura√ß√£o total do sync
- `telegram_gateway_startup_sync_messages_total` - Total de mensagens sincronizadas
- `telegram_gateway_startup_sync_channels_total` - Total de canais sincronizados
- `telegram_gateway_startup_sync_errors_total` - Total de erros no sync

### Exemplo de Query

```promql
# Dura√ß√£o m√©dia do startup sync (√∫ltima hora)
avg_over_time(telegram_gateway_startup_sync_duration_seconds[1h])

# Taxa de sucesso
rate(telegram_gateway_startup_sync_messages_total[5m])
```

## üìö Refer√™ncias

- [MessageSyncService](/apps/telegram-gateway/services/message-sync-service)
- [TelegramClientService](/apps/telegram-gateway/services/telegram-client-service)
- [Canais Monitorados](/apps/telegram-gateway/channels)
- [Troubleshooting Geral](/tools/troubleshooting/telegram-gateway-sync)

## üîÑ Hist√≥rico de Altera√ß√µes

### v1.0.0 (2025-11-04)
- ‚ú® Implementa√ß√£o inicial do startup sync
- ‚úÖ Configura√ß√£o via vari√°veis de ambiente
- ‚úÖ Logs detalhados e estruturados
- ‚úÖ Tratamento de erros n√£o bloqueante
- ‚úÖ Suporte a m√∫ltiplos canais em paralelo

