---
title: Architecture
slug: /apps/telegram-gateway/architecture
sidebar_position: 2
description: Architecture and component responsibilities for the Telegram Gateway stack.
tags:
  - apps
  - telegram-gateway
  - architecture
owner: DocsOps
lastReviewed: '2025-10-26'
---
## Components

### MTProto Gateway (apps/telegram-gateway)

- **Port**: 4007 (`GATEWAY_PORT`).
- **Runtime**: Node.js 18 (ES modules).
- **Responsibilities**:
  - Authenticate using Telegram `api_id`, `api_hash`, and phone-based session.
  - Subscribe to source channels and optional bot webhook.
  - Persist messages to TimescaleDB schema `telegram_gateway` (`messages`, `channels`, `forwarding_rules`).
  - Forward messages via HTTP POST to configured APIs (`API_ENDPOINTS`) with shared secret.
  - Manage retry logic, exponential backoff, and failure queue (`data/failure-queue.jsonl`).
  - Expose `/health` and `/metrics` endpoints for local monitoring.

### Telegram Gateway REST API (backend/api/telegram-gateway)

- **Port**: 4010 (`TELEGRAM_GATEWAY_API_PORT`).
- **Runtime**: Node.js 20 + Express.
- **Responsibilities**:
  - Serve captured messages via REST (`/api/messages`, `/api/channels`).
  - Provide query filters (channel, limit, since/until) and pagination.
  - Enforce token authentication header `X-Gateway-Token`.
  - Export Prometheus metrics and health status.
  - Support initialization scripts for TimescaleDB schema/migrations.

### Storage

- **Database**: TimescaleDB (shared with TP Capital).
- **Schema**: `telegram_gateway`.
- **Tables**:
  - `messages`: queue with statuses (`received`, `processing`, `processed`, `failed`).
  - `channels`: metadata for monitored chats.
  - `failures`: optional log table for debugging (in addition to JSONL backup).
- **Connectivity**: `TELEGRAM_GATEWAY_DB_URL` or composed from host/user/password variables.

### External Dependencies

- Telegram MTProto servers (internet access required).
- TP Capital API or other publishers (HTTP endpoints defined in `API_ENDPOINTS`).
- Systemd (optional) for service supervision on production hosts.

## Data Flow

1. Gateway receives Telegram update (MTProto).
2. Message normalized (text, attachments, metadata) and inserted into `telegram_gateway.messages`.
3. Immediate HTTP forwarding attempted for each configured endpoint (`API_SECRET_TOKEN` attached).
4. If forwarding fails, message remains queued (`status = 'received'`) and JSONL fallback is appended.
5. TP Capital worker (port 4005) polls the queue, stores normalized signal, and marks message `processed`.
6. REST API exposes data for manual auditing, dashboards, or analytics.

## Deployment Topology

```
┌────────────────────────────────────────────┐
│ Telegram Gateway (apps/telegram-gateway)   │
│  • Port 4007                               │
│  • MTProto session + message queue         │
└───────────────┬────────────────────────────┘
                │ TimescaleDB (5433)
┌───────────────▼────────────────────────────┐
│ telegram_gateway schema                    │
│  • messages, channels, failures            │
└───────────────┬────────────────────────────┘
                │
┌───────────────▼────────────────────────────┐
│ TP Capital API (port 4005)                 │
│  • Polls queue, stores normalized signals  │
└───────────────┬────────────────────────────┘
                │
┌───────────────▼────────────────────────────┐
│ Telegram Gateway REST API (port 4010)      │
│  • Serves messages & metrics               │
└────────────────────────────────────────────┘
```

## Observability

- **Gateway metrics** (`apps/telegram-gateway`):
  - `telegram_messages_received_total{channel_id}`
  - `telegram_publish_failures_total{reason}`
  - `telegram_failure_queue_size`
- **REST API metrics** (`backend/api/telegram-gateway`):
  - `telegram_gateway_messages_total`
  - `http_request_duration_seconds{endpoint="/api/messages"}`
- **Logs**:
  - Gateway logs stored locally (systemd journal or stdout).
  - REST API logs accessible via `docker logs` and `/` endpoint listing routes.
