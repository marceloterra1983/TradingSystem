---
title: Neon Database Setup
sidebar_position: 5
tags:
  - database
  - neon
  - workspace
  - postgresql
domain: database
owner: DocsOps
type: guide
summary: Setup guide for Neon PostgreSQL serverless database for the Workspace application. Includes installation, configuration, migration, and troubleshooting.
description: "Setup guide for Neon PostgreSQL serverless database for the Workspace application. Includes installation, configuration, migration, and troubleshooting."
status: active
last_review: "2025-11-03"
lastReviewed: "2025-11-08"
---

# Neon Database Setup

Complete guide for setting up and using **Neon PostgreSQL** as the database for the Workspace application.

## Overview

Neon is a serverless PostgreSQL database with separated storage and compute architecture. Key features include:

- **Database Branching**: Create Git-like branches of your database for testing
- **Autoscaling**: Automatically scale compute resources based on demand
- **Scale to Zero**: Automatically pause compute when idle to save resources
- **PostgreSQL Compatible**: 100% PostgreSQL wire protocol compatibility

### Why Neon for Workspace?

- ✅ **Isolation**: Dedicated database instance for Workspace (no sharing with TP Capital)
- ✅ **Testing**: Database branching enables safe testing of migrations
- ✅ **Modern Architecture**: Separated storage/compute for better resource management
- ✅ **Open Source**: Can run Neon Local for development and testing

## Quick Start

### Prerequisites

- Docker and Docker Compose installed
- Project root `.env` configured with Neon variables
- Sufficient disk space (2GB+ recommended)

### Installation Steps

#### 1. Start Workspace Stack

```bash
# Start complete Workspace stack (Neon DB + Workspace API)
bash scripts/docker/start-workspace-stack.sh

# Or directly with Docker Compose
docker compose -f tools/compose/docker-compose.workspace-stack.yml up -d

# Check status
docker compose -f tools/compose/docker-compose.workspace-stack.yml ps
```

You should see **four containers** running:
- `workspace-db-pageserver` (storage layer)
- `workspace-db-safekeeper` (WAL service)  
- `workspace-db-compute` (PostgreSQL endpoint)
- `workspace-api` (Express REST API)

#### 2. Initialize Workspace Database

```bash
# Run initialization script
bash scripts/database/init-neon-workspace.sh
```

This script will:
- Create `workspace` database
- Create `workspace` schema
- Create tables (`workspace_items`, `workspace_categories`)
- Create indexes
- Seed initial data (6 default categories)

#### 3. Configure Workspace Service

Update `.env` to use Neon:

```env
# Set database strategy to neon
LIBRARY_DB_STRATEGY=neon

# Neon connection details
NEON_HOST=localhost
NEON_PORT=5433
NEON_DATABASE=workspace
NEON_USER=postgres
NEON_PASSWORD=neon_secure_pass
```

#### 4. Verify Stack is Running

```bash
# Check all 4 containers
docker compose -f tools/compose/docker-compose.workspace-stack.yml ps

# Check API health
curl http://localhost:3200/health

# Check logs
docker compose -f tools/compose/docker-compose.workspace-stack.yml logs -f workspace-api
```

#### 5. Verify Connection

```bash
# Run connection test suite
bash scripts/database/test-neon-connection.sh
```

You should see all 10 tests passing ✓

lastReviewed: "2025-11-08"
---

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `NEON_HOST` | `localhost` | Neon server hostname |
| `NEON_PORT` | `5433` | Neon server port (external) |
| `NEON_DATABASE` | `workspace` | Database name |
| `NEON_USER` | `postgres` | Database user |
| `NEON_PASSWORD` | `neon_secure_pass` | Database password |
| `NEON_SCHEMA` | `workspace` | Default schema |
| `NEON_POOL_MAX` | `20` | Maximum connection pool size |
| `NEON_POOL_MIN` | `2` | Minimum connection pool size |
| `NEON_CONNECTION_TIMEOUT` | `5000` | Connection timeout (ms) |

### Connection String

```env
NEON_DATABASE_URL=postgresql://postgres:neon_secure_pass@localhost:5433/workspace
```

lastReviewed: "2025-11-08"
---

## Database Branching

One of Neon's most powerful features is database branching - create isolated copies of your database for testing.

### Create a Branch

```bash
# Create a new branch from main
docker exec neon-compute psql -U postgres -c \
  "SELECT neon.create_branch('workspace', 'test-migration');"
```

### List Branches

```bash
# List all branches
docker exec neon-compute psql -U postgres -d workspace -c \
  "SELECT * FROM neon.branches;"
```

### Switch to Branch

```bash
# Connect to specific branch
psql -h localhost -p 5433 -U postgres -d workspace?branch=test-migration
```

### Delete Branch

```bash
# Delete branch after testing
docker exec neon-compute psql -U postgres -c \
  "SELECT neon.delete_branch('test-migration');"
```

### Use Cases for Branching

1. **Migration Testing**: Test schema changes before applying to production
2. **Feature Development**: Each feature branch gets its own database branch
3. **Data Exploration**: Experiment with data without affecting production
4. **CI/CD**: Automated testing with ephemeral database branches

lastReviewed: "2025-11-08"
---

## Migration from TimescaleDB

If you're migrating existing Workspace data from TimescaleDB to Neon:

### Migration Script

```bash
# Run migration with backup
bash scripts/database/migrate-workspace-to-neon.sh --backup

# Dry run (see what would be migrated)
bash scripts/database/migrate-workspace-to-neon.sh --dry-run

# Force mode (skip confirmations)
bash scripts/database/migrate-workspace-to-neon.sh --force
```

### Migration Steps

1. **Backup**: Creates full backup of TimescaleDB data
2. **Export**: Exports categories and items from TimescaleDB
3. **Import**: Imports data into Neon database
4. **Verify**: Compares record counts to ensure completeness

### Rollback

If migration fails or Neon has issues:

```bash
# Switch back to TimescaleDB
export LIBRARY_DB_STRATEGY=timescaledb

# Restart workspace service
docker compose restart workspace
```

lastReviewed: "2025-11-08"
---

## Monitoring & Maintenance

### Health Checks

```bash
# Quick health check
docker exec neon-compute pg_isready -U postgres

# Full test suite
bash scripts/database/test-neon-connection.sh
```

### View Logs

```bash
# Neon compute logs
docker logs neon-compute -f

# Neon pageserver logs
docker logs neon-pageserver -f

# Neon safekeeper logs
docker logs neon-safekeeper -f
```

### Metrics

Neon exposes Prometheus metrics on:
- Pageserver: `http://localhost:9898/metrics`
- Safekeeper: `http://localhost:7676/metrics`

### Backup & Restore

#### Manual Backup

```bash
# Backup workspace database
docker exec neon-compute pg_dump -U postgres -d workspace > backup-$(date +%Y%m%d).sql

# Restore from backup
docker exec -i neon-compute psql -U postgres -d workspace < backup-20251103.sql
```

#### Automated Backups

Add to crontab for daily backups:

```bash
# Daily backup at 2 AM
0 2 * * * /home/marce/Projetos/TradingSystem/scripts/database/backup-neon.sh
```

lastReviewed: "2025-11-08"
---

## Troubleshooting

### Common Issues

#### 1. Containers Not Starting

**Symptom**: `docker compose up` fails

**Solution**:
```bash
# Check Docker logs
docker compose -f tools/compose/docker-compose.neon.yml logs

# Remove old volumes and restart
docker compose -f tools/compose/docker-compose.neon.yml down -v
docker compose -f tools/compose/docker-compose.neon.yml up -d
```

#### 2. Connection Refused

**Symptom**: `psql: could not connect to server`

**Solution**:
```bash
# Wait for PostgreSQL to be ready
bash scripts/database/test-neon-connection.sh

# Check if port 5433 is available
lsof -i :5433

# Check internal port mapping
docker port neon-compute
```

#### 3. Tables Don't Exist

**Symptom**: `relation "workspace.workspace_items" does not exist`

**Solution**:
```bash
# Re-run initialization
bash scripts/database/init-neon-workspace.sh

# Verify schema
docker exec neon-compute psql -U postgres -d workspace -c "\dt workspace.*"
```

#### 4. Slow Queries

**Symptom**: API responses > 500ms

**Solution**:
```bash
# Check query performance
docker exec neon-compute psql -U postgres -d workspace -c \
  "SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"

# Analyze tables
docker exec neon-compute psql -U postgres -d workspace -c \
  "ANALYZE workspace.workspace_items;"
```

### Debug Mode

Enable detailed logging:

```bash
# Set log level in .env
LOG_LEVEL=debug
RUST_LOG=debug  # For Neon components

# Restart services
docker compose restart
```

lastReviewed: "2025-11-08"
---

## Performance Optimization

### Connection Pooling

Adjust pool size based on load:

```env
# For high traffic
NEON_POOL_MAX=50
NEON_POOL_MIN=5

# For low traffic (development)
NEON_POOL_MAX=10
NEON_POOL_MIN=2
```

### Query Optimization

```sql
-- Create indexes for frequently queried fields
CREATE INDEX idx_items_custom ON workspace.workspace_items (field_name);

-- Analyze query plans
EXPLAIN ANALYZE SELECT * FROM workspace.workspace_items WHERE status = 'new';
```

### Resource Limits

Configure Docker resource limits in `docker-compose.neon.yml`:

```yaml
deploy:
  resources:
    limits:
      cpus: '2.0'
      memory: 2G
    reservations:
      cpus: '0.5'
      memory: 512M
```

lastReviewed: "2025-11-08"
---

## Advanced Usage

### Custom Functions

Create custom PostgreSQL functions:

```sql
-- Example: Auto-archive old completed items
CREATE OR REPLACE FUNCTION workspace.archive_completed_items(days_old INTEGER)
RETURNS INTEGER AS $$
DECLARE
  archived_count INTEGER;
BEGIN
  WITH archived AS (
    DELETE FROM workspace.workspace_items
    WHERE status = 'completed'
      AND created_at < NOW() - (days_old || ' days')::INTERVAL
    RETURNING *
  )
  SELECT COUNT(*) INTO archived_count FROM archived;
  
  RETURN archived_count;
END;
$$ LANGUAGE plpgsql;
```

### Triggers

Auto-update timestamps:

```sql
-- Already included in schema, but here's how it works
CREATE TRIGGER trigger_items_updated_at
  BEFORE UPDATE ON workspace.workspace_items
  FOR EACH ROW
  EXECUTE FUNCTION workspace.update_updated_at_column();
```

lastReviewed: "2025-11-08"
---

## Comparison: Neon vs TimescaleDB

| Feature | Neon | TimescaleDB |
|---------|------|-------------|
| **Database Branching** | ✅ Native | ❌ Manual dumps |
| **Autoscaling** | ✅ Yes | ❌ Fixed size |
| **Scale to Zero** | ✅ Yes | ❌ Always running |
| **Time-series Data** | ⚠️ Via extensions | ✅ Native |
| **Setup Complexity** | Medium | Low |
| **Resource Usage** | Variable | Fixed |
| **PostgreSQL Compatible** | ✅ 100% | ✅ 100% |

**Recommendation**: Use Neon for Workspace (general CRUD app), TimescaleDB for TP Capital (time-series data).

lastReviewed: "2025-11-08"
---

## Production Considerations

### Security

```env
# Use strong passwords in production
NEON_PASSWORD=$(openssl rand -base64 32)

# Enable SSL
NEON_SSL=true
```

### High Availability

For production, consider:
- Multiple safekeeper instances
- Read replicas for scaling reads
- Automated backups to S3/GCS
- Monitoring with Prometheus + Grafana

### Cloud Deployment

Neon also offers managed cloud service (neon.tech):
- Automatic backups
- Point-in-time recovery
- Global edge network
- Managed infrastructure

lastReviewed: "2025-11-08"
---

## Resources

- [Neon GitHub Repository](https://github.com/neondatabase/neon)
- [Neon Documentation](https://neon.tech/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [ADR: Workspace Neon Migration](../reference/adrs/007-workspace-neon-migration)

lastReviewed: "2025-11-08"
---

## Support

For issues or questions:
1. Check [Troubleshooting](#troubleshooting) section
2. Run diagnostics: `bash scripts/database/test-neon-connection.sh`
3. Check Neon logs: `docker logs neon-compute -f`
4. Review project documentation: `docs/content/database/`

lastReviewed: "2025-11-08"
---

**Last Updated**: 2025-11-03  
**Maintained By**: TradingSystem Database Team
