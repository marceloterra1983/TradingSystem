---
title: Loki & Promtail Troubleshooting
description: Guia operacional para investigar falhas no pipeline de logs centralizado (Promtail ‚Üí Loki ‚Üí Grafana).
tags:
  - observability
  - runbook
  - loki
owner: SRE
lastReviewed: "2025-11-12"
---

# Loki & Promtail Troubleshooting

## üß≠ Vis√£o Geral

```
Docker JSON Logs ‚Üí Promtail (9080) ‚Üí Loki (3100) ‚Üí Grafana Datasource ‚ÄúLoki‚Äù
```

## ‚úÖ Checklist r√°pido

1. `docker compose -f tools/monitoring/docker-compose.yml ps promtail loki`
2. Health endpoints:
   - Promtail: `curl http://localhost:9080/ready`
   - Loki: `curl http://localhost:3100/ready`
3. Grafana > Datasources > Loki ‚Üí bot√£o **Save & test**

## üîç Diagn√≥stico Promtail

- Logs:  
  ```bash
  docker compose -f tools/monitoring/docker-compose.yml logs -f promtail
  ```
- Conferir posi√ß√£o do arquivo: `/var/promtail/positions.yaml`
- Certificar que `docker.sock` est√° montado:
  ```bash
  docker inspect mon-promtail --format '{{ json .Mounts }}'
  ```
- Query Loki tempor√°ria:
  ```bash
  docker compose -f tools/monitoring/docker-compose.yml exec promtail promtail --version
  ```

### Erros comuns

| Mensagem | A√ß√£o |
|----------|------|
| `permission denied` | Verificar permiss√µes do host `/var/lib/docker/containers` |
| `client error: 404` | Confirmar URL do Loki (`http://loki:3100/loki/api/v1/push`) |
| `too many open files` | Ajustar `ulimit -n` no host (sugerido 65536) |

## üîç Diagn√≥stico Loki

- Logs:
  ```bash
  docker compose -f tools/monitoring/docker-compose.yml logs -f loki
  ```
- Verificar armazenamento:
  ```bash
  docker compose -f tools/monitoring/docker-compose.yml exec loki ls -R /var/loki | head
  ```
- Testar consulta:
  ```bash
  curl -G http://localhost:3100/loki/api/v1/query \
    --data-urlencode 'query={job="docker-containers"}|= "ERROR"' \
    --data-urlencode 'limit=20'
  ```

### Erros comuns

| Mensagem | A√ß√£o |
|----------|------|
| `failed to flush user` | Checar espa√ßo em disco do volume `loki-data` |
| `data corruption` | Limpar cache: `rm -rf /var/loki/cache/*` e reiniciar |
| `rpc error` | Garantir `common.ring` usando `inmemory` (n√£o misturar inst√¢ncias) |

## üìä Grafana

- Dashboard: `Logs / Loki Live`
- Query builder:
  ```logql
  {container="workspace-api"} |= "ERROR"
  ```
- Exportar logs: `Explore ‚Üí Download JSON`

## üõ†Ô∏è Recupera√ß√£o

1. Reiniciar promtail:
   ```bash
   docker compose -f tools/monitoring/docker-compose.yml restart promtail
   ```
2. Reiniciar loki (ap√≥s backup):
   ```bash
   docker compose -f tools/monitoring/docker-compose.yml stop loki
   sudo tar -czf loki-backup.tgz ./tools/monitoring/loki-data
   docker compose -f tools/monitoring/docker-compose.yml up -d loki
   ```
3. Re-testar Grafana datasource.

## üìå P√≥s-Incidente

- Registrar incidente na issue aberta pelo Alert Router (se aplic√°vel).
- Atualizar este runbook em caso de nova causa raiz.
- Considerar alerta espec√≠fico no Prometheus: `loki_request_duration_seconds`.

