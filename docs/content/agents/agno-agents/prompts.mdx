---
title: Agent Prompt Patterns
description: Prompt templates and variables used by Order Manager agents.
tags:
  - agents
  - order-manager
  - prompts
owner: MCPGuild
lastReviewed: '2025-10-26'
---
## Overview

Agno Agents use structured prompts to guide LLM behavior when `AGNO_ENABLE_LLM=true`. This page documents the prompt templates, input variables, context windows, and formatting requirements.

**LLM Provider**: OpenAI (configurable via `AGNO_MODEL_PROVIDER`)
**Model**: GPT-4o (configurable via `AGNO_MODEL_NAME`)
**Framework**: Agno (handles prompt construction and tool calling)

## Prompt Structure

### System Instructions

Each agent has a system instruction that defines its role and behavior:

**MarketAnalysisAgent**:

```
You are a market analysis agent specialized in consolidating TP Capital signals 
and Workspace insights. Your role is to identify trading opportunities by 
analyzing signal quality, historical performance, and idea context. 
Provide clear BUY/SELL/HOLD recommendations with confidence scores.
```

**RiskManagementAgent**:

```
You are a risk management agent responsible for validating trading signals 
against risk limits. Check daily loss limits, position sizes, trading hours, 
and overall portfolio risk. Approve or reject signals with clear justification. 
Safety is your top priority.
```

**SignalOrchestratorAgent**:

```
You are a signal orchestrator agent that coordinates decisions between 
MarketAnalysisAgent and RiskManagementAgent. Your role is to manage the 
workflow: receive market analysis requests, coordinate signal generation, 
validate signals through risk management, and aggregate results. Ensure 
smooth communication between agents and handle errors gracefully.
```

### Input Variables

**MarketAnalysisAgent Input**:

```json
{
  "task": "analyze_market",
  "payload": {
    "symbols": ["PETR4", "VALE3"],
    "include_tp_capital": true,
    "tp_capital_signals": [
      {"asset": "PETR4", "signal_type": "COMPRA", "buy_min": 32.00, "buy_max": 33.00, "targets": [34.00, 35.00], "stop": 31.00}
    ],
    "workspace_context": [
      {"title": "PETR4 análise semanal", "thesis": "Volume comprador crescente", "rating": "high"}
    ]
  }
}
```

**RiskManagementAgent Input**:

```json
{
  "task": "validate_signal",
  "payload": {
    "symbol": "PETR4",
    "signal_type": "BUY",
    "confidence": 0.85,
    "price": 32.50,
    "timestamp": "2025-10-24T10:30:00Z"
  }
}
```

**SignalOrchestratorAgent Input**:

```json
{
  "action": "ORCHESTRATE",
  "data": {
    "symbols": ["PETR4"],
    "include_tp_capital": true
  }
}
```

### Context Windows

**MarketAnalysisAgent**:

- **TP Capital Signals**: Last 100 signals (configurable via `limit` parameter)
- **Workspace Ideas**: All active ideas (filtered by symbol if applicable)
- **Workspace Insight Scores**: Optional teses/ratings associadas às ideias
- **Context Size**: ~2000 tokens (varies by data volume)

**RiskManagementAgent**:

- **Signal Context**: Single MarketSignal entity
- **Risk Limits**: Current daily loss, position sizes, trading hours
- **Historical Context**: Not used (stateless validation)
- **Context Size**: ~500 tokens

**SignalOrchestratorAgent**:

- **Workflow Context**: Orchestration request + agent responses
- **Agent Metadata**: Agents involved, processing times
- **Context Size**: ~1000 tokens

### Formatting Requirements

**Input Format**: JSON (structured data)

**Output Format**: JSON (structured responses)

**MarketAnalysisAgent Output**:

```json
{
  "signals": [
    {
      "symbol": "PETR4",
      "signal_type": "BUY",
      "confidence": 0.85,
      "price": 32.50,
      "timestamp": "2025-10-24T10:30:00Z",
      "source": "AGNO",
      "size": 100,
      "metadata": {
        "targets": [34.00, 35.00, 36.00],
        "stop": 31.00,
        "reasoning": "Strong buy signal from TP Capital reforçado por tese positiva no Workspace"
      }
    }
  ]
}
```

**RiskManagementAgent Output**:

```json
{
  "approved": true,
  "risk_level": "LOW",
  "reasons": [
    "Trading hours: PASS (10:30 BRT within 9:00-18:00)",
    "Daily loss limit: PASS (current R$1250 < limit R$5000)",
    "Position size: PASS (current 750 + order 100 = 850 < limit 1000)"
  ],
  "checks": {
    "daily_loss_check": true,
    "position_size_check": true,
    "trading_hours_check": true
  }
}
```

## Examples

### Example 1: Market Analysis with LLM

**Request**:

```bash
curl -X POST http://localhost:8200/api/v1/agents/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "symbols": ["PETR4"],
    "include_tp_capital": true
  }'
```

**Expected Response**:

```json
{
  "signals": [
    {
      "symbol": "PETR4",
      "signal_type": "BUY",
      "confidence": 0.85,
      "price": 32.50,
      "timestamp": "2025-10-24T10:30:00Z",
      "source": "AGNO",
      "size": 100,
      "metadata": {
        "reasoning": "TP Capital sinaliza compra entre 32.00-33.00 com alvos em 34.00 e 35.00. Workspace reforça tese de fluxo comprador; recomendação BUY a 32.50."
      }
    }
  ],
  "analysis_time": 0.42,
  "timestamp": "2025-10-24T10:30:00Z"
}
```

**Evaluation Notes**:

- LLM integrou sinal do TP Capital com contexto do Workspace
- Confidence score (0.85) reflects strong signal alignment
- Reasoning provides clear justification
- Processing time (0.42s) within target (&lt;1s)

---

### Example 2: Risk Validation (Rejection)

**Request**:

```bash
curl -X POST http://localhost:8200/api/v1/agents/signals \
  -H "Content-Type: application/json" \
  -d '{
    "action": "VALIDATE",
    "data": {
      "signals": [
        {
          "symbol": "PETR4",
          "signal_type": "BUY",
          "confidence": 0.85,
          "price": 32.50,
          "timestamp": "2025-10-24T19:30:00Z",
          "source": "AGNO",
          "size": 100
        }
      ]
    }
  }'
```

**Expected Response**:

```json
{
  "result": {
    "signals": [],
    "assessments": [
      {
        "signal_id": "PETR4-2025-10-24T19:30:00Z",
        "risk_level": "HIGH",
        "approved": false,
        "daily_loss_check": true,
        "position_size_check": true,
        "trading_hours_check": false,
        "reasons": [
          "Trading hours check FAILED: Signal timestamp 19:30 BRT is outside trading hours (9:00-18:00)"
        ],
        "timestamp": "2025-10-24T19:30:05Z"
      }
    ]
  },
  "agents_involved": ["RiskManagementAgent"],
  "total_time": 0.15
}
```

**Evaluation Notes**:

- Risk check correctly identified trading hours violation
- Signal rejected with clear reason
- Fast processing time (0.15s) due to early failure (trading hours check first)

---

### Example 3: Full Orchestration (LLM Disabled)

**Configuration**: `AGNO_ENABLE_LLM=false`

**Request**:

```bash
curl -X POST http://localhost:8200/api/v1/agents/signals \
  -H "Content-Type: application/json" \
  -d '{
    "action": "ORCHESTRATE",
    "data": {
      "symbols": ["PETR4"],
      "include_tp_capital": true
    }
  }'
```

**Expected Response**:

```json
{
  "result": {
    "signals": [
      {
        "symbol": "PETR4",
        "signal_type": "COMPRA",
        "confidence": 0.5,
        "price": 32.50,
        "timestamp": "2025-10-24T10:30:00Z",
        "source": "TP_CAPITAL",
        "size": 100,
        "metadata": {
          "buy_min": 32.00,
          "buy_max": 33.00,
          "targets": [34.00, 35.00],
          "stop": 31.00
        }
      }
    ],
    "assessments": [
      {
        "signal_id": "PETR4-2025-10-24T10:30:00Z",
        "risk_level": "LOW",
        "approved": true,
        "daily_loss_check": true,
        "position_size_check": true,
        "trading_hours_check": true,
        "reasons": ["Default risk validation for PETR4"],
        "timestamp": "2025-10-24T10:30:05Z"
      }
    ]
  },
  "agents_involved": ["MarketAnalysisAgent", "RiskManagementAgent"],
  "total_time": 0.25
}
```

**Evaluation Notes**:

- LLM disabled, fallback heuristics used
- TP Capital signal converted to MarketSignal format
- Risk validation passed (all checks true)
- Fast processing time (0.25s) without LLM overhead

## Prompt Engineering Best Practices

### 1. Clear Role Definition

- Define agent role explicitly in system instructions
- Specify primary responsibility and constraints
- Emphasize safety and accuracy (especially for RiskManagementAgent)

### 2. Structured Input/Output

- Use JSON format for all inputs and outputs
- Define clear schemas (Pydantic models)
- Validate inputs before passing to LLM
- Parse and validate LLM outputs

### 3. Fallback Strategies

- Always provide deterministic fallback when LLM fails
- Use confidence thresholds for heuristic decisions
- Log when fallback is used (for monitoring)

### 4. Context Management

- Limit context size (avoid token limit errors)
- Prioritize recent data (last 24 hours for market data)
- Filter irrelevant data (only include requested symbols)

### 5. Error Handling

- Catch LLM exceptions gracefully
- Log errors with context (symbol, action, error type)
- Track metrics (`agent_errors_total`)
- Return safe defaults (HOLD signal, reject risk assessment)

## Variable Reference

### LLM Configuration

| Variable | Description | Default | Example |
|----------|-------------|---------|----------|
| `AGNO_ENABLE_LLM` | Enable LLM-powered analysis | `false` | `true` |
| `AGNO_MODEL_PROVIDER` | LLM provider | `openai` | `openai`, `anthropic` |
| `AGNO_MODEL_NAME` | Model identifier | `gpt-4o` | `gpt-4o`, `claude-3-opus` |
| `OPENAI_API_KEY` | OpenAI API key | - | `sk-proj-...` |

**Security**: Never log API keys, rotate every 180 days

### Agent Behavior

| Variable | Description | Default | Impact |
|----------|-------------|---------|--------|
| `AGNO_LOG_LEVEL` | Logging verbosity | `INFO` | DEBUG shows prompt details |
| `HTTP_TIMEOUT` | API request timeout (seconds) | `10` | Affects data gathering latency |
| `RETRY_MAX_ATTEMPTS` | Max retry attempts | `4` | Affects resilience vs latency |

### Context Control

**Market Data Context**:

- Time window: Last 24 hours (hardcoded)
- Symbol filter: Only requested symbols
- Data sources: TP Capital (optional), Workspace (optional)

**Signal Context**:

- TP Capital limit: 100 signals (configurable in client call)
- Workspace ideas: All active ideas (no limit)
- Workspace context: Optional metadata (thesis, rating)

## Prompt Templates

### Market Analysis Prompt Template

**Template**:

```
System: {system_instructions}

User: {task_json}

Task: analyze_market
Payload:
- Symbols: {symbols}
- Include TP Capital: {include_tp_capital}
- Workspace Context: {workspace_context}
- TP Capital Signals: {tp_capital_signals}

Generate BUY/SELL/HOLD signals with confidence scores for each symbol.
```

**Variables**:

- `{system_instructions}`: MarketAnalysisAgent system prompt
- `{task_json}`: JSON-encoded task and payload
- `{symbols}`: List of symbols to analyze
- `{include_tp_capital}`: Boolean flag
- `{workspace_context}`: Workspace insights array
- `{tp_capital_signals}`: TP Capital signals array

**Expected Output**:

```json
{
  "signals": [
    {
      "symbol": "PETR4",
      "signal_type": "BUY",
      "confidence": 0.85,
      "price": 32.50,
      "source": "AGNO",
      "metadata": {
        "reasoning": "Strong buy signal from TP Capital reforçado por insight do Workspace"
      }
    }
  ]
}
```

---

### Risk Validation Prompt Template

**Template**:

```
System: {system_instructions}

User: {task_json}

Task: validate_signal
Payload:
- Symbol: {symbol}
- Signal Type: {signal_type}
- Confidence: {confidence}
- Price: {price}
- Timestamp: {timestamp}

Validate this signal against risk policies. Check:
1. Trading hours (9:00-18:00 BRT)
2. Daily loss limit
3. Position size limit

Provide approval decision with clear justification.
```

**Variables**:

- `{system_instructions}`: RiskManagementAgent system prompt
- `{task_json}`: JSON-encoded task and payload
- `{symbol}`, `{signal_type}`, `{confidence}`, `{price}`, `{timestamp}`: Signal fields

**Expected Output**:

```json
{
  "approved": true,
  "risk_level": "LOW",
  "reasons": [
    "Trading hours: PASS (10:30 BRT within 9:00-18:00)",
    "Daily loss limit: PASS (current R$1250 < limit R$5000)",
    "Position size: PASS (current 750 + order 100 = 850 < limit 1000)"
  ]
}
```

## Evaluation Criteria

### Market Analysis Evaluation

**Correctness**:

- Signal type matches market conditions (BUY on uptrend, SELL on downtrend)
- Confidence score correlates with signal strength
- Price recommendation is actionable (within current market range)

**Performance**:

- Analysis time &lt;1s p95
- No LLM timeout errors
- Fallback heuristics work when LLM unavailable

**Quality Metrics**:

- Signal accuracy (backtesting)
- Confidence calibration (high confidence → high win rate)
- Reasoning clarity (human-readable explanations)

---

### Risk Validation Evaluation

**Correctness**:

- All risk checks executed (trading hours, daily loss, position size)
- Approval decision matches check results (all pass → approve)
- Rejection reasons are clear and actionable

**Performance**:

- Validation time &lt;500ms p95
- No risk engine timeout errors
- Graceful degradation when risk engine unavailable

**Safety Metrics**:

- False positive rate (approved signals that should be rejected)
- False negative rate (rejected signals that should be approved)
- Risk violation detection rate

## Related Documentation

- [Agent Overview](/agents/agno-agents) - Agent responsibilities
- [Agent Flows](./flows) - Execution flows
- [MCP Integration](./mcp) - MCP capabilities
- [Agent Tests](./tests) - Test suite and examples
- Monitoring guidance (migration pending)
