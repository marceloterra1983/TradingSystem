---
title: Política de Gerenciamento de Segredos e Variáveis de Ambiente
description: Diretrizes obrigatórias para gerenciamento, armazenamento e
  versionamento de segredos (API keys, tokens, senhas, certificados) e variáveis
  de ambiente no TradingSystem.
slug: /governance/policies/secrets-env-policy
tags:
  - security
  - compliance
  - secrets
  - environment-variables
owner: SecurityEngineering
lastReviewed: 2025-11-05
sidebar_label: POL-0002 - Secrets Policy
sidebar_position: 5
---

<!-- AUTO-GENERATED from governance source. Do not edit in docs/content. -->

---
title: "Política de Gerenciamento de Segredos e Variáveis de Ambiente"
id: POL-0002
owner: SecurityEngineering
lastReviewed: "2025-11-05"
reviewCycleDays: 90
status: active
appliesTo:
  - OrderManager
  - DataCapture
  - Frontend
  - WorkspaceAPI
  - TPCapital
  - DocumentationAPI
  - ServiceLauncher
related:
  - STD-010
tags:
  - security
  - compliance
  - secrets
  - environment-variables
---

# Política de Gerenciamento de Segredos e Variáveis de Ambiente

**ID:** POL-0002  
**Owner:** SecurityEngineering  
**Status:** Active  
**Last Reviewed:** 2025-11-05  
**Next Review:** 2026-02-03 (90 days)

## 1. Objetivo

Estabelecer diretrizes obrigatórias para gerenciamento, armazenamento e versionamento de segredos (API keys, tokens, senhas, certificados) e variáveis de ambiente no TradingSystem, garantindo confidencialidade, integridade e rastreabilidade.

## 2. Escopo

Esta política aplica-se a:

- **Aplicações de Trading:** OrderManager, DataCapture (Windows nativo)
- **Serviços Auxiliares:** WorkspaceAPI, TPCapital, DocumentationAPI, ServiceLauncher (Docker/WSL)
- **Frontend:** Dashboard React (port 3103)
- **Pipelines CI/CD:** GitHub Actions, scripts de deploy
- **Desenvolvedores:** Todos os contribuidores do repositório

## 3. Princípios Fundamentais

### 3.1 Nunca Versionar Segredos em Plaintext

**PROIBIDO:**
- ❌ Commitar arquivos `.env` reais com valores sensíveis
- ❌ Incluir tokens/passwords em código-fonte ou comentários
- ❌ Armazenar segredos em logs, artifacts de CI/CD ou documentação pública

**PERMITIDO:**
- ✅ Versionar arquivos `.env.example` SEM valores reais
- ✅ Versionar segredos criptografados com SOPS/age (`*.enc.yaml`)
- ✅ Referenciar segredos via variáveis de ambiente ou secret managers

### 3.2 Fontes de Verdade por Ambiente

| Ambiente | Fonte de Verdade | Tecnologia |
|----------|------------------|------------|
| **Desenvolvimento Local** | `.env` local (não versionado) | `dotenv` (Node.js), `python-dotenv` (Python), `appsettings.Development.json` (C#) |
| **CI/CD (GitHub Actions)** | GitHub Secrets + OIDC | Environments, `secrets.*` context |
| **Produção Windows** | Variáveis de sistema + arquivos SOPS/age criptografados | `setx`, `System.Environment`, SOPS decrypt |
| **Docker/WSL** | Arquivos SOPS/age criptografados montados em volumes | Docker secrets, SOPS runtime |

### 3.3 Naming Convention

**Formato Padrão:** `{SERVICO}__{SECAO}__{CHAVE}`

**Exemplos:**
```bash
# OrderManager (C# nativo Windows)
ORDERMANAGER__RISK__DAILY_LOSS_LIMIT=5000.00
ORDERMANAGER__RISK__KILL_SWITCH=false
ORDERMANAGER__PROFITDLL__USERNAME=trader123
ORDERMANAGER__PROFITDLL__PASSWORD=*** # NUNCA versionar

# WorkspaceAPI (Node.js Docker)
WORKSPACE__DB__PRIMARY__URL=postgresql://user:pass@timescaledb:5432/workspace
WORKSPACE__DB__PRIMARY__POOL_SIZE=20
WORKSPACE__AUTH__JWT_SECRET=*** # NUNCA versionar

# Frontend Dashboard (React/Vite)
VITE__API__WORKSPACE__URL=http://localhost:3200
VITE__API__DOCUMENTATION__URL=http://localhost:3401

# Compartilhados
APP_ENV=production
APP_LOG_LEVEL=info
TELEGRAM__BOT_TOKEN=*** # NUNCA versionar
EVOLUTION_API__KEY=*** # NUNCA versionar
```

**Prefixos Reservados:**
- `APP__` → Configurações globais (env, log level, locale)
- `{SERVICO}__` → Específico do serviço (ORDERMANAGER, WORKSPACE, etc.)
- `VITE__` → Variáveis expostas ao frontend (build-time)
- `SOPS__` → Configurações do SOPS/age

## 4. Requisitos Obrigatórios

### 4.1 Templates e Exemplos

**Todos os repositórios/serviços DEVEM:**

1. Incluir `governance/registry/templates/.env.example` com:
   - Todas as chaves necessárias listadas
   - Valores PLACEHOLDER ou comentários explicativos
   - NUNCA valores reais/sensíveis

2. Manter sincronizado com `.env` real (via automação):
   ```bash
   npm run governance:check  # Valida sincronização
   ```

3. Documentar variáveis obrigatórias vs. opcionais:
   ```bash
   # OBRIGATÓRIO - Autenticação ProfitDLL
   ORDERMANAGER__PROFITDLL__USERNAME=<seu_usuario>

   # OPCIONAL - Sobrescreve limite padrão (5000)
   ORDERMANAGER__RISK__DAILY_LOSS_LIMIT=10000.00
   ```

### 4.2 Rotação de Segredos

**Frequência:**
- **Tokens de API Externa:** A cada 90 dias
- **Senhas de Banco de Dados:** A cada 180 dias
- **JWT Secrets:** A cada 90 dias
- **Emergency:** Imediatamente após incidentes de segurança

**Processo:**
- Seguir `governance/controls/secrets-rotation-sop.md`
- Registrar evidência em `governance/evidence/audits/secrets-rotation-YYYY-MM-DD.json`
- Testar em staging antes de produção
- Manter versões antigas ativas por 24h (rollback)

### 4.3 Logs e Auditoria

**PROIBIDO:**
- ❌ `console.log(process.env.JWT_SECRET)` ou similar
- ❌ Incluir valores de secrets em stack traces
- ❌ Expor secrets em endpoints de health/debug

**OBRIGATÓRIO:**
- ✅ Mascarar secrets em logs estruturados:
  ```javascript
  logger.info({ 
    dbUrl: maskSecret(process.env.DB_URL), // postgresql://user:***@host:5432/db
    action: 'database_connection' 
  });
  ```
- ✅ Auditar acessos a secrets (quem, quando, qual):
  ```json
  {
    "timestamp": "2025-11-05T14:32:00Z",
    "actor": "ci-pipeline",
    "secret": "ORDERMANAGER__PROFITDLL__PASSWORD",
    "action": "read",
    "environment": "production"
  }
  ```

### 4.4 Criptografia (SOPS + age)

**Para segredos versionados (ex: configurações de produção):**

1. Criptografar antes de commitar:
   ```bash
   age -R .age-recipients.txt -o secrets.enc.yaml secrets.yaml
   git add secrets.enc.yaml
   git add .age-recipients.txt  # Contém public keys
   ```

2. Descriptografar em runtime (CI/CD ou produção):
   ```bash
   export AGE_KEY=$(cat /secure/location/age-key.txt)
   age -d -i <(echo "$AGE_KEY") secrets.enc.yaml > secrets.yaml
   ```

3. Nunca versionar chaves privadas (`age-key.txt`) no Git

### 4.5 Validação Automatizada

**Pre-Commit / CI:**
```bash
npm run governance:check  # Executa:
  # 1. validate-envs.mjs → Detecta .env reais no repo
  # 2. validate-policies.mjs → Verifica expiração de políticas
  # 3. scan-secrets.mjs → TruffleHog/git-secrets
```

**Build Bloqueado se:**
- Política POL-0002 expirada (`lastReviewed + reviewCycleDays > hoje`)
- Owner vazio ou inválido
- Segredos detectados em plaintext

## 5. Responsabilidades

### Security Engineering (Owner)
- Revisar política a cada 90 dias
- Aprovar exceções (documentadas em `governance/evidence/audits/exceptions/`)
- Conduzir auditorias trimestrais

### Desenvolvedores
- Nunca commitar `.env` reais
- Usar `.env.example` como referência
- Reportar vazamentos acidentais imediatamente
- Rotacionar secrets após saída do projeto

### DevOps/SRE
- Configurar GitHub Secrets/OIDC
- Manter age keys em local seguro (KMS, Vault)
- Automatizar rotação de secrets
- Monitorar acessos anômalos

## 6. Consequências de Violação

**Severidade Alta (Secrets Expostos):**
- Revogação imediata do segredo
- Rotação de todos os secrets relacionados
- Post-mortem obrigatório
- Possível revisão de acessos

**Severidade Média (Processo não seguido):**
- Revisão do PR bloqueada
- Treinamento obrigatório sobre políticas
- Documentação do incidente

## 7. Exceções

Exceções devem ser:
1. Solicitadas via issue no repositório
2. Aprovadas por Security Engineering
3. Documentadas em `governance/evidence/audits/exceptions/EXC-YYYY-MM-DD-{id}.md`
4. Revisadas a cada 30 dias

**Exemplo de exceção válida:**
- Desenvolvimento local com secrets de teste em ambiente isolado (não produção)

## 8. Referências

- **Padrão Relacionado:** [STD-010 - Secrets Standard](../standards/secrets-standard.md)
- **SOP/Runbook:** [Secrets Rotation SOP](../controls/secrets-rotation-sop.mdx)
- **Templates:** [.env.example](../registry/templates/.env.example)
- **Evidências:** [Audits Directory](../evidence/audits/)

## 9. Histórico de Revisões

| Data       | Versão | Autor              | Mudanças                          |
|------------|--------|--------------------|-----------------------------------|
| 2025-11-05 | 1.0    | SecurityEngineering | Criação inicial da política POL-0002 |

---

**Próxima Revisão:** 2026-02-03  
**Contato:** security-engineering@tradingsystem.local
