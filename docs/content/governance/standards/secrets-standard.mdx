---
title: Padrão Técnico de Segredos e Variáveis de Ambiente
description: Requisitos técnicos testáveis e verificáveis para implementação da
  POL-0002 - Política de Gerenciamento de Segredos.
slug: /governance/standards/secrets-standard
tags:
  - security
  - technical-standard
  - secrets
  - testing
owner: SecurityEngineering
lastReviewed: 2025-11-05
sidebar_label: STD-010 - Secrets Standard
sidebar_position: 15
---

<!-- AUTO-GENERATED from governance source. Do not edit in docs/content. -->

---
title: "Padrão Técnico de Segredos e Variáveis de Ambiente"
id: STD-010
owner: SecurityEngineering
lastReviewed: "2025-11-05"
reviewCycleDays: 90
status: active
appliesTo:
  - AllServices
relatedPolicies:
  - POL-0002
tags:
  - security
  - technical-standard
  - secrets
  - testing
---

# Padrão Técnico de Segredos e Variáveis de Ambiente (STD-010)

**ID:** STD-010  
**Owner:** SecurityEngineering  
**Status:** Active  
**Last Reviewed:** 2025-11-05  
**Next Review:** 2026-02-03 (90 days)

## 1. Objetivo

Definir requisitos técnicos **testáveis e verificáveis** para implementação da [POL-0002 - Política de Gerenciamento de Segredos](/governance/policies/secrets-env-policy).

## 2. Requisitos Testáveis

### 2.1 Presença de .env.example

**Requisito:** Todo serviço/aplicação DEVE incluir `.env.example` no repositório.

**Validação:**
```bash
# Automação: validate-envs.mjs
test -f .env.example || exit 1
test -f governance/registry/templates/.env.example || exit 1
```

**Critérios de Aceitação:**
- ✅ Arquivo existe no root do serviço ou em `governance/registry/templates/`
- ✅ Todas as chaves obrigatórias estão presentes
- ✅ NENHUM valor real/sensível incluído
- ✅ Comentários explicativos para chaves complexas

**Exemplo:**
```bash
# ✅ CORRETO
ORDERMANAGER__PROFITDLL__USERNAME=<seu_usuario_nelogica>
ORDERMANAGER__RISK__DAILY_LOSS_LIMIT=5000.00  # Limite em R$

# ❌ ERRADO (valor real)
ORDERMANAGER__PROFITDLL__PASSWORD=SenhaReal123
```

### 2.2 Sincronização .env ↔ .env.example

**Requisito:** Chaves presentes em `.env` real DEVEM estar documentadas em `.env.example`.

**Validação:**
```javascript
// governance/automation/validate-envs.mjs
const envKeys = Object.keys(process.env).filter(k => !k.startsWith('npm_'));
const exampleKeys = parseEnvFile('.env.example');
const missing = envKeys.filter(k => !exampleKeys.includes(k));

if (missing.length > 0) {
  throw new Error(`Chaves faltando no .env.example: ${missing.join(', ')}`);
}
```

**Critérios de Aceitação:**
- ✅ `npm run governance:check` passa sem erros
- ✅ Nenhuma chave "órfã" no `.env` real
- ✅ Nenhuma chave obsoleta no `.env.example`

### 2.3 Scanner de Segredos (Pre-Commit/CI)

**Requisito:** Commits DEVEM ser verificados por scanner de segredos antes de serem aceitos.

**Ferramentas Aprovadas:**
- **TruffleHog** (regex + entropy detection)
- **git-secrets** (AWS/GitHub patterns)
- **detect-secrets** (Yelp - baseline comparison)

**Validação:**
```bash
# CI: .github/workflows/code-quality.yml
- name: Scan Secrets
  run: |
    docker run --rm -v $(pwd):/src trufflesecurity/trufflehog:latest \
      filesystem /src --fail --json > scan-results.json
    if [ $(jq '.[] | select(.Verified == true)' scan-results.json | wc -l) -gt 0 ]; then
      echo "❌ Segredos verificados detectados!"
      exit 1
    fi
```

**Critérios de Aceitação:**
- ✅ Scanner executa em TODOS os commits (pre-commit hook ou CI obrigatório)
- ✅ Build falha se segredos verificados são detectados
- ✅ Falsos positivos documentados em `.trufflehogignore` ou similar

### 2.4 Criptografia SOPS + age

**Requisito:** Segredos versionados DEVEM ser criptografados com SOPS + age.

**Estrutura de Arquivos:**
```
config/
├── .age-recipients.txt         # Public keys (versionado)
├── secrets.enc.yaml            # Criptografado (versionado)
└── secrets.yaml                # Plaintext (NÃO versionado)
```

**Validação:**
```bash
# Automação: validate-envs.mjs
if git ls-files | grep -E 'secrets\.yaml$' | grep -v '\.example$' | grep -v '\.enc\.'; then
  echo "❌ Arquivo secrets.yaml plaintext detectado no Git!"
  exit 1
fi
```

**Critérios de Aceitação:**
- ✅ APENAS `*.enc.yaml` versionados
- ✅ `.gitignore` bloqueia `secrets.yaml` plaintext
- ✅ CI descriptografa com `AGE_KEY` do GitHub Secrets
- ✅ Age private key NUNCA commitada

**Exemplo de Uso:**
```bash
# Criptografar localmente
age -R config/.age-recipients.txt -o config/secrets.enc.yaml config/secrets.yaml

# Descriptografar em CI
age -d -i <(echo "$AGE_SECRET_KEY") config/secrets.enc.yaml > config/secrets.yaml
```

### 2.5 Bloqueio de Build (Política Expirada)

**Requisito:** Build DEVE falhar se POL-0002 estiver expirada ou sem owner.

**Validação:**
```javascript
// governance/automation/validate-policies.mjs
const policy = parseFrontmatter('governance/policies/secrets-env-policy.md');
const lastReviewed = new Date(policy.lastReviewed);
const reviewCycleDays = policy.reviewCycleDays || 90;
const nextReview = new Date(lastReviewed.getTime() + reviewCycleDays * 24 * 60 * 60 * 1000);

if (new Date() > nextReview) {
  throw new Error(`POL-0002 expirada! Última revisão: ${lastReviewed.toISOString()}`);
}

if (!policy.owner || policy.owner === 'TBD') {
  throw new Error('POL-0002 sem owner definido!');
}
```

**Critérios de Aceitação:**
- ✅ CI executa `npm run governance:check` antes de build
- ✅ Build falha se `lastReviewed + reviewCycleDays < hoje`
- ✅ Build falha se `owner` vazio ou "TBD"
- ✅ Notificação enviada para owner 7 dias antes da expiração

### 2.6 Mascaramento de Logs

**Requisito:** Logs NUNCA devem expor valores de segredos em plaintext.

**Implementação (Node.js):**
```javascript
// shared/logger/maskSecret.js
export function maskSecret(value) {
  if (!value) return null;
  const str = String(value);
  if (str.length <= 8) return '***';
  return str.substring(0, 4) + '***' + str.substring(str.length - 4);
}

// Uso
logger.info({ 
  dbUrl: maskSecret(process.env.DATABASE_URL), 
  // postgresql://user:***@host:5432/db
  action: 'connection_established' 
});
```

**Implementação (C#):**
```csharp
// Shared/Logger/SecretMasker.cs
public static string MaskSecret(string value)
{
    if (string.IsNullOrEmpty(value)) return null;
    if (value.Length <= 8) return "***";
    return value.Substring(0, 4) + "***" + value.Substring(value.Length - 4);
}
```

**Validação:**
```bash
# Auditoria de logs
grep -r 'password\|secret\|token\|key' logs/ | grep -vE '\*\*\*|REDACTED|<masked>' && exit 1 || exit 0
```

**Critérios de Aceitação:**
- ✅ Função `maskSecret()` disponível em todas as linguagens (C#, Node.js, Python)
- ✅ Logs estruturados SEMPRE mascaram campos sensíveis
- ✅ Auditoria de logs não encontra valores plaintext

### 2.7 Proibição de Print/Console em Produção

**Requisito:** Código de produção NÃO DEVE conter `console.log()`, `print()`, `Debug.WriteLine()` de secrets.

**Validação (ESLint):**
```javascript
// .eslintrc.js
rules: {
  'no-console': process.env.NODE_ENV === 'production' ? 'error' : 'warn',
  'no-restricted-syntax': [
    'error',
    {
      selector: "CallExpression[callee.object.name='console'][callee.property.name!=/^(warn|error)$/]",
      message: 'console.log() proibido em produção. Use logger estruturado.'
    }
  ]
}
```

**Validação (C# - Analyzer):**
```xml
<!-- .editorconfig -->
[*.cs]
dotnet_diagnostic.CA1848.severity = error  # Use LoggerMessage delegates
dotnet_diagnostic.CA2254.severity = error  # Template should be constant
```

**Critérios de Aceitação:**
- ✅ Linter falha se `console.log(process.env.*)` detectado
- ✅ Code review rejeita PRs com prints de secrets
- ✅ Runtime guards bloqueiam logs em produção

### 2.8 Evidências e Auditoria

**Requisito:** Rotações de segredos DEVEM gerar evidências rastreáveis em JSON.

**Formato:**
```json
{
  "timestamp": "2025-11-05T14:32:00Z",
  "type": "secrets_rotation",
  "actor": "devops-team",
  "environment": "production",
  "secrets_rotated": [
    {
      "key": "ORDERMANAGER__PROFITDLL__PASSWORD",
      "service": "OrderManager",
      "old_hash": "sha256:abc123...",
      "new_hash": "sha256:def456...",
      "rotation_method": "manual",
      "tested_in_staging": true
    }
  ],
  "rollback_available_until": "2025-11-06T14:32:00Z"
}
```

**Localização:**
```
governance/evidence/audits/
├── secrets-audit-2025-11.json        # Gerado por validate-envs.mjs
├── secrets-rotation-2025-11-05.json  # Manual (SOP)
└── secrets-scan-2025-11-05.json      # TruffleHog output
```

**Validação:**
```bash
# Automação: validate-envs.mjs gera relatório
jq '.secrets_rotated | length' governance/evidence/audits/secrets-rotation-*.json
```

**Critérios de Aceitação:**
- ✅ Arquivo JSON gerado a cada rotação
- ✅ Hash (não valor real) dos secrets registrado
- ✅ Janela de rollback documentada (24h padrão)
- ✅ Evidências mantidas por 2 anos (compliance)

## 3. Ambientes de Execução

### 3.1 Desenvolvimento Local

**Tecnologia:** `.env` file (não versionado)

**Checklist:**
- [ ] `.env` criado a partir de `.env.example`
- [ ] Valores de teste/mock utilizados (não produção)
- [ ] `.gitignore` bloqueia `.env`
- [ ] `dotenv` carregado no início da aplicação

**Exemplo (Node.js):**
```javascript
import dotenv from 'dotenv';
import path from 'path';

const projectRoot = path.resolve(__dirname, '../../../');
dotenv.config({ path: path.join(projectRoot, '.env') });

if (!process.env.ORDERMANAGER__PROFITDLL__USERNAME) {
  throw new Error('ORDERMANAGER__PROFITDLL__USERNAME não definido!');
}
```

### 3.2 CI/CD (GitHub Actions)

**Tecnologia:** GitHub Secrets + OIDC

**Checklist:**
- [ ] Secrets configurados em Settings → Secrets → Actions
- [ ] Environments isolados (dev, staging, production)
- [ ] OIDC configurado para Azure/AWS (sem long-lived credentials)
- [ ] Logs do CI não expõem secrets (`set +x` antes de uso)

**Exemplo (GitHub Actions):**
```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Decrypt Secrets
        env:
          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
        run: |
          echo "$AGE_SECRET_KEY" | age -d -i /dev/stdin config/secrets.enc.yaml > config/secrets.yaml

      - name: Deploy
        run: |
          # Secrets disponíveis via arquivo descriptografado
          npm run deploy
```

### 3.3 Produção Windows (Nativo)

**Tecnologia:** Variáveis de sistema + SOPS/age

**Checklist:**
- [ ] Variáveis configuradas via `setx` ou Registry
- [ ] Arquivos SOPS criptografados em `C:\TradingSystem\config\`
- [ ] Age private key em `C:\TradingSystem\secrets\age-key.txt` (ACL restrito)
- [ ] Services/executáveis leem via `Environment.GetEnvironmentVariable()`

**Exemplo (PowerShell):**
```powershell
# Configurar variável de sistema (persistente)
setx ORDERMANAGER__PROFITDLL__USERNAME "trader123" /M

# Descriptografar secrets no boot
age -d -i C:\TradingSystem\secrets\age-key.txt `
  -o C:\TradingSystem\config\secrets.yaml `
  C:\TradingSystem\config\secrets.enc.yaml
```

### 3.4 Docker/WSL

**Tecnologia:** Docker secrets + SOPS runtime

**Checklist:**
- [ ] Secrets montados como volumes read-only
- [ ] Descriptografia em entrypoint (`docker-entrypoint.sh`)
- [ ] Secrets NÃO passados via `ENV` (vulnerável a `docker inspect`)

**Exemplo (docker-compose.yml):**
```yaml
services:
  workspace-api:
    image: tradingsystem/workspace-api:latest
    env_file:
      - ../../.env  # Apenas não-sensíveis
    secrets:
      - db_password
    volumes:
      - ./config/secrets.enc.yaml:/app/config/secrets.enc.yaml:ro

secrets:
  db_password:
    file: ./secrets/db_password.txt  # Gerado por SOPS
```

## 4. Testes de Conformidade

### 4.1 Checklist de Validação

Execute antes de cada release:

```bash
# 1. Verificar sincronização .env ↔ .env.example
npm run governance:check

# 2. Escanear segredos
docker run --rm -v $(pwd):/src trufflesecurity/trufflehog:latest filesystem /src

# 3. Validar políticas
npm run governance:check

# 4. Gerar evidências
npm run governance:metrics
cat governance/evidence/audits/secrets-audit-$(date +%Y-%m).json
```

### 4.2 Testes Automatizados (Jest/Mocha)

```javascript
// tests/governance/secrets.test.js
describe('Secrets Governance', () => {
  test('.env.example existe', () => {
    expect(fs.existsSync('.env.example')).toBe(true);
  });

  test('Nenhum valor real em .env.example', () => {
    const content = fs.readFileSync('.env.example', 'utf-8');
    expect(content).not.toMatch(/password=\w{8,}/i);
    expect(content).not.toMatch(/token=[A-Za-z0-9]{20,}/);
  });

  test('POL-0002 não expirada', () => {
    const policy = parseFrontmatter('governance/policies/secrets-env-policy.md');
    const lastReviewed = new Date(policy.lastReviewed);
    const reviewCycleDays = policy.reviewCycleDays || 90;
    const nextReview = new Date(lastReviewed.getTime() + reviewCycleDays * 24 * 60 * 60 * 1000);
    expect(new Date()).toBeLessThan(nextReview);
  });
});
```

## 5. Métricas de Sucesso

| Métrica | Target | Medição |
|---------|--------|---------|
| Secrets escaneados por commit | 100% | GitHub Actions logs |
| Rotações dentro do prazo | ≥95% | `secrets-rotation-*.json` |
| Incidentes de exposição | 0 | `governance/evidence/audits/exceptions/` |
| Tempo de rotação (emergency) | under 2h | Post-mortem reports |
| Cobertura de mascaramento em logs | 100% | Auditoria de logs |

## 6. Ferramentas Recomendadas

| Ferramenta | Propósito | Obrigatório? |
|------------|-----------|--------------|
| **TruffleHog** | Scanner de segredos (entropy + regex) | ✅ Sim |
| **SOPS** | Criptografia de arquivos YAML/JSON | ✅ Sim (para segredos versionados) |
| **age** | Criptografia moderna (replacement GPG) | ✅ Sim (backend SOPS) |
| **dotenv** | Carregamento de `.env` (Node.js) | ✅ Sim (dev local) |
| **python-dotenv** | Carregamento de `.env` (Python) | ⚠️ Se aplicável |
| **git-secrets** | Pre-commit hook AWS/GitHub | ⚠️ Opcional (TruffleHog preferido) |
| **HashiCorp Vault** | Secret manager enterprise | ❌ Futuro (não obrigatório v1) |

## 7. Responsabilidades

| Papel | Responsabilidade |
|-------|------------------|
| **Developers** | Seguir naming convention, nunca commitar `.env` reais, usar `maskSecret()` |
| **DevOps/SRE** | Configurar GitHub Secrets, manter age keys, automatizar rotação |
| **Security Engineering** | Revisar padrão a cada 90 dias, auditar conformidade, aprovar exceções |
| **QA** | Testar rotação de secrets em staging, validar mascaramento de logs |

## 8. Referências

- **Política:** [POL-0002 - Secrets & Env Policy](/governance/policies/secrets-env-policy)
- **SOP:** [Secrets Rotation SOP](/governance/controls/secrets-rotation-sop)
- **Templates:** [.env.example](https://github.com/marceloterra1983/TradingSystem/blob/main/governance/registry/templates/.env.example)
- **Automação:** `governance/automation/validate-envs.mjs`, `scan-secrets.mjs`

## 9. Histórico de Revisões

| Data       | Versão | Autor              | Mudanças                      |
|------------|--------|--------------------|-------------------------------|
| 2025-11-05 | 1.0    | SecurityEngineering | Criação inicial STD-010 |

---

**Próxima Revisão:** 2026-02-03  
**Contato:** security-engineering@tradingsystem.local
