---
title: Multi-Collection Architecture
sidebar_position: 5
description: Architecture for managing multiple Qdrant collections with different embedding models
tags: [rag, llamaindex, qdrant, embedding]
domain: tools
type: technical-spec
summary: Architecture for managing multiple Qdrant collections with different embedding models
status: active
owner: ArchitectureGuild
lastReviewed: "2025-10-31"
last_review: "2025-10-31"
---

# Multi-Collection RAG Architecture

## Overview

O TradingSystem agora suporta **mÃºltiplas coleÃ§Ãµes** no Qdrant, cada uma indexada com um **modelo de embedding diferente**. Isso permite comparar a qualidade de resultados entre modelos e escolher o melhor para cada caso de uso.

## Modelos de Embedding DisponÃ­veis

### 1. Nomic Embed Text (768d)
- **Modelo**: `nomic-embed-text:latest`
- **DimensÃµes**: 768
- **Tamanho**: 274 MB
- **Uso**: PropÃ³sito geral, busca semÃ¢ntica, retrieval
- **Performance**: RÃ¡pido, alta qualidade
- **ColeÃ§Ã£o**: `documentation__nomic`

### 2. MXBAI Embed Large (384d)
- **Modelo**: `mxbai-embed-large:latest`
- **DimensÃµes**: 384
- **Tamanho**: 669 MB
- **Uso**: Retrieval rÃ¡pido, baixa latÃªncia
- **Performance**: Muito rÃ¡pido, qualidade mÃ©dia-alta
- **ColeÃ§Ã£o**: `documentation__mxbai`

### 3. Embedding Gemma (768d)
- **Modelo**: `embeddinggemma:latest`
- **DimensÃµes**: 768
- **Tamanho**: 621 MB
- **Uso**: CompreensÃ£o contextual, busca multilÃ­ngue
- **Performance**: MÃ©dia, qualidade muito alta
- **ColeÃ§Ã£o**: `documentation__gemma`

## Estrutura de ColeÃ§Ãµes

### ConvenÃ§Ã£o de Nomenclatura

```
{source}__{model_short}

Examples:
  - documentation__nomic
  - documentation__mxbai
  - documentation__gemma
  - repository__nomic
```

### ConfiguraÃ§Ã£o (collection-config.json)

```json
{
  "defaultCollection": "documentation__nomic",
  "collections": [
    {
      "name": "documentation__nomic",
      "displayName": "Documentation (Nomic Embed)",
      "embeddingModel": "nomic-embed-text",
      "dimensions": 768,
      "source": "docs/content",
      "enabled": true
    }
  ]
}
```

## Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Dashboard Frontend                        â”‚
â”‚                   (Collection Selector)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Documentation API (Port 3401)                     â”‚
â”‚                                                              â”‚
â”‚  /api/v1/rag/collections     â† List collections             â”‚
â”‚  /api/v1/rag/collections/models â† List embedding models     â”‚
â”‚  /api/v1/rag/search?collection=X â† Query specific collectionâ”‚
â”‚  /api/v1/rag/query            â† Query with LLM              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Qdrant Vector Database (Port 6333)              â”‚
â”‚                                                              â”‚
â”‚  â€¢ documentation__nomic    (nomic-embed-text, 768d)         â”‚
â”‚  â€¢ documentation__mxbai    (mxbai-embed-large, 384d)        â”‚
â”‚  â€¢ documentation__gemma    (embeddinggemma, 768d)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Endpoints da API

### GET /api/v1/rag/collections

Lista todas as coleÃ§Ãµes configuradas e seu status no Qdrant.

**Response**:
```json
{
  "success": true,
  "defaultCollection": "documentation__nomic",
  "collections": [
    {
      "name": "documentation__nomic",
      "displayName": "Documentation (Nomic Embed)",
      "embeddingModel": "nomic-embed-text",
      "dimensions": 768,
      "exists": true,
      "count": 1250,
      "status": "ready"
    }
  ],
  "totalConfigured": 3,
  "totalExisting": 2
}
```

### GET /api/v1/rag/collections/models

Lista modelos de embedding disponÃ­veis no Ollama.

**Response**:
```json
{
  "success": true,
  "models": [
    {
      "name": "nomic-embed-text:latest",
      "size": 274302450,
      "configured": true,
      "dimensions": 768
    }
  ],
  "totalAvailable": 3
}
```

### POST /api/v1/rag/collections/:collectionName/create

Cria uma nova coleÃ§Ã£o no Qdrant.

**Request**:
```json
{
  "embeddingModel": "nomic-embed-text",
  "dimensions": 768
}
```

## Scripts de IngestÃ£o

### IngestÃ£o Multi-ColeÃ§Ã£o

Cria e popula mÃºltiplas coleÃ§Ãµes de uma vez:

```bash
# Ingerir em todas as coleÃ§Ãµes configuradas
bash scripts/rag/ingest-multi-collections.sh

# Ingerir em coleÃ§Ãµes especÃ­ficas
bash scripts/rag/ingest-multi-collections.sh documentation__nomic,documentation__mxbai
```

**Processo**:
1. Verifica se coleÃ§Ã£o existe no Qdrant
2. Cria coleÃ§Ã£o se nÃ£o existir (com dimensÃµes corretas)
3. Aciona ingestÃ£o via LlamaIndex Ingestion Service
4. Monitora progresso e reporta resultados

### IngestÃ£o Manual (via API)

```bash
# Criar coleÃ§Ã£o
curl -X POST http://localhost:3401/api/v1/rag/collections/documentation__gemma/create \
  -H "Content-Type: application/json" \
  -d '{"embeddingModel": "embeddinggemma", "dimensions": 768}'

# Ingerir documentos (via ingestion service)
curl -X POST http://localhost:8201/ingest/directory \
  -H "Content-Type: application/json" \
  -d '{
    "directory_path": "/data/docs",
    "collection_name": "documentation__gemma",
    "embedding_model": "embeddinggemma"
  }'
```

## Queries com ColeÃ§Ã£o EspecÃ­fica

### Busca SemÃ¢ntica

```bash
# Query padrÃ£o (usa defaultCollection)
curl "http://localhost:3401/api/v1/rag/search?query=Docker&max_results=5"

# Query em coleÃ§Ã£o especÃ­fica
curl "http://localhost:3401/api/v1/rag/search?query=Docker&collection=documentation__mxbai"
```

### Query com LLM

```bash
# Query padrÃ£o
curl -X POST http://localhost:3401/api/v1/rag/query \
  -H "Content-Type: application/json" \
  -d '{"query": "What is Docker?", "max_results": 5}'

# Query em coleÃ§Ã£o especÃ­fica
curl -X POST http://localhost:3401/api/v1/rag/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "What is Docker?",
    "max_results": 5,
    "collection": "documentation__gemma"
  }'
```

## ComparaÃ§Ã£o de Modelos

### Benchmark de Qualidade

Para comparar a qualidade de resultados entre modelos:

```bash
# Query na mesma pergunta em todas as coleÃ§Ãµes
for collection in documentation__nomic documentation__mxbai documentation__gemma; do
  echo "Testing $collection..."
  curl -s "http://localhost:3401/api/v1/rag/search?query=Docker&collection=$collection" | jq '.'
  echo "---"
done
```

### MÃ©tricas de Performance

| Modelo | DimensÃµes | Tamanho | Velocidade | Qualidade | MemÃ³ria |
|--------|-----------|---------|------------|-----------|---------|
| **nomic-embed-text** | 768 | 274 MB | âš¡âš¡âš¡ | â­â­â­â­ | ğŸ’¾ |
| **mxbai-embed-large** | 384 | 669 MB | âš¡âš¡âš¡âš¡ | â­â­â­ | ğŸ’¾ |
| **embeddinggemma** | 768 | 621 MB | âš¡âš¡ | â­â­â­â­â­ | ğŸ’¾ğŸ’¾ |

## GestÃ£o de ColeÃ§Ãµes

### Verificar Status

```bash
# Via API Documentation
curl http://localhost:3401/api/v1/rag/collections | jq '.'

# Via Qdrant direto
curl http://localhost:6333/collections | jq '.result.collections'
```

### Deletar ColeÃ§Ã£o

```bash
# Via API Documentation
curl -X POST http://localhost:3401/api/v1/rag/status/delete-collection \
  -H "Content-Type: application/json" \
  -d '{"collection": "documentation__mxbai"}'

# Via Qdrant direto
curl -X DELETE http://localhost:6333/collections/documentation__mxbai
```

### Re-indexar ColeÃ§Ã£o

```bash
# 1. Deletar coleÃ§Ã£o existente
curl -X POST http://localhost:3401/api/v1/rag/status/delete-collection \
  -d '{"collection": "documentation__nomic"}'

# 2. Recriar e ingerir
bash scripts/rag/ingest-multi-collections.sh documentation__nomic
```

## Frontend Integration

### Collection Selector (Future)

O Dashboard terÃ¡ um seletor de coleÃ§Ã£o que permite:

1. Ver todas as coleÃ§Ãµes disponÃ­veis
2. Ver status (ready/empty/not_created)
3. Alternar entre coleÃ§Ãµes para queries
4. Comparar resultados lado-a-lado

## MigraÃ§Ã£o

### De ColeÃ§Ã£o Ãšnica para Multi-ColeÃ§Ã£o

1. **Atualizar variÃ¡veis de ambiente**:
```bash
# .env
QDRANT_COLLECTION=documentation__nomic
OLLAMA_EMBED_MODEL=nomic-embed-text
```

2. **Reiniciar serviÃ§os**:
```bash
docker compose -f tools/compose/docker-compose.rag.yml restart
docker compose -f tools/compose/docker-compose.docs.yml restart documentation-api
```

3. **Criar coleÃ§Ãµes adicionais**:
```bash
bash scripts/rag/ingest-multi-collections.sh
```

## Troubleshooting

### ColeÃ§Ã£o nÃ£o reconhecida

**Problema**: Query retorna "Collection not found"

**SoluÃ§Ã£o**:
```bash
# 1. Verificar se coleÃ§Ã£o existe
curl http://localhost:6333/collections | jq '.result.collections[].name'

# 2. Se nÃ£o existe, criar
bash scripts/rag/ingest-multi-collections.sh documentation__nomic
```

### DimensÃµes incompatÃ­veis

**Problema**: "Vector dimension mismatch"

**SoluÃ§Ã£o**: Certifique-se de que:
- ColeÃ§Ã£o foi criada com dimensÃµes corretas do modelo
- Ingestion service estÃ¡ usando o modelo correto
- NÃ£o hÃ¡ conflito entre modelos diferentes

### Performance lenta

**SoluÃ§Ã£o**:
- Use `documentation__mxbai` (384d) para queries mais rÃ¡pidas
- Use `documentation__nomic` (768d) para equilÃ­brio qualidade/velocidade
- Use `documentation__gemma` (768d) para mÃ¡xima qualidade

## Roadmap

- [ ] Dashboard UI para seleÃ§Ã£o de coleÃ§Ã£o
- [ ] ComparaÃ§Ã£o lado-a-lado de resultados
- [ ] MÃ©tricas de qualidade por coleÃ§Ã£o
- [ ] Auto-seleÃ§Ã£o de melhor coleÃ§Ã£o por tipo de query
- [ ] Suporte para coleÃ§Ãµes de cÃ³digo (repository__)
- [ ] Hybrid search (sparse + dense) multi-coleÃ§Ã£o

## ReferÃªncias

- [Qdrant Collections API](https://qdrant.tech/documentation/concepts/collections/)
- [LlamaIndex Embeddings](https://docs.llamaindex.ai/en/stable/module_guides/models/embeddings/)
- [Ollama Embedding Models](https://ollama.com/blog/embedding-models)

---

**Last Updated**: 2025-10-31  
**Author**: TradingSystem Team  
**Status**: Active

