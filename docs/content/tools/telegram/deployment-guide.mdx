---
title: Telegram Stack - Guia Oficial de Deployment
description: Guia completo para deploy e operaÃ§Ã£o da stack Telegram com monitoramento integrado
tags:
  - telegram
  - deployment
  - docker
  - monitoring
domain: tools
type: guide
summary: Deploy e operaÃ§Ã£o da stack Telegram completa (12 containers) com core services e monitoring integrado
status: active
last_review: "2025-11-11"
---

# Telegram Stack - Guia Oficial de Deployment

**Ãšltima AtualizaÃ§Ã£o:** 2025-11-11
**Status:** âœ… **PRODUÃ‡ÃƒO - OFICIAL**

---

## ğŸ“‹ VisÃ£o Geral

A **Telegram Stack** Ã© uma soluÃ§Ã£o completa para captura, processamento e armazenamento de mensagens do Telegram, com monitoramento integrado.

### Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Telegram Stack (12 containers)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  CORE SERVICES (8 containers)                                â”‚
â”‚  â”œâ”€â”€ TimescaleDB (internal)    - Banco de dados time-series   â”‚
â”‚  â”œâ”€â”€ PgBouncer (internal)      - Connection pooling           â”‚
â”‚  â”œâ”€â”€ Redis Master (internal)   - Cache principal              â”‚
â”‚  â”œâ”€â”€ Redis Replica (internal)  - Read replica                 â”‚
â”‚  â”œâ”€â”€ Redis Sentinel (internal) - HA monitoring                â”‚
â”‚  â”œâ”€â”€ RabbitMQ (5672/15672)     - Message broker               â”‚
â”‚  â”œâ”€â”€ MTProto (14007)           - Telegram client              â”‚
â”‚  â””â”€â”€ Gateway API (Traefik â†’ /api/telegram-gateway) - REST API â”‚
â”‚                                                               â”‚
â”‚  MONITORING SERVICES (4 containers)                          â”‚
â”‚  â”œâ”€â”€ Prometheus (internal)     - Metrics collection           â”‚
â”‚  â”œâ”€â”€ Grafana (internal)        - Visualization                â”‚
â”‚  â”œâ”€â”€ Postgres Exporter (internal) - Database metrics          â”‚
â”‚  â””â”€â”€ Redis Exporter (internal) - Cache metrics                â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Quick Start

### PrÃ©-requisitos

- Docker 24.0+
- Docker Compose 2.20+
- 8GB RAM disponÃ­vel
- 20GB espaÃ§o em disco

### Deploy da Stack Completa

```bash
# 1. Navegar para o diretÃ³rio compose
cd /home/marce/Projetos/TradingSystem/tools/compose

# 2. Verificar variÃ¡veis de ambiente
cat ../../.env | grep TELEGRAM

# 3. Iniciar a stack
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml up -d

# 4. Verificar status
docker ps --filter "label=com.tradingsystem.stack=telegram-gateway"

# 5. Aguardar todos os containers ficarem healthy (1-2 minutos)
watch -n 2 'docker ps --filter "label=com.tradingsystem.stack=telegram-gateway" --format "{{.Names}}: {{.Status}}"'
```

---

## ğŸ“¦ Containers da Stack

### Core Services

#### 1. TimescaleDB (telegram-timescale)
- **Porta:** 5434 (interna), nÃ£o exposta externamente
- **Banco:** `telegram_gateway`
- **UsuÃ¡rio:** `telegram`
- **Health Check:** `pg_isready`
- **Recursos:** 2 CPU, 4GB RAM

**ConexÃ£o:**
```bash
docker exec telegram-timescale psql -U telegram -d telegram_gateway
```

#### 2. PgBouncer (telegram-pgbouncer)
- **Porta:** 6434 (interna), nÃ£o exposta externamente
- **Pool Size:** 50 conexÃµes
- **Health Check:** `pg_isready`
- **Recursos:** 0.5 CPU, 256MB RAM

**Uso:** Connection pooling para reduzir overhead de conexÃµes ao TimescaleDB

#### 3. Redis Master (telegram-redis-master)
- **Porta:** 6379 (interna), nÃ£o exposta externamente
- **PersistÃªncia:** AOF + RDB
- **Health Check:** `redis-cli ping`
- **Recursos:** 0.5 CPU, 512MB RAM

**Teste:**
```bash
docker exec telegram-redis-master redis-cli ping
# PONG
```

#### 4. Redis Replica (telegram-redis-replica)
- **Porta:** 6385 (interna)
- **Modo:** Read-only replica
- **Health Check:** `redis-cli ping`
- **Recursos:** 0.5 CPU, 512MB RAM

#### 5. Redis Sentinel (telegram-redis-sentinel)
- **Porta:** 26379 (interna)
- **FunÃ§Ã£o:** HA monitoring e failover automÃ¡tico
- **Health Check:** `redis-cli -p 26379 ping`
- **Recursos:** 0.25 CPU, 128MB RAM

#### 6. RabbitMQ (telegram-rabbitmq)
- **Porta AMQP:** 5672 (interna)
- **Porta Admin:** 15672 (http://localhost:15672)
- **Credenciais:** `telegram` / `${TELEGRAM_RABBITMQ_PASSWORD}`
- **Health Check:** `rabbitmq-diagnostics ping`
- **Recursos:** 1 CPU, 1GB RAM

**Admin UI:** http://localhost:15672

#### 7. MTProto (telegram-mtproto)
- **Porta Externa:** 14007
- **Porta Interna:** 4007
- **Protocolo:** HTTP + WebSocket
- **Health Check:** `wget http://localhost:4007/health`
- **Recursos:** 1 CPU, 1GB RAM

**API:**
```bash
# Health check (via exposiÃ§Ã£o direta MTProto)
curl http://localhost:14007/health

# Sincronizar mensagens diretamente no MTProto
curl -X POST http://localhost:14007/sync-messages \
  -H "Content-Type: application/json" \
  -d '{"limit": 1000}'
```

#### 8. Gateway API (telegram-gateway-api)
- **ExposiÃ§Ã£o:** Traefik â†’ `http://localhost:9080/api/telegram-gateway`
- **Porta Interna:** 4010
- **Protocolo:** HTTP REST
- **Health Check:** `wget http://localhost:4010/health`
- **Recursos:** 1 CPU, 1GB RAM

**Endpoints (via Traefik):**
```bash
# Listar canais
curl http://localhost:9080/api/telegram-gateway/channels | jq '.data'

# Listar mensagens (exemplo com limite)
curl "http://localhost:9080/api/telegram-gateway/messages?limit=50"

# Sincronizar mensagens
token="${TELEGRAM_GATEWAY_API_TOKEN}"
curl -X POST http://localhost:9080/api/telegram-gateway/sync-messages \
  -H "Content-Type: application/json" \
  -H "X-API-Key: ${token}" \
  -d '{"limit": 1000}'
```

### Monitoring Services

#### 9. Prometheus (telegram-prometheus)
- **ExposiÃ§Ã£o:** Interna (sem porta publicada)
- **RetenÃ§Ã£o:** 30 dias
- **Scrape Interval:** 15s
- **Health Check:** `wget http://localhost:9090/-/healthy`
- **Recursos:** 1 CPU, 1GB RAM

**Acesso:**
```bash
# Abrir shell interativo e usar port-forward temporÃ¡rio
docker compose -f tools/compose/docker-compose.4-2-telegram-stack-minimal-ports.yml \
  exec telegram-prometheus /bin/sh
# Opcional: docker compose port telegram-prometheus 9090
```

**ConfiguraÃ§Ã£o:**
- `tools/compose/telegram/monitoring/prometheus.yml`
- `tools/compose/telegram/monitoring/alerts/telegram-alerts.yml`

#### 10. Grafana (telegram-grafana)
- **ExposiÃ§Ã£o:** Interna (sem porta publicada). Planeje publicar via Traefik quando necessÃ¡rio.
- **Porta Interna:** 3000
- **Credenciais:** `admin` / `admin` (trocar no primeiro login)
- **Health Check:** HTTP 200 em `/api/health`
- **Recursos:** 0.5 CPU, 512MB RAM

**Acesso temporÃ¡rio:**
```bash
docker compose -f tools/compose/docker-compose.4-2-telegram-stack-minimal-ports.yml \
  port telegram-grafana 3000
```

**Plugins:**
- `redis-datasource`
- `marcusolsson-json-datasource`

**Data Sources Provisionados:**
- Telegram Prometheus (http://telegram-prometheus:9090)
- Telegram TimescaleDB (telegram-timescale:5432)

#### 11. Postgres Exporter (telegram-postgres-exporter)
- **ExposiÃ§Ã£o:** Interna (sem porta publicada)
- **Target:** `telegram-timescale:5432/telegram_gateway`
- **Health Check:** Metrics endpoint
- **Recursos:** 0.25 CPU, 128MB RAM

**Dica:** utilize Prometheus para consumir as mÃ©tricas via rede interna.

**MÃ©tricas Exportadas:**
- `pg_up` - Database status
- `pg_stat_database_*` - Database statistics
- `pg_locks_*` - Lock statistics
- `pg_database_size_bytes` - Database size

#### 12. Redis Exporter (telegram-redis-exporter)
- **ExposiÃ§Ã£o:** Interna (sem porta publicada)
- **Target:** `telegram-redis-master:6379`
- **Health Check:** Metrics endpoint
- **Recursos:** 0.25 CPU, 128MB RAM

**MÃ©tricas Exportadas:**
- `redis_up` - Redis status
- `redis_connected_clients` - Client connections
- `redis_used_memory_bytes` - Memory usage
- `redis_commands_total` - Commands processed

---

## ğŸ”§ ConfiguraÃ§Ã£o

### VariÃ¡veis de Ambiente ObrigatÃ³rias

```bash
# .env file
TELEGRAM_DB_PASSWORD=secure_password_here
TELEGRAM_RABBITMQ_PASSWORD=rabbitmq_password_here
TELEGRAM_GATEWAY_API_KEY=gw_secret_9K7j2mPq8nXwR5tY4vL1zD3fH6bN0sA
TELEGRAM_MTPROTO_API_KEY=mtproto_secret_key_here

# Portas (opcional)
TELEGRAM_MTPROTO_PORT=14007  # Ãšnico serviÃ§o com porta externa direta
# Demais serviÃ§os HTTP sÃ£o expostos via Traefik (http://localhost:9080/*)
```

### Volumes

A stack cria os seguintes volumes Docker:

```bash
telegram-timescale-data      # TimescaleDB data
telegram-redis-data          # Redis master data
telegram-redis-replica-data  # Redis replica data
telegram-rabbitmq-data       # RabbitMQ data
telegram-prometheus-data     # Prometheus metrics
telegram-grafana-data        # Grafana dashboards
```

**Backup dos volumes:**
```bash
# Listar volumes
docker volume ls | grep telegram

# Backup de um volume especÃ­fico
docker run --rm -v telegram-timescale-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/telegram-timescale-backup-$(date +%Y%m%d).tar.gz /data
```

---

## ğŸ” VerificaÃ§Ã£o de SaÃºde

### Health Check Completo

```bash
# Script de verificaÃ§Ã£o
bash << 'EOF'
echo "ğŸ” Telegram Stack - Health Check"
echo ""

# Core Services
echo "ğŸ“¦ CORE SERVICES"
for service in telegram-timescale telegram-pgbouncer telegram-redis-master \
               telegram-redis-replica telegram-redis-sentinel telegram-rabbitmq \
               telegram-mtproto telegram-gateway-api; do
  status=$(docker inspect -f '{{.State.Health.Status}}' $service 2>/dev/null || echo "not running")
  echo "  $service: $status"
done

echo ""
echo "ğŸ“Š MONITORING SERVICES"
for service in telegram-prometheus telegram-grafana telegram-postgres-exporter \
               telegram-redis-exporter; do
  status=$(docker inspect -f '{{.State.Health.Status}}' $service 2>/dev/null || echo "not running")
  echo "  $service: $status"
done

echo ""
echo "ğŸŒ ENDPOINTS"
curl -s http://localhost:14007/health > /dev/null && echo "  âœ… MTProto: http://localhost:14007" || echo "  âŒ MTProto: DOWN"
curl -s http://localhost:9080/api/telegram-gateway/health > /dev/null && echo "  âœ… Gateway API (Traefik): http://localhost:9080/api/telegram-gateway" || echo "  âŒ Gateway API: DOWN"
echo "  â„¹ï¸ Prometheus, Grafana e exporters estÃ£o disponÃ­veis apenas na rede interna (use 'docker compose port' ou Traefik quando configurado)"
EOF
```

### VerificaÃ§Ã£o Individual

**TimescaleDB:**
```bash
docker exec telegram-timescale pg_isready -U telegram
# /var/run/postgresql:5432 - accepting connections
```

**Redis:**
```bash
docker exec telegram-redis-master redis-cli ping
# PONG
```

**RabbitMQ:**
```bash
docker exec telegram-rabbitmq rabbitmq-diagnostics ping
# Ping succeeded
```

**MTProto:**
```bash
curl http://localhost:14007/health | jq
# {"status": "healthy", "timestamp": "2025-11-11T..."}
```

**Gateway API:**
```bash
curl http://localhost:9080/api/telegram-gateway/health | jq
# {"status": "healthy", "services": {...}}
```

**Prometheus (acesso interno):**
```bash
# Expor temporariamente
PORT=$(docker compose -f tools/compose/docker-compose.4-2-telegram-stack-minimal-ports.yml port telegram-prometheus 9090 | cut -d':' -f2)
curl http://localhost:${PORT}/-/healthy
```

**Grafana (acesso interno):**
```bash
PORT=$(docker compose -f tools/compose/docker-compose.4-2-telegram-stack-minimal-ports.yml port telegram-grafana 3000 | cut -d':' -f2)
curl http://localhost:${PORT}/api/health | jq
```

---

## ğŸ“Š Monitoramento

### Acessar Grafana

1. Abra http://localhost:3100
2. Login: `admin` / `admin`
3. Troque a senha no primeiro acesso
4. Navegue para **Data Sources** â†’ Verificar conexÃµes

### Criar Dashboard Personalizado

**Query Prometheus:**
```promql
# Uso de memÃ³ria do Redis
redis_used_memory_bytes{job="telegram-redis"}

# Tamanho do banco de dados
pg_database_size_bytes{datname="telegram_gateway"}

# ConexÃµes ativas
pg_stat_database_numbackends{datname="telegram_gateway"}

# Taxa de mensagens processadas
rate(telegram_messages_processed_total[5m])
```

### Alertas Configurados

**Arquivo:** `tools/compose/telegram/monitoring/alerts/telegram-alerts.yml`

**Alertas ativos:**
- Database down (pg_up == 0)
- Redis down (redis_up == 0)
- High memory usage (> 90%)
- High database connections (> 80% do limite)
- Slow query performance

---

## ğŸ”„ OperaÃ§Ãµes

### Restart da Stack

```bash
# Restart graceful
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml restart

# Restart especÃ­fico de um serviÃ§o
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml restart telegram-mtproto
```

### Stop da Stack

```bash
# Stop graceful
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml stop

# Stop forÃ§ado (SIGKILL)
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml kill
```

### Update de Imagens

```bash
# Pull de novas imagens
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml pull

# Rebuild e restart
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml up -d --build
```

### Logs

```bash
# Logs de todos os containers
docker compose -f docker-compose.4-2-telegram-stack-minimal-ports.yml logs -f

# Logs de um serviÃ§o especÃ­fico
docker logs -f telegram-mtproto

# Ãšltimas 100 linhas
docker logs --tail 100 telegram-gateway-api

# Logs com timestamp
docker logs -t telegram-timescale
```

### Backup

```bash
# Backup do TimescaleDB
docker exec telegram-timescale pg_dump -U telegram telegram_gateway > backup-$(date +%Y%m%d).sql

# Backup compactado
docker exec telegram-timescale pg_dump -U telegram telegram_gateway | gzip > backup-$(date +%Y%m%d).sql.gz

# Backup de um volume
docker run --rm -v telegram-timescale-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/timescale-backup-$(date +%Y%m%d).tar.gz /data
```

### Restore

```bash
# Restore do TimescaleDB
cat backup-20251111.sql | docker exec -i telegram-timescale psql -U telegram telegram_gateway

# Restore compactado
gunzip -c backup-20251111.sql.gz | docker exec -i telegram-timescale psql -U telegram telegram_gateway
```

---

## ğŸš¨ Troubleshooting

### Container nÃ£o inicia

```bash
# Verificar logs de erro
docker logs telegram-mtproto 2>&1 | grep -i error

# Verificar variÃ¡veis de ambiente
docker exec telegram-mtproto env | grep TELEGRAM

# Verificar health check
docker inspect telegram-mtproto | jq '.[0].State.Health'
```

### Erro de conexÃ£o entre containers

```bash
# Testar conectividade (exemplo: Gateway API â†’ MTProto)
docker exec telegram-gateway-api curl -I http://telegram-mtproto:4007/health

# Verificar rede Docker
docker network inspect telegram_backend
```

### Banco de dados nÃ£o responde

```bash
# Verificar conexÃµes ativas
docker exec telegram-timescale psql -U telegram -d telegram_gateway -c \
  "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"

# Verificar locks
docker exec telegram-timescale psql -U telegram -d telegram_gateway -c \
  "SELECT * FROM pg_locks WHERE NOT granted;"

# Reiniciar PgBouncer (resolve a maioria dos problemas)
docker restart telegram-pgbouncer
```

### Redis lento

```bash
# Verificar latÃªncia
docker exec telegram-redis-master redis-cli --latency

# Verificar memÃ³ria
docker exec telegram-redis-master redis-cli INFO memory

# Limpar cache (cuidado em produÃ§Ã£o!)
docker exec telegram-redis-master redis-cli FLUSHDB
```

### Prometheus nÃ£o coleta mÃ©tricas

```bash
# Verificar targets
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'

# Verificar config
docker exec telegram-prometheus cat /etc/prometheus/prometheus.yml

# Reload config sem restart
docker exec telegram-prometheus kill -HUP 1
```

---

## ğŸ“š DocumentaÃ§Ã£o Relacionada

- **[Telegram Issues Summary](../../../TELEGRAM-ISSUES-SUMMARY.md)** - Problemas conhecidos e soluÃ§Ãµes
- **[Telegram Channels Names Issue](../../../docs/TELEGRAM-CHANNELS-NAMES-ISSUE.md)** - Problema de nomes genÃ©ricos
- **[Telegram Sync Button Timeout](../../../docs/TELEGRAM-SYNC-BUTTON-TIMEOUT.md)** - Timeout do botÃ£o de sync
- **[Telegram Monitoring Integration](../../../docs/TELEGRAM-MONITORING-INTEGRATION.md)** - Detalhes da integraÃ§Ã£o de monitoramento
- **[Port Allocation](../ports-services.mdx)** - Registro de portas do sistema

---

## ğŸ”’ SeguranÃ§a

### Minimal Port Exposure

A stack usa **minimal port exposure** para seguranÃ§a:

- âœ… **Apenas portas essenciais expostas** (MTProto direto: 14007; Gateway API via Traefik em 9080)
- âœ… **Portas internas nÃ£o expostas** (TimescaleDB, Redis, PgBouncer, Prometheus, Grafana, exporters)
- âœ… **ComunicaÃ§Ã£o via Docker network** (telegram_backend)
- âœ… **Secrets via variÃ¡veis de ambiente** (nunca hardcoded)

### RecomendaÃ§Ãµes

1. **Troque senhas default**
   ```bash
   # Gerar senha segura
   openssl rand -base64 32
   ```

2. **Use firewall para portas expostas**
   ```bash
   # Exemplo com ufw
   sudo ufw allow from 192.168.0.0/24 to any port 14007    # MTProto
   sudo ufw allow from 192.168.0.0/24 to any port 9080     # Traefik (Gateway API compartilhada)
   ```

3. **Habilite TLS/SSL** (future)
   - MTProto: TLS termination com Traefik
   - Gateway API: HTTPS com certificado vÃ¡lido

4. **Rotacione credenciais periodicamente**
   - TimescaleDB: A cada 90 dias
   - RabbitMQ: A cada 90 dias
   - API Keys: A cada 30 dias

---

## ğŸ“ˆ Escalabilidade

### Scaling Horizontal

**Redis Cluster:**
```yaml
# Adicionar mais replicas
telegram-redis-replica-2:
  image: redis:7-alpine
  command: redis-server --replicaof telegram-redis-master 6379
```

**MTProto Workers:**
```yaml
# Adicionar workers MTProto
telegram-mtproto-worker-2:
  image: telegram-mtproto:latest
  environment:
    - WORKER_ID=2
```

### Scaling Vertical

**Aumentar recursos:**
```yaml
telegram-timescale:
  deploy:
    resources:
      limits:
        cpus: '4.0'      # 2 â†’ 4 CPUs
        memory: 8G       # 4G â†’ 8G RAM
```

---

## âœ… Checklist de Deployment

- [ ] VariÃ¡veis de ambiente configuradas
- [ ] Volumes criados
- [ ] Firewall configurado
- [ ] Senhas trocadas
- [ ] Stack iniciada
- [ ] Health checks passando
- [ ] Prometheus coletando mÃ©tricas
- [ ] Grafana acessÃ­vel
- [ ] Backup configurado
- [ ] Alertas testados
- [ ] DocumentaÃ§Ã£o atualizada

---

**Ãšltima AtualizaÃ§Ã£o:** 2025-11-11 15:00 BRT
**PrÃ³xima RevisÃ£o:** ApÃ³s 30 dias de operaÃ§Ã£o em produÃ§Ã£o
