---
title: Dev Container - Gateway & Proxy
sidebar_label: Gateway & Proxy
sidebar_position: 4
tags: [dev-container, traefik, vite, proxy, gateway, routing]
domain: tools
type: guide
summary: "Guia completo do Traefik API Gateway e Vite Proxy: service discovery, routing rules, middlewares, debugging e troubleshooting"
status: active
last_review: "2025-11-12"
---

# Dev Container - Gateway & Proxy

## ğŸ¯ VisÃ£o Geral

O TradingSystem usa **dois sistemas de proxy**:

1. **Traefik API Gateway** - Reverse proxy para produÃ§Ã£o (containers Docker)
2. **Vite Dev Server Proxy** - Proxy de desenvolvimento (hot reload)

Cada um tem **propÃ³sitos e configuraÃ§Ãµes especÃ­ficas**.

---

## ğŸšª Traefik API Gateway

### O que Ã© Traefik?

**Traefik** Ã© um **reverse proxy e load balancer** moderno que:
- âœ… Descobre serviÃ§os automaticamente (Docker labels)
- âœ… Roteia requests baseado em rules (path, host, headers)
- âœ… Aplica middlewares (CORS, rate limit, compression, circuit breaker)
- âœ… ExpÃµe mÃ©tricas Prometheus
- âœ… Possui dashboard de monitoramento
- âœ… Suporta mÃºltiplos backends (Docker, Kubernetes, Consul, etc)

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser (http://localhost:9082)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Traefik Gateway (Port 9082)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Entrypoint: web (9080 internal, 9082 external)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Routers (priority-based)                         â”‚ â”‚
â”‚  â”‚  â”œâ”€> /api/workspace â†’ Priority 100                â”‚ â”‚
â”‚  â”‚  â”œâ”€> /api/telegram-gateway â†’ Priority 95          â”‚ â”‚
â”‚  â”‚  â”œâ”€> /api/tp-capital â†’ Priority 90                â”‚ â”‚
â”‚  â”‚  â”œâ”€> /api/docs â†’ Priority 85                      â”‚ â”‚
â”‚  â”‚  â”œâ”€> /docs â†’ Priority 50                          â”‚ â”‚
â”‚  â”‚  â””â”€> / â†’ Priority 1                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Middlewares Chain                                â”‚ â”‚
â”‚  â”‚  â”œâ”€> CORS (localhost:5173, localhost:9082)        â”‚ â”‚
â”‚  â”‚  â”œâ”€> Rate Limit (100 req/min per IP)              â”‚ â”‚
â”‚  â”‚  â”œâ”€> Compression (gzip/brotli, >1KB)              â”‚ â”‚
â”‚  â”‚  â”œâ”€> Circuit Breaker (20% error â†’ open)           â”‚ â”‚
â”‚  â”‚  â””â”€> Security Headers (X-Frame-Options, XSS)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Services (Docker containers)                     â”‚ â”‚
â”‚  â”‚  â”œâ”€> workspace-api:3200                           â”‚ â”‚
â”‚  â”‚  â”œâ”€> telegram-gateway-api:4010                    â”‚ â”‚
â”‚  â”‚  â”œâ”€> tp-capital-api:4005                          â”‚ â”‚
â”‚  â”‚  â”œâ”€> documentation-api:3000                       â”‚ â”‚
â”‚  â”‚  â”œâ”€> dashboard-ui:3103                            â”‚ â”‚
â”‚  â”‚  â””â”€> docs-hub:80                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration Files

**Traefik Gateway Compose:**
- **File:** `tools/compose/docker-compose.0-gateway-stack.yml`
- **Container:** `api-gateway` (Traefik v3.0)
- **Ports:** 9082 (HTTP), 9083 (Dashboard)

**Dynamic Configuration:**
- **File:** `tools/traefik/dynamic/middlewares.yml`
- **Purpose:** CORS, rate limiting, compression rules

### Service Discovery (Docker Labels)

Traefik usa **Docker labels** para descobrir serviÃ§os automaticamente.

**Exemplo: Workspace API**
```yaml
# tools/compose/docker-compose.4-3-workspace-stack.yml
services:
  workspace-api:
    container_name: workspace-api
    build: ./backend/api/workspace
    networks:
      - tradingsystem_backend
    labels:
      # Enable Traefik
      - "traefik.enable=true"

      # Router configuration
      - "traefik.http.routers.workspace.rule=PathPrefix(`/api/workspace`)"
      - "traefik.http.routers.workspace.priority=100"
      - "traefik.http.routers.workspace.entrypoints=web"

      # Service configuration (load balancer)
      - "traefik.http.services.workspace.loadbalancer.server.port=3200"

      # Middlewares (optional)
      - "traefik.http.routers.workspace.middlewares=api-standard@file"

      # Path transformation (optional)
      - "traefik.http.middlewares.workspace-path-transform.stripprefix.prefixes=/api/workspace"
```

**Label Breakdown:**

| Label | PropÃ³sito | Valor Exemplo |
|-------|-----------|---------------|
| `traefik.enable` | Habilita discovery | `true` |
| `traefik.http.routers.<name>.rule` | Routing rule | `PathPrefix(\`/api/workspace\`)` |
| `traefik.http.routers.<name>.priority` | Priority (higher wins) | `100` |
| `traefik.http.routers.<name>.entrypoints` | Entrypoint | `web` |
| `traefik.http.services.<name>.loadbalancer.server.port` | Container port | `3200` |
| `traefik.http.routers.<name>.middlewares` | Middleware chain | `api-standard@file` |

### Routing Rules

**PathPrefix (Recomendado para APIs):**
```yaml
- "traefik.http.routers.workspace.rule=PathPrefix(`/api/workspace`)"
```

Matches:
- âœ… `/api/workspace/items`
- âœ… `/api/workspace/items/123`
- âœ… `/api/workspace/health`
- âŒ `/api/workspace-extra` (nÃ£o comeÃ§a com `/api/workspace/`)

**Host (Para mÃºltiplos domÃ­nios):**
```yaml
- "traefik.http.routers.api.rule=Host(`api.tradingsystem.local`)"
```

**Combined Rules (AND/OR logic):**
```yaml
# AND logic
- "traefik.http.routers.api.rule=Host(`api.local`) && PathPrefix(`/v1`)"

# OR logic
- "traefik.http.routers.api.rule=PathPrefix(`/api`) || PathPrefix(`/v1`)"
```

### Priority System

**Como funciona:**
- Traefik avalia routers em **ordem decrescente de priority**
- **Maior nÃºmero** = **maior prioridade**
- Se request match mÃºltiplas rules, usa a de maior prioridade

**TradingSystem Priority Allocation:**

| Service | Priority | Rule | Rationale |
|---------|----------|------|-----------|
| Workspace API | 100 | `/api/workspace` | Specific path, high priority |
| Telegram Gateway | 95 | `/api/telegram-gateway` | Specific path |
| TP Capital API | 90 | `/api/tp-capital` | Specific path |
| Documentation API | 85 | `/api/docs` | Specific path |
| Docs Hub | 50 | `/docs` | Specific path, lower than APIs |
| Dashboard UI | 1 | `/` | Catch-all, lowest priority |

**Por que essa ordem?**
- âœ… Rotas especÃ­ficas (`/api/workspace`) antes de genÃ©ricas (`/`)
- âœ… APIs (100-85) antes de UIs (50-1)
- âœ… Catch-all (`/`) por Ãºltimo (default route)

### Path Rewriting

**Problema:**
```
Browser â†’ http://localhost:9082/api/workspace/items
Traefik (sem rewrite) â†’ workspace-api:3200/api/workspace/items
Workspace API expects â†’ workspace-api:3200/api/items
Result: 404 Not Found
```

**Solution 1: StripPrefix Middleware**
```yaml
labels:
  - "traefik.http.middlewares.workspace-strip.stripprefix.prefixes=/api/workspace"
  - "traefik.http.routers.workspace.middlewares=workspace-strip"
```

**Result:**
```
Browser â†’ /api/workspace/items
Traefik (stripprefix) â†’ /items
Workspace API â†’ Handles /items correctly
```

**Solution 2: API Design (No Rewrite Needed)**
```javascript
// Workspace API routes
app.get('/api/workspace/items', ...);
app.get('/api/workspace/items/:id', ...);
```

**TradingSystem usa Solution 2** (API handles full path).

### Middlewares

**File:** `tools/traefik/dynamic/middlewares.yml`

#### CORS Middleware
```yaml
http:
  middlewares:
    cors-headers:
      headers:
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowOriginList:
          - "http://localhost:5173"  # Vite Dev Server
          - "http://localhost:9082"  # Production Dashboard
          - "http://localhost:8092"  # Dashboard Direct Access
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-API-Key"
          - "X-Requested-With"
        accessControlAllowCredentials: true
        accessControlMaxAge: 100
```

**AplicaÃ§Ã£o:**
```yaml
labels:
  - "traefik.http.routers.workspace.middlewares=cors-headers@file"
```

#### Rate Limiting
```yaml
http:
  middlewares:
    rate-limit:
      rateLimit:
        average: 100        # 100 requests per minute
        period: "1m"
        burst: 50           # Allow bursts up to 50
        sourceCriterion:
          ipStrategy:
            depth: 1        # Use first IP in X-Forwarded-For
```

**Purpose:**
- âœ… Protege contra DDoS
- âœ… Evita abuse de API
- âœ… Garante fair usage

#### Compression
```yaml
http:
  middlewares:
    compress:
      compress:
        excludedContentTypes:
          - "text/event-stream"  # SSE streams
          - "application/grpc"   # gRPC
        minResponseBodyBytes: 1024  # Only compress >1KB
```

**Algoritmos suportados:**
- gzip (default)
- brotli (se cliente suporta)

#### Circuit Breaker
```yaml
http:
  middlewares:
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.20"  # Open if >20% errors
        checkPeriod: "10s"
        fallbackDuration: "30s"
        recoveryDuration: "10s"
```

**States:**
1. **Closed** - Normal operation (requests passam)
2. **Open** - Muitos erros (requests rejeitados imediatamente)
3. **Half-Open** - Testing recovery (alguns requests passam)

**Use case:**
- âœ… API backend estÃ¡ down â†’ Circuit breaker abre
- âœ… Requests retornam 503 Service Unavailable (rÃ¡pido)
- âœ… Evita sobrecarregar API jÃ¡ problemÃ¡tica

#### Security Headers
```yaml
http:
  middlewares:
    security-headers:
      headers:
        frameDeny: true                     # X-Frame-Options: DENY
        contentTypeNosniff: true            # X-Content-Type-Options: nosniff
        browserXssFilter: true              # X-XSS-Protection: 1; mode=block
        stsSeconds: 31536000                # Strict-Transport-Security (HTTPS only)
        stsIncludeSubdomains: true
        referrerPolicy: "strict-origin-when-cross-origin"
```

#### Middleware Chain
```yaml
http:
  middlewares:
    api-standard:
      chain:
        middlewares:
          - "cors-headers"
          - "rate-limit"
          - "compress"
          - "circuit-breaker"
          - "security-headers"
```

**AplicaÃ§Ã£o:**
```yaml
labels:
  - "traefik.http.routers.workspace.middlewares=api-standard@file"
```

**Ordem de execuÃ§Ã£o:**
```
Request â†’ CORS â†’ Rate Limit â†’ Compress â†’ Circuit Breaker â†’ Security Headers â†’ Backend
```

### Health Checks

**Traefik auto-detecta health de serviÃ§os:**

**ConfiguraÃ§Ã£o (Workspace API):**
```yaml
services:
  workspace-api:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3200/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
```

**Traefik behavior:**
- âœ… Se health check **passa** â†’ Roteie requests
- âŒ Se health check **falha** â†’ Marque como unhealthy (nÃ£o roteia)
- âš ï¸ Se **todos backends unhealthy** â†’ 503 Service Unavailable

**Dashboard:** http://localhost:9083/dashboard/ mostra health status de todos os serviÃ§os.

### Traefik Dashboard

**Access:** http://localhost:9083/dashboard/

**Features:**
- âœ… Visualizar routers (rules, priorities, middlewares)
- âœ… Visualizar services (backends, health status)
- âœ… Visualizar middlewares (configuraÃ§Ãµes)
- âœ… Visualizar entrypoints (portas expostas)
- âœ… MÃ©tricas em tempo real (requests/s, errors/s)
- âœ… Access logs (last 100 requests)

**Debugging workflow:**
1. Abrir dashboard
2. HTTP â†’ Routers â†’ Encontrar seu router
3. Verificar rule, priority, middlewares
4. Clicar em Service â†’ Ver health status
5. Verificar se requests estÃ£o chegando (metrics)

---

## âš¡ Vite Dev Server Proxy

### O que Ã© Vite Proxy?

**Vite** possui um **built-in development proxy** que:
- âœ… Intercepta requests no dev server
- âœ… Forwards para backend services
- âœ… MantÃ©m hot reload funcionando
- âœ… Evita CORS issues (same-origin)
- âœ… Permite usar paths relativos no cÃ³digo

### Configuration

**File:** `frontend/dashboard/vite.config.ts`

```typescript
import { defineConfig } from 'vite';

export default defineConfig({
  server: {
    port: 5173,
    host: true, // Allow external access (from host)
    proxy: {
      // Workspace API
      '/api/workspace': {
        target: process.env.WORKSPACE_PROXY_TARGET || 'http://workspace-api:3200',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/workspace/, '/api'),
        configure: (proxy, options) => {
          proxy.on('proxyReq', (proxyReq, req, res) => {
            console.log(`[Vite Proxy] ${req.method} ${req.url} â†’ ${options.target}${proxyReq.path}`);
          });
        }
      },

      // TP Capital API
      '/api/tp-capital': {
        target: process.env.TP_CAPITAL_PROXY_TARGET || 'http://tp-capital-api:4005',
        changeOrigin: true,
      },

      // Telegram Gateway API
      '/api/telegram-gateway': {
        target: process.env.TELEGRAM_GATEWAY_PROXY_TARGET || 'http://telegram-gateway-api:4010',
        changeOrigin: true,
      },

      // Documentation API
      '/api/docs': {
        target: process.env.DOCUMENTATION_PROXY_TARGET || 'http://documentation-api:3000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/docs/, '/api'),
      },

      // Docs Hub
      '/docs': {
        target: 'http://docs-hub:80',
        changeOrigin: true,
      }
    }
  }
});
```

### Proxy Options

| Option | Type | Purpose | Example |
|--------|------|---------|---------|
| `target` | string | Backend URL | `http://workspace-api:3200` |
| `changeOrigin` | boolean | Change `Host` header | `true` |
| `rewrite` | function | Path transformation | `path.replace(...)` |
| `configure` | function | Proxy event handlers | Logging, headers |
| `secure` | boolean | Verify SSL certs | `false` (dev) |
| `ws` | boolean | Proxy WebSocket | `true` |
| `headers` | object | Add/override headers | `{'X-Custom': 'value'}` |

### Environment Variables (.env)

**CRITICAL RULE: NO `VITE_` PREFIX FOR PROXY TARGETS!**

```bash
# âŒ WRONG - Exposed to browser (security risk)
VITE_WORKSPACE_PROXY_TARGET=http://workspace-api:3200
VITE_TP_CAPITAL_PROXY_TARGET=http://tp-capital-api:4005

# âœ… CORRECT - Server-side only (not exposed)
WORKSPACE_PROXY_TARGET=http://workspace-api:3200
TP_CAPITAL_PROXY_TARGET=http://tp-capital-api:4005
TELEGRAM_GATEWAY_PROXY_TARGET=http://telegram-gateway-api:4010
DOCUMENTATION_PROXY_TARGET=http://documentation-api:3000

# âœ… OK - Safe to expose (browser uses this)
VITE_API_BASE_URL=http://localhost:9082
VITE_ENVIRONMENT=development
```

**Why no `VITE_` prefix?**
- âŒ Vite expÃµe `VITE_*` variables ao browser bundle
- âŒ Browser tenta conectar em `http://workspace-api:3200` (falha)
- âŒ Revela topologia interna da rede
- âœ… Server-side variables ficam apenas no Vite dev server

### Path Rewriting

**Example 1: Workspace API**

```
Browser â†’ http://localhost:5173/api/workspace/items
         â†“
Vite Proxy detects: /api/workspace
         â†“
Rewrite: /api/workspace/items â†’ /api/items
         â†“
Forward to: http://workspace-api:3200/api/items
         â†“
Backend handles /api/items
```

**Config:**
```typescript
'/api/workspace': {
  target: 'http://workspace-api:3200',
  rewrite: (path) => path.replace(/^\/api\/workspace/, '/api')
}
```

**Example 2: TP Capital API (No Rewrite)**

```
Browser â†’ http://localhost:5173/api/tp-capital/signals
         â†“
Vite Proxy detects: /api/tp-capital
         â†“
NO rewrite (API handles full path)
         â†“
Forward to: http://tp-capital-api:4005/api/tp-capital/signals
         â†“
Backend handles /api/tp-capital/signals
```

**Config:**
```typescript
'/api/tp-capital': {
  target: 'http://tp-capital-api:4005',
  // NO rewrite - API expects /api/tp-capital/* path
}
```

### Logging Proxy Requests

**Configure logger:**
```typescript
proxy: {
  '/api/workspace': {
    target: 'http://workspace-api:3200',
    configure: (proxy, options) => {
      proxy.on('proxyReq', (proxyReq, req, res) => {
        const originalUrl = req.url;
        const targetUrl = `${options.target}${proxyReq.path}`;
        console.log(`[Vite Proxy] ${req.method} ${originalUrl} â†’ ${targetUrl}`);
      });

      proxy.on('proxyRes', (proxyRes, req, res) => {
        console.log(`[Vite Proxy] Response ${proxyRes.statusCode} for ${req.url}`);
      });

      proxy.on('error', (err, req, res) => {
        console.error(`[Vite Proxy] Error for ${req.url}:`, err.message);
      });
    }
  }
}
```

**Output:**
```
[Vite Proxy] GET /api/workspace/items â†’ http://workspace-api:3200/api/items
[Vite Proxy] Response 200 for /api/workspace/items
```

### WebSocket Proxy

**Enable WS proxying:**
```typescript
'/api/websocket': {
  target: 'ws://websocket-server:8080',
  ws: true,  // Enable WebSocket proxy
  changeOrigin: true,
}
```

**Browser code:**
```typescript
const ws = new WebSocket('ws://localhost:5173/api/websocket');
// Vite proxies to ws://websocket-server:8080
```

---

## ğŸ” Debugging

### Traefik Gateway Debugging

#### 1. Check Dashboard
```
URL: http://localhost:9083/dashboard/
Steps:
1. HTTP â†’ Routers â†’ Find your router
2. Verify rule, priority, middlewares
3. Click Service â†’ Check health status
4. HTTP â†’ Services â†’ See backend servers
```

#### 2. Check Logs
```bash
# Real-time logs
docker logs -f api-gateway

# Filter for specific service
docker logs api-gateway 2>&1 | grep workspace

# Filter errors only
docker logs api-gateway 2>&1 | grep -i error
```

#### 3. Check Container Networks
```bash
# Gateway must be in service networks
docker network inspect tradingsystem_backend | grep -A 5 api-gateway
docker network inspect tradingsystem_frontend | grep -A 5 api-gateway
```

#### 4. Validate Service Labels
```bash
# Check Workspace API labels
docker inspect workspace-api | jq '.[0].Config.Labels'

# Expected:
# "traefik.enable": "true"
# "traefik.http.routers.workspace.rule": "PathPrefix(`/api/workspace`)"
# "traefik.http.routers.workspace.priority": "100"
```

#### 5. Test Routing Manually
```bash
# Via Gateway
curl -i http://localhost:9082/api/workspace/health

# Expected:
# HTTP/1.1 200 OK
# Access-Control-Allow-Origin: http://localhost:5173
# Content-Encoding: gzip
# X-Frame-Options: DENY
```

#### 6. Check Middleware Application
```bash
# Check CORS headers
curl -i http://localhost:9082/api/workspace/items \
  -H "Origin: http://localhost:5173"

# Expected:
# Access-Control-Allow-Origin: http://localhost:5173
# Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
```

### Vite Proxy Debugging

#### 1. Enable Debug Logs
```typescript
// vite.config.ts
export default defineConfig({
  server: {
    proxy: {
      '/api/workspace': {
        target: 'http://workspace-api:3200',
        configure: (proxy) => {
          proxy.on('proxyReq', (proxyReq, req) => {
            console.log(`â†’ ${req.method} ${req.url} â†’ ${proxyReq.path}`);
          });
          proxy.on('proxyRes', (proxyRes, req) => {
            console.log(`â† ${proxyRes.statusCode} for ${req.url}`);
          });
          proxy.on('error', (err, req) => {
            console.error(`âœ— Proxy error for ${req.url}:`, err.message);
          });
        }
      }
    }
  }
});
```

#### 2. Test Direct Container Access
```bash
# Inside Dev Container
curl http://workspace-api:3200/api/items

# If this fails, container networking is broken
# Check: docker network inspect tradingsystem_backend
```

#### 3. Validate Environment Variables
```bash
# Inside Dev Container
node -e "console.log(process.env.WORKSPACE_PROXY_TARGET)"

# Expected: http://workspace-api:3200
# If undefined, .env is not loaded correctly
```

#### 4. Check Browser Network Tab
```
1. Open DevTools (F12)
2. Network tab
3. Make request to /api/workspace/items
4. Check:
   - Request URL: http://localhost:5173/api/workspace/items
   - Status: 200 OK
   - Response Headers: Content-Type, etc
   - Response Body: JSON data
```

#### 5. Test Path Rewriting
```bash
# Terminal 1: Start Vite with logs
cd frontend/dashboard
npm run dev

# Terminal 2: Make request
curl http://localhost:5173/api/workspace/items

# Check Terminal 1 logs:
# [Vite Proxy] GET /api/workspace/items â†’ http://workspace-api:3200/api/items
# â† 200 for /api/workspace/items
```

---

## âš ï¸ Common Issues

### Issue 1: "API IndisponÃ­vel" - Vite Proxy

**Symptoms:**
- Dashboard shows "API IndisponÃ­vel"
- Console: `Failed to fetch`
- Network tab: Status (failed)

**Root Cause:** `VITE_` prefix em proxy target

**Fix:**
```bash
# .env - REMOVE VITE_ prefix
# BEFORE:
VITE_WORKSPACE_PROXY_TARGET=http://workspace-api:3200

# AFTER:
WORKSPACE_PROXY_TARGET=http://workspace-api:3200
```

**Rebuild:**
```bash
docker compose -f tools/compose/docker-compose.1-dashboard-stack.yml up -d --build
```

### Issue 2: 404 Not Found - Traefik

**Symptoms:**
- Gateway returns 404
- Dashboard shows router exists
- Health check passes

**Root Cause:** Path rewriting incorreto

**Debug:**
```bash
# Check backend logs
docker logs workspace-api 2>&1 | grep -i "not found"

# Expected request path: /api/items
# Actual request path: /api/workspace/items (wrong!)
```

**Fix:**
```yaml
# Add stripprefix middleware
labels:
  - "traefik.http.middlewares.workspace-strip.stripprefix.prefixes=/api/workspace"
  - "traefik.http.routers.workspace.middlewares=workspace-strip"
```

### Issue 3: CORS Blocked

**Symptoms:**
- Console: `CORS policy: No 'Access-Control-Allow-Origin' header`
- Network tab: Status 200, but response blocked

**Root Cause:** CORS middleware nÃ£o aplicado

**Fix:**
```yaml
# Apply CORS middleware to router
labels:
  - "traefik.http.routers.workspace.middlewares=cors-headers@file"
```

**Verify:**
```bash
curl -i http://localhost:9082/api/workspace/items \
  -H "Origin: http://localhost:5173"

# Expected header:
# Access-Control-Allow-Origin: http://localhost:5173
```

### Issue 4: Rate Limit Exceeded

**Symptoms:**
- Status 429 Too Many Requests
- Header: `X-Rate-Limit-Limit: 100`

**Root Cause:** Burst limit atingido

**Temporary Fix:**
```yaml
# Increase limits (dev only!)
http:
  middlewares:
    rate-limit:
      rateLimit:
        average: 1000  # 1000 req/min
        burst: 500     # Burst 500
```

**Permanent Fix:** Optimize frontend code (reduce API calls, add caching)

### Issue 5: Circuit Breaker Opened

**Symptoms:**
- Status 503 Service Unavailable
- Traefik Dashboard: Circuit breaker "Open"

**Root Cause:** Backend teve >20% error rate

**Debug:**
```bash
# Check backend health
docker logs workspace-api 2>&1 | grep -i error | tail -20

# Check health endpoint
curl http://workspace-api:3200/api/health
```

**Fix:**
1. Resolver erro no backend
2. Aguardar recovery period (30s)
3. Circuit breaker volta para "Half-Open" â†’ "Closed"

---

## ğŸ“– DocumentaÃ§Ã£o Relacionada

### Guias Complementares
- **[Overview](./overview.mdx)** - VisÃ£o geral do Dev Container
- **[Architecture](./architecture.mdx)** - Arquitetura detalhada
- **[API Access](./api-access.mdx)** - PadrÃµes de acesso a APIs
- **[Workflows](./workflows.mdx)** - Fluxo de trabalho diÃ¡rio
- **[Troubleshooting](./troubleshooting.mdx)** - Problemas comuns

### GovernanÃ§a
- **[Dev Container Policy](../../../governance/policies/dev-container-policy.md)** - PolÃ­ticas de uso
- **[API Gateway Policy](../../../governance/policies/api-gateway-policy.md)** - Traefik governance

### Frontend Engineering
- **[Proxy Best Practices](../../frontend/engineering/PROXY-BEST-PRACTICES.md)** - Guia completo
- **[AI Agent Proxy Guide](../../frontend/engineering/AI-AGENT-PROXY-GUIDE.md)** - Para AI agents

---

## â“ FAQ

### Qual a diferenÃ§a entre Traefik e Vite Proxy?

**Traefik:**
- âœ… Production-ready reverse proxy
- âœ… MÃºltiplas backends, load balancing
- âœ… Middlewares (CORS, rate limit, etc)
- âœ… Health checks, circuit breakers
- âœ… MÃ©tricas Prometheus
- âš ï¸ Requer rebuild para mudanÃ§as

**Vite Proxy:**
- âœ… Development-only proxy
- âœ… Hot reload preservado
- âœ… Simples de configurar
- âœ… Fast feedback loop
- âš ï¸ Sem middlewares avanÃ§ados
- âš ï¸ Apenas para dev mode

### Posso usar ambos ao mesmo tempo?

**Sim!** Ã‰ exatamente o que fazemos:

```
Development: Browser â†’ Vite Proxy â†’ APIs
Production: Browser â†’ Traefik Gateway â†’ APIs
```

Vite automaticamente desativa proxy em production build.

### Como adicionar um novo serviÃ§o ao Traefik?

**1. Add Docker labels ao compose file:**
```yaml
services:
  new-service:
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.newservice.rule=PathPrefix(`/api/new`)"
      - "traefik.http.routers.newservice.priority=80"
      - "traefik.http.services.newservice.loadbalancer.server.port=3000"
```

**2. Add service Ã  rede Traefik:**
```yaml
networks:
  - tradingsystem_backend
```

**3. Restart stack:**
```bash
docker compose -f tools/compose/docker-compose.new-service.yml up -d
```

**4. Verify no Traefik Dashboard:**
```
http://localhost:9083/dashboard/
â†’ HTTP â†’ Routers â†’ "newservice" deve aparecer
```

### Como adicionar novo proxy no Vite?

**1. Add environment variable:**
```bash
# .env
NEW_SERVICE_PROXY_TARGET=http://new-service:3000
```

**2. Update vite.config.ts:**
```typescript
proxy: {
  '/api/new': {
    target: process.env.NEW_SERVICE_PROXY_TARGET,
    changeOrigin: true,
  }
}
```

**3. Rebuild container:**
```bash
docker compose -f tools/compose/docker-compose.1-dashboard-stack.yml up -d --build
```

**4. Test:**
```bash
curl http://localhost:5173/api/new/health
```

---

**Ãšltima revisÃ£o:** 2025-11-12
**Status:** âœ… Ativo
**PrÃ³xima revisÃ£o:** 2026-02-12 (3 meses)
