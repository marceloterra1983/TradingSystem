---
title: Dev Container - API Access Patterns
slug: /tools/dev-container/api-access
sidebar_label: API Access
sidebar_position: 3
tags: [dev-container, api, proxy, vite, traefik]
domain: tools
type: guide
summary: "Padr√µes de acesso a APIs no Dev Container: embedded services vs external APIs, Vite Proxy, Traefik Gateway, e quando usar cada abordagem"
status: active
last_review: "2025-11-12"
---

# Dev Container - API Access Patterns

## üéØ Vis√£o Geral

O TradingSystem possui **dois tipos de servi√ßos**:

1. **Embedded Services** - Rodam **dentro do Dev Container** (desenvolvimento)
2. **External Services** - Rodam em **containers Docker separados** (produ√ß√£o-like)

Cada tipo tem **padr√µes de acesso espec√≠ficos** que voc√™ precisa entender para desenvolver eficientemente.

---

## üì¶ Embedded Services (Dev Container)

### O que s√£o Embedded Services?

Servi√ßos que **rodam diretamente dentro do Dev Container** usando ferramentas de desenvolvimento (Vite, Nodemon, etc).

**Caracter√≠sticas:**
- ‚úÖ Hot reload ativo (altera√ß√µes refletem instantaneamente)
- ‚úÖ Debugging direto (breakpoints funcionam)
- ‚úÖ Fast feedback loop (sem rebuild de containers)
- ‚úÖ Logs diretos no terminal
- ‚ö†Ô∏è Apenas para desenvolvimento

### Servi√ßos Embedded

#### 1. Dashboard UI (Vite Dev Server)

**Execu√ß√£o:**
```bash
# Dentro do Dev Container
cd /workspace/frontend/dashboard
npm run dev
```

**Acesso:**
```
Browser ‚Üí http://localhost:5173
         ‚Üì (Vite Dev Server dentro do Dev Container)
Dev Container ‚Üí Vite process (PID ~15000)
```

**Configura√ß√£o (vite.config.ts):**
```typescript
export default defineConfig({
  server: {
    port: 5173,
    host: true, // Permite acesso externo ao container
    proxy: {
      // Proxy para APIs externas
      '/api/workspace': {
        target: 'http://workspace-api:3200',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/workspace/, '/api')
      },
      '/api/tp-capital': {
        target: 'http://tp-capital-api:4005',
        changeOrigin: true,
      },
      '/api/telegram-gateway': {
        target: 'http://telegram-gateway-api:4010',
        changeOrigin: true,
      },
      '/api/docs': {
        target: 'http://documentation-api:3000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/docs/, '/api')
      }
    }
  }
});
```

**Environment Variables (.env):**
```bash
# ‚ö†Ô∏è CRITICAL: Sem prefixo VITE_ (server-side only)
WORKSPACE_PROXY_TARGET=http://workspace-api:3200
TP_CAPITAL_PROXY_TARGET=http://tp-capital-api:4005
TELEGRAM_GATEWAY_PROXY_TARGET=http://telegram-gateway-api:4010
DOCUMENTATION_PROXY_TARGET=http://documentation-api:3000

# ‚úÖ Com prefixo VITE_ (exposed to browser)
VITE_API_BASE_URL=http://localhost:9082
VITE_ENVIRONMENT=development
```

**Por que essa configura√ß√£o?**
- ‚ùå `VITE_WORKSPACE_PROXY_TARGET` ‚Üí Exposto ao browser (vazamento de hostname interno)
- ‚úÖ `WORKSPACE_PROXY_TARGET` ‚Üí Server-side apenas (seguro)
- ‚úÖ Browser usa paths relativos (`/api/workspace/*`)
- ‚úÖ Vite Proxy intercepta e roteia para container correto

#### 2. Node.js APIs em Desenvolvimento (Nodemon)

**Exemplo:** Testando Workspace API localmente

```bash
# Dentro do Dev Container
cd /workspace/backend/api/workspace
npm run dev  # Inicia com nodemon
```

**Acesso:**
```
# Direct access (sem proxy)
curl http://localhost:3200/api/items

# Via Vite Proxy (do browser)
http://localhost:5173/api/workspace/items
```

**Quando usar:**
- ‚úÖ Debugando API com breakpoints
- ‚úÖ Testando mudan√ßas r√°pidas sem rebuild
- ‚úÖ Desenvolvendo novos endpoints
- ‚ùå N√£o para testes de produ√ß√£o

---

## üê≥ External Services (Docker Containers)

### O que s√£o External Services?

Servi√ßos que **rodam em containers Docker separados** do Dev Container, gerenciados via Docker Compose.

**Caracter√≠sticas:**
- ‚úÖ Ambiente production-like
- ‚úÖ Isolamento completo
- ‚úÖ Escalabilidade (m√∫ltiplas inst√¢ncias)
- ‚úÖ Health checks autom√°ticos
- ‚ö†Ô∏è Rebuild necess√°rio para mudan√ßas

### Servi√ßos External

#### 1. Backend APIs

**Workspace API** (Port 3200)
```yaml
# tools/compose/docker-compose.4-3-workspace-stack.yml
services:
  workspace-api:
    container_name: workspace-api
    build: ./backend/api/workspace
    ports:
      - "3210:3200"  # Debug access
    networks:
      - tradingsystem_backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.workspace.rule=PathPrefix(`/api/workspace`)"
      - "traefik.http.routers.workspace.priority=100"
      - "traefik.http.services.workspace.loadbalancer.server.port=3200"
```

**Acesso:**
```bash
# Via Traefik Gateway (RECOMENDADO - produ√ß√£o)
curl http://localhost:9082/api/workspace/items

# Via Vite Proxy (desenvolvimento - browser)
http://localhost:5173/api/workspace/items

# Direct access (debug apenas - containers mesma rede)
curl http://workspace-api:3200/api/items

# Direct access via port mapping (debug - host)
curl http://localhost:3210/api/items
```

**TP Capital API** (Port 4005)
```yaml
services:
  tp-capital-api:
    container_name: tp-capital-api
    build: ./backend/api/tp-capital
    ports:
      - "4008:4005"  # Debug access
    networks:
      - tradingsystem_backend
      - tp_capital_backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tp-capital.rule=PathPrefix(`/api/tp-capital`)"
      - "traefik.http.routers.tp-capital.priority=90"
```

**Telegram Gateway API** (Port 4010)
```yaml
services:
  telegram-gateway-api:
    container_name: telegram-gateway-api
    build: ./backend/api/telegram-gateway
    networks:
      - tradingsystem_backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.telegram.rule=PathPrefix(`/api/telegram-gateway`)"
      - "traefik.http.routers.telegram.priority=95"
```

#### 2. Databases

**PostgreSQL / TimescaleDB**
```yaml
services:
  workspace-db:
    image: postgres:16-alpine
    container_name: workspace-db
    ports:
      - "5444:5432"  # Direct access para debug
    networks:
      - tradingsystem_backend
    environment:
      POSTGRES_USER: workspace
      POSTGRES_PASSWORD: ${WORKSPACE_DB_PASSWORD}
      POSTGRES_DB: workspace
```

**Acesso:**
```bash
# Via container networking (APIs)
postgresql://workspace:password@workspace-db:5432/workspace

# Via host port mapping (psql local)
psql -h localhost -p 5444 -U workspace -d workspace
```

**Redis (Cache)**
```yaml
services:
  workspace-redis:
    image: redis:7-alpine
    container_name: workspace-redis
    ports:
      - "6388:6379"  # Direct access
    networks:
      - tradingsystem_backend
```

**Acesso:**
```bash
# Via container networking (APIs)
redis://workspace-redis:6379

# Via host port mapping (redis-cli local)
redis-cli -h localhost -p 6388
```

#### 3. Frontend (Production Build)

**Dashboard UI** (Port 3103)
```yaml
services:
  dashboard-ui:
    container_name: dashboard-ui
    build:
      context: ./frontend/dashboard
      dockerfile: Dockerfile
    ports:
      - "8092:3103"  # Direct access
    networks:
      - tradingsystem_frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=PathPrefix(`/`)"
      - "traefik.http.routers.dashboard.priority=1"
```

**Docs Hub** (Port 80)
```yaml
services:
  docs-hub:
    container_name: docs-hub
    build: ./docs
    networks:
      - tradingsystem_frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.docs.rule=PathPrefix(`/docs`)"
      - "traefik.http.routers.docs.priority=50"
```

---

## üîÄ Padr√µes de Acesso

### Pattern 1: Browser ‚Üí Vite Proxy ‚Üí External API (Development)

**Fluxo:**
```
Browser ‚Üí http://localhost:5173/api/workspace/items
         ‚Üì (Vite Dev Server dentro do Dev Container)
Vite Proxy ‚Üí workspace-api:3200/api/items
         ‚Üì (Container networking)
Workspace API ‚Üí PostgreSQL
         ‚Üì
Response (JSON) ‚Üí Vite ‚Üí Browser (Hot Reload)
```

**Quando usar:**
- ‚úÖ Desenvolvendo frontend (UI components)
- ‚úÖ Testando integra√ß√£o API em tempo real
- ‚úÖ Querendo hot reload autom√°tico
- ‚úÖ Debugando chamadas de API

**Configura√ß√£o necess√°ria:**
```typescript
// vite.config.ts
export default defineConfig({
  server: {
    proxy: {
      '/api/workspace': {
        target: 'http://workspace-api:3200',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/workspace/, '/api')
      }
    }
  }
});
```

```bash
# .env (root do projeto)
WORKSPACE_PROXY_TARGET=http://workspace-api:3200
```

**C√≥digo no Browser:**
```typescript
// ‚úÖ CORRETO - Path relativo
const response = await fetch('/api/workspace/items');

// ‚ùå ERRADO - Hardcoded localhost
const response = await fetch('http://localhost:3200/api/items');
```

---

### Pattern 2: Browser ‚Üí Traefik Gateway ‚Üí External API (Production-like)

**Fluxo:**
```
Browser ‚Üí http://localhost:9082/api/workspace/items
         ‚Üì (Traefik Gateway container)
Traefik ‚Üí Route detection (PathPrefix: /api/workspace)
         ‚Üì (Priority: 100)
Path Rewrite: /api/workspace/* ‚Üí /api/*
         ‚Üì
Workspace API (workspace-api:3200/api/items)
         ‚Üì
Response (JSON) ‚Üí Traefik (CORS, Compression) ‚Üí Browser
```

**Quando usar:**
- ‚úÖ Testando ambiente production-like
- ‚úÖ Validando CORS configuration
- ‚úÖ Testando rate limiting
- ‚úÖ Verificando health checks
- ‚úÖ E2E tests

**Configura√ß√£o necess√°ria:**
```yaml
# docker-compose (Traefik labels)
labels:
  - "traefik.enable=true"
  - "traefik.http.routers.workspace.rule=PathPrefix(`/api/workspace`)"
  - "traefik.http.routers.workspace.priority=100"
  - "traefik.http.routers.workspace.entrypoints=web"
  - "traefik.http.services.workspace.loadbalancer.server.port=3200"
  - "traefik.http.routers.workspace.middlewares=api-standard@file"
```

**C√≥digo no Browser:**
```typescript
// ‚úÖ CORRETO - Via gateway
const response = await fetch(`${import.meta.env.VITE_API_BASE_URL}/api/workspace/items`);
// URL real: http://localhost:9082/api/workspace/items

// ‚úÖ ALTERNATIVA - Path relativo (se base URL = /)
const response = await fetch('/api/workspace/items');
```

---

### Pattern 3: Dev Container ‚Üí External API (Container Networking)

**Fluxo:**
```
Dev Container (shell) ‚Üí curl http://workspace-api:3200/api/items
         ‚Üì (Docker network: tradingsystem_backend)
Docker DNS ‚Üí Resolve workspace-api ‚Üí Container IP
         ‚Üì
Workspace API (3200)
         ‚Üì
Response (JSON)
```

**Quando usar:**
- ‚úÖ Testando API com curl/Postman dentro do Dev Container
- ‚úÖ Scripts de automa√ß√£o (migrations, seeding)
- ‚úÖ Health checks de servi√ßos
- ‚úÖ Debugging direto de API

**Exemplos:**
```bash
# Dentro do Dev Container
# Health check
curl http://workspace-api:3200/api/health

# Get items
curl http://workspace-api:3200/api/items | jq .

# Post item
curl -X POST http://workspace-api:3200/api/items \
  -H "Content-Type: application/json" \
  -d '{"title": "Test Item", "status": "active"}'

# Database connection test
psql -h workspace-db -p 5432 -U workspace -d workspace -c "SELECT COUNT(*) FROM items;"
```

**Requisitos:**
- ‚úÖ Dev Container deve estar na mesma rede Docker (`tradingsystem_backend`)
- ‚úÖ Usar hostname do container (n√£o `localhost`)
- ‚úÖ Usar porta interna (3200, n√£o 3210)

---

### Pattern 4: Direct Port Access (Debug Only)

**Fluxo:**
```
Browser/curl ‚Üí http://localhost:3210/api/items
         ‚Üì (Port mapping: 3210 ‚Üí 3200)
Host Docker ‚Üí Forward to workspace-api:3200
         ‚Üì
Workspace API
         ‚Üì
Response (JSON) ‚Üí BUT: CORS ERROR if from browser!
```

**Quando usar:**
- ‚ö†Ô∏è Debug apenas
- ‚ö†Ô∏è Testando com Postman/Insomnia (n√£o browser)
- ‚ö†Ô∏è Troubleshooting direto de servi√ßo
- ‚ùå NUNCA em produ√ß√£o
- ‚ùå NUNCA do browser (CORS bloqueado)

**Por que CORS bloqueia:**
```
Origin: http://localhost:5173 (Vite)
Request: http://localhost:3210/api/items (API)
         ‚Üì
API n√£o tem header: Access-Control-Allow-Origin: http://localhost:5173
         ‚Üì
Browser: ‚ùå CORS policy blocked
```

**Solu√ß√£o:** Use Vite Proxy ou Traefik Gateway (ambos configurados com CORS).

---

## üîê Authentication Flows

### Development Mode (Vite Proxy)

```typescript
// Browser code
const token = localStorage.getItem('auth_token');

const response = await fetch('/api/workspace/items', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});

// ‚Üì Vite Proxy forwards to workspace-api:3200 with headers intact
```

**Fluxo:**
```
Browser ‚Üí /api/workspace/items (with Authorization header)
       ‚Üì
Vite Proxy ‚Üí workspace-api:3200/api/items (headers forwarded)
       ‚Üì
API validates JWT ‚Üí Returns data
```

### Production Mode (Traefik Gateway)

```typescript
// Browser code (same as development!)
const token = localStorage.getItem('auth_token');

const response = await fetch(`${import.meta.env.VITE_API_BASE_URL}/api/workspace/items`, {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
```

**Fluxo:**
```
Browser ‚Üí http://localhost:9082/api/workspace/items
       ‚Üì
Traefik ‚Üí Middleware: JWT validation (optional)
       ‚Üì
Traefik ‚Üí Route to workspace-api:3200 (headers forwarded)
       ‚Üì
API validates JWT ‚Üí Returns data
       ‚Üì
Traefik ‚Üí Add CORS headers ‚Üí Browser
```

**Traefik JWT Middleware (opcional):**
```yaml
# tools/traefik/dynamic/middlewares.yml
http:
  middlewares:
    jwt-validation:
      plugin:
        jwt:
          secret: "${JWT_SECRET}"
          algorithm: "HS256"
```

---

## üåç Environment Variables

### Rules (CRITICAL!)

**‚ùå NEVER use `VITE_` prefix for proxy targets:**
```bash
# ‚ùå WRONG - Exposed to browser (security risk)
VITE_WORKSPACE_PROXY_TARGET=http://workspace-api:3200
```

**‚úÖ ALWAYS use server-side only variables:**
```bash
# ‚úÖ CORRECT - Server-side only (not exposed)
WORKSPACE_PROXY_TARGET=http://workspace-api:3200
TP_CAPITAL_PROXY_TARGET=http://tp-capital-api:4005
TELEGRAM_GATEWAY_PROXY_TARGET=http://telegram-gateway-api:4010
```

**‚úÖ Use `VITE_` only for browser-safe values:**
```bash
# ‚úÖ CORRECT - Safe to expose
VITE_API_BASE_URL=http://localhost:9082
VITE_ENVIRONMENT=development
VITE_APP_NAME=TradingSystem
```

### Environment Variable Precedence

```
1. .env.local (highest priority, git-ignored)
2. .env (project root, committed as .env.example)
3. docker-compose env_file
4. docker-compose environment section
5. Dockerfile ENV statements (lowest priority)
```

**Validation:**
```bash
# Inside Dev Container
bash scripts/env/validate-env.sh

# Check for VITE_ proxy targets (should be ZERO)
grep -r "VITE_.*PROXY_TARGET" .env
# Expected: no matches
```

---

## üìä Comparison Table

| Aspect | Vite Proxy (Dev) | Traefik Gateway (Prod) | Direct Access (Debug) |
|--------|------------------|------------------------|----------------------|
| **Use Case** | Frontend development | Production testing | Troubleshooting |
| **Hot Reload** | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| **CORS** | ‚úÖ Configured | ‚úÖ Configured | ‚ùå Blocked |
| **Rate Limiting** | ‚ùå No | ‚úÖ Yes (100 req/min) | ‚ùå No |
| **Compression** | ‚ùå No | ‚úÖ Yes (gzip/brotli) | ‚ùå No |
| **Health Checks** | ‚ùå No | ‚úÖ Yes (30s interval) | ‚ùå No |
| **Circuit Breaker** | ‚ùå No | ‚úÖ Yes | ‚ùå No |
| **Metrics** | ‚ùå No | ‚úÖ Yes (Prometheus) | ‚ùå No |
| **Security Headers** | ‚ùå No | ‚úÖ Yes | ‚ùå No |
| **Access Logs** | ‚úÖ Dev logs | ‚úÖ JSON format | ‚ùå No |
| **Path Rewrite** | ‚úÖ Yes | ‚úÖ Yes | ‚ùå No |
| **Browser Access** | ‚úÖ Yes | ‚úÖ Yes | ‚ö†Ô∏è CORS error |
| **Container Network** | ‚úÖ Yes | ‚úÖ Yes | ‚ö†Ô∏è Port mapping |

---

## üîç Debugging API Issues

### Issue: "API Indispon√≠vel" in Dashboard

**Symptoms:**
- Dashboard shows "API Indispon√≠vel"
- Console error: `Failed to fetch`
- Network tab: Status (failed)

**Root Causes:**

#### 1. Vite Proxy Target com prefixo `VITE_`
```bash
# ‚ùå WRONG (.env)
VITE_WORKSPACE_PROXY_TARGET=http://workspace-api:3200

# Browser can see this! Tries to connect directly ‚Üí fails
```

**Fix:**
```bash
# ‚úÖ CORRECT
WORKSPACE_PROXY_TARGET=http://workspace-api:3200

# vite.config.ts
proxy: {
  '/api/workspace': {
    target: process.env.WORKSPACE_PROXY_TARGET, // Server-side only
    // ...
  }
}
```

#### 2. Hardcoded localhost URLs no c√≥digo

```typescript
// ‚ùå WRONG
const url = 'http://localhost:3200/api/items';
```

**Fix:**
```typescript
// ‚úÖ CORRECT
const url = '/api/workspace/items'; // Relative path
```

#### 3. Container n√£o est√° na rede correta

**Verificar:**
```bash
# Dev Container deve estar em tradingsystem_backend
docker network inspect tradingsystem_backend | grep -A 5 "tradingsystem-dev"
```

**Fix (devcontainer.json):**
```json
{
  "runArgs": [
    "--network=tradingsystem_backend",
    "--network=tradingsystem_frontend"
  ]
}
```

#### 4. API container n√£o est√° rodando

**Verificar:**
```bash
docker ps --filter "name=workspace-api"
```

**Fix:**
```bash
docker compose -f tools/compose/docker-compose.4-3-workspace-stack.yml up -d
```

#### 5. Path rewriting incorreto

**Problema:**
```
Browser ‚Üí /api/workspace/items
Vite Proxy ‚Üí workspace-api:3200/api/workspace/items (WRONG!)
API espera: workspace-api:3200/api/items
```

**Fix (vite.config.ts):**
```typescript
proxy: {
  '/api/workspace': {
    target: 'http://workspace-api:3200',
    changeOrigin: true,
    rewrite: (path) => path.replace(/^\/api\/workspace/, '/api') // CRITICAL!
  }
}
```

---

## üìñ Documenta√ß√£o Relacionada

### Guias Complementares
- **[Overview](overview.mdx)** - Vis√£o geral do Dev Container
- **[Architecture](architecture.mdx)** - Arquitetura detalhada
- **[Gateway & Proxy](gateway-proxy.mdx)** - Traefik e Vite em profundidade
- **[Workflows](workflows.mdx)** - Fluxo de trabalho di√°rio
- **[Troubleshooting](troubleshooting.mdx)** - Problemas comuns

### Governan√ßa
- **[Dev Container Policy](../../governance/policies/dev-container-policy.md)** - Pol√≠ticas de uso
- **[Security Guide](../../governance/controls/dev-container-security.md)** - Seguran√ßa

### Frontend Engineering
- **[Proxy Best Practices](../../frontend/engineering/PROXY-BEST-PRACTICES.md)** - Guia completo de proxy
- **[AI Agent Proxy Guide](https://github.com/marceloterra1983/TradingSystem/blob/main/docs/content/frontend/engineering/AI-AGENT-PROXY-GUIDE)** - Para AI agents

---

## ‚ùì FAQ

### Como sei qual padr√£o de acesso usar?

**Decis√£o r√°pida:**
- Desenvolvendo UI? ‚Üí **Vite Proxy** (hot reload)
- Testando produ√ß√£o? ‚Üí **Traefik Gateway** (production-like)
- Debugando API? ‚Üí **Container Networking** (curl dentro do Dev Container)
- Troubleshooting? ‚Üí **Direct Port Access** (Postman, n√£o browser)

### Posso misturar padr√µes?

**Sim!** √â comum:
```typescript
// Development: Vite Proxy
const apiUrl = import.meta.env.DEV ? '/api/workspace' : `${import.meta.env.VITE_API_BASE_URL}/api/workspace`;
```

Vite automaticamente usa proxy em dev mode e gateway em prod build.

### Por que n√£o usar sempre Direct Access?

**Problemas:**
1. ‚ùå CORS bloqueado (browser)
2. ‚ùå Sem rate limiting (DDoS risk)
3. ‚ùå Sem compression (slow)
4. ‚ùå Sem health checks (availability)
5. ‚ùå Sem metrics (observability)

**Direct Access √© APENAS para debug.**

### Como testar CORS configuration?

**Use Traefik Gateway:**
```bash
# Check CORS headers
curl -i http://localhost:9082/api/workspace/items \
  -H "Origin: http://localhost:5173"

# Expected headers:
# Access-Control-Allow-Origin: http://localhost:5173
# Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
# Access-Control-Allow-Headers: Content-Type, Authorization
```

### Embedded service vs External service - como escolher?

**Use Embedded quando:**
- ‚úÖ Desenvolvendo UI (precisa hot reload)
- ‚úÖ Debugando c√≥digo (precisa breakpoints)
- ‚úÖ Mudan√ßas r√°pidas (sem rebuild)

**Use External quando:**
- ‚úÖ Testando integra√ß√£o completa
- ‚úÖ Validando configura√ß√£o de produ√ß√£o
- ‚úÖ E2E tests
- ‚úÖ Performance testing

---

**√öltima revis√£o:** 2025-11-12
**Status:** ‚úÖ Ativo
**Pr√≥xima revis√£o:** 2026-02-12 (3 meses)
