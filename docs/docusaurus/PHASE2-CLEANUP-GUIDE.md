# Phase 2: Docusaurus Cleanup Guide

**Purpose:** Safe removal of build artifacts while preserving source code
**Prerequisites:** Phase 1 backup completed and verified
**Estimated time:** 2-5 minutes
**Risk level:** LOW (backup available for rollback)

## Overview

What Phase 2 accomplishes:

- Removes build artifacts: node_modules/, .docusaurus/, build/, package-lock.json
- Clears Docusaurus cache using `npm run clear`
- Preserves all source code: src/, static/, scripts/, configuration files
- Validates source integrity before and after cleanup
- Prepares for Phase 3: npm install

## Current State Analysis

Based on exploration, the current state is:

- ❌ node_modules/ - NOT present (already clean)
- ❌ .docusaurus/ - NOT present (already clean)
- ❌ build/ - NOT present (already clean)
- ✅ package-lock.json - EXISTS (needs removal)
- ❌ .cache-loader/ - NOT present (already clean)
- ❌ static/spec/ - NOT present (already clean)

**Conclusion:** Most cleanup is already done. Only package-lock.json needs removal, plus running `npm run clear` for safety.

## Prerequisites

Before starting Phase 2:

1. ✅ Phase 1 backup completed: `.backup-docusaurus-{timestamp}/`
2. ✅ Backup verified: All source files present in backup
3. ✅ No Docusaurus processes running: `pkill -f docusaurus`
4. ✅ Current directory: `/home/marce/projetos/TradingSystem/docs/docusaurus`
5. ✅ Sufficient disk space: `df -h` (should have > 500 MB free)

## Cleanup Methods

Two methods available:

### Method 1: Automated Script (Recommended)

Use the cleanup script from `scripts/docs/cleanup-docusaurus-artifacts.sh`:

```bash
cd /home/marce/projetos/TradingSystem
bash scripts/docs/cleanup-docusaurus-artifacts.sh --verbose
```

Advantages:

- ✅ Automated validation (pre/post cleanup)
- ✅ Comprehensive logging
- ✅ Source integrity verification
- ✅ Rollback instructions if errors occur
- ✅ Detailed cleanup report

Options:

- `--dry-run` - Simulate cleanup without actual deletion
- `--verbose` - Show detailed output
- `--backup-ref PATH` - Reference Phase 1 backup location

### Method 2: Manual Cleanup

Follow the checklist in `CLEANUP-CHECKLIST.md`:

```bash
cd /home/marce/projetos/TradingSystem/docs/docusaurus

# 1. Document current state
test -d node_modules && echo "node_modules: $(du -sh node_modules)" || echo "node_modules: Not present"
test -d .docusaurus && echo ".docusaurus: $(du -sh .docusaurus)" || echo ".docusaurus: Not present"
test -d build && echo "build: $(du -sh build)" || echo "build: Not present"
test -f package-lock.json && echo "package-lock.json: $(ls -lh package-lock.json | awk '{print $5}')" || echo "package-lock.json: Not present"

# 2. Create source manifest (for verification)
find src static scripts -type f -not -path 'static/spec/*' -exec md5sum {} \; > .source-manifest-pre.txt

# 3. Remove artifacts (only if they exist)
rm -rf node_modules/
rm -rf .docusaurus/
rm -rf build/
rm -f package-lock.json
rm -rf .cache-loader/
rm -rf static/spec/

# 4. Run npm clear
npm run clear

# 5. Verify artifacts removed
test ! -d node_modules && echo "✅ node_modules removed" || echo "❌ node_modules still exists"
test ! -d .docusaurus && echo "✅ .docusaurus removed" || echo "❌ .docusaurus still exists"
test ! -d build && echo "✅ build removed" || echo "❌ build still exists"
test ! -f package-lock.json && echo "✅ package-lock.json removed" || echo "❌ package-lock.json still exists"

# 6. Verify source preserved
find src static scripts -type f -not -path 'static/spec/*' -exec md5sum {} \; > .source-manifest-post.txt
diff .source-manifest-pre.txt .source-manifest-post.txt && echo "✅ All source files preserved" || echo "❌ Source files modified!"

# 7. Clean up manifests
rm -f .source-manifest-*.txt
```

Advantages:

- ✅ Full control over each step
- ✅ Can inspect results after each command
- ✅ Good for learning the process

Disadvantages:

- ⚠️ Manual validation required
- ⚠️ No automatic logging
- ⚠️ More error-prone

## What Gets Removed

Artifacts to be removed (if present):

1. **node_modules/** - NPM dependencies (200-300 MB)

   - Contains all installed packages
   - Will be reinstalled in Phase 3 with `npm install`
   - Safe to remove (defined in package.json)

2. **.docusaurus/** - Docusaurus build cache (10-20 MB)

   - Generated during development/build
   - Contains compiled assets, metadata
   - Safe to remove (regenerated automatically)

3. **build/** - Production build output (5-10 MB)

   - Generated by `npm run build`
   - Contains static HTML/CSS/JS for deployment
   - Safe to remove (can rebuild anytime)

4. **package-lock.json** - NPM lock file (1-2 MB)

   - Locks exact dependency versions
   - Will be regenerated in Phase 3 with `npm install`
   - Safe to remove (package.json has version ranges)

5. **.cache-loader/** - Webpack cache (if present)

   - Build optimization cache
   - Safe to remove (regenerated automatically)

6. **static/spec/** - Generated OpenSpec assets
   - Created by `scripts/sync-spec.js` (line 7 in package.json)
   - Synced from `docs/spec/` directory
   - Safe to remove (regenerated by prestart script)

## What Gets Preserved

Source files that MUST NOT be touched:

1. **src/** directory (24 files)

   - src/components/ - Custom React components (9 components)
   - src/pages/ - Custom pages (index, health, search, spec)
   - src/theme/ - Theme overrides (Layout, SearchBar)
   - src/css/custom.css - Gemini CLI theme (708 lines)

2. **static/** directory (excluding static/spec/)

   - static/img/ - Logos, images, favicon
   - static/.htaccess - Apache configuration
   - static/.nojekyll - GitHub Pages config

3. **scripts/** directory (2 files)

   - scripts/sync-spec.js - OpenSpec sync script
   - scripts/preview-theme.sh - Theme preview utility

4. **Configuration files**

   - package.json - Dependencies and scripts
   - docusaurus.config.ts - Main Docusaurus config
   - sidebars.ts - Sidebar configuration
   - tsconfig.json - TypeScript configuration
   - .gitignore - Git ignore rules
   - .prettierrc - Prettier config
   - .eslintrc.js - ESLint config

5. **Documentation files**
   - README.md - Main documentation
   - TROUBLESHOOTING.md - Troubleshooting guide
   - QUICK-START.md - Quick start guide
   - THEME-\*.md - Theme documentation
   - All other .md files

## Validation Process

### Pre-Cleanup Validation

1. Document current state (artifact sizes)
2. Create source file manifest with checksums
3. Count source files: src/ (24), static/ (varies), scripts/ (2)
4. Verify backup from Phase 1 exists

### Post-Cleanup Validation

1. Verify all artifacts removed (test ! -d, test ! -f)
2. Verify all source files present (test -d, test -f)
3. Compare source checksums (diff manifests)
4. Count source files (should match pre-cleanup)
5. Verify critical config files intact

### Validation Commands

```bash
# Verify artifacts removed
test ! -d node_modules && test ! -d .docusaurus && test ! -d build && test ! -f package-lock.json && echo "✅ All artifacts removed" || echo "❌ Some artifacts remain"

# Verify source preserved
test -d src && test -d static && test -d scripts && test -f package.json && test -f docusaurus.config.ts && echo "✅ All source preserved" || echo "❌ Source files missing!"

# Count source files
echo "src/ files: $(find src -type f | wc -l)"
echo "static/ files: $(find static -type f -not -path 'static/spec/*' | wc -l)"
echo "scripts/ files: $(find scripts -type f | wc -l)"
```

## Expected Results

After successful cleanup:

**Artifacts Status:**

- ✅ node_modules/ - Removed (or already clean)
- ✅ .docusaurus/ - Removed (or already clean)
- ✅ build/ - Removed (or already clean)
- ✅ package-lock.json - Removed
- ✅ .cache-loader/ - Removed (or already clean)
- ✅ static/spec/ - Removed (or already clean)

**Source Code Status:**

- ✅ src/ - Preserved (24 files)
- ✅ static/ - Preserved (excluding spec/)
- ✅ scripts/ - Preserved (2 files)
- ✅ Configuration files - Preserved
- ✅ Documentation files - Preserved
- ✅ Checksums match pre-cleanup state

**Space Freed:**

- Estimated: 1-2 MB (only package-lock.json in current state)
- If node_modules existed: 200-300 MB
- If .docusaurus existed: 10-20 MB
- If build existed: 5-10 MB

## Troubleshooting

### Problem: Source files missing after cleanup

Solution:

1. STOP immediately - do not proceed to Phase 3
2. Check cleanup log for errors
3. Restore from Phase 1 backup:
   ```bash
   cd /home/marce/projetos/TradingSystem
   rm -rf docs/docusaurus
   rsync -av .backup-docusaurus-{timestamp}/docusaurus/ docs/docusaurus/
   ```
4. Verify restoration: `find src -type f | wc -l` (should be 24)
5. Investigate root cause before retrying

### Problem: Checksums don't match

Solution:

1. Review which files changed: `diff .source-manifest-pre.txt .source-manifest-post.txt`
2. If only timestamps changed, it's OK (use md5sum, not stat)
3. If file content changed, restore from backup
4. Investigate why files were modified

### Problem: Artifacts still present after cleanup

Solution:

1. Check file permissions: `ls -la`
2. Try with sudo (if permission denied): `sudo rm -rf node_modules`
3. Check if files are in use: `lsof | grep docusaurus`
4. Stop all processes: `pkill -f docusaurus && pkill -f npm`
5. Retry cleanup

### Problem: npm run clear fails

Solution:

1. Check npm is available: `command -v npm`
2. Check Node.js version: `node --version` (should be >= 20.0)
3. Verify package.json has clear script: `grep '"clear"' package.json`
4. Try manual cache clear: `rm -rf .docusaurus`
5. Check error message and resolve

## Rollback Procedure

If cleanup fails or source is damaged:

```bash
# 1. Stop all processes
pkill -f docusaurus
pkill -f npm

# 2. Remove current installation
cd /home/marce/projetos/TradingSystem
rm -rf docs/docusaurus

# 3. Restore from Phase 1 backup
rsync -av .backup-docusaurus-{timestamp}/docusaurus/ docs/docusaurus/

# 4. Verify restoration
cd docs/docusaurus
test -f package.json && echo "✅ package.json restored"
test -f docusaurus.config.ts && echo "✅ docusaurus.config.ts restored"
test -d src && echo "✅ src/ restored"
find src -type f | wc -l  # Should be 24

# 5. Review backup manifest
cat ../.backup-docusaurus-{timestamp}/metadata/MANIFEST.md
```

## Next Steps

After successful Phase 2 cleanup:

1. ✅ Review cleanup log: `cat CLEANUP-LOG-{timestamp}.md`
2. ✅ Verify all validations passed
3. ✅ Confirm source files preserved
4. ✅ Check disk space: `df -h` (should have > 500 MB for npm install)
5. ✅ Proceed to Phase 3: npm install (see Phase 3 plan)
6. ✅ Keep Phase 1 backup until Phase 4 validation complete

## Success Criteria

Phase 2 is successful when:

- ✅ All build artifacts removed (or confirmed already clean)
- ✅ All source files preserved with matching checksums
- ✅ npm run clear executed successfully
- ✅ Post-cleanup validation passed
- ✅ Cleanup log generated
- ✅ No errors in cleanup process
- ✅ Ready to proceed to Phase 3

## Cleanup Log Location

Cleanup results documented in:

- `CLEANUP-LOG-{timestamp}.md` - Detailed cleanup log
- `CLEANUP-REPORT-{timestamp}.json` - JSON format report
- `.source-manifest-pre.txt` - Pre-cleanup checksums (temporary)
- `.source-manifest-post.txt` - Post-cleanup checksums (temporary)

These files are created in `/home/marce/projetos/TradingSystem/docs/docusaurus/`

## Time Estimates

- Pre-cleanup validation: 30 seconds
- Artifact removal: 10-30 seconds (depends on sizes)
- npm run clear: 5-10 seconds
- Post-cleanup validation: 30 seconds
- Report generation: 10 seconds
- **Total: 2-5 minutes**

## Safety Notes

⚠️ **IMPORTANT:**

- Always verify Phase 1 backup exists before cleanup
- Never skip source file validation
- Stop immediately if any validation fails
- Keep backup until entire restoration verified (Phase 4)
- Document any issues in cleanup log
- If in doubt, use --dry-run flag first

✅ **SAFE TO REMOVE:**

- node_modules/ (reinstalled from package.json)
- .docusaurus/ (regenerated automatically)
- build/ (rebuilt with npm run build)
- package-lock.json (regenerated with npm install)
- .cache-loader/ (regenerated automatically)
- static/spec/ (regenerated by prestart script)

❌ **NEVER REMOVE:**

- src/ directory
- static/ directory (except static/spec/)
- scripts/ directory
- package.json
- docusaurus.config.ts
- sidebars.ts
- tsconfig.json
- Any .md documentation files
