---
title: SOP - Rota√ß√£o de Segredos e Vari√°veis de Ambiente
description: Procedimento passo-a-passo para rota√ß√£o segura de segredos (API
  keys, tokens, senhas) em todos os ambientes do TradingSystem.
slug: /governance/controls/secrets-rotation-sop
tags:
  - sop
  - runbook
  - secrets
  - incident-response
owner: SecurityEngineering
lastReviewed: 2025-11-05
sidebar_label: SOP-SEC-001 - Secrets Rotation
sidebar_position: 20
---

<!-- AUTO-GENERATED from governance source. Do not edit in docs/content. -->

---
title: "SOP - Rota√ß√£o de Segredos e Vari√°veis de Ambiente"
id: SOP-SEC-001
owner: SecurityEngineering
lastReviewed: "2025-11-05"
reviewCycleDays: 180
status: active
relatedPolicies:
  - POL-0002
relatedStandards:
  - STD-010
tags:
  - sop
  - runbook
  - secrets
  - incident-response
---

# SOP - Rota√ß√£o de Segredos e Vari√°veis de Ambiente

**ID:** SOP-SEC-001  
**Owner:** SecurityEngineering  
**Status:** Active  
**Last Reviewed:** 2025-11-05

## 1. Objetivo

Fornecer procedimento **passo-a-passo** para rota√ß√£o segura de segredos (API keys, tokens, senhas) em todos os ambientes do TradingSystem, garantindo zero downtime e rastreabilidade completa.

## 2. Escopo

- **Segredos Cobertos:**
  - Senhas de banco de dados (TimescaleDB, QuestDB, PostgreSQL)
  - Tokens de API externa (Telegram Bot, Evolution API, Firecrawl)
  - JWT Secrets (autentica√ß√£o interna)
  - Credenciais ProfitDLL (Nelogica)
  - Age encryption keys

- **Ambientes:**
  - Desenvolvimento Local
  - CI/CD (GitHub Actions)
  - Staging/Homologa√ß√£o
  - Produ√ß√£o (Windows + Docker/WSL)

## 3. Frequ√™ncia de Rota√ß√£o

| Tipo de Segredo | Frequ√™ncia Planejada | Rota√ß√£o de Emerg√™ncia |
|-----------------|----------------------|------------------------|
| **Senhas de DB** | 180 dias | Imediatamente |
| **Tokens de API** | 90 dias | Imediatamente |
| **JWT Secrets** | 90 dias | Imediatamente |
| **ProfitDLL Credentials** | 180 dias | Imediatamente |
| **Age Private Keys** | Anualmente | Imediatamente |

**Triggers de Emerg√™ncia:**
- Exposi√ß√£o acidental em commit/log
- Suspeita de comprometimento
- Sa√≠da de colaborador com acesso
- Auditoria de seguran√ßa identificou vulnerabilidade

## 4. Pr√©-Requisitos

### 4.1 Ferramentas Necess√°rias

```bash
# Node.js/npm (automa√ß√£o)
node --version  # >=18.0.0
npm --version

# SOPS + age (criptografia)
age --version
sops --version

# Docker (descriptografia em containers)
docker --version

# PowerShell (Windows nativo)
pwsh --version  # >=7.0
```

### 4.2 Permiss√µes Necess√°rias

- **GitHub:** Admin access to repository secrets
- **Azure/AWS:** IAM roles for OIDC token exchange
- **Windows:** Administrator rights (setx /M)
- **Docker:** Access to production volumes/secrets

### 4.3 Backups Atuais

**ANTES de iniciar rota√ß√£o, garantir:**
```bash
# 1. Backup do .env atual (descriptografado)
cp .env .env.backup.$(date +%Y%m%d-%H%M%S)

# 2. Backup dos secrets criptografados
cp config/secrets.enc.yaml config/secrets.enc.yaml.backup.$(date +%Y%m%d)

# 3. Documentar valores antigos (HASH, n√£o plaintext)
echo "OLD_JWT_SECRET_HASH=$(echo -n $JWT_SECRET | sha256sum)" >> rotation.log
```

## 5. Procedimento de Rota√ß√£o

### 5.1 Rota√ß√£o de Senha de Banco de Dados

#### Fase 1: Gerar Nova Senha

```bash
# Gerar senha forte (32 chars, alfanum√©rico + s√≠mbolos)
NEW_DB_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)
echo "Nova senha gerada (N√ÉO logar plaintext em produ√ß√£o): ${NEW_DB_PASSWORD:0:4}***"
```

#### Fase 2: Atualizar Banco de Dados

**PostgreSQL/TimescaleDB:**
```sql
-- Conectar como superuser
psql -U postgres -h localhost

-- Alterar senha do usu√°rio da aplica√ß√£o
ALTER USER workspace_user WITH PASSWORD 'NEW_DB_PASSWORD';

-- Verificar
\du workspace_user
```

**QuestDB:**
```bash
# Atualizar arquivo de configura√ß√£o
echo "pg.user.password=NEW_DB_PASSWORD" >> /var/lib/questdb/conf/server.conf

# Reiniciar QuestDB (Docker)
docker compose -f tools/compose/docker-compose.data.yml restart questdb
```

#### Fase 3: Atualizar Aplica√ß√£o

**Desenvolvimento Local:**
```bash
# Editar .env (N√ÉO versionar)
sed -i "s|WORKSPACE__DB__PRIMARY__URL=postgresql://.*|WORKSPACE__DB__PRIMARY__URL=postgresql://workspace_user:${NEW_DB_PASSWORD}@localhost:5432/workspace|" .env
```

**Staging/Production (SOPS):**
```bash
# 1. Descriptografar secrets
age -d -i ~/.age/key.txt config/secrets.enc.yaml > config/secrets.yaml

# 2. Editar valor
yq eval ".database.password = \"${NEW_DB_PASSWORD}\"" -i config/secrets.yaml

# 3. Re-criptografar
age -R config/.age-recipients.txt -o config/secrets.enc.yaml config/secrets.yaml

# 4. Remover plaintext
shred -u config/secrets.yaml

# 5. Commitar vers√£o criptografada
git add config/secrets.enc.yaml
git commit -m "chore(secrets): rotate database password"
```

**GitHub Secrets (CI/CD):**
```bash
# Via GitHub CLI
gh secret set WORKSPACE__DB__PRIMARY__URL \
  --body "postgresql://workspace_user:${NEW_DB_PASSWORD}@db.production.local:5432/workspace" \
  --env production
```

#### Fase 4: Testar Conex√£o

```bash
# Staging
docker compose -f tools/compose/docker-compose.apps.yml exec workspace-api \
  npm run db:test-connection

# Production Windows
cd C:\TradingSystem\OrderManager
dotnet run --no-build -- --test-db-connection
```

#### Fase 5: Rollout e Monitoramento

```bash
# Staging (testar primeiro)
docker compose -f tools/compose/docker-compose.apps.yml restart workspace-api

# Aguardar 5 minutos, monitorar logs
docker logs -f workspace-api --since 5m | grep -i "database\|connection"

# Se OK, aplicar em produ√ß√£o
systemctl restart tradingsystem-ordermanager.service
systemctl status tradingsystem-ordermanager.service

# Monitorar por 24h (janela de rollback)
tail -f /var/log/trading/ordermanager.log | grep -i "database"
```

#### Fase 6: Registrar Evid√™ncia

```bash
# Gerar evid√™ncia JSON
cat > governance/evidence/audits/secrets-rotation-$(date +%Y-%m-%d).json <<EOF
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "type": "secrets_rotation",
  "actor": "$(whoami)",
  "environment": "production",
  "secrets_rotated": [
    {
      "key": "WORKSPACE__DB__PRIMARY__URL",
      "service": "WorkspaceAPI",
      "old_hash": "$(echo -n '$OLD_DB_PASSWORD' | sha256sum | cut -d' ' -f1)",
      "new_hash": "$(echo -n '$NEW_DB_PASSWORD' | sha256sum | cut -d' ' -f1)",
      "rotation_method": "manual_sop",
      "tested_in_staging": true,
      "downtime": "0s"
    }
  ],
  "rollback_available_until": "$(date -u -d '+24 hours' +%Y-%m-%dT%H:%M:%SZ)",
  "notes": "Rota√ß√£o planejada (90 dias)"
}
EOF
```

### 5.2 Rota√ß√£o de Token de API Externa (Telegram Bot)

#### Fase 1: Gerar Novo Token

```bash
# 1. Acessar BotFather no Telegram
# 2. Enviar: /revoke
# 3. Selecionar bot
# 4. Copiar novo token: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

NEW_TELEGRAM_TOKEN="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
```

#### Fase 2: Atualizar Configura√ß√£o

**Desenvolvimento Local:**
```bash
sed -i "s|TELEGRAM__BOT_TOKEN=.*|TELEGRAM__BOT_TOKEN=${NEW_TELEGRAM_TOKEN}|" .env
```

**Staging/Production:**
```bash
# Atualizar secrets.enc.yaml (mesmo processo 5.1 Fase 3)
age -d -i ~/.age/key.txt config/secrets.enc.yaml > config/secrets.yaml
yq eval ".telegram.bot_token = \"${NEW_TELEGRAM_TOKEN}\"" -i config/secrets.yaml
age -R config/.age-recipients.txt -o config/secrets.enc.yaml config/secrets.yaml
shred -u config/secrets.yaml
```

#### Fase 3: Testar Webhook

```bash
# Testar novo token
curl -X POST "https://api.telegram.org/bot${NEW_TELEGRAM_TOKEN}/getMe"

# Configurar webhook
curl -X POST "https://api.telegram.org/bot${NEW_TELEGRAM_TOKEN}/setWebhook" \
  -d "url=https://tradingsystem.local/webhook/telegram"
```

#### Fase 4: Deploy e Valida√ß√£o

```bash
# Restart servi√ßo
docker compose -f tools/compose/docker-compose.apps.yml restart tp-capital

# Enviar mensagem de teste no bot
# Verificar logs
docker logs tp-capital --since 2m | grep "webhook received"
```

### 5.3 Rota√ß√£o de JWT Secret

#### Fase 1: Gerar Novo Secret

```bash
NEW_JWT_SECRET=$(openssl rand -base64 64 | tr -d '\n')
echo "Novo JWT Secret: ${NEW_JWT_SECRET:0:8}***"
```

#### Fase 2: Implementar Dual-Key Support (Zero Downtime)

**Node.js (Express):**
```javascript
// middleware/auth.js
const OLD_JWT_SECRET = process.env.JWT_SECRET;
const NEW_JWT_SECRET = process.env.JWT_SECRET_NEW;

function verifyToken(token) {
  try {
    // Tentar novo secret primeiro
    return jwt.verify(token, NEW_JWT_SECRET);
  } catch (err) {
    // Fallback para secret antigo (compatibilidade)
    return jwt.verify(token, OLD_JWT_SECRET);
  }
}

function signToken(payload) {
  // SEMPRE assinar com novo secret
  return jwt.sign(payload, NEW_JWT_SECRET, { expiresIn: '1h' });
}
```

#### Fase 3: Rollout Gradual

```bash
# 1. Deploy c√≥digo com dual-key support
git commit -m "feat(auth): support dual JWT secrets for rotation"
git push

# 2. Atualizar NEW_JWT_SECRET em produ√ß√£o (manter OLD)
gh secret set JWT_SECRET_NEW --body "${NEW_JWT_SECRET}" --env production

# 3. Aguardar 24h (todos os tokens antigos expirarem)

# 4. Promover novo secret e remover antigo
gh secret set JWT_SECRET --body "${NEW_JWT_SECRET}" --env production
gh secret delete JWT_SECRET_NEW --env production

# 5. Remover dual-key do c√≥digo
git commit -m "chore(auth): remove dual JWT secret support"
```

### 5.4 Rota√ß√£o de Age Private Key

**‚ö†Ô∏è CR√çTICO: Processo mais sens√≠vel, requer coordena√ß√£o de toda a equipe.**

#### Fase 1: Gerar Novo Par de Chaves

```bash
# Gerar novo par age
age-keygen -o ~/.age/key-new.txt

# Extrair public key
AGE_PUBLIC_NEW=$(grep "public key:" ~/.age/key-new.txt | cut -d: -f2 | tr -d ' ')
echo "Nova public key: $AGE_PUBLIC_NEW"
```

#### Fase 2: Adicionar Recipient

```bash
# Adicionar nova public key aos recipients (mantendo antiga)
echo "$AGE_PUBLIC_NEW" >> config/.age-recipients.txt

# Commitar
git add config/.age-recipients.txt
git commit -m "chore(secrets): add new age recipient for key rotation"
```

#### Fase 3: Re-criptografar Todos os Secrets

```bash
# 1. Descriptografar com chave antiga
age -d -i ~/.age/key.txt config/secrets.enc.yaml > config/secrets.yaml

# 2. Re-criptografar com AMBAS as chaves (recipients file)
age -R config/.age-recipients.txt -o config/secrets.enc.yaml config/secrets.yaml

# 3. Testar descriptografia com nova chave
age -d -i ~/.age/key-new.txt config/secrets.enc.yaml > /dev/null && echo "‚úÖ Nova chave funciona"

# 4. Remover plaintext
shred -u config/secrets.yaml
```

#### Fase 4: Distribuir Nova Chave para Equipe/Ambientes

```bash
# GitHub Actions (via UI ou CLI)
gh secret set AGE_SECRET_KEY --body "$(cat ~/.age/key-new.txt)" --env production

# Produ√ß√£o Windows (via RDP seguro)
# 1. Copiar key-new.txt via canal seguro (n√£o email!)
# 2. Salvar em C:\TradingSystem\secrets\age-key.txt
# 3. Configurar ACL: icacls age-key.txt /inheritance:r /grant "NT AUTHORITY\SYSTEM:(F)" /grant "Administrators:(F)"
```

#### Fase 5: Remover Chave Antiga

```bash
# 1. Aguardar 7 dias (todos os ambientes atualizados)

# 2. Remover public key antiga de recipients
# Editar config/.age-recipients.txt manualmente

# 3. Re-criptografar com apenas nova chave
age -d -i ~/.age/key-new.txt config/secrets.enc.yaml > config/secrets.yaml
age -R config/.age-recipients.txt -o config/secrets.enc.yaml config/secrets.yaml
shred -u config/secrets.yaml

# 4. Destruir chave antiga
shred -u ~/.age/key.txt
mv ~/.age/key-new.txt ~/.age/key.txt
```

## 6. Rollback

### 6.1 Reverter Senha de DB (< 24h ap√≥s rota√ß√£o)

```bash
# 1. Restaurar senha antiga no banco
psql -U postgres -c "ALTER USER workspace_user WITH PASSWORD 'OLD_DB_PASSWORD';"

# 2. Restaurar .env ou secrets.enc.yaml do backup
cp .env.backup.YYYYMMDD-HHMMSS .env

# 3. Restart aplica√ß√£o
docker compose restart workspace-api

# 4. Registrar incidente
cat > governance/evidence/audits/rollback-$(date +%Y-%m-%d).json <<EOF
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "type": "secrets_rollback",
  "reason": "Connection failures after rotation",
  "secret": "WORKSPACE__DB__PRIMARY__URL",
  "reverted_to_backup": "YYYYMMDD-HHMMSS"
}
EOF
```

### 6.2 Reverter Token de API

```bash
# 1. Restaurar token antigo em .env
sed -i "s|TELEGRAM__BOT_TOKEN=.*|TELEGRAM__BOT_TOKEN=${OLD_TELEGRAM_TOKEN}|" .env

# 2. Re-configurar webhook
curl -X POST "https://api.telegram.org/bot${OLD_TELEGRAM_TOKEN}/setWebhook" \
  -d "url=https://tradingsystem.local/webhook/telegram"

# 3. Restart servi√ßo
docker compose restart tp-capital
```

## 7. Checklist de Valida√ß√£o P√≥s-Rota√ß√£o

**Executar 30 minutos, 4 horas e 24 horas ap√≥s rota√ß√£o:**

```bash
# 1. Health checks passando
bash scripts/maintenance/health-check-all.sh

# 2. Logs sem erros de autentica√ß√£o
docker logs workspace-api --since 30m | grep -iE "error|fail|auth" | wc -l  # Deve ser 0

# 3. Conex√µes de DB ativas
psql -U postgres -c "SELECT count(*) FROM pg_stat_activity WHERE usename='workspace_user';"

# 4. APIs externas respondendo
curl -s https://api.telegram.org/bot${NEW_TELEGRAM_TOKEN}/getMe | jq -r '.ok'  # true

# 5. Evid√™ncia registrada
ls -lh governance/evidence/audits/secrets-rotation-$(date +%Y-%m-%d).json

# 6. Backup dispon√≠vel
ls -lh .env.backup.* | tail -1
```

## 8. Tratamento de Emerg√™ncia (Exposi√ß√£o Acidental)

### 8.1 Detec√ß√£o de Exposi√ß√£o

**Cen√°rios:**
- Secret commitado em plaintext no Git
- Secret logado em arquivo/console
- Secret exposto em endpoint p√∫blico
- Secret compartilhado via canal inseguro (email, Slack)

### 8.2 Resposta Imediata (< 15 minutos)

```bash
# 1. REVOGAR IMEDIATAMENTE (n√£o esperar rota√ß√£o completa)
# Exemplos:
# - DB: ALTER USER ... WITH PASSWORD '***' (tempor√°ria forte)
# - Telegram: /revoke no BotFather
# - JWT: Invalidar todos os tokens (force logout)

# 2. Notificar equipe via canal de emerg√™ncia
# Slack: #security-incidents
# Mensagem: "CRITICAL: [SECRET_TYPE] exposed in [LOCATION]. Revoked at [TIMESTAMP]."

# 3. Remover evid√™ncia p√∫blica (se GitHub)
# Op√ß√£o A: git filter-repo (reescrever hist√≥rico)
git filter-repo --invert-paths --path .env --force

# Op√ß√£o B: GitHub support (se repo p√∫blico)
# https://support.github.com/ ‚Üí "Remove sensitive data"

# 4. Registrar incidente
cat > governance/evidence/audits/incident-$(date +%Y-%m-%d-%H%M%S).json <<EOF
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "severity": "CRITICAL",
  "type": "secret_exposure",
  "secret": "TELEGRAM__BOT_TOKEN",
  "exposure_method": "git_commit",
  "commit_hash": "abc123def456",
  "revoked_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "rotation_completed_at": "TBD",
  "root_cause": "Developer bypassed pre-commit hook",
  "remediation": "Enforced git-secrets globally"
}
EOF
```

### 8.3 Rota√ß√£o Completa (< 2 horas)

```bash
# 5. Seguir procedimento 5.1-5.4 (dependendo do tipo)
# Priorizar zero downtime mesmo em emerg√™ncia

# 6. Auditoria completa de acessos
# - Logs de acesso ao secret (quem leu, quando)
# - Logs de uso do secret (APIs chamadas, DBs acessados)

# 7. Post-mortem obrigat√≥rio (24-48h ap√≥s)
# Template: governance/evidence/audits/postmortem-YYYY-MM-DD.md
```

## 9. Automa√ß√£o (Futuro)

**Roadmap para rota√ß√£o automatizada:**

```javascript
// scripts/automation/auto-rotate-secrets.mjs
// Executado via cron job (weekly)

import { rotateSecret } from './lib/secrets-manager.js';

const ROTATION_SCHEDULE = {
  'WORKSPACE__DB__PRIMARY__URL': { daysUntilRotation: 180, lastRotated: '2025-09-05' },
  'TELEGRAM__BOT_TOKEN': { daysUntilRotation: 90, lastRotated: '2025-11-01' },
  'JWT_SECRET': { daysUntilRotation: 90, lastRotated: '2025-10-15' }
};

for (const [secretKey, config] of Object.entries(ROTATION_SCHEDULE)) {
  const daysSinceRotation = Math.floor((Date.now() - new Date(config.lastRotated)) / (1000 * 60 * 60 * 24));
  
  if (daysSinceRotation >= config.daysUntilRotation - 7) {
    console.log(`‚ö†Ô∏è ${secretKey} precisa de rota√ß√£o em ${config.daysUntilRotation - daysSinceRotation} dias`);
    // Enviar notifica√ß√£o para owner
  }
  
  if (daysSinceRotation >= config.daysUntilRotation) {
    console.log(`üîÑ Rotacionando ${secretKey} automaticamente...`);
    await rotateSecret(secretKey);
  }
}
```

## 10. Responsabilidades

| Papel | Atividade |
|-------|-----------|
| **Security Engineering** | Aprovar rota√ß√µes, auditar evid√™ncias, conduzir post-mortems |
| **DevOps/SRE** | Executar rota√ß√µes, atualizar GitHub Secrets, monitorar rollout |
| **Developers** | Testar conex√µes, validar funcionalidade, reportar issues |
| **QA** | Validar staging antes de produ√ß√£o, executar testes de integra√ß√£o |

## 11. Refer√™ncias

- **Pol√≠tica:** [POL-0002 - Secrets & Env Policy](../policies/secrets-env-policy)
- **Padr√£o:** [STD-010 - Secrets Standard](../standards/secrets-standard)
- **Templates:** arquivo `governance/registry/templates/.env.example`
- **Evid√™ncias:** diret√≥rio `governance/evidence/audits`

## 12. Hist√≥rico de Revis√µes

| Data       | Vers√£o | Autor              | Mudan√ßas                  |
|------------|--------|--------------------|---------------------------|
| 2025-11-05 | 1.0    | SecurityEngineering | Cria√ß√£o inicial SOP-SEC-001 |

---

**Emerg√™ncia 24/7:** security-oncall@tradingsystem.local  
**Pr√≥xima Revis√£o:** 2026-05-04 (180 dias)
