@startuml TP Capital - Proposed Architecture (To-Be)
!define RECTANGLE_COLOR #4A90E2
!define INTERFACE_COLOR #50E3C2
!define DATABASE_COLOR #BD10E0
!define EXTERNAL_COLOR #F5A623
!define NEW_COLOR #7ED321

skinparam componentStyle rectangle
skinparam backgroundColor #FFFFFF
skinparam defaultFontSize 12

title TP Capital - Proposed Architecture (Clean Architecture + DDD)

' External Systems
component "Telegram Gateway" <<External>> #F5A623 as TelegramGateway
database "Gateway DB" <<PostgreSQL>> #BD10E0 as GatewayDB
database "TimescaleDB" <<PostgreSQL>> #BD10E0 as TimescaleDB
database "Redis Cache" <<Cache>> #NEW_COLOR as Redis

package "TP Capital Service" {
  
  ' === PRESENTATION LAYER ===
  package "Presentation Layer" #E8F5E9 {
    component "Express Server" #4A90E2 as Server
    
    package "Routes" {
      component "signalsRouter" #50E3C2 as SignalsRouter
      component "channelsRouter" #50E3C2 as ChannelsRouter
      component "syncRouter" #50E3C2 as SyncRouter
      component "healthRouter" #50E3C2 as HealthRouter
    }
    
    package "Middleware" {
      component "authMiddleware" #50E3C2 as AuthMW
      component "validationMiddleware" #50E3C2 as ValidationMW
      component "errorHandler" #50E3C2 as ErrorHandler
    }
    
    package "DTOs" {
      component "CreateSignalDto" #50E3C2 as CreateSignalDto
      component "CreateChannelDto" #50E3C2 as CreateChannelDto
      component "SyncMessagesDto" #50E3C2 as SyncDto
    }
  }
  
  ' === APPLICATION LAYER ===
  package "Application Layer" #FFF3E0 {
    component "SignalService" #NEW_COLOR as SignalService {
      rectangle "createSignal()"
      rectangle "getSignals()"
      rectangle "deleteSignal()"
    }
    
    component "ChannelService" #NEW_COLOR as ChannelService {
      rectangle "createChannel()"
      rectangle "updateChannel()"
      rectangle "getActiveChannels()"
    }
    
    component "SyncService" #NEW_COLOR as SyncService {
      rectangle "syncMessagesFromGateway()"
      rectangle "convertQueuedToReceived()"
    }
    
    component "ParsingService" #NEW_COLOR as ParsingService {
      rectangle "parseSignal()"
      rectangle "validateSignal()"
      rectangle "normalizeFields()"
    }
  }
  
  ' === DOMAIN LAYER ===
  package "Domain Layer" #E1F5FE {
    component "Signal (Entity)" #NEW_COLOR as SignalEntity {
      rectangle "- id: UUID"
      rectangle "- ts: DateTime"
      rectangle "- asset: string"
      rectangle "- buyRange: Range"
      rectangle "- targets: Target[]"
      rectangle "- stop: number"
      rectangle "+ isComplete(): boolean"
      rectangle "+ isDuplicate(): boolean"
    }
    
    component "Channel (Entity)" #NEW_COLOR as ChannelEntity {
      rectangle "- id: string"
      rectangle "- channelId: string"
      rectangle "- label: string"
      rectangle "- status: ChannelStatus"
      rectangle "+ activate()"
      rectangle "+ deactivate()"
    }
    
    component "ISignalRepository" <<interface>> #50E3C2 as ISignalRepo
    component "IChannelRepository" <<interface>> #50E3C2 as IChannelRepo
  }
  
  ' === INFRASTRUCTURE LAYER ===
  package "Infrastructure Layer" #FCE4EC {
    component "SignalRepository" #4A90E2 as SignalRepo {
      rectangle "save(signal): Promise<void>"
      rectangle "findByChannel(): Promise<Signal[]>"
      rectangle "findDuplicate(): Promise<boolean>"
    }
    
    component "ChannelRepository" #4A90E2 as ChannelRepo {
      rectangle "findActive(): Promise<Channel[]>"
      rectangle "save(): Promise<void>"
    }
    
    component "TimescaleClient" #4A90E2 as TSClient {
      rectangle "Connection Pool"
      rectangle "Query Execution"
      rectangle "Health Check"
    }
    
    component "GatewayClient" #4A90E2 as GWClient {
      rectangle "Connection Pool"
      rectangle "Message Polling"
    }
    
    component "CacheService" #NEW_COLOR as Cache {
      rectangle "get(key)"
      rectangle "set(key, value, ttl)"
      rectangle "invalidate(pattern)"
    }
    
    component "CircuitBreaker" #NEW_COLOR as CB {
      rectangle "callDatabase()"
      rectangle "onOpen()"
      rectangle "onHalfOpen()"
    }
  }
  
  ' === WORKERS ===
  package "Background Workers" {
    component "PollingWorker" #4A90E2 as Worker {
      rectangle "Poll Loop (with backoff)"
      rectangle "Batch Processing"
      rectangle "Error Handling"
    }
  }
}

' ============================================================================
' RELATIONSHIPS - Presentation → Application
' ============================================================================
Server --> SignalsRouter
Server --> ChannelsRouter
Server --> SyncRouter
Server --> HealthRouter

SignalsRouter --> AuthMW
SignalsRouter --> ValidationMW
SignalsRouter --> SignalService

ChannelsRouter --> AuthMW
ChannelsRouter --> ValidationMW
ChannelsRouter --> ChannelService

SyncRouter --> AuthMW
SyncRouter --> SyncService

' DTOs
SignalsRouter ..> CreateSignalDto : <<validates>>
ChannelsRouter ..> CreateChannelDto : <<validates>>
SyncRouter ..> SyncDto : <<validates>>

' ============================================================================
' RELATIONSHIPS - Application → Domain
' ============================================================================
SignalService --> ISignalRepo : <<depends on>>
SignalService --> ParsingService
SignalService --> Cache

ChannelService --> IChannelRepo : <<depends on>>
ChannelService --> Cache

SyncService --> TelegramGateway : HTTP
SyncService --> GWClient

ParsingService ..> SignalEntity : <<creates>>

' ============================================================================
' RELATIONSHIPS - Infrastructure → Domain
' ============================================================================
SignalRepo ..|> ISignalRepo : <<implements>>
SignalRepo --> TSClient
SignalRepo --> CB

ChannelRepo ..|> IChannelRepo : <<implements>>
ChannelRepo --> TSClient

TSClient --> TimescaleDB
GWClient --> GatewayDB
Cache --> Redis

' ============================================================================
' RELATIONSHIPS - Workers
' ============================================================================
Worker --> GWClient : fetch messages
Worker --> ParsingService : parse
Worker --> SignalService : createSignal()

' ============================================================================
' NOTES
' ============================================================================

note right of SignalService #NEW_COLOR
  **New Service Layer:**
  - Business logic isolated
  - Testable (mockable repos)
  - Transactions managed here
  - Input validation with Zod
end note

note bottom of ISignalRepo #NEW_COLOR
  **Repository Pattern:**
  - Abstracts data access
  - Enables unit testing (mock repos)
  - Swappable persistence (SQL → NoSQL)
  - Centralized query optimization
end note

note left of CB #NEW_COLOR
  **Circuit Breaker:**
  - Prevents cascade failures
  - Auto-recovery with half-open state
  - Configurable thresholds
  - Prometheus metrics
end note

note right of Cache #NEW_COLOR
  **Caching Strategy:**
  - Channel configs (TTL: 5min)
  - Recent signals (TTL: 1min)
  - Cache invalidation on mutations
  - Reduces DB load by ~40%
end note

@enduml


